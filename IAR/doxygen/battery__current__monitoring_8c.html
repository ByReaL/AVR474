<html xmlns:v="urn:schemas-microsoft-com:vml"
xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns="http://www.w3.org/TR/REC-html40">

<head>
<meta http-equiv=Content-Type content="text/html; charset=iso-8859-1">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 11">
<meta name=Originator content="Microsoft Word 11">
<link rel=File-List href="atmel-header_files/filelist.xml">
<link rel=Edit-Time-Data href="atmel-header_files/editdata.mso">
<!--[if !mso]>
<style>
v\:* {behavior:url(#default#VML);}
o\:* {behavior:url(#default#VML);}
w\:* {behavior:url(#default#VML);}
.shape {behavior:url(#default#VML);}
</style>
<![endif]-->
<title>@DOC_TITLE@</title>
<!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>ping.zhou</o:Author>
  <o:Template>Normal</o:Template>
  <o:LastAuthor>ping.zhou</o:LastAuthor>
  <o:Revision>3</o:Revision>
  <o:TotalTime>0</o:TotalTime>
  <o:Created>2010-08-04T02:58:00Z</o:Created>
  <o:LastSaved>2010-08-04T02:58:00Z</o:LastSaved>
  <o:Pages>1</o:Pages>
  <o:Words>51</o:Words>
  <o:Characters>297</o:Characters>
  <o:Company>Atmel</o:Company>
  <o:Lines>2</o:Lines>
  <o:Paragraphs>1</o:Paragraphs>
  <o:CharactersWithSpaces>347</o:CharactersWithSpaces>
  <o:Version>11.9999</o:Version>
 </o:DocumentProperties>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:Zoom>150</w:Zoom>
  <w:SpellingState>Clean</w:SpellingState>
  <w:GrammarState>Clean</w:GrammarState>
  <w:ValidateAgainstSchemas/>
  <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid>
  <w:IgnoreMixedContent>false</w:IgnoreMixedContent>
  <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText>
  <w:Compatibility>
   <w:UseFELayout/>
  </w:Compatibility>
  <w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel>
 </w:WordDocument>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:LatentStyles DefLockedState="false" LatentStyleCount="156">
 </w:LatentStyles>
</xml><![endif]-->
<link rel=Stylesheet type="text/css" media=all href="doxygen.css">
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Helvetica;
	panose-1:2 11 6 4 2 2 2 2 2 4;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:536902279 -2147483648 8 0 511 0;}
@font-face
	{font-family:SimSun;
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-alt:SimSun;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 135135232 16 0 262145 0;}
@font-face
	{font-family:SimSun;
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 135135232 16 0 262145 0;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:SimSun;}
p
	{font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:SimSun;}
span.SpellE
	{mso-style-name:"";
	mso-spl-e:yes;}
@page Section1
	{size:8.5in 11.0in;
	margin:1.0in 1.25in 1.0in 1.25in;
	mso-header-margin:.5in;
	mso-footer-margin:.5in;
	mso-paper-source:0;}
div.Section1
	{page:Section1;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
	{mso-style-name:"Table Normal";
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-parent:"";
	mso-padding-alt:0in 5.4pt 0in 5.4pt;
	mso-para-margin:0in;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-ansi-language:#0400;
	mso-fareast-language:#0400;
	mso-bidi-language:#0400;}
</style>
<![endif]--><!--[if gte mso 9]><xml>
 <o:shapedefaults v:ext="edit" spidmax="2050"/>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <o:shapelayout v:ext="edit">
  <o:idmap v:ext="edit" data="1"/>
 </o:shapelayout></xml><![endif]-->
</head>

<body lang=EN-US link=blue vlink=blue style='tab-interval:.5in'>

<div class=Section1>

<table class=MsoNormalTable border=0 cellpadding=0 width="100%"
 style='width:100.0%;mso-cellspacing:1.5pt;background:white'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes'>
  <td style='padding:.75pt .75pt .75pt .75pt'>
  <p><a href="http://www.atmel.com"><span style='text-decoration:none;
  text-underline:none'><img border=0 width=109 height=50 id="_x0000_i1025"
  src=atmel.jpg></span></a></p>
  <p class=MsoNormal><o:p>&nbsp;</o:p></p>
  </td>
  <td style='padding:.75pt .75pt .75pt .75pt'>
  <p class=MsoNormal><span class=SpellE><strong><span style='font-size:24.0pt;
  font-family:Helvetica;color:black'>SmartBattery</span></strong></span><strong><span
  style='font-size:24.0pt;font-family:Helvetica;color:black'> Device
  Application Note</span></strong></p>
  </td>
  <td style='padding:.75pt .75pt .75pt .75pt'>
  <p><a href="http://www.atmel.com/products/AVR"><span style='text-decoration:
  none;text-underline:none'><img border=0 width=138 height=77 id="_x0000_i1026"
  src="AVR_logo_blue.gif"></span></a></p>
  <p class=MsoNormal><o:p>&nbsp;</o:p></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:1;mso-yfti-lastrow:yes;height:.75pt'>
  <td colspan=3 style='padding:.75pt .75pt .75pt .75pt;height:.75pt'
  background=blue.gif>
  <p class=MsoNormal><span style='font-size:1.0pt;mso-bidi-font-size:12.0pt'><o:p>&nbsp;</o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

</div>

</body>

</html>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_29ae905079a6eb1b30b29288f24757bc.html">lib_mcu</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_cb83f2bb87201f51e86f47135d125b21.html">Battery_current_monitoring</a>
  </div>
</div>
<div class="contents">
<h1>battery_current_monitoring.c File Reference</h1><hr><a name="_details"></a><h2>Detailed Description</h2>
CC-ADC result processing firmware module. 
<p>
<dl class="user" compact><dt><b>Application note:</b></dt><dd>AVR474: SB202 Firmware user's guide.</dd></dl>
<dl class="user" compact><dt><b>Documentation</b></dt><dd>For comprehensive code documentation, supported compilers, compiler settings and supported devices see readme.html</dd></dl>
<dl class="author" compact><dt><b>Author:</b></dt><dd>Atmel Corporation: <a href="http://www.atmel.com">http://www.atmel.com</a> <br>
 Support email: <a href="mailto:avr@atmel.com">avr@atmel.com</a></dd></dl>
<dl class="rcs" compact><dt><b>Revision</b></dt><dd>6090 </dd></dl>
<dl class="rcs" compact><dt><b>Date</b></dt><dd>2009-10-05 21:40:12 +0800 (Mon, 05 Oct 2009) </dd></dl>
<br>
<p>
Copyright (c) 2009, Atmel Corporation All rights reserved.<p>
Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:<p>
1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.<p>
2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.<p>
3. The name of ATMEL may not be used to endorse or promote products derived from this software without specific prior written permission.<p>
THIS SOFTWARE IS PROVIDED BY ATMEL "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE EXPRESSLY AND SPECIFICALLY DISCLAIMED. IN NO EVENT SHALL ATMEL BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. 
<p>Definition in file <a class="el" href="battery__current__monitoring_8c-source.html">battery_current_monitoring.c</a>.</p>

<p>
<code>#include &quot;<a class="el" href="common_8h-source.html">common.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="battery__pack__parameters_8h-source.html">battery_pack_parameters.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="battery__current__monitoring_8h-source.html">battery_current_monitoring.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="ccadc_8h-source.html">ccadc.h</a>&quot;</code><br>

<p>
<div class="dynheader">
Include dependency graph for battery_current_monitoring.c:</div>
<div class="dynsection">
<p><center><img src="battery__current__monitoring_8c__incl.gif" border="0" usemap="#lib_mcu/Battery_current_monitoring/battery_current_monitoring.c_map" alt=""></center>
<map name="lib_mcu/Battery_current_monitoring/battery_current_monitoring.c_map">
<area shape="rect" href="common_8h.html" title="Common headerfile." alt="" coords="276,304,359,331"><area shape="rect" href="battery__pack__parameters_8h.html" title="Definition file for a smart battery pack." alt="" coords="228,155,407,181"><area shape="rect" href="battery__current__monitoring_8h.html" title="Header file for CC&#45;ADC result processing firmware module." alt="" coords="409,229,596,256"><area shape="rect" href="ccadc_8h.html" title="CCADC module header file." alt="" coords="540,80,607,107"><area shape="rect" href="stdint_8h.html" title="stdint.h" alt="" coords="60,379,124,405"><area shape="rect" href="error_8h.html" title="error.h" alt="" coords="412,379,471,405"><area shape="rect" href="sbs__commands_8h.html" title="Headerfile for sbs_commands.c." alt="" coords="20,229,143,256"><area shape="rect" href="vadc_8h.html" title="Headerfile for vadc_usage.c." alt="" coords="167,229,225,256"><area shape="rect" href="battery__protection_8h.html" title="Header file for Battery Protection peripheral module driver." alt="" coords="249,229,385,256"><area shape="rect" href="crc16_8h.html" title="Header file for CRC16 functions." alt="" coords="60,304,124,331"></map>
</div>

<p>
<a href="battery__current__monitoring_8c-source.html">Go to the source code of this file.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="battery__current__monitoring_8c.html#3f516153abe33ea81943f5121a723ff1">BATTCUR_CalculateShuntCoeffient</a> (<a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> shuntResistance, <a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> VrefSel)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Calculate the Shunt Coefficient for CCADC_Value to mA conversion.  <a href="#3f516153abe33ea81943f5121a723ff1"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="battery__current__monitoring_8c.html#0959c4b3bb0cee63ad2a3bdb89a92a6d">BATTCUR_GetAverageCurrent</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Provide an estimate for the average current throughout the last minute (18-bit signed).  <a href="#0959c4b3bb0cee63ad2a3bdb89a92a6d"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="battery__current__monitoring_8c.html#ae8592ed4c14b5a00048fe1ed1c68e4a">BATTCUR_GetCurrent</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Provides the current from the last CC-ADC reading (18-bit signed).  <a href="#ae8592ed4c14b5a00048fe1ed1c68e4a"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="battery__current__monitoring_8c.html#6a557e4dca31a58b1683861bf8f154e6">BATTCUR_GetOffsetCalibratedCurrent</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Provides the offset calibrated current from the last CC-ADC reading.  <a href="#6a557e4dca31a58b1683861bf8f154e6"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="battery__current__monitoring_8c.html#8b9942c60483ab80e9daf26fd8c98782">BATTCUR_InitializeAverageCurrent</a> (<a class="el" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a> current)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Init the average current counter.  <a href="#8b9942c60483ab80e9daf26fd8c98782"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="battery__current__monitoring_8c.html#5514ee0b54dac907d6cbb5572146f612">BATTCUR_IsCurrentLow</a> (<a class="el" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a> current)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Is the current below the limit that defines standby operation (time to enter low power mode?).  <a href="#5514ee0b54dac907d6cbb5572146f612"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="battery__current__monitoring_8c.html#7509bf2a6930a4ba1a5a1927582c40bb">BATTCUR_IsDischargeOngoing</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Is the current charging or discharging the battery.  <a href="#7509bf2a6930a4ba1a5a1927582c40bb"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="battery__current__monitoring_8c.html#490aa68cdebeff1cd6ca0f27c039139d">BATTCUR_mA2RccTicks</a> (<a class="el" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a> mA_in)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Convert mA to Rcc CCADC ticks.  <a href="#490aa68cdebeff1cd6ca0f27c039139d"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="battery__current__monitoring_8c.html#90ab35d451c37cb0d641b5f037598441">BATTCUR_mA2Ticks</a> (<a class="el" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a> mA_in)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Convert mA to CCADC tick.  <a href="#90ab35d451c37cb0d641b5f037598441"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="battery__current__monitoring_8c.html#8baedbc3e31405ed1b2d642808d21933">BATTCUR_StoreCurrent</a> (<a class="el" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a> current)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Stores the current from the last CC-ADC reading ( mV, 18-bit signed).  <a href="#8baedbc3e31405ed1b2d642808d21933"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="battery__current__monitoring_8c.html#d971791f4fc1c6f54e1d7d46fea20786">BATTCUR_Ticks2mA</a> (<a class="el" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a> ticks)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Convert CCADC ticks to mA.  <a href="#d971791f4fc1c6f54e1d7d46fea20786"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="battery__current__monitoring_8c.html#cfd447102c06d4b657539fe1cd9f3f59">BATTCUR_UpdateAverageCurrent</a> (<a class="el" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a> current)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Calculates and stores the average current during the last minut (18-bit signed).  <a href="#cfd447102c06d4b657539fe1cd9f3f59"></a><br></td></tr>
<tr><td colspan="2"><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="battery__current__monitoring_8c.html#9807215021356036591244af7f666ac6">averageCurrent</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="battery__current__monitoring_8c.html#bac10e7b6c168aaa6ec71c626d549569">CCADC2mACoefficient</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="battery__current__monitoring_8c.html#0331ed61d181da48bb4c5e7d3cdc26e7">discharge</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="battery__current__monitoring_8c.html#7d2aa52407c70bb2a4f07abf389c1303">lastCurrent</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="battery__current__monitoring_8c.html#ef4974cae3e7d0d084ea55f438b9c7d9">lastOffsetCalibratedCurrent</a></td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="3f516153abe33ea81943f5121a723ff1"></a><!-- doxytag: member="battery_current_monitoring.c::BATTCUR_CalculateShuntCoeffient" ref="3f516153abe33ea81943f5121a723ff1" args="(uint16_t shuntResistance, uint8_t VrefSel)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void BATTCUR_CalculateShuntCoeffient           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a>&nbsp;</td>
          <td class="paramname"> <em>shuntResistance</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>&nbsp;</td>
          <td class="paramname"> <em>VrefSel</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Calculate the Shunt Coefficient for CCADC_Value to mA conversion. 
<p>
The goal for this function is to find a coefficient that can be used in the following formula: CCADC_Value*coefficient = mA But since coefficient is a very small number, it is scaled up by 2^16, so the formula is: (CCADC_Value*coefficient)/2^16 = mA<p>
Formula for Shunt Coefficient for CCADC_Value to mA conversion CCADC2mACoefficient = I(mA)*10^6/CCADC_Value = ref(mV)*10^6*2^16/(shunt(uohm)*2^17)<p>
ref(mV): the internal reference voltage of CCADC with the unit "mV" shunt(uohm): the current sensor resistance with the unit "microOhm" 10^6: compensation for using the shunt with "microOhm" 2^17: the CCADC measurement result range 2^16: up-scaling to increase accuracy<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>shuntResistance</em>&nbsp;</td><td>Shunt resistance in microOhm </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>VrefSel</em>&nbsp;</td><td>Selects the voltage reference to use </td></tr>
  </table>
</dl>

<p>Definition at line <a class="el" href="battery__current__monitoring_8c-source.html#l00224">224</a> of file <a class="el" href="battery__current__monitoring_8c-source.html">battery_current_monitoring.c</a>.</p>

<p>References <a class="el" href="battery__current__monitoring_8c-source.html#l00064">CCADC2mACoefficient</a>, <a class="el" href="battery__pack__parameters_8h-source.html#l00082">CCADC_VOLTREF_110mV</a>, and <a class="el" href="battery__pack__parameters_8h-source.html#l00083">CCADC_VOLTREF_220mV</a>.</p>

<p>Referenced by <a class="el" href="main_8c-source.html#l01076">handleSBSCommand()</a>, and <a class="el" href="main_8c-source.html#l00187">main()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00225"></a>00225 {
<a name="l00226"></a>00226     
<a name="l00227"></a>00227         <span class="comment">// CCADC2mACoefficient = I(mA)*10^6/tick</span>
<a name="l00228"></a>00228         <span class="comment">//                    = ref(mV)*10^6*2^16/(shunt(uohm)*2^17)</span>
<a name="l00229"></a>00229         <span class="comment">// define: dividend = ref(mV)*10^6*2^16/*2^17</span>
<a name="l00230"></a>00230         <span class="comment">// So:     CCADC2mACoefficient = dividend/shunt(uohm)</span>
<a name="l00231"></a>00231         <span class="comment">// ref(mV):the internal reference voltage of CCADC with the unit "mV"</span>
<a name="l00232"></a>00232         <span class="comment">// shunt(uohm): the current sensor resistance with the unit "microOhm"</span>
<a name="l00233"></a>00233         <span class="comment">// 10^6:compensation for using the shunt with "microOhm"</span>
<a name="l00234"></a>00234         <span class="comment">// 2^17:the CCADC measurement result range</span>
<a name="l00235"></a>00235         <span class="comment">// 2^16:up-scaling to increase accuracy</span>
<a name="l00236"></a>00236     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> dividend;
<a name="l00237"></a>00237 
<a name="l00238"></a>00238         <span class="comment">// VrefSel==0, select 220mV as CCADC internal voltage reference</span>
<a name="l00239"></a>00239         <span class="comment">// VrefSel==1, Select 110mV as CCADC internal voltage reference</span>
<a name="l00240"></a>00240         <span class="keywordflow">if</span>(VrefSel==<a class="code" href="battery__pack__parameters_8h.html#f961c5c9b8cfde037e5ef0c752c9b329">CCADC_VOLTREF_220mV</a>){
<a name="l00241"></a>00241             dividend = <a class="code" href="battery__pack__parameters_8h.html#f961c5c9b8cfde037e5ef0c752c9b329">CCADC_VOLTREF_220mV</a> * 500000;
<a name="l00242"></a>00242     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(VrefSel==<a class="code" href="battery__pack__parameters_8h.html#6cb23dd2269a9b31a3821d25668ca26b" title="CC-ADC internal reference voltage in mV.">CCADC_VOLTREF_110mV</a>){
<a name="l00243"></a>00243             dividend = <a class="code" href="battery__pack__parameters_8h.html#6cb23dd2269a9b31a3821d25668ca26b" title="CC-ADC internal reference voltage in mV.">CCADC_VOLTREF_110mV</a> * 500000;
<a name="l00244"></a>00244         }
<a name="l00245"></a>00245 
<a name="l00246"></a>00246     dividend += (shuntResistance &gt;&gt; 1); <span class="comment">// Add halv divisor to get rounding</span>
<a name="l00247"></a>00247     
<a name="l00248"></a>00248     <a class="code" href="battery__current__monitoring_8c.html#bac10e7b6c168aaa6ec71c626d549569">CCADC2mACoefficient</a> = (<a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a>) (dividend/shuntResistance);
<a name="l00249"></a>00249 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="0959c4b3bb0cee63ad2a3bdb89a92a6d"></a><!-- doxytag: member="battery_current_monitoring.c::BATTCUR_GetAverageCurrent" ref="0959c4b3bb0cee63ad2a3bdb89a92a6d" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a> BATTCUR_GetAverageCurrent           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Provide an estimate for the average current throughout the last minute (18-bit signed). 
<p>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>The average current flowing in/out of the battery pack (represented as mV accros the shunt). </dd></dl>

<p>Definition at line <a class="el" href="battery__current__monitoring_8c-source.html#l00150">150</a> of file <a class="el" href="battery__current__monitoring_8c-source.html">battery_current_monitoring.c</a>.</p>

<p>References <a class="el" href="battery__pack__parameters_8h-source.html#l00226">AVERAGE_CURRENT_SCALING</a>, and <a class="el" href="battery__current__monitoring_8c-source.html#l00062">averageCurrent</a>.</p>

<p>Referenced by <a class="el" href="main_8c-source.html#l01076">handleSBSCommand()</a>, <a class="el" href="main_8c-source.html#l00187">main()</a>, <a class="el" href="main_8c-source.html#l00641">runEveryMinute()</a>, <a class="el" href="smbus__removed_8c-source.html#l00566">SMBR_AbsSOC()</a>, <a class="el" href="smbus__removed_8c-source.html#l00539">SMBR_AvgCurrent()</a>, <a class="el" href="smbus__removed_8c-source.html#l00606">SMBR_AvgTTE()</a>, <a class="el" href="smbus__removed_8c-source.html#l00619">SMBR_AvgTTF()</a>, <a class="el" href="smbus__removed_8c-source.html#l00556">SMBR_RelSOC()</a>, and <a class="el" href="smbus__removed_8c-source.html#l00575">SMBR_RemCap()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00151"></a>00151 {
<a name="l00152"></a>00152     <span class="keywordflow">if</span>(<a class="code" href="battery__current__monitoring_8c.html#9807215021356036591244af7f666ac6">averageCurrent</a> &lt; 0) {
<a name="l00153"></a>00153         <span class="comment">// TODO: perhaps round this division, but the value is not used for anything important so skip that for now</span>
<a name="l00154"></a>00154         <span class="keywordflow">return</span> -(-<a class="code" href="battery__current__monitoring_8c.html#9807215021356036591244af7f666ac6">averageCurrent</a> &gt;&gt; <a class="code" href="battery__pack__parameters_8h.html#3f87b5b1bad8ce6f8a42292fa37cd003" title="If defined, the part is allowed to enter poweroff. Good idea to undefine during normal...">AVERAGE_CURRENT_SCALING</a>);
<a name="l00155"></a>00155     } <span class="keywordflow">else</span> {
<a name="l00156"></a>00156         <span class="keywordflow">return</span> (<a class="code" href="battery__current__monitoring_8c.html#9807215021356036591244af7f666ac6">averageCurrent</a> &gt;&gt; <a class="code" href="battery__pack__parameters_8h.html#3f87b5b1bad8ce6f8a42292fa37cd003" title="If defined, the part is allowed to enter poweroff. Good idea to undefine during normal...">AVERAGE_CURRENT_SCALING</a>);
<a name="l00157"></a>00157     }
<a name="l00158"></a>00158 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="ae8592ed4c14b5a00048fe1ed1c68e4a"></a><!-- doxytag: member="battery_current_monitoring.c::BATTCUR_GetCurrent" ref="ae8592ed4c14b5a00048fe1ed1c68e4a" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a> BATTCUR_GetCurrent           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Provides the current from the last CC-ADC reading (18-bit signed). 
<p>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>The current flowing in/out of the battery pack (represented as mV accros the shunt). </dd></dl>

<p>Definition at line <a class="el" href="battery__current__monitoring_8c-source.html#l00094">94</a> of file <a class="el" href="battery__current__monitoring_8c-source.html">battery_current_monitoring.c</a>.</p>

<p>References <a class="el" href="battery__current__monitoring_8c-source.html#l00059">lastCurrent</a>.</p>

<p>Referenced by <a class="el" href="gas__gauging_8c-source.html#l00131">GASG_AtRateOK()</a>, <a class="el" href="main_8c-source.html#l00187">main()</a>, <a class="el" href="smbus__removed_8c-source.html#l00529">SMBR_Current()</a>, and <a class="el" href="smbus__removed_8c-source.html#l00593">SMBR_RunTTE()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00095"></a>00095 {
<a name="l00096"></a>00096     <span class="keywordflow">return</span> <a class="code" href="battery__current__monitoring_8c.html#7d2aa52407c70bb2a4f07abf389c1303">lastCurrent</a>;
<a name="l00097"></a>00097 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="6a557e4dca31a58b1683861bf8f154e6"></a><!-- doxytag: member="battery_current_monitoring.c::BATTCUR_GetOffsetCalibratedCurrent" ref="6a557e4dca31a58b1683861bf8f154e6" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a> BATTCUR_GetOffsetCalibratedCurrent           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Provides the offset calibrated current from the last CC-ADC reading. 
<p>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>The current flowing in/out of the battery pack (represented as mV accros the shunt). </dd></dl>

<p>Definition at line <a class="el" href="battery__current__monitoring_8c-source.html#l00106">106</a> of file <a class="el" href="battery__current__monitoring_8c-source.html">battery_current_monitoring.c</a>.</p>

<p>References <a class="el" href="battery__current__monitoring_8c-source.html#l00060">lastOffsetCalibratedCurrent</a>.</p>

<p>Referenced by <a class="el" href="voltage__based__SoC_8c-source.html#l00325">ConvertDigitalToCurrent()</a>, <a class="el" href="main_8c-source.html#l00904">handleNewCCADCResult()</a>, <a class="el" href="main_8c-source.html#l01076">handleSBSCommand()</a>, and <a class="el" href="main_8c-source.html#l00187">main()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00107"></a>00107 {
<a name="l00108"></a>00108     <span class="keywordflow">return</span> <a class="code" href="battery__current__monitoring_8c.html#ef4974cae3e7d0d084ea55f438b9c7d9">lastOffsetCalibratedCurrent</a>;
<a name="l00109"></a>00109 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="8b9942c60483ab80e9daf26fd8c98782"></a><!-- doxytag: member="battery_current_monitoring.c::BATTCUR_InitializeAverageCurrent" ref="8b9942c60483ab80e9daf26fd8c98782" args="(int32_t current)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void BATTCUR_InitializeAverageCurrent           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a>&nbsp;</td>
          <td class="paramname"> <em>current</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Init the average current counter. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>current</em>&nbsp;</td><td>First current </td></tr>
  </table>
</dl>

<p>Definition at line <a class="el" href="battery__current__monitoring_8c-source.html#l00184">184</a> of file <a class="el" href="battery__current__monitoring_8c-source.html">battery_current_monitoring.c</a>.</p>

<p>References <a class="el" href="battery__pack__parameters_8h-source.html#l00226">AVERAGE_CURRENT_SCALING</a>, and <a class="el" href="battery__current__monitoring_8c-source.html#l00062">averageCurrent</a>.</p>

<p>Referenced by <a class="el" href="main_8c-source.html#l00187">main()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00185"></a>00185 {
<a name="l00186"></a>00186     <a class="code" href="battery__current__monitoring_8c.html#9807215021356036591244af7f666ac6">averageCurrent</a> = current * (1&lt;&lt;<a class="code" href="battery__pack__parameters_8h.html#3f87b5b1bad8ce6f8a42292fa37cd003" title="If defined, the part is allowed to enter poweroff. Good idea to undefine during normal...">AVERAGE_CURRENT_SCALING</a>);
<a name="l00187"></a>00187 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="5514ee0b54dac907d6cbb5572146f612"></a><!-- doxytag: member="battery_current_monitoring.c::BATTCUR_IsCurrentLow" ref="5514ee0b54dac907d6cbb5572146f612" args="(int32_t current)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool BATTCUR_IsCurrentLow           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a>&nbsp;</td>
          <td class="paramname"> <em>current</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Is the current below the limit that defines standby operation (time to enter low power mode?). 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>current</em>&nbsp;</td><td>The current to check if below standby operation limit (in CCADC ticks)</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>Returns true if the current is below the "low" limit. </dd></dl>

<p>Definition at line <a class="el" href="battery__current__monitoring_8c-source.html#l00169">169</a> of file <a class="el" href="battery__current__monitoring_8c-source.html">battery_current_monitoring.c</a>.</p>

<p>References <a class="el" href="battery__pack__parameters_8h-source.html#l00333">battParam_sramstruct::activeCurrentThresholdInTicks</a>, and <a class="el" href="battery__pack__parameters_8c-source.html#l00067">battParams_sram</a>.</p>

<p>Referenced by <a class="el" href="main_8c-source.html#l00904">handleNewCCADCResult()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00170"></a>00170 {
<a name="l00171"></a>00171     <span class="keywordflow">if</span>(0 &gt; current) {
<a name="l00172"></a>00172         current = -current;
<a name="l00173"></a>00173     }
<a name="l00174"></a>00174     
<a name="l00175"></a>00175     <span class="keywordflow">return</span> ( (<a class="code" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a>)<a class="code" href="battery__pack__parameters_8c.html#465d57b9c9b2b607be86de50f09ed7ba" title="Battery parameters that are calculated at startup from eeprom variables.">battParams_sram</a>.<a class="code" href="structbattParam__sramstruct.html#3b21b0b2c4ba4eab5b1544f92cf6d2fe" title="If current drawn from the battery is above this threshold the application is assumed...">activeCurrentThresholdInTicks</a> &gt; current );
<a name="l00176"></a>00176 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="7509bf2a6930a4ba1a5a1927582c40bb"></a><!-- doxytag: member="battery_current_monitoring.c::BATTCUR_IsDischargeOngoing" ref="7509bf2a6930a4ba1a5a1927582c40bb" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool BATTCUR_IsDischargeOngoing           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Is the current charging or discharging the battery. 
<p>
Uses the offset calibrated current<p>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>Returns true if the current flow is in the discharging direction. </dd></dl>

<p>Definition at line <a class="el" href="battery__current__monitoring_8c-source.html#l00196">196</a> of file <a class="el" href="battery__current__monitoring_8c-source.html">battery_current_monitoring.c</a>.</p>

<p>References <a class="el" href="battery__current__monitoring_8c-source.html#l00061">discharge</a>.</p>

<p>Referenced by <a class="el" href="main_8c-source.html#l00904">handleNewCCADCResult()</a>, <a class="el" href="main_8c-source.html#l00725">handleNewCellTemperature()</a>, <a class="el" href="main_8c-source.html#l00812">handleNewCellVoltage()</a>, <a class="el" href="main_8c-source.html#l00683">handleNewCoreTemperature()</a>, and <a class="el" href="main_8c-source.html#l01076">handleSBSCommand()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00197"></a>00197 {
<a name="l00198"></a>00198     <span class="keywordflow">return</span> <a class="code" href="battery__current__monitoring_8c.html#0331ed61d181da48bb4c5e7d3cdc26e7">discharge</a>;
<a name="l00199"></a>00199 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="490aa68cdebeff1cd6ca0f27c039139d"></a><!-- doxytag: member="battery_current_monitoring.c::BATTCUR_mA2RccTicks" ref="490aa68cdebeff1cd6ca0f27c039139d" args="(int16_t mA_in)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a> BATTCUR_mA2RccTicks           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a>&nbsp;</td>
          <td class="paramname"> <em>mA_in</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Convert mA to Rcc CCADC ticks. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>mA_in</em>&nbsp;</td><td>mA to convert to Rcc ticks </td></tr>
  </table>
</dl>

<p>Definition at line <a class="el" href="battery__current__monitoring_8c-source.html#l00303">303</a> of file <a class="el" href="battery__current__monitoring_8c-source.html">battery_current_monitoring.c</a>.</p>

<p>References <a class="el" href="battery__current__monitoring_8c-source.html#l00289">BATTCUR_mA2Ticks()</a>.</p>

<p>Referenced by <a class="el" href="ccadc_8c-source.html#l00097">CCADC_Init()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00304"></a>00304 {
<a name="l00305"></a>00305     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> temp = (<a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a>) <a class="code" href="battery__current__monitoring_8c.html#90ab35d451c37cb0d641b5f037598441" title="Convert mA to CCADC tick.">BATTCUR_mA2Ticks</a>(mA_in);
<a name="l00306"></a>00306     
<a name="l00307"></a>00307     <span class="comment">// Rcc ticks are 2^5 times as "big" as accumululating ticks</span>
<a name="l00308"></a>00308     temp &gt;&gt;= 5;
<a name="l00309"></a>00309     
<a name="l00310"></a>00310     <span class="keywordflow">return</span> temp;
<a name="l00311"></a>00311 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<p><center><img src="battery__current__monitoring_8c_490aa68cdebeff1cd6ca0f27c039139d_cgraph.gif" border="0" usemap="#battery__current__monitoring_8c_490aa68cdebeff1cd6ca0f27c039139d_cgraph_map" alt=""></center>
<map name="battery__current__monitoring_8c_490aa68cdebeff1cd6ca0f27c039139d_cgraph_map">
<area shape="rect" href="battery__current__monitoring_8c.html#90ab35d451c37cb0d641b5f037598441" title="Convert mA to CCADC tick." alt="" coords="223,5,367,32"></map>
</div>

</div>
</div><p>
<a class="anchor" name="90ab35d451c37cb0d641b5f037598441"></a><!-- doxytag: member="battery_current_monitoring.c::BATTCUR_mA2Ticks" ref="90ab35d451c37cb0d641b5f037598441" args="(int16_t mA_in)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a> BATTCUR_mA2Ticks           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a>&nbsp;</td>
          <td class="paramname"> <em>mA_in</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Convert mA to CCADC tick. 
<p>
Formula: ccadc_ticks = (mA*2^16)/CCADC2mACoefficient<p>
<dl class="note" compact><dt><b>Note:</b></dt><dd>mA cannot be higher than +- 16384 (ie, dont use more than 14 bits excluding the sign bit)</dd></dl>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>mA_in</em>&nbsp;</td><td>mA to convert to CCADC accumulating ticks </td></tr>
  </table>
</dl>

<p>Definition at line <a class="el" href="battery__current__monitoring_8c-source.html#l00289">289</a> of file <a class="el" href="battery__current__monitoring_8c-source.html">battery_current_monitoring.c</a>.</p>

<p>References <a class="el" href="battery__current__monitoring_8c-source.html#l00064">CCADC2mACoefficient</a>.</p>

<p>Referenced by <a class="el" href="battery__current__monitoring_8c-source.html#l00303">BATTCUR_mA2RccTicks()</a>, <a class="el" href="battery__pack__parameters_8c-source.html#l00135">BATTPARAM_InitSramParameters()</a>, <a class="el" href="gas__gauging_8c-source.html#l00222">GASG_CalculateRemainingCapacityValues()</a>, <a class="el" href="gas__gauging_8c-source.html#l00101">GASG_TimeToEmpty()</a>, <a class="el" href="gas__gauging_8c-source.html#l00070">GASG_TimeToFull()</a>, and <a class="el" href="main_8c-source.html#l00904">handleNewCCADCResult()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00290"></a>00290 {
<a name="l00291"></a>00291     <a class="code" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a> temp = (<a class="code" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a>)mA_in*(1ul&lt;&lt;16); <span class="comment">// 2^16</span>
<a name="l00292"></a>00292     
<a name="l00293"></a>00293     temp /= (<a class="code" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a>)<a class="code" href="battery__current__monitoring_8c.html#bac10e7b6c168aaa6ec71c626d549569">CCADC2mACoefficient</a>;
<a name="l00294"></a>00294     
<a name="l00295"></a>00295     <span class="keywordflow">return</span> temp;
<a name="l00296"></a>00296 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="8baedbc3e31405ed1b2d642808d21933"></a><!-- doxytag: member="battery_current_monitoring.c::BATTCUR_StoreCurrent" ref="8baedbc3e31405ed1b2d642808d21933" args="(int32_t current)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void BATTCUR_StoreCurrent           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a>&nbsp;</td>
          <td class="paramname"> <em>current</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Stores the current from the last CC-ADC reading ( mV, 18-bit signed). 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>current</em>&nbsp;</td><td>The current flowing in/out of the battery pack (represented as mV accros the shunt). </td></tr>
  </table>
</dl>

<p>Definition at line <a class="el" href="battery__current__monitoring_8c-source.html#l00077">77</a> of file <a class="el" href="battery__current__monitoring_8c-source.html">battery_current_monitoring.c</a>.</p>

<p>References <a class="el" href="ccadc_8c-source.html#l00392">CCADC_GetAccOffset()</a>, <a class="el" href="battery__current__monitoring_8c-source.html#l00061">discharge</a>, <a class="el" href="battery__current__monitoring_8c-source.html#l00059">lastCurrent</a>, and <a class="el" href="battery__current__monitoring_8c-source.html#l00060">lastOffsetCalibratedCurrent</a>.</p>

<p>Referenced by <a class="el" href="main_8c-source.html#l00187">main()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00078"></a>00078 {
<a name="l00079"></a>00079     <a class="code" href="battery__current__monitoring_8c.html#7d2aa52407c70bb2a4f07abf389c1303">lastCurrent</a> = current;
<a name="l00080"></a>00080     <a class="code" href="battery__current__monitoring_8c.html#ef4974cae3e7d0d084ea55f438b9c7d9">lastOffsetCalibratedCurrent</a> = current + <a class="code" href="ccadc_8c.html#99e4ffa15714d365505a8e83f023bb23" title="Returns the offset for the accumulating conversion.">CCADC_GetAccOffset</a>();
<a name="l00081"></a>00081     <span class="keywordflow">if</span>( 0 &gt;= <a class="code" href="battery__current__monitoring_8c.html#ef4974cae3e7d0d084ea55f438b9c7d9">lastOffsetCalibratedCurrent</a>) {
<a name="l00082"></a>00082         <a class="code" href="battery__current__monitoring_8c.html#0331ed61d181da48bb4c5e7d3cdc26e7">discharge</a> = <span class="keyword">true</span>;
<a name="l00083"></a>00083     } <span class="keywordflow">else</span> {
<a name="l00084"></a>00084         <a class="code" href="battery__current__monitoring_8c.html#0331ed61d181da48bb4c5e7d3cdc26e7">discharge</a> = <span class="keyword">false</span>;
<a name="l00085"></a>00085     }
<a name="l00086"></a>00086 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<p><center><img src="battery__current__monitoring_8c_8baedbc3e31405ed1b2d642808d21933_cgraph.gif" border="0" usemap="#battery__current__monitoring_8c_8baedbc3e31405ed1b2d642808d21933_cgraph_map" alt=""></center>
<map name="battery__current__monitoring_8c_8baedbc3e31405ed1b2d642808d21933_cgraph_map">
<area shape="rect" href="ccadc_8c.html#99e4ffa15714d365505a8e83f023bb23" title="Returns the offset for the accumulating conversion." alt="" coords="213,5,365,32"><area shape="rect" href="ccadc_8c.html#059777fbbf56eeddb97a317a9301284b" title="Check if polarity was changed after last completed ACC conversion." alt="" coords="415,5,596,32"></map>
</div>

</div>
</div><p>
<a class="anchor" name="d971791f4fc1c6f54e1d7d46fea20786"></a><!-- doxytag: member="battery_current_monitoring.c::BATTCUR_Ticks2mA" ref="d971791f4fc1c6f54e1d7d46fea20786" args="(int32_t ticks)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a> BATTCUR_Ticks2mA           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a>&nbsp;</td>
          <td class="paramname"> <em>ticks</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Convert CCADC ticks to mA. 
<p>
Formula: (ccadc_ticks*CCADC2mACoefficient)/2^16 = mA<p>
<dl class="note" compact><dt><b>Note:</b></dt><dd>The ticks value must not be more than 15-bits, or else the calculation may overflow.</dd></dl>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>ticks</em>&nbsp;</td><td>CCADC accumulating ticks to convert to mA </td></tr>
  </table>
</dl>

<p>Definition at line <a class="el" href="battery__current__monitoring_8c-source.html#l00262">262</a> of file <a class="el" href="battery__current__monitoring_8c-source.html">battery_current_monitoring.c</a>.</p>

<p>References <a class="el" href="battery__current__monitoring_8c-source.html#l00064">CCADC2mACoefficient</a>.</p>

<p>Referenced by <a class="el" href="voltage__based__SoC_8c-source.html#l00325">ConvertDigitalToCurrent()</a>, <a class="el" href="gas__gauging_8c-source.html#l00131">GASG_AtRateOK()</a>, <a class="el" href="main_8c-source.html#l01076">handleSBSCommand()</a>, <a class="el" href="smbus__removed_8c-source.html#l00539">SMBR_AvgCurrent()</a>, <a class="el" href="smbus__removed_8c-source.html#l00606">SMBR_AvgTTE()</a>, <a class="el" href="smbus__removed_8c-source.html#l00619">SMBR_AvgTTF()</a>, <a class="el" href="smbus__removed_8c-source.html#l00529">SMBR_Current()</a>, and <a class="el" href="smbus__removed_8c-source.html#l00593">SMBR_RunTTE()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00263"></a>00263 {
<a name="l00264"></a>00264     ticks *= <a class="code" href="battery__current__monitoring_8c.html#bac10e7b6c168aaa6ec71c626d549569">CCADC2mACoefficient</a>;
<a name="l00265"></a>00265     
<a name="l00266"></a>00266     <span class="keywordflow">if</span>(ticks &gt;= 0) {
<a name="l00267"></a>00267         ticks += (1ul&lt;&lt;15);
<a name="l00268"></a>00268         ticks &gt;&gt;= 16;
<a name="l00269"></a>00269     } <span class="keywordflow">else</span> {
<a name="l00270"></a>00270         ticks = -ticks;
<a name="l00271"></a>00271         ticks += (1ul&lt;&lt;15);
<a name="l00272"></a>00272         ticks &gt;&gt;= 16;
<a name="l00273"></a>00273         ticks = -ticks;
<a name="l00274"></a>00274     }
<a name="l00275"></a>00275     
<a name="l00276"></a>00276     <span class="keywordflow">return</span> (<a class="code" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a>)ticks;
<a name="l00277"></a>00277 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="cfd447102c06d4b657539fe1cd9f3f59"></a><!-- doxytag: member="battery_current_monitoring.c::BATTCUR_UpdateAverageCurrent" ref="cfd447102c06d4b657539fe1cd9f3f59" args="(int32_t current)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void BATTCUR_UpdateAverageCurrent           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a>&nbsp;</td>
          <td class="paramname"> <em>current</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Calculates and stores the average current during the last minut (18-bit signed). 
<p>
Assumes that the time base for the sampling is app 1 second. The average is calculated using an "exponential filter" and is an estimate for the average current. This method instead of a real average to reduce memory consumption.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>current</em>&nbsp;</td><td>The current flowing in/out of the battery pack (represented as mV accros the shunt). </td></tr>
  </table>
</dl>

<p>Definition at line <a class="el" href="battery__current__monitoring_8c-source.html#l00122">122</a> of file <a class="el" href="battery__current__monitoring_8c-source.html">battery_current_monitoring.c</a>.</p>

<p>References <a class="el" href="battery__pack__parameters_8h-source.html#l00226">AVERAGE_CURRENT_SCALING</a>, and <a class="el" href="battery__current__monitoring_8c-source.html#l00062">averageCurrent</a>.</p>

<p>Referenced by <a class="el" href="main_8c-source.html#l00904">handleNewCCADCResult()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00123"></a>00123 {
<a name="l00124"></a>00124     <span class="comment">// An exponential filter is used to</span>
<a name="l00125"></a>00125     <span class="comment">// average = 31/32 * old value + 1/32 * new value.</span>
<a name="l00126"></a>00126     <span class="comment">// But to remove the truncation error, the current is scaled up</span>
<a name="l00127"></a>00127     <a class="code" href="battery__current__monitoring_8c.html#9807215021356036591244af7f666ac6">averageCurrent</a> *= 31;
<a name="l00128"></a>00128     <a class="code" href="battery__current__monitoring_8c.html#9807215021356036591244af7f666ac6">averageCurrent</a> += current * (1&lt;&lt;<a class="code" href="battery__pack__parameters_8h.html#3f87b5b1bad8ce6f8a42292fa37cd003" title="If defined, the part is allowed to enter poweroff. Good idea to undefine during normal...">AVERAGE_CURRENT_SCALING</a>);
<a name="l00129"></a>00129     
<a name="l00130"></a>00130     <span class="comment">// Right-shifting works nice for dividing positive numbers, and oppositing if negative is</span>
<a name="l00131"></a>00131     <span class="comment">// a lot faster than doing a division</span>
<a name="l00132"></a>00132     <span class="keywordflow">if</span>(<a class="code" href="battery__current__monitoring_8c.html#9807215021356036591244af7f666ac6">averageCurrent</a> &gt; 0) {
<a name="l00133"></a>00133         <span class="comment">// Add half divisor to get proper mathematical rounding</span>
<a name="l00134"></a>00134         <a class="code" href="battery__current__monitoring_8c.html#9807215021356036591244af7f666ac6">averageCurrent</a> += 16;
<a name="l00135"></a>00135         <a class="code" href="battery__current__monitoring_8c.html#9807215021356036591244af7f666ac6">averageCurrent</a> &gt;&gt;= 5; <span class="comment">// /32</span>
<a name="l00136"></a>00136     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="battery__current__monitoring_8c.html#9807215021356036591244af7f666ac6">averageCurrent</a> &lt; 0) {
<a name="l00137"></a>00137         <a class="code" href="battery__current__monitoring_8c.html#9807215021356036591244af7f666ac6">averageCurrent</a> = -<a class="code" href="battery__current__monitoring_8c.html#9807215021356036591244af7f666ac6">averageCurrent</a>;
<a name="l00138"></a>00138         <span class="comment">// Add half divisor to get proper mathematical rounding</span>
<a name="l00139"></a>00139         <a class="code" href="battery__current__monitoring_8c.html#9807215021356036591244af7f666ac6">averageCurrent</a> += 16;
<a name="l00140"></a>00140         <a class="code" href="battery__current__monitoring_8c.html#9807215021356036591244af7f666ac6">averageCurrent</a> &gt;&gt;= 5; <span class="comment">// /32</span>
<a name="l00141"></a>00141         <a class="code" href="battery__current__monitoring_8c.html#9807215021356036591244af7f666ac6">averageCurrent</a> = -<a class="code" href="battery__current__monitoring_8c.html#9807215021356036591244af7f666ac6">averageCurrent</a>;
<a name="l00142"></a>00142     }
<a name="l00143"></a>00143 }
</pre></div>
<p>

</div>
</div><p>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="9807215021356036591244af7f666ac6"></a><!-- doxytag: member="battery_current_monitoring.c::averageCurrent" ref="9807215021356036591244af7f666ac6" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a> <a class="el" href="battery__current__monitoring_8c.html#9807215021356036591244af7f666ac6">averageCurrent</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="battery__current__monitoring_8c-source.html#l00062">62</a> of file <a class="el" href="battery__current__monitoring_8c-source.html">battery_current_monitoring.c</a>.</p>

<p>Referenced by <a class="el" href="battery__current__monitoring_8c-source.html#l00150">BATTCUR_GetAverageCurrent()</a>, <a class="el" href="battery__current__monitoring_8c-source.html#l00184">BATTCUR_InitializeAverageCurrent()</a>, and <a class="el" href="battery__current__monitoring_8c-source.html#l00122">BATTCUR_UpdateAverageCurrent()</a>.</p>

</div>
</div><p>
<a class="anchor" name="bac10e7b6c168aaa6ec71c626d549569"></a><!-- doxytag: member="battery_current_monitoring.c::CCADC2mACoefficient" ref="bac10e7b6c168aaa6ec71c626d549569" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> <a class="el" href="battery__current__monitoring_8c.html#bac10e7b6c168aaa6ec71c626d549569">CCADC2mACoefficient</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="battery__current__monitoring_8c-source.html#l00064">64</a> of file <a class="el" href="battery__current__monitoring_8c-source.html">battery_current_monitoring.c</a>.</p>

<p>Referenced by <a class="el" href="battery__current__monitoring_8c-source.html#l00224">BATTCUR_CalculateShuntCoeffient()</a>, <a class="el" href="battery__current__monitoring_8c-source.html#l00289">BATTCUR_mA2Ticks()</a>, and <a class="el" href="battery__current__monitoring_8c-source.html#l00262">BATTCUR_Ticks2mA()</a>.</p>

</div>
</div><p>
<a class="anchor" name="0331ed61d181da48bb4c5e7d3cdc26e7"></a><!-- doxytag: member="battery_current_monitoring.c::discharge" ref="0331ed61d181da48bb4c5e7d3cdc26e7" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="battery__current__monitoring_8c.html#0331ed61d181da48bb4c5e7d3cdc26e7">discharge</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="battery__current__monitoring_8c-source.html#l00061">61</a> of file <a class="el" href="battery__current__monitoring_8c-source.html">battery_current_monitoring.c</a>.</p>

<p>Referenced by <a class="el" href="battery__current__monitoring_8c-source.html#l00196">BATTCUR_IsDischargeOngoing()</a>, <a class="el" href="battery__current__monitoring_8c-source.html#l00077">BATTCUR_StoreCurrent()</a>, <a class="el" href="main_8c-source.html#l00725">handleNewCellTemperature()</a>, and <a class="el" href="main_8c-source.html#l00812">handleNewCellVoltage()</a>.</p>

</div>
</div><p>
<a class="anchor" name="7d2aa52407c70bb2a4f07abf389c1303"></a><!-- doxytag: member="battery_current_monitoring.c::lastCurrent" ref="7d2aa52407c70bb2a4f07abf389c1303" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a> <a class="el" href="battery__current__monitoring_8c.html#7d2aa52407c70bb2a4f07abf389c1303">lastCurrent</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="battery__current__monitoring_8c-source.html#l00059">59</a> of file <a class="el" href="battery__current__monitoring_8c-source.html">battery_current_monitoring.c</a>.</p>

<p>Referenced by <a class="el" href="battery__current__monitoring_8c-source.html#l00094">BATTCUR_GetCurrent()</a>, and <a class="el" href="battery__current__monitoring_8c-source.html#l00077">BATTCUR_StoreCurrent()</a>.</p>

</div>
</div><p>
<a class="anchor" name="ef4974cae3e7d0d084ea55f438b9c7d9"></a><!-- doxytag: member="battery_current_monitoring.c::lastOffsetCalibratedCurrent" ref="ef4974cae3e7d0d084ea55f438b9c7d9" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a> <a class="el" href="battery__current__monitoring_8c.html#ef4974cae3e7d0d084ea55f438b9c7d9">lastOffsetCalibratedCurrent</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="battery__current__monitoring_8c-source.html#l00060">60</a> of file <a class="el" href="battery__current__monitoring_8c-source.html">battery_current_monitoring.c</a>.</p>

<p>Referenced by <a class="el" href="battery__current__monitoring_8c-source.html#l00106">BATTCUR_GetOffsetCalibratedCurrent()</a>, and <a class="el" href="battery__current__monitoring_8c-source.html#l00077">BATTCUR_StoreCurrent()</a>.</p>

</div>
</div><p>
</div>
<html>
 <head>
  <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
  <title>@DOC_TITLE@</title>
  <link href="doxygen.css" rel="stylesheet" type="text/css">
</head>
<body>

<table width="100%" height="10%" bgcolor="#FFFFFF">
  <tr>
    <td colspan="6" height="1" background="blue.gif"></td>
  </tr>

  <tr>
    <td colspan="6">
    <address style="align: right;"><small>
Generated on Wed Aug 4 11:00:57 2010 for AVR474 Firmware User's Guide for SB202 by <a href="http://www.doxygen.org/index.html"><img src="doxygen.png" alt="doxygen" align="middle" border=0></a> 1.5.6</small></address>
    </td>
  </tr>

</table>
