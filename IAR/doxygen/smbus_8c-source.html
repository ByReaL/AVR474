<html xmlns:v="urn:schemas-microsoft-com:vml"
xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns="http://www.w3.org/TR/REC-html40">

<head>
<meta http-equiv=Content-Type content="text/html; charset=iso-8859-1">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 11">
<meta name=Originator content="Microsoft Word 11">
<link rel=File-List href="atmel-header_files/filelist.xml">
<link rel=Edit-Time-Data href="atmel-header_files/editdata.mso">
<!--[if !mso]>
<style>
v\:* {behavior:url(#default#VML);}
o\:* {behavior:url(#default#VML);}
w\:* {behavior:url(#default#VML);}
.shape {behavior:url(#default#VML);}
</style>
<![endif]-->
<title>@DOC_TITLE@</title>
<!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>ping.zhou</o:Author>
  <o:Template>Normal</o:Template>
  <o:LastAuthor>ping.zhou</o:LastAuthor>
  <o:Revision>3</o:Revision>
  <o:TotalTime>0</o:TotalTime>
  <o:Created>2010-08-04T02:58:00Z</o:Created>
  <o:LastSaved>2010-08-04T02:58:00Z</o:LastSaved>
  <o:Pages>1</o:Pages>
  <o:Words>51</o:Words>
  <o:Characters>297</o:Characters>
  <o:Company>Atmel</o:Company>
  <o:Lines>2</o:Lines>
  <o:Paragraphs>1</o:Paragraphs>
  <o:CharactersWithSpaces>347</o:CharactersWithSpaces>
  <o:Version>11.9999</o:Version>
 </o:DocumentProperties>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:Zoom>150</w:Zoom>
  <w:SpellingState>Clean</w:SpellingState>
  <w:GrammarState>Clean</w:GrammarState>
  <w:ValidateAgainstSchemas/>
  <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid>
  <w:IgnoreMixedContent>false</w:IgnoreMixedContent>
  <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText>
  <w:Compatibility>
   <w:UseFELayout/>
  </w:Compatibility>
  <w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel>
 </w:WordDocument>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:LatentStyles DefLockedState="false" LatentStyleCount="156">
 </w:LatentStyles>
</xml><![endif]-->
<link rel=Stylesheet type="text/css" media=all href="doxygen.css">
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Helvetica;
	panose-1:2 11 6 4 2 2 2 2 2 4;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:536902279 -2147483648 8 0 511 0;}
@font-face
	{font-family:SimSun;
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-alt:SimSun;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 135135232 16 0 262145 0;}
@font-face
	{font-family:SimSun;
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 135135232 16 0 262145 0;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:SimSun;}
p
	{font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:SimSun;}
span.SpellE
	{mso-style-name:"";
	mso-spl-e:yes;}
@page Section1
	{size:8.5in 11.0in;
	margin:1.0in 1.25in 1.0in 1.25in;
	mso-header-margin:.5in;
	mso-footer-margin:.5in;
	mso-paper-source:0;}
div.Section1
	{page:Section1;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
	{mso-style-name:"Table Normal";
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-parent:"";
	mso-padding-alt:0in 5.4pt 0in 5.4pt;
	mso-para-margin:0in;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-ansi-language:#0400;
	mso-fareast-language:#0400;
	mso-bidi-language:#0400;}
</style>
<![endif]--><!--[if gte mso 9]><xml>
 <o:shapedefaults v:ext="edit" spidmax="2050"/>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <o:shapelayout v:ext="edit">
  <o:idmap v:ext="edit" data="1"/>
 </o:shapelayout></xml><![endif]-->
</head>

<body lang=EN-US link=blue vlink=blue style='tab-interval:.5in'>

<div class=Section1>

<table class=MsoNormalTable border=0 cellpadding=0 width="100%"
 style='width:100.0%;mso-cellspacing:1.5pt;background:white'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes'>
  <td style='padding:.75pt .75pt .75pt .75pt'>
  <p><a href="http://www.atmel.com"><span style='text-decoration:none;
  text-underline:none'><img border=0 width=109 height=50 id="_x0000_i1025"
  src=atmel.jpg></span></a></p>
  <p class=MsoNormal><o:p>&nbsp;</o:p></p>
  </td>
  <td style='padding:.75pt .75pt .75pt .75pt'>
  <p class=MsoNormal><span class=SpellE><strong><span style='font-size:24.0pt;
  font-family:Helvetica;color:black'>SmartBattery</span></strong></span><strong><span
  style='font-size:24.0pt;font-family:Helvetica;color:black'> Device
  Application Note</span></strong></p>
  </td>
  <td style='padding:.75pt .75pt .75pt .75pt'>
  <p><a href="http://www.atmel.com/products/AVR"><span style='text-decoration:
  none;text-underline:none'><img border=0 width=138 height=77 id="_x0000_i1026"
  src="AVR_logo_blue.gif"></span></a></p>
  <p class=MsoNormal><o:p>&nbsp;</o:p></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:1;mso-yfti-lastrow:yes;height:.75pt'>
  <td colspan=3 style='padding:.75pt .75pt .75pt .75pt;height:.75pt'
  background=blue.gif>
  <p class=MsoNormal><span style='font-size:1.0pt;mso-bidi-font-size:12.0pt'><o:p>&nbsp;</o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

</div>

</body>

</html>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_29ae905079a6eb1b30b29288f24757bc.html">lib_mcu</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_c2f2e611aade4b362b2bd89f67a7ad7a.html">sm_bus</a>
  </div>
</div>
<div class="contents">
<h1>smbus.c</h1><a href="smbus_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*This file has been prepared for Doxygen automatic documentation generation.*/</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include "<a class="code" href="common_8h.html" title="Common headerfile.">common.h</a>"</span>
<a name="l00050"></a>00050 
<a name="l00051"></a><a class="code" href="smbus_8c.html#ae08ff0a047918e0245782dd183dad98">00051</a> <span class="preprocessor">#define MODULE_SMBUS        </span><span class="comment">/* ensure that we instantiate our variables in smbus.h */</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="preprocessor">#include "<a class="code" href="smbus_8h.html" title="Headerfile for smbus.c.">smbus.h</a>"</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include "SBS_commands.h"</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include "<a class="code" href="sm__bus_2interpreter_8h.html" title="SMBus Protocol command interpreter.">interpreter.h</a>"</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include "<a class="code" href="timer_8h.html" title="Headerfile for timer.c.">timer.h</a>"</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include "<a class="code" href="battery__pack__parameters_8h.html" title="Definition file for a smart battery pack.">battery_pack_parameters.h</a>"</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include "<a class="code" href="gas__gauging_8h.html" title="Gas gauging module for calculating time to empty, time to full etc.">gas_gauging.h</a>"</span>
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="comment">//---------------------------------------------------------------------</span>
<a name="l00061"></a><a class="code" href="smbus_8c.html#3d8e137fcafe4a844f4c783f5b62b2f0">00061</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="communication_8c.html#bd43f4ac549de63ca6ad46bd406ea17f">TEST50US</a> = 0;
<a name="l00062"></a><a class="code" href="smbus_8c.html#073f6663e89074a86174c10ad3b88a73">00062</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="communication_8c.html#8eb5d9128fac12df31c29313df01b1ac">SMLOCK</a>   = 0;         <span class="comment">//prevents Master bus grab attempts WHILE BUS IS IN MASTER MODE.</span>
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 <span class="comment">//uint8_t TW_MTxBuf[8];       //Master-mode TX buffer</span>
<a name="l00065"></a>00065 <span class="comment">//uint8_t TW_MTxBufCnt   = 0; //how many valid bytes are in the buffer</span>
<a name="l00066"></a>00066 <span class="comment">//uint8_t TW_MTxBufIndex = 0;</span>
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="comment">// Note for the buffers below, these must be able to contain:</span>
<a name="l00069"></a>00069 <span class="comment">// Slave Address, SMBus Command, Byte Count (if Block-mode), up to 32 bytes, plus PEC.</span>
<a name="l00070"></a><a class="code" href="smbus_8c.html#639bcaf149615285a706ea342add17d7">00070</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[36];         <span class="comment">//must be long enough for any outbound strings</span>
<a name="l00071"></a><a class="code" href="smbus_8c.html#8b0021b979a3e0d2abf84c558f0022a0">00071</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a>    = 0; <span class="comment">//how many valid bytes are in the buffer</span>
<a name="l00072"></a><a class="code" href="smbus_8c.html#eb6c852ef5c3ebe1a21b5c00de980185">00072</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a>  = 0;
<a name="l00073"></a>00073 
<a name="l00074"></a><a class="code" href="smbus_8c.html#2ba11b9846337754474c2db586742246">00074</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[36];         <span class="comment">//In Application mode (non-ISP mode), only receive WORD commands.</span>
<a name="l00075"></a><a class="code" href="smbus_8c.html#93d72a4a884264836af00f4d32ab677e">00075</a> <a class="code" href="stdint_8h.html#ef44329758059c91c76d334e8fc09700">int8_t</a> <a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a>    = 0;
<a name="l00076"></a><a class="code" href="smbus_8c.html#6fb4d146b64f434730a82e2a4f10cee0">00076</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>  = 0;
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 <span class="comment">//This byte contains flags from the TWI ISR to tell the Foreground code what to do.</span>
<a name="l00080"></a>00080 <span class="comment">//If this byte is ever non-zero, the foreground code will act on its contents.</span>
<a name="l00081"></a>00081 <span class="comment">//Although it is written by both the ISR and the Foreground code, it does not</span>
<a name="l00082"></a>00082 <span class="comment">//  need to be declared VOLATILE because the SMBus is halted until the foreground</span>
<a name="l00083"></a>00083 <span class="comment">//  code finishes processing the associated command and has cleared this flag byte.</span>
<a name="l00084"></a><a class="code" href="smbus_8c.html#5d7f64488757c7f3316d68bfdea76a6d">00084</a> <span class="keyword">volatile</span> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a>;
<a name="l00085"></a><a class="code" href="smbus_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">00085</a> <span class="preprocessor">  #define SMB_GenBusTimeout 1   </span><span class="comment">/* Tell Foreground to generate a bus timeout, as we saw an error! */</span>
<a name="l00086"></a><a class="code" href="smbus_8c.html#1fef3300524ef987fa146cc892813b20">00086</a> <span class="preprocessor">  #define SMB_SetUpReply    2   </span><span class="comment">/* Have Foreground set up TW_TxBuf[]. */</span>
<a name="l00087"></a><a class="code" href="smbus_8c.html#07b00aac11ba389d5b53e2f9d54bd0bd">00087</a> <span class="preprocessor">  #define SMB_GotCmdData    4   </span><span class="comment">/* Have Foreground interpret the complete received command. */</span>
<a name="l00088"></a>00088 
<a name="l00089"></a><a class="code" href="smbus_8c.html#c0a0963896d590350fbb796f490ebd02">00089</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="communication_8c.html#50d57ab7cb03b10099411f378522dadd">CurrentCmd</a> = 0xFF;
<a name="l00090"></a><a class="code" href="smbus_8c.html#ef8fe2dab8cfd0c7933a63418d64f462">00090</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="communication_8c.html#fd9b3e99365b45af6cf763b2dda41546">UsePEC</a> = 0; <span class="comment">//PEC usage is disabled by default.</span>
<a name="l00091"></a>00091 
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 
<a name="l00094"></a>00094 <span class="comment">/* *************************************************************************</span>
<a name="l00095"></a>00095 <span class="comment"> *</span>
<a name="l00096"></a>00096 <span class="comment"> *   SMBus Initialization routine</span>
<a name="l00097"></a>00097 <span class="comment"> *</span>
<a name="l00098"></a>00098 <span class="comment"> ************************************************************************* */</span>
<a name="l00104"></a><a class="code" href="smbus_8c.html#98a59b5ab5cde59154465aab070afa30">00104</a> <span class="keywordtype">void</span> <a class="code" href="communication_8c.html#98a59b5ab5cde59154465aab070afa30" title="Initialize TWI module.">Comm_Init</a>(<span class="keywordtype">void</span>)
<a name="l00105"></a>00105 {
<a name="l00106"></a>00106     <a class="code" href="communication_8c.html#a43740bb86658af2f20234cc35e87e1c">SMB_RestoreBus</a>();
<a name="l00107"></a>00107 }
<a name="l00108"></a>00108 
<a name="l00109"></a>00109 
<a name="l00110"></a>00110 
<a name="l00111"></a>00111 
<a name="l00112"></a>00112 <span class="comment">/* *************************************************************************</span>
<a name="l00113"></a>00113 <span class="comment"> *</span>
<a name="l00114"></a>00114 <span class="comment"> *   SMBus Wakeup Interrupt</span>
<a name="l00115"></a>00115 <span class="comment"> *</span>
<a name="l00116"></a>00116 <span class="comment"> ************************************************************************* */</span>
<a name="l00117"></a>00117 
<a name="l00118"></a>00118 
<a name="l00119"></a>00119 <span class="comment">//This wakes up a battery from sleep mode into the "On" state, per sbdat110, 4.4.2</span>
<a name="l00120"></a>00120 
<a name="l00121"></a>00121 <span class="preprocessor">#pragma vector = TWI_BUS_C_D_vect</span>
<a name="l00122"></a><a class="code" href="smbus_8c.html#6ad83522570a9dfb8df36852769b5393">00122</a> <span class="preprocessor"></span>__interrupt <span class="keywordtype">void</span> <a class="code" href="communication_8c.html#6ad83522570a9dfb8df36852769b5393">TWICD_ISR</a>(<span class="keywordtype">void</span>)
<a name="l00123"></a>00123 {
<a name="l00124"></a>00124     <span class="comment">//clear bits per sbdat110, 4.4.2</span>
<a name="l00125"></a>00125     <span class="comment">//SMBvariables[SMBV_BattMode][hibyte] &amp;= ~(0xE3);   </span>
<a name="l00126"></a>00126     
<a name="l00127"></a>00127     <span class="keywordflow">if</span>(TWBCSR &amp; (1&lt;&lt;TWBCIP))    <span class="comment">//this int was caused by bus DISCONNECT event.</span>
<a name="l00128"></a>00128     {
<a name="l00129"></a>00129         TWBCSR &amp;= ~(1&lt;&lt;TWBCIP);
<a name="l00130"></a>00130 <span class="comment">//SH        ChangePowerMode(POWERMODE_IDLE,0);</span>
<a name="l00131"></a>00131     }
<a name="l00132"></a>00132     <span class="keywordflow">else</span>    <span class="comment">//this int occurred due to a bus CONNECT event.</span>
<a name="l00133"></a>00133     {
<a name="l00134"></a>00134         TWBCSR |= (1&lt;&lt;TWBCIP);
<a name="l00135"></a>00135 <span class="comment">//SH        ChangePowerMode(POWERMODE_ACTIVE,0);</span>
<a name="l00136"></a>00136     }
<a name="l00137"></a>00137 }
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 
<a name="l00140"></a>00140 
<a name="l00141"></a>00141 
<a name="l00142"></a>00142 
<a name="l00143"></a>00143 
<a name="l00150"></a><a class="code" href="smbus_8c.html#1efd4641b8a2e2b7d2daddb0b38245a6">00150</a> <span class="keywordtype">void</span> <a class="code" href="communication_8c.html#1efd4641b8a2e2b7d2daddb0b38245a6" title="Reply to a SBS read block command.">Comm_SbsBlockCommandReply</a>( <a class="code" href="unionSBS__command__union.html">SBS_command_t</a>* <a class="code" href="main_8c.html#79cdcc825d6c642cfb1115bb757a4e82">sbsReply</a> )
<a name="l00151"></a>00151 {
<a name="l00152"></a>00152     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> temp = 0;
<a name="l00153"></a>00153     
<a name="l00154"></a>00154     temp = <a class="code" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e">SMB_PEC</a>(temp, (TWAR &amp; 0xFE));    <span class="comment">//use the SLA+W address</span>
<a name="l00155"></a>00155     temp = <a class="code" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e">SMB_PEC</a>(temp, <a class="code" href="communication_8c.html#50d57ab7cb03b10099411f378522dadd">CurrentCmd</a>);
<a name="l00156"></a>00156     temp = <a class="code" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e">SMB_PEC</a>(temp, (TWAR | 1));   <span class="comment">//use the SLA+R address</span>
<a name="l00157"></a>00157     
<a name="l00158"></a>00158     <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[0] = <a class="code" href="sbs__commands_8h.html#0b02553f29b7aca194415268255042df" title="Defines the default length of any string in the smart battery data set.">SBSDATA_BLOCK_LENGTH</a>;<span class="comment">//Block Length</span>
<a name="l00159"></a>00159     temp = <a class="code" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e">SMB_PEC</a>(temp, <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[0]);
<a name="l00160"></a>00160     
<a name="l00161"></a>00161     <a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a> = 1;
<a name="l00162"></a>00162     <a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a> = <a class="code" href="sbs__commands_8h.html#0b02553f29b7aca194415268255042df" title="Defines the default length of any string in the smart battery data set.">SBSDATA_BLOCK_LENGTH</a>+1;
<a name="l00163"></a>00163     
<a name="l00164"></a>00164     <span class="keywordflow">do</span> {
<a name="l00165"></a>00165         <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[<a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a>] = (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) sbsReply-&gt;<a class="code" href="unionSBS__command__union.html#e4854b8a4616b897278934082725e41f">payload</a>[<a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a>-1];
<a name="l00166"></a>00166         temp = <a class="code" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e">SMB_PEC</a>(temp, <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[<a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a>++]);
<a name="l00167"></a>00167     }<span class="keywordflow">while</span>(<a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a> != <a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a>);
<a name="l00168"></a>00168     
<a name="l00169"></a>00169     <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[<a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a>] = temp; <span class="comment">//append the CRC value on the end.</span>
<a name="l00170"></a>00170     <a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a>++;          <span class="comment">//increase the byte count for the PEC.</span>
<a name="l00171"></a>00171     <a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a> = 0;      <span class="comment">//Reset the buffer pointer.</span>
<a name="l00172"></a>00172     TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//have TWI continue from where it stalled.</span>
<a name="l00173"></a>00173     
<a name="l00174"></a>00174     
<a name="l00175"></a>00175 }
<a name="l00176"></a>00176 
<a name="l00181"></a><a class="code" href="smbus_8c.html#6f68436ccb337585587e7fa8ca888bda">00181</a> <span class="keywordtype">void</span> <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( <a class="code" href="unionSBS__command__union.html">SBS_command_t</a>* <a class="code" href="main_8c.html#79cdcc825d6c642cfb1115bb757a4e82">sbsReply</a> )
<a name="l00182"></a>00182 {
<a name="l00183"></a>00183     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> temp = 0;
<a name="l00184"></a>00184     
<a name="l00185"></a>00185     <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[0] = (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) sbsReply-&gt;<a class="code" href="unionSBS__command__union.html#e4854b8a4616b897278934082725e41f">payload</a>[0];
<a name="l00186"></a>00186     <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[1] = (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) sbsReply-&gt;<a class="code" href="unionSBS__command__union.html#e4854b8a4616b897278934082725e41f">payload</a>[1];;
<a name="l00187"></a>00187     
<a name="l00188"></a>00188     temp = <a class="code" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e">SMB_PEC</a>(temp, (TWAR &amp; 0xFE));    <span class="comment">//use the SLA+W address</span>
<a name="l00189"></a>00189     temp = <a class="code" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e">SMB_PEC</a>(temp, <a class="code" href="communication_8c.html#50d57ab7cb03b10099411f378522dadd">CurrentCmd</a>);
<a name="l00190"></a>00190     temp = <a class="code" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e">SMB_PEC</a>(temp, (TWAR | 1));   <span class="comment">//use the SLA+R address</span>
<a name="l00191"></a>00191 
<a name="l00192"></a>00192     <span class="comment">//Calculate PEC for Word</span>
<a name="l00193"></a>00193     temp = <a class="code" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e">SMB_PEC</a>(temp, <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[0]);
<a name="l00194"></a>00194     temp = <a class="code" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e">SMB_PEC</a>(temp, <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[1]);
<a name="l00195"></a>00195     
<a name="l00196"></a>00196     <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[2] = temp;     <span class="comment">//Append the CRC value on the end.</span>
<a name="l00197"></a>00197     <a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a> = 3;        <span class="comment">//Set the byte count for the Word + PEC.</span>
<a name="l00198"></a>00198     <a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a> = 0;      <span class="comment">//Reset the buffer pointer.</span>
<a name="l00199"></a>00199     
<a name="l00200"></a>00200     TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//have TWI continue from where it stalled.</span>
<a name="l00201"></a>00201 
<a name="l00202"></a>00202 }
<a name="l00203"></a>00203 
<a name="l00216"></a><a class="code" href="smbus_8c.html#bebcf5dbdcea576a31271721d411de4d">00216</a> <span class="keywordtype">bool</span> <a class="code" href="communication_8c.html#bebcf5dbdcea576a31271721d411de4d" title="Parse command.">Comm_Handle</a>( <a class="code" href="unionSBS__command__union.html">SBS_command_t</a>* sbsCmdDestination )
<a name="l00217"></a>00217 {
<a name="l00218"></a>00218     <span class="keywordtype">bool</span> receiveComplete = <span class="keyword">false</span>;
<a name="l00219"></a>00219     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> temp = 0;
<a name="l00220"></a>00220     
<a name="l00221"></a>00221     <span class="keywordflow">switch</span>(<a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a>)
<a name="l00222"></a>00222     {
<a name="l00223"></a>00223         <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>: <span class="comment">//The ISR detected an error condition.</span>
<a name="l00224"></a>00224         
<a name="l00225"></a>00225         <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = 0;           <span class="comment">//clear the flag that brought us here.</span>
<a name="l00226"></a>00226         sbsCmdDestination-&gt;<a class="code" href="unionSBS__command__union.html#6100200cb255940c793af26657713005">command</a> = (<a class="code" href="sbs__commands_8h.html#c0a1d53cdf5fb4745cd0dbbac35e97f2">SBS_commands_t</a>) 0xFF;         <span class="comment">//clear command register</span>
<a name="l00227"></a>00227         <span class="comment">//start the 26mS timer.  When it is done, the Timer handler will re-init the TWI peripheral.</span>
<a name="l00228"></a>00228         <a class="code" href="timer_8c.html#3ad6d4c2cd213c29e403adeff96c71d4">SetGenericTimer</a>(<a class="code" href="timer_8h.html#1e9c8bb728946234c7ca94eefed0d4c1">SMBfaultTimer</a>, 26);
<a name="l00229"></a>00229         <span class="keywordflow">break</span>;
<a name="l00230"></a>00230         
<a name="l00231"></a>00231         <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#1fef3300524ef987fa146cc892813b20">SMB_SetUpReply</a>:       <span class="comment">//interpret a 'Read' Command.</span>
<a name="l00232"></a>00232         <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = 0;           <span class="comment">//clear the flag that brought us here.</span>
<a name="l00233"></a>00233         <a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a> = 0;          <span class="comment">//initialize</span>
<a name="l00234"></a>00234         <a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a> = 0;            <span class="comment">//initialize</span>
<a name="l00235"></a>00235         sbsCmdDestination-&gt;<a class="code" href="unionSBS__command__union.html#6100200cb255940c793af26657713005">command</a> = (<a class="code" href="sbs__commands_8h.html#c0a1d53cdf5fb4745cd0dbbac35e97f2">SBS_commands_t</a>) (<a class="code" href="communication_8c.html#50d57ab7cb03b10099411f378522dadd">CurrentCmd</a> | <a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a>);
<a name="l00236"></a>00236         receiveComplete = <span class="keyword">true</span>;
<a name="l00237"></a>00237         <span class="keywordflow">break</span>;
<a name="l00238"></a>00238         
<a name="l00239"></a>00239         <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#07b00aac11ba389d5b53e2f9d54bd0bd">SMB_GotCmdData</a>:    <span class="comment">//process some received command+data.</span>
<a name="l00240"></a>00240         <span class="comment">//NOTE: as of 6/17/2005, TWI_CmdFlags should NOT be cleared until we are</span>
<a name="l00241"></a>00241         <span class="comment">// completely done processing this message, else the TWI ISR will overwrite</span>
<a name="l00242"></a>00242         <span class="comment">// the RX buffer and won't respond with BUSY as it should.  Note also that</span>
<a name="l00243"></a>00243         <span class="comment">// the TWI is fully re-enabled when entering here, so we MUST NOT write</span>
<a name="l00244"></a>00244         <span class="comment">// to any of the TWI h/w registers or we could create havoc.  -rgf</span>
<a name="l00245"></a>00245         <span class="keywordflow">if</span>(<a class="code" href="communication_8c.html#fd9b3e99365b45af6cf763b2dda41546">UsePEC</a>)              <span class="comment">//check the CRC of the received packet.</span>
<a name="l00246"></a>00246         {
<a name="l00247"></a>00247             temp = 0;               <span class="comment">//use this as our CRC value.</span>
<a name="l00248"></a>00248             
<a name="l00249"></a>00249             <span class="keywordflow">do</span>{
<a name="l00250"></a>00250                 temp = <a class="code" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e">SMB_PEC</a>(temp, <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[<a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>++]);
<a name="l00251"></a>00251             }<span class="keywordflow">while</span>(<a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> != <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>);
<a name="l00252"></a>00252             
<a name="l00253"></a>00253             <span class="keywordflow">if</span>(temp)    <span class="comment">//The result of a CRC check SHOULD be =0 if all was ok.</span>
<a name="l00254"></a>00254             {
<a name="l00255"></a>00255                 <span class="comment">//start the 26mS timer to generate a bus timeout error.</span>
<a name="l00256"></a>00256                 <a class="code" href="timer_8c.html#3ad6d4c2cd213c29e403adeff96c71d4">SetGenericTimer</a>(<a class="code" href="timer_8h.html#1e9c8bb728946234c7ca94eefed0d4c1">SMBfaultTimer</a>, 26);
<a name="l00257"></a>00257                 receiveComplete = <span class="keyword">false</span>;
<a name="l00258"></a>00258                 <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = 0;           <span class="comment">//clear the flag that brought us here.</span>
<a name="l00259"></a>00259                 <span class="keywordflow">break</span>;
<a name="l00260"></a>00260             }
<a name="l00261"></a>00261         }
<a name="l00262"></a>00262         
<a name="l00263"></a>00263         <span class="comment">//If more bytes than a word, a block has been received and omit length byte</span>
<a name="l00264"></a>00264         <span class="comment">// Addr + Cmd + DataWord = 4 bytes</span>
<a name="l00265"></a>00265         <span class="keywordflow">if</span>(<a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> &gt; 4){
<a name="l00266"></a>00266             <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a> = 3;      <span class="comment">//Start of data in block</span>
<a name="l00267"></a>00267         }<span class="keywordflow">else</span>{
<a name="l00268"></a>00268             <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a> = 2;      <span class="comment">//Start of data in word</span>
<a name="l00269"></a>00269         }
<a name="l00270"></a>00270         
<a name="l00271"></a>00271         temp = 0;
<a name="l00272"></a>00272         
<a name="l00273"></a>00273         <span class="keywordflow">do</span>{
<a name="l00274"></a>00274             sbsCmdDestination-&gt;<a class="code" href="unionSBS__command__union.html#e4854b8a4616b897278934082725e41f">payload</a>[temp++] = <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[<a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>++];
<a name="l00275"></a>00275         }<span class="keywordflow">while</span>(<a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> != <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>);
<a name="l00276"></a>00276         
<a name="l00277"></a>00277         sbsCmdDestination-&gt;<a class="code" href="unionSBS__command__union.html#6100200cb255940c793af26657713005">command</a> = (<a class="code" href="sbs__commands_8h.html#c0a1d53cdf5fb4745cd0dbbac35e97f2">SBS_commands_t</a>) (<a class="code" href="communication_8c.html#50d57ab7cb03b10099411f378522dadd">CurrentCmd</a> | <a class="code" href="communication_8h.html#d5500c9b9dd285eaa77e28413d7258df">SBS_WRITE</a>);
<a name="l00278"></a>00278         receiveComplete = <span class="keyword">true</span>;
<a name="l00279"></a>00279 
<a name="l00280"></a>00280         <span class="comment">//At this point it looks like everything went OK.</span>
<a name="l00281"></a>00281         <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a> = 0;      <span class="comment">//Wipe out anything in the buffer, just in case.</span>
<a name="l00282"></a>00282         <a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> = 0;            
<a name="l00283"></a>00283         <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = 0;           <span class="comment">//clear the flag that brought us here.</span>
<a name="l00284"></a>00284         <span class="keywordflow">break</span>;
<a name="l00285"></a>00285         <span class="keywordflow">default</span>:
<a name="l00286"></a>00286         receiveComplete = <span class="keyword">false</span>;
<a name="l00287"></a>00287     }
<a name="l00288"></a>00288     
<a name="l00289"></a>00289     <span class="keywordflow">return</span> receiveComplete;
<a name="l00290"></a>00290 }
<a name="l00291"></a>00291 
<a name="l00292"></a>00292 <span class="comment">//TWI Interrupt Service Routine</span>
<a name="l00293"></a>00293 <span class="comment">//  This ISR contains a state machine for handling the low-level bus communications.</span>
<a name="l00294"></a>00294 <span class="comment">//  It uses the variable TWI_CmdFlags to communicate the need for message processing</span>
<a name="l00295"></a>00295 <span class="comment">//    to the foreground-based command interpreter.  Whenever it passes control off</span>
<a name="l00296"></a>00296 <span class="comment">//    to the foreground routine, the SMBus is halted.</span>
<a name="l00297"></a>00297 
<a name="l00298"></a>00298 <span class="comment">/* Changes to the operation of the SMBus State Machine as of 6/17/2005 (rgf):</span>
<a name="l00299"></a>00299 <span class="comment"></span>
<a name="l00300"></a>00300 <span class="comment">   Since there can be multiple Masters on the bus addressing a Smart Battery,</span>
<a name="l00301"></a>00301 <span class="comment">   namely either a Host or a Charger, it is entirely possible that one Master</span>
<a name="l00302"></a>00302 <span class="comment">   may support PEC while the other does not.  For maximum reliability, we must</span>
<a name="l00303"></a>00303 <span class="comment">   be able to support the reception of PEC on-the-fly regardless of whether it</span>
<a name="l00304"></a>00304 <span class="comment">   was used in the past or not.</span>
<a name="l00305"></a>00305 <span class="comment"></span>
<a name="l00306"></a>00306 <span class="comment">   To do so, we determine an expected byte count WITHOUT PEC.  While receiving,</span>
<a name="l00307"></a>00307 <span class="comment">   we decrement this counter and store received bytes until either (a) the counter</span>
<a name="l00308"></a>00308 <span class="comment">   drops below a value of (-1), or (b) we receive a STOP.  If we receive a STOP</span>
<a name="l00309"></a>00309 <span class="comment">   and the counter is not either 0 or -1, this is an error and is flagged as such.</span>
<a name="l00310"></a>00310 <span class="comment">   (Note that AFTER receiving a STOP, it is not possible to flag an error to the</span>
<a name="l00311"></a>00311 <span class="comment">   Host or Charger except through the Battery Status flags.)  If the counter is</span>
<a name="l00312"></a>00312 <span class="comment">   zero, this indicates that PEC is disabled.  If the counter is -1, this indicates</span>
<a name="l00313"></a>00313 <span class="comment">   that PEC is enabled.  The message will be processed with this knowledge.</span>
<a name="l00314"></a>00314 <span class="comment"></span>
<a name="l00315"></a>00315 <span class="comment">   However, since the SCL line is not being held low due to TWINT being left asserted,</span>
<a name="l00316"></a>00316 <span class="comment">   a different mechanism is needed to hold off incoming messages to the battery</span>
<a name="l00317"></a>00317 <span class="comment">   until the previous message has been processed.  This is done by turning off</span>
<a name="l00318"></a>00318 <span class="comment">   the generation of ACK on any subsequent bytes and/or messages until the foreground</span>
<a name="l00319"></a>00319 <span class="comment">   code has finished processing the prior message.</span>
<a name="l00320"></a>00320 <span class="comment"></span>
<a name="l00321"></a>00321 <span class="comment">   It is crucial therefore that the foreground code does not change the</span>
<a name="l00322"></a>00322 <span class="comment">   value of the TWI_CmdFlags variable from being equal to 'SMB_GotCmdData'</span>
<a name="l00323"></a>00323 <span class="comment">   until after it is completely done with processing of the prior message.</span>
<a name="l00324"></a>00324 <span class="comment"></span>
<a name="l00325"></a>00325 <span class="comment">   This mechanism also is valid if a Master attempts to perform a Master Read</span>
<a name="l00326"></a>00326 <span class="comment">   while the battery is busy.  In this case, the second byte from the Master,</span>
<a name="l00327"></a>00327 <span class="comment">   specifically the SMBus Command byte, will not be acknowledged.  The Master</span>
<a name="l00328"></a>00328 <span class="comment">   is thereby required to generate a STOP condition.</span>
<a name="l00329"></a>00329 <span class="comment"></span>
<a name="l00330"></a>00330 <span class="comment">*/</span>
<a name="l00331"></a>00331 
<a name="l00332"></a>00332 <span class="comment">//State Machine states</span>
<a name="l00333"></a><a class="code" href="smbus_8c.html#bed82baf7f470b522273a3e37c24c600ce05baed30278f132f7d9d27a502e7a0">00333</a> <span class="keyword">enum</span> <span class="comment">/*TWISR_State*/</span> {<a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>=0, <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5ce05baed30278f132f7d9d27a502e7a0">TW_Wait4Stop</a>, <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b594d13a4b6be6ef4404b13908d933e1ad">TW_Wait4Cmd</a>, <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5bc8bda251da4d6aae1c2bfb2900c1444">TW_Wait4RW</a>, <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5e4714c204fd9c4052ca3208a63493baa">TW_Wait4Data</a>, <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b583d27cae0915c8a8002877623dcb0dc9">TW_ReplyData</a> };
<a name="l00334"></a>00334 
<a name="l00335"></a><a class="code" href="smbus_8c.html#988a0e4620a54c9475e880542c2c2df6">00335</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;  <span class="comment">//state variable</span>
<a name="l00336"></a>00336 
<a name="l00337"></a>00337 
<a name="l00338"></a>00338 <span class="preprocessor">#pragma vector = TWI_vect</span>
<a name="l00339"></a><a class="code" href="smbus_8c.html#1f03d433517342e03440452013989dc4">00339</a> <span class="preprocessor"></span>__interrupt <span class="keywordtype">void</span> <a class="code" href="communication_8c.html#1f03d433517342e03440452013989dc4">TWI_ISR</a>(<span class="keywordtype">void</span>)
<a name="l00340"></a>00340 {
<a name="l00341"></a>00341     <span class="comment">//Command-related feature flags</span>
<a name="l00342"></a>00342     <span class="keyword">static</span> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> TWISR_CmdFeatures = 0;
<a name="l00343"></a>00343     
<a name="l00344"></a>00344     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> Status;
<a name="l00345"></a>00345     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> tmp;
<a name="l00346"></a>00346     
<a name="l00347"></a>00347     <span class="comment">//This identifies what caused the interrupt to fire.</span>
<a name="l00348"></a>00348     Status = TWSR &amp; 0xF8;
<a name="l00349"></a>00349     
<a name="l00350"></a>00350     <span class="keywordflow">switch</span>(<a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a>){
<a name="l00351"></a>00351         <span class="keywordflow">default</span>:
<a name="l00352"></a>00352 
<a name="l00353"></a>00353         <span class="comment">//If not SLA_W or RSTOP, is an error!</span>
<a name="l00354"></a>00354         <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>:
<a name="l00355"></a>00355         
<a name="l00356"></a>00356         <span class="comment">// Saw Slave address match with a Write bit</span>
<a name="l00357"></a>00357         <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#13ec926035138d61a7e90193645942ee">TWS_SLA_W</a> == Status)
<a name="l00358"></a>00358         {
<a name="l00359"></a>00359             <span class="keywordflow">if</span>(<a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> == <a class="code" href="communication_8c.html#07b00aac11ba389d5b53e2f9d54bd0bd">SMB_GotCmdData</a>)
<a name="l00360"></a>00360             {
<a name="l00361"></a>00361                 <a class="code" href="timer_8c.html#3ad6d4c2cd213c29e403adeff96c71d4">SetGenericTimer</a>(<a class="code" href="timer_8h.html#1e9c8bb728946234c7ca94eefed0d4c1">SMBfaultTimer</a>, 26);
<a name="l00362"></a>00362                 
<a name="l00363"></a>00363                 <span class="comment">//Assert that we're 'busy' to SMBus Master by leaving TWEA *off* until we get a STOP.</span>
<a name="l00364"></a>00364                 <span class="comment">//Note that this is 'legal' because we have ALREADY sent an ACK to our Slave Address,</span>
<a name="l00365"></a>00365                 <span class="comment">// as is required by the SMBus specification.</span>
<a name="l00366"></a>00366                 
<a name="l00367"></a>00367                 <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5ce05baed30278f132f7d9d27a502e7a0">TW_Wait4Stop</a>;
<a name="l00368"></a>00368                 TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//must NOT re-enable ACKing!</span>
<a name="l00369"></a>00369                 <span class="keywordflow">break</span>;
<a name="l00370"></a>00370             }
<a name="l00371"></a>00371             
<a name="l00372"></a>00372             <span class="comment">// Still waiting for command data.</span>
<a name="l00373"></a>00373             <span class="keywordflow">else</span>
<a name="l00374"></a>00374             {
<a name="l00375"></a>00375                 <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b594d13a4b6be6ef4404b13908d933e1ad">TW_Wait4Cmd</a>;
<a name="l00376"></a>00376             }
<a name="l00377"></a>00377         }
<a name="l00378"></a>00378         <span class="comment">//Saw a Stop, possibly left over from previous cmd.</span>
<a name="l00379"></a>00379         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#ea29a640c276fdaea02372a2c1ac5f78">TWS_RSTOP</a> == Status)
<a name="l00380"></a>00380         {
<a name="l00381"></a>00381             <span class="comment">//Everything is probably OK.  Take no action.</span>
<a name="l00382"></a>00382         }
<a name="l00383"></a>00383         
<a name="l00384"></a>00384         <span class="comment">// Had some type of error!</span>
<a name="l00385"></a>00385         <span class="keywordflow">else</span>
<a name="l00386"></a>00386         {
<a name="l00387"></a>00387             <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;  <span class="comment">//Generate a bus timeout.</span>
<a name="l00388"></a>00388             TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);      <span class="comment">//Disable int, and DON'T clear the TWINT flag!</span>
<a name="l00389"></a>00389             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;             <span class="comment">//Reset the state machine.</span>
<a name="l00390"></a>00390             <span class="keywordflow">break</span>;
<a name="l00391"></a>00391         }
<a name="l00392"></a>00392         TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//must re-enable ACKing</span>
<a name="l00393"></a>00393         <span class="keywordflow">break</span>;
<a name="l00394"></a>00394         
<a name="l00395"></a>00395 
<a name="l00396"></a>00396         <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5ce05baed30278f132f7d9d27a502e7a0">TW_Wait4Stop</a>:
<a name="l00397"></a>00397         <span class="comment">//Saw a Stop, possibly left over from previous cmd.</span>
<a name="l00398"></a>00398         <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#ea29a640c276fdaea02372a2c1ac5f78">TWS_RSTOP</a> == Status)
<a name="l00399"></a>00399         {
<a name="l00400"></a>00400             TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//must re-enable ACKing</span>
<a name="l00401"></a>00401             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;          <span class="comment">//Reset the state machine.</span>
<a name="l00402"></a>00402         }
<a name="l00403"></a>00403         <span class="comment">//Error! Did not see a stop as expected. NACKing the rest.</span>
<a name="l00404"></a>00404         <span class="keywordflow">else</span>
<a name="l00405"></a>00405         {
<a name="l00406"></a>00406             TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//must NOT re-enable ACKing yet!</span>
<a name="l00407"></a>00407         }
<a name="l00408"></a>00408         <span class="keywordflow">break</span>;
<a name="l00409"></a>00409         
<a name="l00410"></a>00410         
<a name="l00411"></a>00411         <span class="comment">//SLAVE-mode states follow.</span>
<a name="l00412"></a>00412         
<a name="l00413"></a>00413         <span class="comment">// Upon entry, we expect to have received a Cmd byte.</span>
<a name="l00414"></a>00414         <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b594d13a4b6be6ef4404b13908d933e1ad">TW_Wait4Cmd</a>:
<a name="l00415"></a>00415 
<a name="l00416"></a>00416         <span class="comment">//It appears that we have received a Command byte now.</span>
<a name="l00417"></a>00417         <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#494d83524c0a35a9680f8abf43538088">TWS_RCMD</a> == Status)
<a name="l00418"></a>00418         {
<a name="l00419"></a>00419             tmp = TWDR;
<a name="l00420"></a>00420             
<a name="l00421"></a>00421             <span class="comment">//Is the Cmd within valid range?</span>
<a name="l00422"></a>00422             <span class="keywordflow">if</span>(tmp &lt;= <a class="code" href="SMBSlave_8h.html#335910998ef911de0e71a0c1b059e565">HIGHEST_SMB_CMD</a>)
<a name="l00423"></a>00423             {
<a name="l00424"></a>00424                 <a class="code" href="communication_8c.html#50d57ab7cb03b10099411f378522dadd">CurrentCmd</a> = tmp;       <span class="comment">//Save a copy.</span>
<a name="l00425"></a>00425                 tmp = <a class="code" href="communication_2interpreter_8h.html#98f76d05b9eb74053793b1fc1835b663">SM_Cmd_Table</a>[tmp][0]; <span class="comment">//Grab the Command Characteristics/Features flags.</span>
<a name="l00426"></a>00426                 <span class="keywordflow">if</span>(tmp &amp; <a class="code" href="communication_2interpreter_8h.html#3ffa90cb904c7f395662aa7573e79b4f">SMBslave</a>)      <span class="comment">//Is the Command valid for Slaves?</span>
<a name="l00427"></a>00427                 {               <span class="comment">//The command appears to be valid.</span>
<a name="l00428"></a>00428                     TWISR_CmdFeatures = tmp;    <span class="comment">//Save the Feature flags for use in Wait4RW state.</span>
<a name="l00429"></a>00429                     <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5bc8bda251da4d6aae1c2bfb2900c1444">TW_Wait4RW</a>;   <span class="comment">//set up next state</span>
<a name="l00430"></a>00430                     TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//enable ACKing</span>
<a name="l00431"></a>00431                     <span class="keywordflow">break</span>;
<a name="l00432"></a>00432                 }
<a name="l00433"></a>00433             }
<a name="l00434"></a>00434         }
<a name="l00435"></a>00435         <span class="comment">//In all cases except those that 'break' (above), it's an error.</span>
<a name="l00436"></a>00436         <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;  <span class="comment">//Generate a bus timeout.</span>
<a name="l00437"></a>00437         TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);      <span class="comment">//Disable int, and DON'T clear the TWINT flag!</span>
<a name="l00438"></a>00438         <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;             <span class="comment">//Reset the state machine.</span>
<a name="l00439"></a>00439         <span class="keywordflow">break</span>;
<a name="l00440"></a>00440         
<a name="l00441"></a>00441         <span class="comment">//We will now find out if we will RX more, or we need to TX a reply instead.</span>
<a name="l00442"></a>00442         <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5bc8bda251da4d6aae1c2bfb2900c1444">TW_Wait4RW</a>:
<a name="l00443"></a>00443         
<a name="l00444"></a>00444         <span class="comment">//It is a WRITE-type command. Prep the RX buffer to accept more data.</span>
<a name="l00445"></a>00445         <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#be4452976a52cc5e091f32ead12669ce">TWS_RDATA</a> == Status)
<a name="l00446"></a>00446         {
<a name="l00447"></a>00447             <span class="comment">//NOTE: except for OptionalMfgFunction5, all WRITE cmds are 2-byte, plus optional PEC.</span>
<a name="l00448"></a>00448             <span class="comment">//Place all bytes of the transaction into the buffer so we can do a PEC on it if needed.</span>
<a name="l00449"></a>00449             
<a name="l00450"></a>00450             <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[0] = TWAR &amp; 0xFE;  <span class="comment">//store everything incl. the slave address for computing PEC.</span>
<a name="l00451"></a>00451             <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[1] = <a class="code" href="communication_8c.html#50d57ab7cb03b10099411f378522dadd">CurrentCmd</a>;   <span class="comment">//store the previously-send Command.</span>
<a name="l00452"></a>00452             <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[2] = TWDR;     <span class="comment">//store this first DATA byte</span>
<a name="l00453"></a>00453             <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a> = 3;      <span class="comment">//use RxBufIndex as the index to store data in the buffer.</span>
<a name="l00454"></a>00454             
<a name="l00455"></a>00455             <span class="comment">//Is it a Write-WORD command type?</span>
<a name="l00456"></a>00456             <span class="keywordflow">if</span>(TWISR_CmdFeatures &amp; <a class="code" href="communication_2interpreter_8h.html#1200a2673b359fcd7568b69b684cc625">SCWW</a>)
<a name="l00457"></a>00457             {
<a name="l00458"></a>00458                 <a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> = 1;        <span class="comment">//We expect 1 more data byte, and possibly PEC after that.</span>
<a name="l00459"></a>00459             }
<a name="l00460"></a>00460             
<a name="l00461"></a>00461             <span class="comment">//Is it a write-BLOCK command (must be OptionalMfgFunction5 then)</span>
<a name="l00462"></a>00462             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(TWISR_CmdFeatures &amp; <a class="code" href="communication_2interpreter_8h.html#fb396475fb3fa7a935530e516e420c76">SCWG</a>)
<a name="l00463"></a>00463             {
<a name="l00464"></a>00464                 tmp = TWDR;
<a name="l00465"></a>00465                 <span class="keywordflow">if</span>((tmp &gt;= 1) &amp;&amp; (tmp &lt;= 32))
<a name="l00466"></a>00466                     <a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> = TWDR;
<a name="l00467"></a>00467                 <span class="keywordflow">else</span>
<a name="l00468"></a>00468                 {
<a name="l00469"></a>00469                     <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;  <span class="comment">//Generate a bus timeout.</span>
<a name="l00470"></a>00470                     TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);      <span class="comment">//Disable int, and DON'T clear the TWINT flag!</span>
<a name="l00471"></a>00471                     <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;             <span class="comment">//Reset the state machine.</span>
<a name="l00472"></a>00472                     <span class="keywordflow">break</span>;
<a name="l00473"></a>00473                 }
<a name="l00474"></a>00474             }
<a name="l00475"></a>00475 
<a name="l00476"></a>00476             <span class="comment">//Error! This Command doesn't allow EITHER word OR group/block Writes! It's Read-only!</span>
<a name="l00477"></a>00477             <span class="keywordflow">else</span>
<a name="l00478"></a>00478             {
<a name="l00479"></a>00479                 <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;  <span class="comment">//Generate a bus timeout.</span>
<a name="l00480"></a>00480                 TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);      <span class="comment">//Disable int, and DON'T clear the TWINT flag!</span>
<a name="l00481"></a>00481                 <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;             <span class="comment">//Reset the state machine.</span>
<a name="l00482"></a>00482                 <span class="keywordflow">break</span>;
<a name="l00483"></a>00483             }
<a name="l00484"></a>00484             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5e4714c204fd9c4052ca3208a63493baa">TW_Wait4Data</a>;
<a name="l00485"></a>00485             TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//enable ACKing</span>
<a name="l00486"></a>00486         }
<a name="l00487"></a>00487         
<a name="l00488"></a>00488         <span class="comment">//We saw a re-Start, so must be getting ready for a Read cmd.</span>
<a name="l00489"></a>00489         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#6ab2d53631ce164e3cd5fb1d1d1658ab">TWS_REPEAT</a> == Status)
<a name="l00490"></a>00490         {   
<a name="l00491"></a>00491             <span class="comment">//Must now interpret previously-sent CurrentCmd &amp; set up Reply data.</span>
<a name="l00492"></a>00492             
<a name="l00493"></a>00493             <span class="comment">//Is it a 'ReadWord' or 'ReadGroup' command type?</span>
<a name="l00494"></a>00494             <span class="keywordflow">if</span>(TWISR_CmdFeatures &amp; (<a class="code" href="communication_2interpreter_8h.html#a85af9d88231ee9fe08e31e03ba2d11b">SCRW</a> | <a class="code" href="communication_2interpreter_8h.html#f5e6b90ad1abedbf1c8b369dca830d8a">SCRG</a>))
<a name="l00495"></a>00495             {
<a name="l00496"></a>00496                 <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#1fef3300524ef987fa146cc892813b20">SMB_SetUpReply</a>;    <span class="comment">//Foreground decoder will set up TWCR.</span>
<a name="l00497"></a>00497                 <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b583d27cae0915c8a8002877623dcb0dc9">TW_ReplyData</a>;       <span class="comment">//Move to next state.</span>
<a name="l00498"></a>00498             }
<a name="l00499"></a>00499 
<a name="l00500"></a>00500             <span class="comment">//Error! Not a valid read command.</span>
<a name="l00501"></a>00501             <span class="keywordflow">else</span>
<a name="l00502"></a>00502             {
<a name="l00503"></a>00503                 <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;  <span class="comment">//Generate a bus timeout.</span>
<a name="l00504"></a>00504                 TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);      <span class="comment">//Disable int, and DON'T clear the TWINT flag!</span>
<a name="l00505"></a>00505                 <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;             <span class="comment">//Reset the state machine.</span>
<a name="l00506"></a>00506                 <span class="keywordflow">break</span>;
<a name="l00507"></a>00507             }
<a name="l00508"></a>00508             TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);         <span class="comment">//disable int, and DON'T clear the TWINT flag!</span>
<a name="l00509"></a>00509         }
<a name="l00510"></a>00510         
<a name="l00511"></a>00511         <span class="comment">// Some type of error!</span>
<a name="l00512"></a>00512         <span class="keywordflow">else</span>
<a name="l00513"></a>00513         {
<a name="l00514"></a>00514             <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;  <span class="comment">//Generate a bus timeout.</span>
<a name="l00515"></a>00515             TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);      <span class="comment">//Disable int, and DON'T clear the TWINT flag!</span>
<a name="l00516"></a>00516             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;             <span class="comment">//Reset the state machine.</span>
<a name="l00517"></a>00517             <span class="keywordflow">break</span>;
<a name="l00518"></a>00518         }
<a name="l00519"></a>00519         <span class="keywordflow">break</span>;
<a name="l00520"></a>00520         
<a name="l00521"></a>00521         
<a name="l00522"></a>00522         <span class="comment">//We are in Slave Receive operating mode.</span>
<a name="l00523"></a>00523         <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5e4714c204fd9c4052ca3208a63493baa">TW_Wait4Data</a>:
<a name="l00524"></a>00524 
<a name="l00525"></a>00525         <span class="comment">// Received a data byte.</span>
<a name="l00526"></a>00526         <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#be4452976a52cc5e091f32ead12669ce">TWS_RDATA</a> == Status) 
<a name="l00527"></a>00527         {
<a name="l00528"></a>00528             tmp = TWDR;
<a name="l00529"></a>00529             
<a name="l00530"></a>00530             <span class="comment">//Are we past the PEC byte and still getting more data?</span>
<a name="l00531"></a>00531             <span class="keywordflow">if</span>(--<a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> &lt; -1)
<a name="l00532"></a>00532             {
<a name="l00533"></a>00533                 <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;  <span class="comment">//Generate a bus timeout.</span>
<a name="l00534"></a>00534                 TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);      <span class="comment">//Disable int, and DON'T clear the TWINT flag!</span>
<a name="l00535"></a>00535                 <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;             <span class="comment">//Reset the state machine.</span>
<a name="l00536"></a>00536                 <span class="keywordflow">break</span>;
<a name="l00537"></a>00537             }
<a name="l00538"></a>00538             <span class="comment">//Store the byte in the buffer.</span>
<a name="l00539"></a>00539             <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[<a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>++] = tmp;
<a name="l00540"></a>00540         }
<a name="l00541"></a>00541     
<a name="l00542"></a>00542         <span class="comment">//Got a STOP; All done RXing data now.</span>
<a name="l00543"></a>00543         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#ea29a640c276fdaea02372a2c1ac5f78">TWS_RSTOP</a> == Status)
<a name="l00544"></a>00544         {
<a name="l00545"></a>00545             <span class="comment">//Note: If we get a STOP prematurely, then we simply ignore the command,</span>
<a name="l00546"></a>00546             <span class="comment">//since it is too late to inform the Master of the error.</span>
<a name="l00547"></a>00547             <span class="keywordflow">if</span>((<a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> &gt; 0) || (<a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> &lt; -1))
<a name="l00548"></a>00548             {
<a name="l00549"></a>00549                 <span class="comment">// We got a premature STOP or too much data; ERROR!</span>
<a name="l00550"></a>00550                 <span class="comment">// Error handling if needed.</span>
<a name="l00551"></a>00551             }
<a name="l00552"></a>00552             <span class="keywordflow">else</span>
<a name="l00553"></a>00553             {
<a name="l00554"></a>00554                 <span class="keywordflow">if</span>(0 == <a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a>){
<a name="l00555"></a>00555                     <a class="code" href="communication_8c.html#fd9b3e99365b45af6cf763b2dda41546">UsePEC</a> = 0;            <span class="comment">//there is no PEC coming for this packet.</span>
<a name="l00556"></a>00556                 }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(-1 == <a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a>){
<a name="l00557"></a>00557                     <a class="code" href="communication_8c.html#fd9b3e99365b45af6cf763b2dda41546">UsePEC</a> = 1;            <span class="comment">//PEC was included.</span>
<a name="l00558"></a>00558                 }
<a name="l00559"></a>00559                 
<a name="l00560"></a>00560                 <a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> = <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>;      <span class="comment">//re-use the Write Index's value as the Valid Byte Count.</span>
<a name="l00561"></a>00561                 <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a> = 0;                <span class="comment">//clear the index in preparation for interpreting it.</span>
<a name="l00562"></a>00562                 <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#07b00aac11ba389d5b53e2f9d54bd0bd">SMB_GotCmdData</a>;    <span class="comment">//tell Foreground to process this now.</span>
<a name="l00563"></a>00563                 <span class="comment">//Note that when (TWI_CmdFlags == SMB_GotCmdData), TWI ISR will respond with BUSY condition.</span>
<a name="l00564"></a>00564             }
<a name="l00565"></a>00565             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;      <span class="comment">//Reset the state machine in all cases.</span>
<a name="l00566"></a>00566         }
<a name="l00567"></a>00567 
<a name="l00568"></a>00568         <span class="comment">//Some type of error during transmission!</span>
<a name="l00569"></a>00569         <span class="keywordflow">else</span>
<a name="l00570"></a>00570         {
<a name="l00571"></a>00571             <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;  <span class="comment">//Generate a bus timeout.</span>
<a name="l00572"></a>00572             TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);      <span class="comment">//Disable int, and DON'T clear the TWINT flag!</span>
<a name="l00573"></a>00573             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;             <span class="comment">//Reset the state machine.</span>
<a name="l00574"></a>00574             <span class="keywordflow">break</span>;
<a name="l00575"></a>00575         }
<a name="l00576"></a>00576         
<a name="l00577"></a>00577         TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//enable ACKing</span>
<a name="l00578"></a>00578         <span class="keywordflow">break</span>;
<a name="l00579"></a>00579         
<a name="l00580"></a>00580 
<a name="l00581"></a>00581         <span class="comment">// We are now in Slave Transmit operating mode.</span>
<a name="l00582"></a>00582         <span class="comment">// The foreground code has set up the response that we are now sending.</span>
<a name="l00583"></a>00583         <span class="comment">// Note: TW_TxBufCnt *always* includes the PEC byte! Since we don't</span>
<a name="l00584"></a>00584         <span class="comment">// know whether the Master actually WANTS the PEC byte or not, we will</span>
<a name="l00585"></a>00585         <span class="comment">// always TRY to send it, regardless of the state of the UsePEC flag.</span>
<a name="l00586"></a>00586         <span class="comment">// If the Master does NOT want it, we will get a NAK while the PEC</span>
<a name="l00587"></a>00587         <span class="comment">// byte is still in the buffer.  In the rare case where we send it all,</span>
<a name="l00588"></a>00588         <span class="comment">// including the PEC byte, but we still get an ACK back, the TWI module</span>
<a name="l00589"></a>00589         <span class="comment">// will be off-line anyway due to not setting the TWEA bit after sending PEC,</span>
<a name="l00590"></a>00590         <span class="comment">// and we will therefore be unable to flag that an error has occurred.</span>
<a name="l00591"></a>00591         <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b583d27cae0915c8a8002877623dcb0dc9">TW_ReplyData</a>:
<a name="l00592"></a>00592         
<a name="l00593"></a>00593         <span class="comment">//Send out Reply data</span>
<a name="l00594"></a>00594         <span class="keywordflow">if</span>((<a class="code" href="SMBSlave_8h.html#56a6f2a019fcb0f004ad6a8619fd9b3f">TWS_SLA_R</a> == Status) || (<a class="code" href="SMBSlave_8h.html#69333e59f4e48bd3130a871152cc17ae">TWS_RACK</a> == Status))
<a name="l00595"></a>00595         {
<a name="l00596"></a>00596             <span class="comment">//Get data next byte from buffer and send data out.</span>
<a name="l00597"></a>00597             TWDR = <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[<a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a>++];
<a name="l00598"></a>00598             
<a name="l00599"></a>00599             <span class="comment">//Have we emptied the buffer, incl. PEC?</span>
<a name="l00600"></a>00600             <span class="keywordflow">if</span>(--<a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a> == 0)
<a name="l00601"></a>00601             {   <span class="comment">// Yes, so don't set TWEA.</span>
<a name="l00602"></a>00602                 TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);
<a name="l00603"></a>00603             }
<a name="l00604"></a>00604             <span class="keywordflow">else</span>
<a name="l00605"></a>00605             {   <span class="comment">// No, so assert TWEA.</span>
<a name="l00606"></a>00606                 TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);
<a name="l00607"></a>00607             }
<a name="l00608"></a>00608         }
<a name="l00609"></a>00609         
<a name="l00610"></a>00610         <span class="comment">//We may have gotten this validly or as an Error.</span>
<a name="l00611"></a>00611         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#d3a2ba13b4f5c4ccac0d9d5a67a08c9c">TWS_RNAK</a> == Status)
<a name="l00612"></a>00612         {
<a name="l00613"></a>00613             <span class="comment">//Not an error. Master didn't want PEC; clear UsePEC flag!</span>
<a name="l00614"></a>00614             <span class="keywordflow">if</span>(<a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a> == 1)
<a name="l00615"></a>00615             {
<a name="l00616"></a>00616                 <a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a> = 0;    <span class="comment">//clear the buffer too.</span>
<a name="l00617"></a>00617                 <a class="code" href="communication_8c.html#fd9b3e99365b45af6cf763b2dda41546">UsePEC</a> = 0;
<a name="l00618"></a>00618             }
<a name="l00619"></a>00619             <span class="comment">//Not an error. Master wanted PEC (and got it); assert UsePEC.</span>
<a name="l00620"></a>00620             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a> == 0)
<a name="l00621"></a>00621             {
<a name="l00622"></a>00622                 <a class="code" href="communication_8c.html#fd9b3e99365b45af6cf763b2dda41546">UsePEC</a> = 1;
<a name="l00623"></a>00623             }
<a name="l00624"></a>00624             
<a name="l00625"></a>00625             <span class="comment">//Some kind of error occurred; we got NAK too early!</span>
<a name="l00626"></a>00626             <span class="keywordflow">else</span>
<a name="l00627"></a>00627             {
<a name="l00628"></a>00628                 <span class="comment">//Note: the TWI module is now OFF-LINE, so we can't inform Host of this error!!</span>
<a name="l00629"></a>00629             }
<a name="l00630"></a>00630             
<a name="l00631"></a>00631             <span class="comment">//In all cases, go back to IDLE.</span>
<a name="l00632"></a>00632             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;
<a name="l00633"></a>00633             TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);
<a name="l00634"></a>00634         }
<a name="l00635"></a>00635         
<a name="l00636"></a>00636         <span class="comment">// if(TWS_FINAL == Status)  //ERROR: we got an ACK but we have no more data!</span>
<a name="l00637"></a>00637         <span class="comment">// Since the TWI module is now in "Not Addressed Slave" mode, we can't flag the error</span>
<a name="l00638"></a>00638         <span class="comment">// back to the Master DURING this transaction; we WILL assert an error status though.</span>
<a name="l00639"></a>00639         <span class="keywordflow">else</span>
<a name="l00640"></a>00640         {
<a name="l00641"></a>00641             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;  <span class="comment">//Reset the state machine.</span>
<a name="l00642"></a>00642             TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);
<a name="l00643"></a>00643         }
<a name="l00644"></a>00644         <span class="keywordflow">break</span>;
<a name="l00645"></a>00645     } <span class="comment">// end of switch(TWISR_state)</span>
<a name="l00646"></a>00646 }
<a name="l00647"></a>00647 
<a name="l00648"></a>00648 
<a name="l00656"></a><a class="code" href="smbus_8c.html#671390135cd0d30125661704332715a5">00656</a> <span class="keywordtype">bool</span> <a class="code" href="communication_8c.html#671390135cd0d30125661704332715a5" title="Check Communication State.">Comm_IsIdle</a>(<span class="keywordtype">void</span>)
<a name="l00657"></a>00657 {
<a name="l00658"></a>00658     <span class="keywordflow">return</span> (<a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a> == <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a>);
<a name="l00659"></a>00659 }
<a name="l00660"></a>00660 
<a name="l00661"></a>00661 
<a name="l00669"></a><a class="code" href="smbus_8c.html#2bab1f3bd066faa428e782b7417bc18a">00669</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="communication_8c.html#2bab1f3bd066faa428e782b7417bc18a" title="Check Communication Status.">Comm_Flag</a>(<span class="keywordtype">void</span>)
<a name="l00670"></a>00670 {
<a name="l00671"></a>00671     <span class="keywordflow">return</span> <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a>;  <span class="comment">// TW_IDLE=0</span>
<a name="l00672"></a>00672 }
<a name="l00673"></a>00673 
<a name="l00674"></a>00674 
<a name="l00675"></a>00675 
<a name="l00676"></a>00676 <span class="comment">//This function restores the SMBus &amp; the TWI_ISR state machine to normal after</span>
<a name="l00677"></a>00677 <span class="comment">//  we have deliberately generated a bus timeout error (in order to tell the</span>
<a name="l00678"></a>00678 <span class="comment">//  Master that something was wrong with his last command).</span>
<a name="l00679"></a><a class="code" href="smbus_8c.html#a43740bb86658af2f20234cc35e87e1c">00679</a> <span class="keywordtype">void</span> <a class="code" href="communication_8c.html#a43740bb86658af2f20234cc35e87e1c">SMB_RestoreBus</a>(<span class="keywordtype">void</span>)
<a name="l00680"></a>00680 {
<a name="l00681"></a>00681     TWCR = 0;               <span class="comment">//shut down the peripheral</span>
<a name="l00682"></a>00682     <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;  <span class="comment">//force an init of the state machine</span>
<a name="l00683"></a>00683     TWAR = <a class="code" href="SMBSlave_8h.html#fe8d42918d4038d5d5c20a30a661e57e">BATTERY_ADDR</a>&lt;&lt;1;         
<a name="l00684"></a>00684     TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);<span class="comment">// | (1&lt;&lt;TWSTO); // re-enable</span>
<a name="l00685"></a>00685     
<a name="l00686"></a>00686     <span class="comment">//Note that we must be careful not to generate some kind of bus error</span>
<a name="l00687"></a>00687     <span class="comment">// as a result of waking back up, or we will get into an endless loop</span>
<a name="l00688"></a>00688     <span class="comment">// by generating another bus timeout if the IDLE state doesn't like</span>
<a name="l00689"></a>00689     <span class="comment">// something it sees when it comes back to life.</span>
<a name="l00690"></a>00690 }
<a name="l00691"></a>00691 
<a name="l00692"></a>00692 
<a name="l00693"></a>00693 <span class="comment">/* *************************************************************************</span>
<a name="l00694"></a>00694 <span class="comment"> *</span>
<a name="l00695"></a>00695 <span class="comment"> *   Utilities for SMBus commmunications</span>
<a name="l00696"></a>00696 <span class="comment"> *</span>
<a name="l00697"></a>00697 <span class="comment"> ************************************************************************* */</span>
<a name="l00698"></a>00698 
<a name="l00699"></a>00699 <span class="preprocessor">#ifdef SMB_PEC_ROUTINE_SLOW</span>
<a name="l00700"></a>00700 <span class="preprocessor"></span>
<a name="l00701"></a>00701 <span class="comment">/* \brief PEC CRC lookup function</span>
<a name="l00702"></a>00702 <span class="comment"> *</span>
<a name="l00703"></a>00703 <span class="comment"> * This function calculates the PEC value of one byte, using the</span>
<a name="l00704"></a>00704 <span class="comment"> * PEC calculated so far as a starting point.</span>
<a name="l00705"></a>00705 <span class="comment"> *</span>
<a name="l00706"></a>00706 <span class="comment"> * \param  newByte    Value to calculate PEC of.</span>
<a name="l00707"></a>00707 <span class="comment"> * \param  lastCRC    The current PEC.</span>
<a name="l00708"></a>00708 <span class="comment"> */</span>
<a name="l00709"></a><a class="code" href="smbus_8h.html#c095e228dbfe422c65ad59a4aa6e535e">00709</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e">SMB_PEC</a>(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> lastCRC, <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> newByte)
<a name="l00710"></a>00710 {
<a name="l00711"></a>00711     <span class="comment">// Initial XOR</span>
<a name="l00712"></a>00712     lastCRC ^= newByte;
<a name="l00713"></a>00713     
<a name="l00714"></a>00714     <span class="keywordflow">for</span>(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> i = 0; i &lt; 8; i++){
<a name="l00715"></a>00715         <span class="keywordflow">if</span> (lastCRC &amp; 0x80){
<a name="l00716"></a>00716             lastCRC = (lastCRC &lt;&lt; 1) ^ <a class="code" href="smbus_8h.html#4af28c4425ff1b83529f5269be120be3" title="The CRC polynome used in PEC calculation.">SMB_PEC_CRC_POLYNOME</a>;
<a name="l00717"></a>00717         }<span class="keywordflow">else</span>{
<a name="l00718"></a>00718             lastCRC &lt;&lt;= 1;
<a name="l00719"></a>00719         }
<a name="l00720"></a>00720     }
<a name="l00721"></a>00721     <span class="keywordflow">return</span> lastCRC;
<a name="l00722"></a>00722 }
<a name="l00723"></a>00723 
<a name="l00724"></a>00724 <span class="preprocessor">#elif defined(SMB_PEC_ROUTINE_MEDIUM)</span>
<a name="l00725"></a>00725 <span class="preprocessor"></span>
<a name="l00727"></a>00727 __flash <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> crcTable1[16] = {0x00,0x07,0x0E,0x09, 0x1c,0x1b,0x12,0x15, 0x38,0x3F,0x36,0x31, 0x24,0x23,0x2A,0x2D};
<a name="l00728"></a>00728 __flash <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> crcTable2[16] = {0x00,0x70,0xE0,0x90, 0xC1,0xB1,0x21,0x51, 0x83,0xF3,0x63,0x13, 0x42,0x32,0xA2,0xD2};
<a name="l00729"></a>00729 
<a name="l00730"></a>00730 <span class="comment">/* \brief PEC CRC lookup function</span>
<a name="l00731"></a>00731 <span class="comment"> *</span>
<a name="l00732"></a>00732 <span class="comment"> * This function uses a table stored in flash to look up the</span>
<a name="l00733"></a>00733 <span class="comment"> * PEC value of one byte, using the PEC calculated so far as a</span>
<a name="l00734"></a>00734 <span class="comment"> * starting point.</span>
<a name="l00735"></a>00735 <span class="comment"> *</span>
<a name="l00736"></a>00736 <span class="comment"> * \param  newByte    Value to calculate PEC of.</span>
<a name="l00737"></a>00737 <span class="comment"> * \param  lastCRC    The current PEC.</span>
<a name="l00738"></a>00738 <span class="comment"> */</span>
<a name="l00739"></a>00739 <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e">SMB_PEC</a>(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> lastCRC, <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> newByte)
<a name="l00740"></a>00740 {
<a name="l00741"></a>00741     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> index;
<a name="l00742"></a>00742     
<a name="l00743"></a>00743     index = newByte;
<a name="l00744"></a>00744     index ^= lastCRC;
<a name="l00745"></a>00745     index &gt;&gt;= 4;
<a name="l00746"></a>00746     lastCRC &amp;= 0x0F;
<a name="l00747"></a>00747     lastCRC ^= crcTable2[index];
<a name="l00748"></a>00748     
<a name="l00749"></a>00749     index = lastCRC;
<a name="l00750"></a>00750     index ^= newByte;
<a name="l00751"></a>00751     index &amp;= 0x0F;
<a name="l00752"></a>00752     lastCRC &amp;= 0xF0;
<a name="l00753"></a>00753     lastCRC ^= crcTable1[index];
<a name="l00754"></a>00754     
<a name="l00755"></a>00755     <span class="keywordflow">return</span> lastCRC;
<a name="l00756"></a>00756 }
<a name="l00757"></a>00757 
<a name="l00758"></a>00758 <span class="preprocessor">#elif defined(SMB_PEC_ROUTINE_FAST)</span>
<a name="l00759"></a>00759 <span class="preprocessor"></span>
<a name="l00761"></a>00761 __flash <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> crcTable[256] = {   
<a name="l00762"></a>00762     0x00, 0x07, 0x0e, 0x09, 0x1c, 0x1b, 0x12, 0x15,
<a name="l00763"></a>00763     0x38, 0x3f, 0x36, 0x31, 0x24, 0x23, 0x2a, 0x2d,
<a name="l00764"></a>00764     0x70, 0x77, 0x7e, 0x79, 0x6c, 0x6b, 0x62, 0x65,
<a name="l00765"></a>00765     0x48, 0x4f, 0x46, 0x41, 0x54, 0x53, 0x5a, 0x5d,
<a name="l00766"></a>00766     0xe0, 0xe7, 0xee, 0xe9, 0xfc, 0xfb, 0xf2, 0xf5,
<a name="l00767"></a>00767     0xd8, 0xdf, 0xd6, 0xd1, 0xc4, 0xc3, 0xca, 0xcd,
<a name="l00768"></a>00768     0x90, 0x97, 0x9e, 0x99, 0x8c, 0x8b, 0x82, 0x85,
<a name="l00769"></a>00769     0xa8, 0xaf, 0xa6, 0xa1, 0xb4, 0xb3, 0xba, 0xbd,
<a name="l00770"></a>00770     0xc7, 0xc0, 0xc9, 0xce, 0xdb, 0xdc, 0xd5, 0xd2,
<a name="l00771"></a>00771     0xff, 0xf8, 0xf1, 0xf6, 0xe3, 0xe4, 0xed, 0xea,
<a name="l00772"></a>00772     0xb7, 0xb0, 0xb9, 0xbe, 0xab, 0xac, 0xa5, 0xa2,
<a name="l00773"></a>00773     0x8f, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9d, 0x9a,
<a name="l00774"></a>00774     0x27, 0x20, 0x29, 0x2e, 0x3b, 0x3c, 0x35, 0x32,
<a name="l00775"></a>00775     0x1f, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0d, 0x0a,
<a name="l00776"></a>00776     0x57, 0x50, 0x59, 0x5e, 0x4b, 0x4c, 0x45, 0x42,
<a name="l00777"></a>00777     0x6f, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7d, 0x7a,
<a name="l00778"></a>00778     0x89, 0x8e, 0x87, 0x80, 0x95, 0x92, 0x9b, 0x9c,
<a name="l00779"></a>00779     0xb1, 0xb6, 0xbf, 0xb8, 0xad, 0xaa, 0xa3, 0xa4,
<a name="l00780"></a>00780     0xf9, 0xfe, 0xf7, 0xf0, 0xe5, 0xe2, 0xeb, 0xec,
<a name="l00781"></a>00781     0xc1, 0xc6, 0xcf, 0xc8, 0xdd, 0xda, 0xd3, 0xd4,
<a name="l00782"></a>00782     0x69, 0x6e, 0x67, 0x60, 0x75, 0x72, 0x7b, 0x7c,
<a name="l00783"></a>00783     0x51, 0x56, 0x5f, 0x58, 0x4d, 0x4a, 0x43, 0x44,
<a name="l00784"></a>00784     0x19, 0x1e, 0x17, 0x10, 0x05, 0x02, 0x0b, 0x0c,
<a name="l00785"></a>00785     0x21, 0x26, 0x2f, 0x28, 0x3d, 0x3a, 0x33, 0x34,
<a name="l00786"></a>00786     0x4e, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5c, 0x5b,
<a name="l00787"></a>00787     0x76, 0x71, 0x78, 0x7f, 0x6a, 0x6d, 0x64, 0x63,
<a name="l00788"></a>00788     0x3e, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2c, 0x2b,
<a name="l00789"></a>00789     0x06, 0x01, 0x08, 0x0f, 0x1a, 0x1d, 0x14, 0x13,
<a name="l00790"></a>00790     0xae, 0xa9, 0xa0, 0xa7, 0xb2, 0xb5, 0xbc, 0xbb,
<a name="l00791"></a>00791     0x96, 0x91, 0x98, 0x9f, 0x8a, 0x8d, 0x84, 0x83,
<a name="l00792"></a>00792     0xde, 0xd9, 0xd0, 0xd7, 0xc2, 0xc5, 0xcc, 0xcb,
<a name="l00793"></a>00793     0xe6, 0xe1, 0xe8, 0xef, 0xfa, 0xfd, 0xf4, 0xf3
<a name="l00794"></a>00794 };
<a name="l00795"></a>00795 
<a name="l00796"></a>00796 <span class="comment">/* \brief PEC CRC lookup function</span>
<a name="l00797"></a>00797 <span class="comment"> *</span>
<a name="l00798"></a>00798 <span class="comment"> * This function uses a table stored in flash to look up the</span>
<a name="l00799"></a>00799 <span class="comment"> * PEC value of one byte, using the PEC calculated so far as a</span>
<a name="l00800"></a>00800 <span class="comment"> * starting point.</span>
<a name="l00801"></a>00801 <span class="comment"> *</span>
<a name="l00802"></a>00802 <span class="comment"> * \param  newByte    Value to calculate PEC of.</span>
<a name="l00803"></a>00803 <span class="comment"> * \param  lastCRC    The current PEC.</span>
<a name="l00804"></a>00804 <span class="comment"> */</span>
<a name="l00805"></a>00805 <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e">SMB_PEC</a>(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> lastCRC, <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> newByte)
<a name="l00806"></a>00806 {
<a name="l00807"></a>00807     lastCRC ^= newByte;
<a name="l00808"></a>00808     lastCRC = crcTable[lastCRC];
<a name="l00809"></a>00809     
<a name="l00810"></a>00810     <span class="keywordflow">return</span> lastCRC;
<a name="l00811"></a>00811 }
<a name="l00812"></a>00812 
<a name="l00813"></a>00813 
<a name="l00814"></a>00814 <span class="preprocessor">#else</span>
<a name="l00815"></a>00815 <span class="preprocessor"></span><span class="preprocessor">#error One SMB_PEC_ROUTINE must be defined.</span>
<a name="l00816"></a>00816 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00817"></a>00817 <span class="preprocessor"></span>
<a name="l00818"></a>00818 
<a name="l00819"></a>00819 <span class="comment">/* Some important notes from the SMBus specs:</span>
<a name="l00820"></a>00820 <span class="comment"></span>
<a name="l00821"></a>00821 <span class="comment">Insertion or removal of a Smart Battery may be detected when the Safety Signal?transitions from or to an</span>
<a name="l00822"></a>00822 <span class="comment">open-circuit value (&gt;100k.)</span>
<a name="l00823"></a>00823 <span class="comment"></span>
<a name="l00824"></a>00824 <span class="comment">When an SMBus device acting as the bus master detects an error, it must attempt to return the bus to the idle</span>
<a name="l00825"></a>00825 <span class="comment">state by generating a STOP condition.</span>
<a name="l00826"></a>00826 <span class="comment"></span>
<a name="l00827"></a>00827 <span class="comment">The Smart Battery must ALWAYS acknowledge its own address. Failure to do so might cause the SMBus</span>
<a name="l00828"></a>00828 <span class="comment">Host or Smart Battery Charger to incorrectly assume the Smart Battery is NOT present in the system,</span>
<a name="l00829"></a>00829 <span class="comment">although the Safety Signal?can be used to detect the presence of a Smart Battery in a system. Note</span>
<a name="l00830"></a>00830 <span class="comment">however that the Smart Battery may choose not to acknowledge any byte following its address if it is</span>
<a name="l00831"></a>00831 <span class="comment">busy or otherwise unable to respond. If this occurs, the requestor should re-try the data request.</span>
<a name="l00832"></a>00832 <span class="comment"></span>
<a name="l00833"></a>00833 <span class="comment">After each SMBus transaction directed to the Smart Battery device address, the Smart Battery must place</span>
<a name="l00834"></a>00834 <span class="comment">the appropriate error code in the lower nibble of the BatteryStatus() register. If the transaction completed</span>
<a name="l00835"></a>00835 <span class="comment">successfully, the error codes should be cleared to signify that no error was detected. Timeout and other</span>
<a name="l00836"></a>00836 <span class="comment">errors not described by one of the error code types may be signaled with an Unknown Error.</span>
<a name="l00837"></a>00837 <span class="comment"></span>
<a name="l00838"></a>00838 <span class="comment">Another device may try to interrogate the battery immediately after a transaction from the Host.</span>
<a name="l00839"></a>00839 <span class="comment">The safest method to insure that the read of BatteryStatus() corresponds to the most recently read data value</span>
<a name="l00840"></a>00840 <span class="comment">is to perform this read of BatteryStatus() immediately after the read of the initial data value. This may be</span>
<a name="l00841"></a>00841 <span class="comment">accomplished by issuing a SMBus START condition after the SMBus STOP condition from the previous</span>
<a name="l00842"></a>00842 <span class="comment">transmission.</span>
<a name="l00843"></a>00843 <span class="comment"></span>
<a name="l00844"></a>00844 <span class="comment">A bus master is required to check for bus idle time of 50 us.</span>
<a name="l00845"></a>00845 <span class="comment"></span>
<a name="l00846"></a>00846 <span class="comment">The Smart Battery enters the On State whenever it detects that the SMBus Clock and Data lines go high.</span>
<a name="l00847"></a>00847 <span class="comment">The battery should be active and able to communicate via the SMBus within 1 ms of detecting these SMBus</span>
<a name="l00848"></a>00848 <span class="comment">lines going high.</span>
<a name="l00849"></a>00849 <span class="comment"></span>
<a name="l00850"></a>00850 <span class="comment">The Smart Battery may not begin *broadcasting* ChargingVoltage(), ChargingCurrent() or AlarmWarning()</span>
<a name="l00851"></a>00851 <span class="comment">messages to either the SMBus Host or Smart Battery Charger for at least 10 seconds after entering the On</span>
<a name="l00852"></a>00852 <span class="comment">State.?</span>
<a name="l00853"></a>00853 <span class="comment">When the Smart Battery enters the On State?the following values must be reinitialized:</span>
<a name="l00854"></a>00854 <span class="comment">Function (Data Value)       Initial Value       </span>
<a name="l00855"></a>00855 <span class="comment">---------------------   ----------------------------    </span>
<a name="l00856"></a>00856 <span class="comment">BatteryMode()       Bit 15: CAPACITY_MODE=0</span>
<a name="l00857"></a>00857 <span class="comment">            Bit 14: CHARGER_MODE=0</span>
<a name="l00858"></a>00858 <span class="comment">            Bit 13: ALARM MODE=0</span>
<a name="l00859"></a>00859 <span class="comment">            Bit 9: PRIMARY_BATTERY=0</span>
<a name="l00860"></a>00860 <span class="comment">            Bit 8: CHARGE_CONTROLLER_ENABLED=0</span>
<a name="l00861"></a>00861 <span class="comment"></span>
<a name="l00862"></a>00862 <span class="comment"></span>
<a name="l00863"></a>00863 <span class="comment">The Smart Battery may enter the Off State?whenever the SMBus Clock and Data lines both remain low</span>
<a name="l00864"></a>00864 <span class="comment">for greater than 2.5 seconds.</span>
<a name="l00865"></a>00865 <span class="comment"></span>
<a name="l00866"></a>00866 <span class="comment">There is no limit to the speed (other than SMBus limits) or rate at which data may be requested from the</span>
<a name="l00867"></a>00867 <span class="comment">Smart Battery. Continuous data polling at high rates is permitted and allowed, though not encouraged due</span>
<a name="l00868"></a>00868 <span class="comment">to limitations on SMBus bandwidth and availability. The Smart Battery may delay any data request by</span>
<a name="l00869"></a>00869 <span class="comment">holding the CLOCK line low for up to 25 ms. This may be done in order to re-calculate the requested data</span>
<a name="l00870"></a>00870 <span class="comment">value or to retrieve data from a storage device.</span>
<a name="l00871"></a>00871 <span class="comment"></span>
<a name="l00872"></a>00872 <span class="comment"></span>
<a name="l00873"></a>00873 <span class="comment">*/</span>
</pre></div></div>
<html>
 <head>
  <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
  <title>@DOC_TITLE@</title>
  <link href="doxygen.css" rel="stylesheet" type="text/css">
</head>
<body>

<table width="100%" height="10%" bgcolor="#FFFFFF">
  <tr>
    <td colspan="6" height="1" background="blue.gif"></td>
  </tr>

  <tr>
    <td colspan="6">
    <address style="align: right;"><small>
Generated on Wed Aug 4 10:59:55 2010 for AVR474 Firmware User's Guide for SB202 by <a href="http://www.doxygen.org/index.html"><img src="doxygen.png" alt="doxygen" align="middle" border=0></a> 1.5.6</small></address>
    </td>
  </tr>

</table>
