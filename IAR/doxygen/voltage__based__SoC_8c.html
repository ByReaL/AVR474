<html xmlns:v="urn:schemas-microsoft-com:vml"
xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns="http://www.w3.org/TR/REC-html40">

<head>
<meta http-equiv=Content-Type content="text/html; charset=iso-8859-1">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 11">
<meta name=Originator content="Microsoft Word 11">
<link rel=File-List href="atmel-header_files/filelist.xml">
<link rel=Edit-Time-Data href="atmel-header_files/editdata.mso">
<!--[if !mso]>
<style>
v\:* {behavior:url(#default#VML);}
o\:* {behavior:url(#default#VML);}
w\:* {behavior:url(#default#VML);}
.shape {behavior:url(#default#VML);}
</style>
<![endif]-->
<title>@DOC_TITLE@</title>
<!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>ping.zhou</o:Author>
  <o:Template>Normal</o:Template>
  <o:LastAuthor>ping.zhou</o:LastAuthor>
  <o:Revision>3</o:Revision>
  <o:TotalTime>0</o:TotalTime>
  <o:Created>2010-08-04T02:58:00Z</o:Created>
  <o:LastSaved>2010-08-04T02:58:00Z</o:LastSaved>
  <o:Pages>1</o:Pages>
  <o:Words>51</o:Words>
  <o:Characters>297</o:Characters>
  <o:Company>Atmel</o:Company>
  <o:Lines>2</o:Lines>
  <o:Paragraphs>1</o:Paragraphs>
  <o:CharactersWithSpaces>347</o:CharactersWithSpaces>
  <o:Version>11.9999</o:Version>
 </o:DocumentProperties>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:Zoom>150</w:Zoom>
  <w:SpellingState>Clean</w:SpellingState>
  <w:GrammarState>Clean</w:GrammarState>
  <w:ValidateAgainstSchemas/>
  <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid>
  <w:IgnoreMixedContent>false</w:IgnoreMixedContent>
  <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText>
  <w:Compatibility>
   <w:UseFELayout/>
  </w:Compatibility>
  <w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel>
 </w:WordDocument>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:LatentStyles DefLockedState="false" LatentStyleCount="156">
 </w:LatentStyles>
</xml><![endif]-->
<link rel=Stylesheet type="text/css" media=all href="doxygen.css">
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Helvetica;
	panose-1:2 11 6 4 2 2 2 2 2 4;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:536902279 -2147483648 8 0 511 0;}
@font-face
	{font-family:SimSun;
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-alt:SimSun;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 135135232 16 0 262145 0;}
@font-face
	{font-family:SimSun;
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 135135232 16 0 262145 0;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:SimSun;}
p
	{font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:SimSun;}
span.SpellE
	{mso-style-name:"";
	mso-spl-e:yes;}
@page Section1
	{size:8.5in 11.0in;
	margin:1.0in 1.25in 1.0in 1.25in;
	mso-header-margin:.5in;
	mso-footer-margin:.5in;
	mso-paper-source:0;}
div.Section1
	{page:Section1;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
	{mso-style-name:"Table Normal";
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-parent:"";
	mso-padding-alt:0in 5.4pt 0in 5.4pt;
	mso-para-margin:0in;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-ansi-language:#0400;
	mso-fareast-language:#0400;
	mso-bidi-language:#0400;}
</style>
<![endif]--><!--[if gte mso 9]><xml>
 <o:shapedefaults v:ext="edit" spidmax="2050"/>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <o:shapelayout v:ext="edit">
  <o:idmap v:ext="edit" data="1"/>
 </o:shapelayout></xml><![endif]-->
</head>

<body lang=EN-US link=blue vlink=blue style='tab-interval:.5in'>

<div class=Section1>

<table class=MsoNormalTable border=0 cellpadding=0 width="100%"
 style='width:100.0%;mso-cellspacing:1.5pt;background:white'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes'>
  <td style='padding:.75pt .75pt .75pt .75pt'>
  <p><a href="http://www.atmel.com"><span style='text-decoration:none;
  text-underline:none'><img border=0 width=109 height=50 id="_x0000_i1025"
  src=atmel.jpg></span></a></p>
  <p class=MsoNormal><o:p>&nbsp;</o:p></p>
  </td>
  <td style='padding:.75pt .75pt .75pt .75pt'>
  <p class=MsoNormal><span class=SpellE><strong><span style='font-size:24.0pt;
  font-family:Helvetica;color:black'>SmartBattery</span></strong></span><strong><span
  style='font-size:24.0pt;font-family:Helvetica;color:black'> Device
  Application Note</span></strong></p>
  </td>
  <td style='padding:.75pt .75pt .75pt .75pt'>
  <p><a href="http://www.atmel.com/products/AVR"><span style='text-decoration:
  none;text-underline:none'><img border=0 width=138 height=77 id="_x0000_i1026"
  src="AVR_logo_blue.gif"></span></a></p>
  <p class=MsoNormal><o:p>&nbsp;</o:p></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:1;mso-yfti-lastrow:yes;height:.75pt'>
  <td colspan=3 style='padding:.75pt .75pt .75pt .75pt;height:.75pt'
  background=blue.gif>
  <p class=MsoNormal><span style='font-size:1.0pt;mso-bidi-font-size:12.0pt'><o:p>&nbsp;</o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

</div>

</body>

</html>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_29ae905079a6eb1b30b29288f24757bc.html">lib_mcu</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_2496ec0daa6eca24b89316dc3d1a4410.html">voltage_based_SoC</a>
  </div>
</div>
<div class="contents">
<h1>voltage_based_SoC.c File Reference</h1><hr><a name="_details"></a><h2>Detailed Description</h2>
Functions for estimating State of Charge based on voltage. 
<p>
<dl class="user" compact><dt><b>Application note:</b></dt><dd>AVR474: SB202 Firmware user's guide.</dd></dl>
<dl class="user" compact><dt><b>Documentation</b></dt><dd>For comprehensive code documentation, supported compilers, compiler settings and supported devices see readme.html</dd></dl>
<dl class="author" compact><dt><b>Author:</b></dt><dd>Atmel Corporation: <a href="http://www.atmel.com">http://www.atmel.com</a> <br>
 Support email: <a href="mailto:avr@atmel.com">avr@atmel.com</a></dd></dl>
<dl class="rcs" compact><dt><b>Revision</b></dt><dd>5627 </dd></dl>
<dl class="rcs" compact><dt><b>Date</b></dt><dd>2009-05-15 14:49:21 +0800 (Fri, 15 May 2009) </dd></dl>
<br>
<p>
Copyright (c) 2009, Atmel Corporation All rights reserved.<p>
Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:<p>
1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.<p>
2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.<p>
3. The name of ATMEL may not be used to endorse or promote products derived from this software without specific prior written permission.<p>
THIS SOFTWARE IS PROVIDED BY ATMEL "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE EXPRESSLY AND SPECIFICALLY DISCLAIMED. IN NO EVENT SHALL ATMEL BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. 
<p>Definition in file <a class="el" href="voltage__based__SoC_8c-source.html">voltage_based_SoC.c</a>.</p>

<p>
<code>#include &quot;<a class="el" href="common_8h-source.html">common.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="vadc_8h-source.html">vadc.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="ccadc_8h-source.html">ccadc.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="voltage__based__SoC_8h-source.html">voltage_based_SoC.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="rtc_8h-source.html">rtc.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="battery__current__monitoring_8h-source.html">battery_current_monitoring.h</a>&quot;</code><br>

<p>
<div class="dynheader">
Include dependency graph for voltage_based_SoC.c:</div>
<div class="dynsection">
<p><center><img src="voltage__based__SoC_8c__incl.gif" border="0" usemap="#lib_mcu/voltage_based_SoC/voltage_based_SoC.c_map" alt=""></center>
<map name="lib_mcu/voltage_based_SoC/voltage_based_SoC.c_map">
<area shape="rect" href="common_8h.html" title="Common headerfile." alt="" coords="287,304,369,331"><area shape="rect" href="vadc_8h.html" title="Headerfile for vadc_usage.c." alt="" coords="245,80,304,107"><area shape="rect" href="battery__current__monitoring_8h.html" title="Header file for CC&#45;ADC result processing firmware module." alt="" coords="324,229,511,256"><area shape="rect" href="ccadc_8h.html" title="CCADC module header file." alt="" coords="495,80,561,107"><area shape="rect" href="voltage__based__SoC_8h.html" title="Contains defines, typedefinitions and functions prototypes for voltage_based_SoC..." alt="" coords="697,80,844,107"><area shape="rect" href="rtc_8h.html" title="Headerfile for rtc.c." alt="" coords="575,155,623,181"><area shape="rect" href="stdint_8h.html" title="stdint.h" alt="" coords="75,379,139,405"><area shape="rect" href="error_8h.html" title="error.h" alt="" coords="427,379,485,405"><area shape="rect" href="battery__pack__parameters_8h.html" title="Definition file for a smart battery pack." alt="" coords="185,155,364,181"><area shape="rect" href="sbs__commands_8h.html" title="Headerfile for sbs_commands.c." alt="" coords="177,229,300,256"><area shape="rect" href="battery__protection_8h.html" title="Header file for Battery Protection peripheral module driver." alt="" coords="17,229,153,256"><area shape="rect" href="crc16_8h.html" title="Header file for CRC16 functions." alt="" coords="75,304,139,331"></map>
</div>

<p>
<a href="voltage__based__SoC_8c-source.html">Go to the source code of this file.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="voltage__based__SoC_8c.html#492beb3ac8d746f1f463048c1dbffdeb">VOLTAGE_EMPTY</a>&nbsp;&nbsp;&nbsp;(<a class="el" href="voltage__based__SoC_8c.html#c28d1c0b39ee43aa53bce466804ad44b">VoltageTable</a>[0][VOLTAGE_TABLE_SIZE-1])</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="voltage__based__SoC_8c.html#ef4930a056e88cc0bd77d0a91603222e">VOLTAGE_FULL</a>&nbsp;&nbsp;&nbsp;(<a class="el" href="voltage__based__SoC_8c.html#c28d1c0b39ee43aa53bce466804ad44b">VoltageTable</a>[0][0])</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="voltage__based__SoC_8c.html#df6029d5c8be52478edf62fe248e1125">VOLTAGE_TABLE_SIZE</a>&nbsp;&nbsp;&nbsp;21</td></tr>

<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="voltage__based__SoC_8c.html#568cb223b73b8d4d234670ebb0baefb6">ConvertDigitalToCurrent</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Current conversion.  <a href="#568cb223b73b8d4d234670ebb0baefb6"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="voltage__based__SoC_8c.html#711f47676ef41fa51a7721e95498474b">ConvertDigitalToVoltage</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Voltage conversion.  <a href="#711f47676ef41fa51a7721e95498474b"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="voltage__based__SoC_8c.html#a575b7d78b65c89953c9b265ab4a181e">ConvertVoltageToSoC</a> (<a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> inputVoltage)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">SoC conversion.  <a href="#a575b7d78b65c89953c9b265ab4a181e"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="voltage__based__SoC_8c.html#b8eeb992ca44aa7fcf70946ffad1be1e">VBSoC_ConvertSoCToVoltage</a> (<a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> inputsoc)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">SoC-Voltage conversion.  <a href="#b8eeb992ca44aa7fcf70946ffad1be1e"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="voltage__based__SoC_8c.html#ce1479a5937438f72f5357e20ee39db0">VBSoC_EstimatedSoC</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Returns the the latest estimated state of charge.  <a href="#ce1479a5937438f72f5357e20ee39db0"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="voltage__based__SoC_8c.html#78d7f4f0eb9968d7e0468dc7eb01c2a2">VBSoC_Init</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Calculate the initial SoC.  <a href="#78d7f4f0eb9968d7e0468dc7eb01c2a2"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="voltage__based__SoC_8c.html#3cfbb7f6888a90eb03eeb14e7f4b00aa">VBSoC_OCSoC</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Returns the the latest open circuit state of charge.  <a href="#3cfbb7f6888a90eb03eeb14e7f4b00aa"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="voltage__based__SoC_8c.html#95f0ec8dc8b936dc47ae56b0ef72b406">VBSoC_OCSoCLastUpdated</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Returns how many seconds ago the open circuit voltage SoC was updated.  <a href="#95f0ec8dc8b936dc47ae56b0ef72b406"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="voltage__based__SoC_8c.html#96735c5df96b87b60cfd1222e1420adb">VBSoC_ResetTimer</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Reset the relaxation timer.  <a href="#96735c5df96b87b60cfd1222e1420adb"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="voltage__based__SoC_8c.html#9708e584eda79bcf685b716b25e66765">VBSoC_Update</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Updates the SoC.  <a href="#9708e584eda79bcf685b716b25e66765"></a><br></td></tr>
<tr><td colspan="2"><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="voltage__based__SoC_8c.html#c0306252998313f3e18faf6fc4256f2a">LastUpdated</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="voltage__based__SoC_8c.html#99d4ca55297bd706857e2cb9d8868e7a">OpenCircuitSoC</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="voltage__based__SoC_8c.html#1a9192b7d255c0058c58d63b7ba4f0ae">relaxationTimer</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">__flash <a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="voltage__based__SoC_8c.html#c28d1c0b39ee43aa53bce466804ad44b">VoltageTable</a> [2][21]</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="492beb3ac8d746f1f463048c1dbffdeb"></a><!-- doxytag: member="voltage_based_SoC.c::VOLTAGE_EMPTY" ref="492beb3ac8d746f1f463048c1dbffdeb" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define VOLTAGE_EMPTY&nbsp;&nbsp;&nbsp;(<a class="el" href="voltage__based__SoC_8c.html#c28d1c0b39ee43aa53bce466804ad44b">VoltageTable</a>[0][VOLTAGE_TABLE_SIZE-1])          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="voltage__based__SoC_8c-source.html#l00058">58</a> of file <a class="el" href="voltage__based__SoC_8c-source.html">voltage_based_SoC.c</a>.</p>

<p>Referenced by <a class="el" href="voltage__based__SoC_8c-source.html#l00282">ConvertVoltageToSoC()</a>, and <a class="el" href="voltage__based__SoC_8c-source.html#l00365">VBSoC_ConvertSoCToVoltage()</a>.</p>

</div>
</div><p>
<a class="anchor" name="ef4930a056e88cc0bd77d0a91603222e"></a><!-- doxytag: member="voltage_based_SoC.c::VOLTAGE_FULL" ref="ef4930a056e88cc0bd77d0a91603222e" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define VOLTAGE_FULL&nbsp;&nbsp;&nbsp;(<a class="el" href="voltage__based__SoC_8c.html#c28d1c0b39ee43aa53bce466804ad44b">VoltageTable</a>[0][0])          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="voltage__based__SoC_8c-source.html#l00059">59</a> of file <a class="el" href="voltage__based__SoC_8c-source.html">voltage_based_SoC.c</a>.</p>

<p>Referenced by <a class="el" href="voltage__based__SoC_8c-source.html#l00282">ConvertVoltageToSoC()</a>, and <a class="el" href="voltage__based__SoC_8c-source.html#l00365">VBSoC_ConvertSoCToVoltage()</a>.</p>

</div>
</div><p>
<a class="anchor" name="df6029d5c8be52478edf62fe248e1125"></a><!-- doxytag: member="voltage_based_SoC.c::VOLTAGE_TABLE_SIZE" ref="df6029d5c8be52478edf62fe248e1125" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define VOLTAGE_TABLE_SIZE&nbsp;&nbsp;&nbsp;21          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="voltage__based__SoC_8c-source.html#l00078">78</a> of file <a class="el" href="voltage__based__SoC_8c-source.html">voltage_based_SoC.c</a>.</p>

<p>Referenced by <a class="el" href="voltage__based__SoC_8c-source.html#l00282">ConvertVoltageToSoC()</a>, and <a class="el" href="voltage__based__SoC_8c-source.html#l00365">VBSoC_ConvertSoCToVoltage()</a>.</p>

</div>
</div><p>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="568cb223b73b8d4d234670ebb0baefb6"></a><!-- doxytag: member="voltage_based_SoC.c::ConvertDigitalToCurrent" ref="568cb223b73b8d4d234670ebb0baefb6" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a> ConvertDigitalToCurrent           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Current conversion. 
<p>
Conversion of digital value to current (in mA).<p>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>Current (mA) </dd></dl>

<p>Definition at line <a class="el" href="voltage__based__SoC_8c-source.html#l00325">325</a> of file <a class="el" href="voltage__based__SoC_8c-source.html">voltage_based_SoC.c</a>.</p>

<p>References <a class="el" href="battery__current__monitoring_8c-source.html#l00106">BATTCUR_GetOffsetCalibratedCurrent()</a>, and <a class="el" href="battery__current__monitoring_8c-source.html#l00262">BATTCUR_Ticks2mA()</a>.</p>

<p>Referenced by <a class="el" href="voltage__based__SoC_8c-source.html#l00337">ConvertDigitalToVoltage()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00326"></a>00326 {       
<a name="l00327"></a>00327     <span class="keywordflow">return</span> <a class="code" href="battery__current__monitoring_8c.html#d971791f4fc1c6f54e1d7d46fea20786" title="Convert CCADC ticks to mA.">BATTCUR_Ticks2mA</a>(<a class="code" href="battery__current__monitoring_8c.html#6a557e4dca31a58b1683861bf8f154e6" title="Provides the offset calibrated current from the last CC-ADC reading.">BATTCUR_GetOffsetCalibratedCurrent</a>());
<a name="l00328"></a>00328 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<p><center><img src="voltage__based__SoC_8c_568cb223b73b8d4d234670ebb0baefb6_cgraph.gif" border="0" usemap="#voltage__based__SoC_8c_568cb223b73b8d4d234670ebb0baefb6_cgraph_map" alt=""></center>
<map name="voltage__based__SoC_8c_568cb223b73b8d4d234670ebb0baefb6_cgraph_map">
<area shape="rect" href="battery__current__monitoring_8c.html#6a557e4dca31a58b1683861bf8f154e6" title="Provides the offset calibrated current from the last CC&#45;ADC reading." alt="" coords="211,5,453,32"><area shape="rect" href="battery__current__monitoring_8c.html#d971791f4fc1c6f54e1d7d46fea20786" title="Convert CCADC ticks to mA." alt="" coords="260,56,404,83"></map>
</div>

</div>
</div><p>
<a class="anchor" name="711f47676ef41fa51a7721e95498474b"></a><!-- doxytag: member="voltage_based_SoC.c::ConvertDigitalToVoltage" ref="711f47676ef41fa51a7721e95498474b" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a> ConvertDigitalToVoltage           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Voltage conversion. 
<p>
Conversion of digital value to voltage on battery internal resistor (mV).<p>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>current (mA) </dd></dl>

<p>Definition at line <a class="el" href="voltage__based__SoC_8c-source.html#l00337">337</a> of file <a class="el" href="voltage__based__SoC_8c-source.html">voltage_based_SoC.c</a>.</p>

<p>References <a class="el" href="voltage__based__SoC_8c-source.html#l00325">ConvertDigitalToCurrent()</a>, and <a class="el" href="battery__pack__parameters_8h-source.html#l00241">INTERNAL_BATT_RESISTOR_TIMES_128</a>.</p>

<p>Referenced by <a class="el" href="voltage__based__SoC_8c-source.html#l00238">VBSoC_EstimatedSoC()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00338"></a>00338 {
<a name="l00339"></a>00339     <a class="code" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a> temp;
<a name="l00340"></a>00340     
<a name="l00341"></a>00341     temp = <a class="code" href="voltage__based__SoC_8c.html#568cb223b73b8d4d234670ebb0baefb6" title="Current conversion.">ConvertDigitalToCurrent</a>();
<a name="l00342"></a>00342     temp *= <a class="code" href="battery__pack__parameters_8h.html#7ba6042611e8423752ea4df386574b46" title="The internal batt resistance in ohms *128.">INTERNAL_BATT_RESISTOR_TIMES_128</a>;
<a name="l00343"></a>00343     
<a name="l00344"></a>00344     <span class="keywordflow">if</span>(temp &lt; 0) {
<a name="l00345"></a>00345         temp = -temp;
<a name="l00346"></a>00346         temp += 64; <span class="comment">// rounding</span>
<a name="l00347"></a>00347         temp &gt;&gt;= 7; <span class="comment">// divide by 128</span>
<a name="l00348"></a>00348         temp = -temp;
<a name="l00349"></a>00349     } <span class="keywordflow">else</span> {
<a name="l00350"></a>00350         temp += 64; <span class="comment">// rounding</span>
<a name="l00351"></a>00351         temp &gt;&gt;= 7; <span class="comment">// divide by 128</span>
<a name="l00352"></a>00352     }
<a name="l00353"></a>00353 
<a name="l00354"></a>00354     <span class="keywordflow">return</span> ((<a class="code" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a>) temp);
<a name="l00355"></a>00355 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<p><center><img src="voltage__based__SoC_8c_711f47676ef41fa51a7721e95498474b_cgraph.gif" border="0" usemap="#voltage__based__SoC_8c_711f47676ef41fa51a7721e95498474b_cgraph_map" alt=""></center>
<map name="voltage__based__SoC_8c_711f47676ef41fa51a7721e95498474b_cgraph_map">
<area shape="rect" href="voltage__based__SoC_8c.html#568cb223b73b8d4d234670ebb0baefb6" title="Current conversion." alt="" coords="215,31,369,57"><area shape="rect" href="battery__current__monitoring_8c.html#6a557e4dca31a58b1683861bf8f154e6" title="Provides the offset calibrated current from the last CC&#45;ADC reading." alt="" coords="419,5,661,32"><area shape="rect" href="battery__current__monitoring_8c.html#d971791f4fc1c6f54e1d7d46fea20786" title="Convert CCADC ticks to mA." alt="" coords="468,56,612,83"></map>
</div>

</div>
</div><p>
<a class="anchor" name="a575b7d78b65c89953c9b265ab4a181e"></a><!-- doxytag: member="voltage_based_SoC.c::ConvertVoltageToSoC" ref="a575b7d78b65c89953c9b265ab4a181e" args="(uint16_t inputVoltage)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> ConvertVoltageToSoC           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a>&nbsp;</td>
          <td class="paramname"> <em>inputVoltage</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
SoC conversion. 
<p>
Conversion of voltage to SoC by using conversion table.<p>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>Soc (0 to 100) </dd></dl>

<p>Definition at line <a class="el" href="voltage__based__SoC_8c-source.html#l00282">282</a> of file <a class="el" href="voltage__based__SoC_8c-source.html">voltage_based_SoC.c</a>.</p>

<p>References <a class="el" href="voltage__based__SoC_8c-source.html#l00058">VOLTAGE_EMPTY</a>, <a class="el" href="voltage__based__SoC_8c-source.html#l00059">VOLTAGE_FULL</a>, <a class="el" href="voltage__based__SoC_8c-source.html#l00078">VOLTAGE_TABLE_SIZE</a>, and <a class="el" href="voltage__based__SoC_8c-source.html#l00079">VoltageTable</a>.</p>

<p>Referenced by <a class="el" href="voltage__based__SoC_8c-source.html#l00238">VBSoC_EstimatedSoC()</a>, <a class="el" href="voltage__based__SoC_8c-source.html#l00108">VBSoC_Init()</a>, and <a class="el" href="voltage__based__SoC_8c-source.html#l00151">VBSoC_Update()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00283"></a>00283 {
<a name="l00284"></a>00284     <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> socval = 0;
<a name="l00285"></a>00285     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> i = 1;
<a name="l00286"></a>00286       
<a name="l00287"></a>00287     <span class="comment">// Check if voltage is above treshold.</span>
<a name="l00288"></a>00288     <span class="keywordflow">if</span>(inputVoltage &gt;= <a class="code" href="voltage__based__SoC_8c.html#ef4930a056e88cc0bd77d0a91603222e">VOLTAGE_FULL</a>)
<a name="l00289"></a>00289     {
<a name="l00290"></a>00290         <span class="comment">// Set SoC to 100%.</span>
<a name="l00291"></a>00291         socval = 100;
<a name="l00292"></a>00292     }
<a name="l00293"></a>00293     <span class="comment">// Check if voltage is below treshold.</span>
<a name="l00294"></a>00294     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(inputVoltage &lt;= <a class="code" href="voltage__based__SoC_8c.html#492beb3ac8d746f1f463048c1dbffdeb">VOLTAGE_EMPTY</a>)
<a name="l00295"></a>00295     {
<a name="l00296"></a>00296         <span class="comment">// Set SoC to 0%.</span>
<a name="l00297"></a>00297         socval = 0;
<a name="l00298"></a>00298     }
<a name="l00299"></a>00299     <span class="comment">// Look up interval in table and interpolate</span>
<a name="l00300"></a>00300     <span class="keywordflow">else</span>
<a name="l00301"></a>00301     {
<a name="l00302"></a>00302         <span class="comment">// Find the actual interval in the voltage-SoC table and interpolate.</span>
<a name="l00303"></a>00303         <span class="keywordflow">while</span>((i&lt;<a class="code" href="voltage__based__SoC_8c.html#df6029d5c8be52478edf62fe248e1125">VOLTAGE_TABLE_SIZE</a>) &amp;&amp; (socval==0))
<a name="l00304"></a>00304         {
<a name="l00305"></a>00305             <span class="keywordflow">if</span>(<a class="code" href="voltage__based__SoC_8c.html#c28d1c0b39ee43aa53bce466804ad44b">VoltageTable</a>[0][i] &lt;= inputVoltage)
<a name="l00306"></a>00306             {
<a name="l00307"></a>00307                 socval = <a class="code" href="voltage__based__SoC_8c.html#c28d1c0b39ee43aa53bce466804ad44b">VoltageTable</a>[1][i] + (inputVoltage - <a class="code" href="voltage__based__SoC_8c.html#c28d1c0b39ee43aa53bce466804ad44b">VoltageTable</a>[0][i]) * ( <a class="code" href="voltage__based__SoC_8c.html#c28d1c0b39ee43aa53bce466804ad44b">VoltageTable</a>[1][i-1] - <a class="code" href="voltage__based__SoC_8c.html#c28d1c0b39ee43aa53bce466804ad44b">VoltageTable</a>[1][i] ) / (<a class="code" href="voltage__based__SoC_8c.html#c28d1c0b39ee43aa53bce466804ad44b">VoltageTable</a>[0][i-1] - <a class="code" href="voltage__based__SoC_8c.html#c28d1c0b39ee43aa53bce466804ad44b">VoltageTable</a>[0][i]);
<a name="l00308"></a>00308                 socval /= 10; <span class="comment">// To get percent instead of 0.1percent</span>
<a name="l00309"></a>00309             }
<a name="l00310"></a>00310 
<a name="l00311"></a>00311             i++;
<a name="l00312"></a>00312         }
<a name="l00313"></a>00313     }
<a name="l00314"></a>00314 
<a name="l00315"></a>00315     <span class="keywordflow">return</span> socval;
<a name="l00316"></a>00316 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="b8eeb992ca44aa7fcf70946ffad1be1e"></a><!-- doxytag: member="voltage_based_SoC.c::VBSoC_ConvertSoCToVoltage" ref="b8eeb992ca44aa7fcf70946ffad1be1e" args="(uint16_t inputsoc)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> VBSoC_ConvertSoCToVoltage           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a>&nbsp;</td>
          <td class="paramname"> <em>inputsoc</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
SoC-Voltage conversion. 
<p>
Conversion of SoC to voltage by using conversion table.<p>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>Voltage(OCV)in mV </dd></dl>

<p>Definition at line <a class="el" href="voltage__based__SoC_8c-source.html#l00365">365</a> of file <a class="el" href="voltage__based__SoC_8c-source.html">voltage_based_SoC.c</a>.</p>

<p>References <a class="el" href="voltage__based__SoC_8c-source.html#l00058">VOLTAGE_EMPTY</a>, <a class="el" href="voltage__based__SoC_8c-source.html#l00059">VOLTAGE_FULL</a>, <a class="el" href="voltage__based__SoC_8c-source.html#l00078">VOLTAGE_TABLE_SIZE</a>, and <a class="el" href="voltage__based__SoC_8c-source.html#l00079">VoltageTable</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00366"></a>00366 {
<a name="l00367"></a>00367   
<a name="l00368"></a>00368         <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> volval = 0;
<a name="l00369"></a>00369     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> i = 1;
<a name="l00370"></a>00370       
<a name="l00371"></a>00371     <span class="comment">// Check if soc is above 1000.</span>
<a name="l00372"></a>00372     <span class="keywordflow">if</span>(inputsoc &gt;= 1000){
<a name="l00373"></a>00373     
<a name="l00374"></a>00374             <span class="comment">// Set voltage to full voltage.</span>
<a name="l00375"></a>00375         volval = <a class="code" href="voltage__based__SoC_8c.html#ef4930a056e88cc0bd77d0a91603222e">VOLTAGE_FULL</a>;
<a name="l00376"></a>00376         
<a name="l00377"></a>00377     <span class="comment">// Check if soc is below 0.</span>
<a name="l00378"></a>00378     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(inputsoc &lt;= 0){
<a name="l00379"></a>00379     
<a name="l00380"></a>00380         <span class="comment">// Set voltage to empty voltage.</span>
<a name="l00381"></a>00381         volval = <a class="code" href="voltage__based__SoC_8c.html#492beb3ac8d746f1f463048c1dbffdeb">VOLTAGE_EMPTY</a>;
<a name="l00382"></a>00382         
<a name="l00383"></a>00383     <span class="comment">// Look up interval in table and interpolate</span>
<a name="l00384"></a>00384     }<span class="keywordflow">else</span>{
<a name="l00385"></a>00385         <span class="comment">// Find the actual interval in the voltage-SoC table and interpolate.</span>
<a name="l00386"></a>00386         <span class="keywordflow">while</span>((i&lt;<a class="code" href="voltage__based__SoC_8c.html#df6029d5c8be52478edf62fe248e1125">VOLTAGE_TABLE_SIZE</a>) &amp;&amp; (volval==0))
<a name="l00387"></a>00387         {
<a name="l00388"></a>00388             <span class="keywordflow">if</span>(<a class="code" href="voltage__based__SoC_8c.html#c28d1c0b39ee43aa53bce466804ad44b">VoltageTable</a>[1][i] &lt;= inputsoc)
<a name="l00389"></a>00389             {
<a name="l00390"></a>00390                 <span class="comment">//socval = VoltageTable[1][i] + (inputVoltage - VoltageTable[0][i]) * ( VoltageTable[1][i-1] - VoltageTable[1][i] ) / (VoltageTable[0][i-1] - VoltageTable[0][i]);</span>
<a name="l00391"></a>00391                 volval = <a class="code" href="voltage__based__SoC_8c.html#c28d1c0b39ee43aa53bce466804ad44b">VoltageTable</a>[0][i] + (inputsoc - <a class="code" href="voltage__based__SoC_8c.html#c28d1c0b39ee43aa53bce466804ad44b">VoltageTable</a>[1][i]) * ( <a class="code" href="voltage__based__SoC_8c.html#c28d1c0b39ee43aa53bce466804ad44b">VoltageTable</a>[0][i-1] - <a class="code" href="voltage__based__SoC_8c.html#c28d1c0b39ee43aa53bce466804ad44b">VoltageTable</a>[0][i] ) / (<a class="code" href="voltage__based__SoC_8c.html#c28d1c0b39ee43aa53bce466804ad44b">VoltageTable</a>[1][i-1] - <a class="code" href="voltage__based__SoC_8c.html#c28d1c0b39ee43aa53bce466804ad44b">VoltageTable</a>[1][i]);
<a name="l00392"></a>00392                 
<a name="l00393"></a>00393             }
<a name="l00394"></a>00394 
<a name="l00395"></a>00395             i++;
<a name="l00396"></a>00396         }
<a name="l00397"></a>00397     }
<a name="l00398"></a>00398 
<a name="l00399"></a>00399     <span class="keywordflow">return</span> volval;
<a name="l00400"></a>00400 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="ce1479a5937438f72f5357e20ee39db0"></a><!-- doxytag: member="voltage_based_SoC.c::VBSoC_EstimatedSoC" ref="ce1479a5937438f72f5357e20ee39db0" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> VBSoC_EstimatedSoC           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Returns the the latest estimated state of charge. 
<p>

<p>Definition at line <a class="el" href="voltage__based__SoC_8c-source.html#l00238">238</a> of file <a class="el" href="voltage__based__SoC_8c-source.html">voltage_based_SoC.c</a>.</p>

<p>References <a class="el" href="vadc_8h-source.html#l00089">CELL1</a>, <a class="el" href="vadc_8h-source.html#l00089">CELL2</a>, <a class="el" href="vadc_8h-source.html#l00089">CELL3</a>, <a class="el" href="vadc_8h-source.html#l00089">CELL4</a>, <a class="el" href="voltage__based__SoC_8c-source.html#l00337">ConvertDigitalToVoltage()</a>, <a class="el" href="voltage__based__SoC_8c-source.html#l00282">ConvertVoltageToSoC()</a>, and <a class="el" href="vadc_8c-source.html#l00450">VADC_readCellVoltage()</a>.</p>

<p>Referenced by <a class="el" href="main_8c-source.html#l00187">main()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00238"></a>00238                                   {
<a name="l00239"></a>00239     <a class="code" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a> result_volt;
<a name="l00240"></a>00240     <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> lowestCellVoltage;
<a name="l00241"></a>00241     
<a name="l00242"></a>00242     <span class="comment">// See which cell has the lowest voltage and use that in the calculations </span>
<a name="l00243"></a>00243 <span class="preprocessor">#if BATTPARAM_CELLS_IN_SERIES == 2</span>
<a name="l00244"></a>00244 <span class="preprocessor"></span>    {
<a name="l00245"></a>00245         <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> voltageCell1 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac671449b08613e4845ef2a5d657b8562c394673">CELL1</a>);
<a name="l00246"></a>00246         <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> voltageCell2 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac67144983bc57407aa6f82e37d495ff9d28ed81">CELL2</a>);
<a name="l00247"></a>00247         lowestCellVoltage = (voltageCell1 &lt; voltageCell2) ? voltageCell1 : voltageCell2;
<a name="l00248"></a>00248     }
<a name="l00249"></a>00249 <span class="preprocessor">#elif BATTPARAM_CELLS_IN_SERIES == 3</span>
<a name="l00250"></a>00250 <span class="preprocessor"></span>    {
<a name="l00251"></a>00251         <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> voltageCell1 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac671449b08613e4845ef2a5d657b8562c394673">CELL1</a>);
<a name="l00252"></a>00252         <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> voltageCell2 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac67144983bc57407aa6f82e37d495ff9d28ed81">CELL2</a>);
<a name="l00253"></a>00253         <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> voltageCell3 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac6714494ab35dc613899d959b4e063d736deb2d">CELL3</a>);
<a name="l00254"></a>00254         lowestCellVoltage = (voltageCell1 &lt; voltageCell2)      ? voltageCell1 : voltageCell2;
<a name="l00255"></a>00255         lowestCellVoltage = (lowestCellVoltage &lt; voltageCell3) ? lowestCellVoltage : voltageCell3;
<a name="l00256"></a>00256     }
<a name="l00257"></a>00257 <span class="preprocessor">#elif BATTPARAM_CELLS_IN_SERIES == 4</span>
<a name="l00258"></a>00258 <span class="preprocessor"></span>    {
<a name="l00259"></a>00259         <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> voltageCell1 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac671449b08613e4845ef2a5d657b8562c394673">CELL1</a>);
<a name="l00260"></a>00260         <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> voltageCell2 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac67144983bc57407aa6f82e37d495ff9d28ed81">CELL2</a>);
<a name="l00261"></a>00261         <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> voltageCell3 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac6714494ab35dc613899d959b4e063d736deb2d">CELL3</a>);
<a name="l00262"></a>00262         <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> voltageCell4 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac6714495dc31be69defc09d627e487ce6a56c1a">CELL4</a>);
<a name="l00263"></a>00263         lowestCellVoltage = (voltageCell1 &lt; voltageCell2)      ? voltageCell1 : voltageCell2;
<a name="l00264"></a>00264         lowestCellVoltage = (lowestCellVoltage &lt; voltageCell3) ? lowestCellVoltage : voltageCell3;
<a name="l00265"></a>00265         lowestCellVoltage = (lowestCellVoltage &lt; voltageCell4) ? lowestCellVoltage : voltageCell4;
<a name="l00266"></a>00266     }
<a name="l00267"></a>00267 <span class="preprocessor">#endif</span>
<a name="l00268"></a>00268 <span class="preprocessor"></span>    
<a name="l00269"></a>00269     <span class="comment">// Calculate the voltage drop from current (is negative while discharging, and positive while charging)</span>
<a name="l00270"></a>00270     result_volt = <a class="code" href="voltage__based__SoC_8c.html#711f47676ef41fa51a7721e95498474b" title="Voltage conversion.">ConvertDigitalToVoltage</a>();
<a name="l00271"></a>00271 
<a name="l00272"></a>00272     <span class="comment">// Estimate the SoC bases on cell voltage and voltage drop</span>
<a name="l00273"></a>00273     <span class="keywordflow">return</span> <a class="code" href="voltage__based__SoC_8c.html#a575b7d78b65c89953c9b265ab4a181e" title="SoC conversion.">ConvertVoltageToSoC</a>(lowestCellVoltage - result_volt );
<a name="l00274"></a>00274 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<p><center><img src="voltage__based__SoC_8c_ce1479a5937438f72f5357e20ee39db0_cgraph.gif" border="0" usemap="#voltage__based__SoC_8c_ce1479a5937438f72f5357e20ee39db0_cgraph_map" alt=""></center>
<map name="voltage__based__SoC_8c_ce1479a5937438f72f5357e20ee39db0_cgraph_map">
<area shape="rect" href="voltage__based__SoC_8c.html#711f47676ef41fa51a7721e95498474b" title="Voltage conversion." alt="" coords="212,31,369,57"><area shape="rect" href="voltage__based__SoC_8c.html#a575b7d78b65c89953c9b265ab4a181e" title="SoC conversion." alt="" coords="217,81,364,108"><area shape="rect" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage." alt="" coords="213,132,368,159"><area shape="rect" href="voltage__based__SoC_8c.html#568cb223b73b8d4d234670ebb0baefb6" title="Current conversion." alt="" coords="420,31,575,57"><area shape="rect" href="battery__current__monitoring_8c.html#6a557e4dca31a58b1683861bf8f154e6" title="Provides the offset calibrated current from the last CC&#45;ADC reading." alt="" coords="624,5,867,32"><area shape="rect" href="battery__current__monitoring_8c.html#d971791f4fc1c6f54e1d7d46fea20786" title="Convert CCADC ticks to mA." alt="" coords="673,56,817,83"></map>
</div>

</div>
</div><p>
<a class="anchor" name="78d7f4f0eb9968d7e0468dc7eb01c2a2"></a><!-- doxytag: member="voltage_based_SoC.c::VBSoC_Init" ref="78d7f4f0eb9968d7e0468dc7eb01c2a2" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void VBSoC_Init           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Calculate the initial SoC. 
<p>
This function updates both the estimated and open circuit SoC, run when sure the voltage is a open circuit voltage (for example, at startup after being shut down for a couple of days) 
<p>Definition at line <a class="el" href="voltage__based__SoC_8c-source.html#l00108">108</a> of file <a class="el" href="voltage__based__SoC_8c-source.html">voltage_based_SoC.c</a>.</p>

<p>References <a class="el" href="vadc_8h-source.html#l00089">CELL1</a>, <a class="el" href="vadc_8h-source.html#l00089">CELL2</a>, <a class="el" href="vadc_8h-source.html#l00089">CELL3</a>, <a class="el" href="vadc_8h-source.html#l00089">CELL4</a>, <a class="el" href="voltage__based__SoC_8c-source.html#l00282">ConvertVoltageToSoC()</a>, <a class="el" href="voltage__based__SoC_8c-source.html#l00087">OpenCircuitSoC</a>, and <a class="el" href="vadc_8c-source.html#l00450">VADC_readCellVoltage()</a>.</p>

<p>Referenced by <a class="el" href="main_8c-source.html#l00187">main()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00109"></a>00109 {
<a name="l00110"></a>00110     <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> lowestCellVoltage;
<a name="l00111"></a>00111     
<a name="l00112"></a>00112     <span class="comment">// See which cell has the lowest voltage and use that in the calculations </span>
<a name="l00113"></a>00113 <span class="preprocessor">#if BATTPARAM_CELLS_IN_SERIES == 2</span>
<a name="l00114"></a>00114 <span class="preprocessor"></span>    {
<a name="l00115"></a>00115         <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> voltageCell1 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac671449b08613e4845ef2a5d657b8562c394673">CELL1</a>);
<a name="l00116"></a>00116         <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> voltageCell2 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac67144983bc57407aa6f82e37d495ff9d28ed81">CELL2</a>);
<a name="l00117"></a>00117         lowestCellVoltage = (voltageCell1 &lt; voltageCell2) ? voltageCell1 : voltageCell2;
<a name="l00118"></a>00118     }
<a name="l00119"></a>00119 <span class="preprocessor">#elif BATTPARAM_CELLS_IN_SERIES == 3</span>
<a name="l00120"></a>00120 <span class="preprocessor"></span>    {
<a name="l00121"></a>00121         <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> voltageCell1 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac671449b08613e4845ef2a5d657b8562c394673">CELL1</a>);
<a name="l00122"></a>00122         <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> voltageCell2 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac67144983bc57407aa6f82e37d495ff9d28ed81">CELL2</a>);
<a name="l00123"></a>00123         <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> voltageCell3 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac6714494ab35dc613899d959b4e063d736deb2d">CELL3</a>);
<a name="l00124"></a>00124         lowestCellVoltage = (voltageCell1 &lt; voltageCell2)      ? voltageCell1 : voltageCell2;
<a name="l00125"></a>00125         lowestCellVoltage = (lowestCellVoltage &lt; voltageCell3) ? lowestCellVoltage : voltageCell3;
<a name="l00126"></a>00126     }
<a name="l00127"></a>00127 <span class="preprocessor">#elif BATTPARAM_CELLS_IN_SERIES == 4</span>
<a name="l00128"></a>00128 <span class="preprocessor"></span>    {
<a name="l00129"></a>00129         <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> voltageCell1 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac671449b08613e4845ef2a5d657b8562c394673">CELL1</a>);
<a name="l00130"></a>00130         <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> voltageCell2 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac67144983bc57407aa6f82e37d495ff9d28ed81">CELL2</a>);
<a name="l00131"></a>00131         <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> voltageCell3 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac6714494ab35dc613899d959b4e063d736deb2d">CELL3</a>);
<a name="l00132"></a>00132         <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> voltageCell4 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac6714495dc31be69defc09d627e487ce6a56c1a">CELL4</a>);
<a name="l00133"></a>00133         lowestCellVoltage = (voltageCell1 &lt; voltageCell2)      ? voltageCell1 : voltageCell2;
<a name="l00134"></a>00134         lowestCellVoltage = (lowestCellVoltage &lt; voltageCell3) ? lowestCellVoltage : voltageCell3;
<a name="l00135"></a>00135         lowestCellVoltage = (lowestCellVoltage &lt; voltageCell4) ? lowestCellVoltage : voltageCell4;
<a name="l00136"></a>00136     }
<a name="l00137"></a>00137 <span class="preprocessor">#endif</span>
<a name="l00138"></a>00138 <span class="preprocessor"></span>    
<a name="l00139"></a>00139     <a class="code" href="voltage__based__SoC_8c.html#99d4ca55297bd706857e2cb9d8868e7a">OpenCircuitSoC</a> = <a class="code" href="voltage__based__SoC_8c.html#a575b7d78b65c89953c9b265ab4a181e" title="SoC conversion.">ConvertVoltageToSoC</a>(lowestCellVoltage);
<a name="l00140"></a>00140 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<p><center><img src="voltage__based__SoC_8c_78d7f4f0eb9968d7e0468dc7eb01c2a2_cgraph.gif" border="0" usemap="#voltage__based__SoC_8c_78d7f4f0eb9968d7e0468dc7eb01c2a2_cgraph_map" alt=""></center>
<map name="voltage__based__SoC_8c_78d7f4f0eb9968d7e0468dc7eb01c2a2_cgraph_map">
<area shape="rect" href="voltage__based__SoC_8c.html#a575b7d78b65c89953c9b265ab4a181e" title="SoC conversion." alt="" coords="147,5,293,32"><area shape="rect" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage." alt="" coords="143,56,297,83"></map>
</div>

</div>
</div><p>
<a class="anchor" name="3cfbb7f6888a90eb03eeb14e7f4b00aa"></a><!-- doxytag: member="voltage_based_SoC.c::VBSoC_OCSoC" ref="3cfbb7f6888a90eb03eeb14e7f4b00aa" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> VBSoC_OCSoC           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Returns the the latest open circuit state of charge. 
<p>
Check how old this is with the VBSoC_OCSoCLastUpdated function 
<p>Definition at line <a class="el" href="voltage__based__SoC_8c-source.html#l00230">230</a> of file <a class="el" href="voltage__based__SoC_8c-source.html">voltage_based_SoC.c</a>.</p>

<p>References <a class="el" href="voltage__based__SoC_8c-source.html#l00087">OpenCircuitSoC</a>.</p>

<p>Referenced by <a class="el" href="main_8c-source.html#l00812">handleNewCellVoltage()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00230"></a>00230                            {
<a name="l00231"></a>00231     <span class="keywordflow">return</span> <a class="code" href="voltage__based__SoC_8c.html#99d4ca55297bd706857e2cb9d8868e7a">OpenCircuitSoC</a>;
<a name="l00232"></a>00232 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="95f0ec8dc8b936dc47ae56b0ef72b406"></a><!-- doxytag: member="voltage_based_SoC.c::VBSoC_OCSoCLastUpdated" ref="95f0ec8dc8b936dc47ae56b0ef72b406" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> VBSoC_OCSoCLastUpdated           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Returns how many seconds ago the open circuit voltage SoC was updated. 
<p>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>Seconds since last time OCV SoC was updated </dd></dl>

<p>Definition at line <a class="el" href="voltage__based__SoC_8c-source.html#l00221">221</a> of file <a class="el" href="voltage__based__SoC_8c-source.html">voltage_based_SoC.c</a>.</p>

<p>References <a class="el" href="voltage__based__SoC_8c-source.html#l00093">LastUpdated</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00221"></a>00221                                       {
<a name="l00222"></a>00222     <span class="keywordflow">return</span> <a class="code" href="voltage__based__SoC_8c.html#c0306252998313f3e18faf6fc4256f2a">LastUpdated</a>;
<a name="l00223"></a>00223 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="96735c5df96b87b60cfd1222e1420adb"></a><!-- doxytag: member="voltage_based_SoC.c::VBSoC_ResetTimer" ref="96735c5df96b87b60cfd1222e1420adb" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void VBSoC_ResetTimer           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Reset the relaxation timer. 
<p>
Run this function when device not is in standby mode 
<p>Definition at line <a class="el" href="voltage__based__SoC_8c-source.html#l00212">212</a> of file <a class="el" href="voltage__based__SoC_8c-source.html">voltage_based_SoC.c</a>.</p>

<p>References <a class="el" href="voltage__based__SoC_8c-source.html#l00096">relaxationTimer</a>, and <a class="el" href="rtc_8c-source.html#l00067">RTC_GetMinutes()</a>.</p>

<p>Referenced by <a class="el" href="main_8c-source.html#l00904">handleNewCCADCResult()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00212"></a>00212                             {
<a name="l00213"></a>00213     <a class="code" href="voltage__based__SoC_8c.html#1a9192b7d255c0058c58d63b7ba4f0ae">relaxationTimer</a> = <a class="code" href="rtc_8c.html#7fd4050fbdd5b78bdc45336b7f9c1724" title="Return number of minutes since start.">RTC_GetMinutes</a>() + battParams.openCircuitRelaxationTime;
<a name="l00214"></a>00214 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<p><center><img src="voltage__based__SoC_8c_96735c5df96b87b60cfd1222e1420adb_cgraph.gif" border="0" usemap="#voltage__based__SoC_8c_96735c5df96b87b60cfd1222e1420adb_cgraph_map" alt=""></center>
<map name="voltage__based__SoC_8c_96735c5df96b87b60cfd1222e1420adb_cgraph_map">
<area shape="rect" href="rtc_8c.html#7fd4050fbdd5b78bdc45336b7f9c1724" title="Return number of minutes since start." alt="" coords="192,5,312,32"></map>
</div>

</div>
</div><p>
<a class="anchor" name="9708e584eda79bcf685b716b25e66765"></a><!-- doxytag: member="voltage_based_SoC.c::VBSoC_Update" ref="9708e584eda79bcf685b716b25e66765" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool VBSoC_Update           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Updates the SoC. 
<p>
Should be run once a second<p>
Updates open circuit SoC if have been in relaxation for battParams.openCircuitRelaxationTime<p>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>Returns true if openCircuitSoC was updated </dd></dl>

<p>Definition at line <a class="el" href="voltage__based__SoC_8c-source.html#l00151">151</a> of file <a class="el" href="voltage__based__SoC_8c-source.html">voltage_based_SoC.c</a>.</p>

<p>References <a class="el" href="vadc_8h-source.html#l00089">CELL1</a>, <a class="el" href="vadc_8h-source.html#l00089">CELL2</a>, <a class="el" href="vadc_8h-source.html#l00089">CELL3</a>, <a class="el" href="vadc_8h-source.html#l00089">CELL4</a>, <a class="el" href="voltage__based__SoC_8c-source.html#l00282">ConvertVoltageToSoC()</a>, <a class="el" href="voltage__based__SoC_8c-source.html#l00093">LastUpdated</a>, <a class="el" href="voltage__based__SoC_8c-source.html#l00087">OpenCircuitSoC</a>, <a class="el" href="voltage__based__SoC_8c-source.html#l00096">relaxationTimer</a>, <a class="el" href="rtc_8c-source.html#l00067">RTC_GetMinutes()</a>, and <a class="el" href="vadc_8c-source.html#l00450">VADC_readCellVoltage()</a>.</p>

<p>Referenced by <a class="el" href="main_8c-source.html#l00812">handleNewCellVoltage()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00152"></a>00152 {
<a name="l00153"></a>00153     <span class="comment">// Don't want LastUpdated to overflow back to zero, but that it stays at </span>
<a name="l00154"></a>00154     <span class="comment">// 65534 seconds doesn't matter.</span>
<a name="l00155"></a>00155     <span class="comment">// It shouldn't really be this long between LastUpdated is reset, but better</span>
<a name="l00156"></a>00156     <span class="comment">// to be safe.</span>
<a name="l00157"></a>00157     <span class="keywordflow">if</span>(<a class="code" href="voltage__based__SoC_8c.html#c0306252998313f3e18faf6fc4256f2a">LastUpdated</a> &lt; 65535) {
<a name="l00158"></a>00158         ++<a class="code" href="voltage__based__SoC_8c.html#c0306252998313f3e18faf6fc4256f2a">LastUpdated</a>;
<a name="l00159"></a>00159     }
<a name="l00160"></a>00160     
<a name="l00161"></a>00161     <span class="comment">// Check if it's time to update the open circuit SoC</span>
<a name="l00162"></a>00162     <span class="keywordflow">if</span>(<a class="code" href="rtc_8c.html#7fd4050fbdd5b78bdc45336b7f9c1724" title="Return number of minutes since start.">RTC_GetMinutes</a>() == <a class="code" href="voltage__based__SoC_8c.html#1a9192b7d255c0058c58d63b7ba4f0ae">relaxationTimer</a>) {
<a name="l00163"></a>00163         <span class="comment">// Only update if it was more than 30 seconds ago last time</span>
<a name="l00164"></a>00164         <span class="comment">// TODO: maybe a define, but the actual value is not that important, its just to avoid </span>
<a name="l00165"></a>00165         <span class="comment">//       doing the calculations every second. And since the current is low (or else </span>
<a name="l00166"></a>00166         <span class="comment">//       it wouldn't get here) the state of charge changes very slowly</span>
<a name="l00167"></a>00167         <span class="keywordflow">if</span>(<a class="code" href="voltage__based__SoC_8c.html#c0306252998313f3e18faf6fc4256f2a">LastUpdated</a> &gt;= 30) {
<a name="l00168"></a>00168             <span class="comment">// See which cell has the lowest voltage and use that in the calculations </span>
<a name="l00169"></a>00169             <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> lowestCellVoltage;
<a name="l00170"></a>00170             
<a name="l00171"></a>00171 <span class="preprocessor">#if BATTPARAM_CELLS_IN_SERIES == 2</span>
<a name="l00172"></a>00172 <span class="preprocessor"></span>            {
<a name="l00173"></a>00173                 <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> voltageCell1 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac671449b08613e4845ef2a5d657b8562c394673">CELL1</a>);
<a name="l00174"></a>00174                 <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> voltageCell2 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac67144983bc57407aa6f82e37d495ff9d28ed81">CELL2</a>);
<a name="l00175"></a>00175                 lowestCellVoltage = (voltageCell1 &lt; voltageCell2) ? voltageCell1 : voltageCell2;
<a name="l00176"></a>00176             }
<a name="l00177"></a>00177 <span class="preprocessor">#elif BATTPARAM_CELLS_IN_SERIES == 3</span>
<a name="l00178"></a>00178 <span class="preprocessor"></span>            {
<a name="l00179"></a>00179                 <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> voltageCell1 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac671449b08613e4845ef2a5d657b8562c394673">CELL1</a>);
<a name="l00180"></a>00180                 <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> voltageCell2 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac67144983bc57407aa6f82e37d495ff9d28ed81">CELL2</a>);
<a name="l00181"></a>00181                 <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> voltageCell3 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac6714494ab35dc613899d959b4e063d736deb2d">CELL3</a>);
<a name="l00182"></a>00182                 lowestCellVoltage = (voltageCell1 &lt; voltageCell2)      ? voltageCell1 : voltageCell2;
<a name="l00183"></a>00183                 lowestCellVoltage = (lowestCellVoltage &lt; voltageCell3) ? lowestCellVoltage : voltageCell3;
<a name="l00184"></a>00184             }
<a name="l00185"></a>00185 <span class="preprocessor">#elif BATTPARAM_CELLS_IN_SERIES == 4</span>
<a name="l00186"></a>00186 <span class="preprocessor"></span>            {
<a name="l00187"></a>00187                 <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> voltageCell1 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac671449b08613e4845ef2a5d657b8562c394673">CELL1</a>);
<a name="l00188"></a>00188                 <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> voltageCell2 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac67144983bc57407aa6f82e37d495ff9d28ed81">CELL2</a>);
<a name="l00189"></a>00189                 <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> voltageCell3 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac6714494ab35dc613899d959b4e063d736deb2d">CELL3</a>);
<a name="l00190"></a>00190                 <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> voltageCell4 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac6714495dc31be69defc09d627e487ce6a56c1a">CELL4</a>);
<a name="l00191"></a>00191                 lowestCellVoltage = (voltageCell1 &lt; voltageCell2)      ? voltageCell1 : voltageCell2;
<a name="l00192"></a>00192                 lowestCellVoltage = (lowestCellVoltage &lt; voltageCell3) ? lowestCellVoltage : voltageCell3;
<a name="l00193"></a>00193                 lowestCellVoltage = (lowestCellVoltage &lt; voltageCell4) ? lowestCellVoltage : voltageCell4;
<a name="l00194"></a>00194             }
<a name="l00195"></a>00195 <span class="preprocessor">#endif</span>
<a name="l00196"></a>00196 <span class="preprocessor"></span>            
<a name="l00197"></a>00197             <a class="code" href="voltage__based__SoC_8c.html#99d4ca55297bd706857e2cb9d8868e7a">OpenCircuitSoC</a> = <a class="code" href="voltage__based__SoC_8c.html#a575b7d78b65c89953c9b265ab4a181e" title="SoC conversion.">ConvertVoltageToSoC</a>(lowestCellVoltage);
<a name="l00198"></a>00198             <a class="code" href="voltage__based__SoC_8c.html#c0306252998313f3e18faf6fc4256f2a">LastUpdated</a> = 0;
<a name="l00199"></a>00199             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00200"></a>00200         }
<a name="l00201"></a>00201     }
<a name="l00202"></a>00202     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00203"></a>00203 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<p><center><img src="voltage__based__SoC_8c_9708e584eda79bcf685b716b25e66765_cgraph.gif" border="0" usemap="#voltage__based__SoC_8c_9708e584eda79bcf685b716b25e66765_cgraph_map" alt=""></center>
<map name="voltage__based__SoC_8c_9708e584eda79bcf685b716b25e66765_cgraph_map">
<area shape="rect" href="voltage__based__SoC_8c.html#a575b7d78b65c89953c9b265ab4a181e" title="SoC conversion." alt="" coords="171,5,317,32"><area shape="rect" href="rtc_8c.html#7fd4050fbdd5b78bdc45336b7f9c1724" title="Return number of minutes since start." alt="" coords="184,56,304,83"><area shape="rect" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage." alt="" coords="167,107,321,133"></map>
</div>

</div>
</div><p>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="c0306252998313f3e18faf6fc4256f2a"></a><!-- doxytag: member="voltage_based_SoC.c::LastUpdated" ref="c0306252998313f3e18faf6fc4256f2a" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> <a class="el" href="voltage__based__SoC_8c.html#c0306252998313f3e18faf6fc4256f2a">LastUpdated</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="voltage__based__SoC_8c-source.html#l00093">93</a> of file <a class="el" href="voltage__based__SoC_8c-source.html">voltage_based_SoC.c</a>.</p>

<p>Referenced by <a class="el" href="voltage__based__SoC_8c-source.html#l00221">VBSoC_OCSoCLastUpdated()</a>, and <a class="el" href="voltage__based__SoC_8c-source.html#l00151">VBSoC_Update()</a>.</p>

</div>
</div><p>
<a class="anchor" name="99d4ca55297bd706857e2cb9d8868e7a"></a><!-- doxytag: member="voltage_based_SoC.c::OpenCircuitSoC" ref="99d4ca55297bd706857e2cb9d8868e7a" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> <a class="el" href="voltage__based__SoC_8c.html#99d4ca55297bd706857e2cb9d8868e7a">OpenCircuitSoC</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="voltage__based__SoC_8c-source.html#l00087">87</a> of file <a class="el" href="voltage__based__SoC_8c-source.html">voltage_based_SoC.c</a>.</p>

<p>Referenced by <a class="el" href="voltage__based__SoC_8c-source.html#l00108">VBSoC_Init()</a>, <a class="el" href="voltage__based__SoC_8c-source.html#l00230">VBSoC_OCSoC()</a>, and <a class="el" href="voltage__based__SoC_8c-source.html#l00151">VBSoC_Update()</a>.</p>

</div>
</div><p>
<a class="anchor" name="1a9192b7d255c0058c58d63b7ba4f0ae"></a><!-- doxytag: member="voltage_based_SoC.c::relaxationTimer" ref="1a9192b7d255c0058c58d63b7ba4f0ae" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="el" href="voltage__based__SoC_8c.html#1a9192b7d255c0058c58d63b7ba4f0ae">relaxationTimer</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="voltage__based__SoC_8c-source.html#l00096">96</a> of file <a class="el" href="voltage__based__SoC_8c-source.html">voltage_based_SoC.c</a>.</p>

<p>Referenced by <a class="el" href="voltage__based__SoC_8c-source.html#l00212">VBSoC_ResetTimer()</a>, and <a class="el" href="voltage__based__SoC_8c-source.html#l00151">VBSoC_Update()</a>.</p>

</div>
</div><p>
<a class="anchor" name="c28d1c0b39ee43aa53bce466804ad44b"></a><!-- doxytag: member="voltage_based_SoC.c::VoltageTable" ref="c28d1c0b39ee43aa53bce466804ad44b" args="[2][21]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__flash <a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> <a class="el" href="voltage__based__SoC_8c.html#c28d1c0b39ee43aa53bce466804ad44b">VoltageTable</a>[2][21]          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<b>Initial value:</b><div class="fragment"><pre class="fragment"> { 
    {4180,4112,4074,4013,3973,3922,3858,3810,3782,3762,3751,3725,3701,3684,3678,3663,3607,3511,3350,3200,2771 },
    {1000,950 ,900 ,850 ,800 ,700 ,600 ,500 ,400 ,300 ,250 ,200 ,150 ,120 ,100 ,80  ,60  ,40  ,20  ,10  ,0 } }
</pre></div>
<p>Definition at line <a class="el" href="voltage__based__SoC_8c-source.html#l00079">79</a> of file <a class="el" href="voltage__based__SoC_8c-source.html">voltage_based_SoC.c</a>.</p>

<p>Referenced by <a class="el" href="voltage__based__SoC_8c-source.html#l00282">ConvertVoltageToSoC()</a>, and <a class="el" href="voltage__based__SoC_8c-source.html#l00365">VBSoC_ConvertSoCToVoltage()</a>.</p>

</div>
</div><p>
</div>
<html>
 <head>
  <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
  <title>@DOC_TITLE@</title>
  <link href="doxygen.css" rel="stylesheet" type="text/css">
</head>
<body>

<table width="100%" height="10%" bgcolor="#FFFFFF">
  <tr>
    <td colspan="6" height="1" background="blue.gif"></td>
  </tr>

  <tr>
    <td colspan="6">
    <address style="align: right;"><small>
Generated on Wed Aug 4 11:02:27 2010 for AVR474 Firmware User's Guide for SB202 by <a href="http://www.doxygen.org/index.html"><img src="doxygen.png" alt="doxygen" align="middle" border=0></a> 1.5.6</small></address>
    </td>
  </tr>

</table>
