<html xmlns:v="urn:schemas-microsoft-com:vml"
xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns="http://www.w3.org/TR/REC-html40">

<head>
<meta http-equiv=Content-Type content="text/html; charset=iso-8859-1">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 11">
<meta name=Originator content="Microsoft Word 11">
<link rel=File-List href="atmel-header_files/filelist.xml">
<link rel=Edit-Time-Data href="atmel-header_files/editdata.mso">
<!--[if !mso]>
<style>
v\:* {behavior:url(#default#VML);}
o\:* {behavior:url(#default#VML);}
w\:* {behavior:url(#default#VML);}
.shape {behavior:url(#default#VML);}
</style>
<![endif]-->
<title>@DOC_TITLE@</title>
<!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>ping.zhou</o:Author>
  <o:Template>Normal</o:Template>
  <o:LastAuthor>ping.zhou</o:LastAuthor>
  <o:Revision>3</o:Revision>
  <o:TotalTime>0</o:TotalTime>
  <o:Created>2010-08-04T02:58:00Z</o:Created>
  <o:LastSaved>2010-08-04T02:58:00Z</o:LastSaved>
  <o:Pages>1</o:Pages>
  <o:Words>51</o:Words>
  <o:Characters>297</o:Characters>
  <o:Company>Atmel</o:Company>
  <o:Lines>2</o:Lines>
  <o:Paragraphs>1</o:Paragraphs>
  <o:CharactersWithSpaces>347</o:CharactersWithSpaces>
  <o:Version>11.9999</o:Version>
 </o:DocumentProperties>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:Zoom>150</w:Zoom>
  <w:SpellingState>Clean</w:SpellingState>
  <w:GrammarState>Clean</w:GrammarState>
  <w:ValidateAgainstSchemas/>
  <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid>
  <w:IgnoreMixedContent>false</w:IgnoreMixedContent>
  <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText>
  <w:Compatibility>
   <w:UseFELayout/>
  </w:Compatibility>
  <w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel>
 </w:WordDocument>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:LatentStyles DefLockedState="false" LatentStyleCount="156">
 </w:LatentStyles>
</xml><![endif]-->
<link rel=Stylesheet type="text/css" media=all href="doxygen.css">
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Helvetica;
	panose-1:2 11 6 4 2 2 2 2 2 4;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:536902279 -2147483648 8 0 511 0;}
@font-face
	{font-family:SimSun;
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-alt:SimSun;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 135135232 16 0 262145 0;}
@font-face
	{font-family:SimSun;
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 135135232 16 0 262145 0;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:SimSun;}
p
	{font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:SimSun;}
span.SpellE
	{mso-style-name:"";
	mso-spl-e:yes;}
@page Section1
	{size:8.5in 11.0in;
	margin:1.0in 1.25in 1.0in 1.25in;
	mso-header-margin:.5in;
	mso-footer-margin:.5in;
	mso-paper-source:0;}
div.Section1
	{page:Section1;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
	{mso-style-name:"Table Normal";
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-parent:"";
	mso-padding-alt:0in 5.4pt 0in 5.4pt;
	mso-para-margin:0in;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-ansi-language:#0400;
	mso-fareast-language:#0400;
	mso-bidi-language:#0400;}
</style>
<![endif]--><!--[if gte mso 9]><xml>
 <o:shapedefaults v:ext="edit" spidmax="2050"/>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <o:shapelayout v:ext="edit">
  <o:idmap v:ext="edit" data="1"/>
 </o:shapelayout></xml><![endif]-->
</head>

<body lang=EN-US link=blue vlink=blue style='tab-interval:.5in'>

<div class=Section1>

<table class=MsoNormalTable border=0 cellpadding=0 width="100%"
 style='width:100.0%;mso-cellspacing:1.5pt;background:white'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes'>
  <td style='padding:.75pt .75pt .75pt .75pt'>
  <p><a href="http://www.atmel.com"><span style='text-decoration:none;
  text-underline:none'><img border=0 width=109 height=50 id="_x0000_i1025"
  src=atmel.jpg></span></a></p>
  <p class=MsoNormal><o:p>&nbsp;</o:p></p>
  </td>
  <td style='padding:.75pt .75pt .75pt .75pt'>
  <p class=MsoNormal><span class=SpellE><strong><span style='font-size:24.0pt;
  font-family:Helvetica;color:black'>SmartBattery</span></strong></span><strong><span
  style='font-size:24.0pt;font-family:Helvetica;color:black'> Device
  Application Note</span></strong></p>
  </td>
  <td style='padding:.75pt .75pt .75pt .75pt'>
  <p><a href="http://www.atmel.com/products/AVR"><span style='text-decoration:
  none;text-underline:none'><img border=0 width=138 height=77 id="_x0000_i1026"
  src="AVR_logo_blue.gif"></span></a></p>
  <p class=MsoNormal><o:p>&nbsp;</o:p></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:1;mso-yfti-lastrow:yes;height:.75pt'>
  <td colspan=3 style='padding:.75pt .75pt .75pt .75pt;height:.75pt'
  background=blue.gif>
  <p class=MsoNormal><span style='font-size:1.0pt;mso-bidi-font-size:12.0pt'><o:p>&nbsp;</o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

</div>

</body>

</html>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
<h1>main.c</h1><a href="main_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*This file has been prepared for Doxygen automatic documentation generation.*/</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include "<a class="code" href="common_8h.html" title="Common headerfile.">common.h</a>"</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include "<a class="code" href="ATmega32HVB__signature_8h.html" title="Signature row defines for ATmega16HVB and ATmega32HVB.">ATmega32HVB_signature.h</a>"</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include "<a class="code" href="bandgap_8h.html" title="Headerfile for bandgap.c.">bandgap.h</a>"</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include "<a class="code" href="vadc_8h.html" title="Headerfile for vadc_usage.c.">vadc.h</a>"</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include "<a class="code" href="ccadc_8h.html" title="CCADC module header file.">ccadc.h</a>"</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include "<a class="code" href="smbus_8h.html" title="Headerfile for smbus.c.">smbus.h</a>"</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include "<a class="code" href="authentication_8h.html" title="Headerfile for authentication.c.">authentication.h</a>"</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include "<a class="code" href="battery__protection_8h.html" title="Header file for Battery Protection peripheral module driver.">battery_protection.h</a>"</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include "<a class="code" href="battery__pack__parameters_8h.html" title="Definition file for a smart battery pack.">battery_pack_parameters.h</a>"</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include "<a class="code" href="battery__voltage__monitoring_8h.html" title="Header file for bettery voltage monitoring firmware module.">battery_voltage_monitoring.h</a>"</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include "<a class="code" href="battery__current__monitoring_8h.html" title="Header file for CC-ADC result processing firmware module.">battery_current_monitoring.h</a>"</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include "<a class="code" href="fet__control_8h.html" title="Header file for FET control peripheral module driver.">fet_control.h</a>"</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include "<a class="code" href="watchdog_8h.html" title="Header file for Watchdog Timer peripheral module driver.">watchdog.h</a>"</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include "<a class="code" href="rc__calibration_8h.html" title="Defines and prototypes for rc_calibration.c.">rc_calibration.h</a>"</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include "<a class="code" href="pwr__mgmnt_8h.html" title="Contains defines for setting of sleep modes and entering sleep, and for disabling...">pwr_mgmnt.h</a>"</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include "<a class="code" href="ntc__rh163h103f_8h.html" title="Headerfile for ntc_rh163h103f.c.">ntc_rh163h103f.h</a>"</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include "<a class="code" href="rtc_8h.html" title="Headerfile for rtc.c.">rtc.h</a>"</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include "<a class="code" href="cc__gas__gauging_8h.html" title="Gas gauging header file.">cc_gas_gauging.h</a>"</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include "<a class="code" href="gas__gauging_8h.html" title="Gas gauging module for calculating time to empty, time to full etc.">gas_gauging.h</a>"</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include "<a class="code" href="vreg__mon_8h.html" title="Headerfile for vreg_mon.c.">vreg_mon.h</a>"</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include "<a class="code" href="voltage__based__SoC_8h.html" title="Contains defines, typedefinitions and functions prototypes for voltage_based_SoC...">voltage_based_SoC.h</a>"</span>
<a name="l00071"></a>00071 <span class="preprocessor">#include "<a class="code" href="timer_8h.html" title="Headerfile for timer.c.">timer.h</a>"</span>
<a name="l00072"></a>00072 
<a name="l00073"></a>00073 
<a name="l00074"></a>00074 <span class="comment">/******************************************************************************</span>
<a name="l00075"></a>00075 <span class="comment"> File scope variables</span>
<a name="l00076"></a>00076 <span class="comment">*******************************************************************************/</span>
<a name="l00078"></a><a class="code" href="main_8c.html#87de25a56cfc5857df059f510fe3b049">00078</a> <span class="keyword">static</span> <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> <a class="code" href="main_8c.html#87de25a56cfc5857df059f510fe3b049" title="The internal chip temperature in 0.1 Kelvin.">coreTemperature</a> = <a class="code" href="battery__pack__parameters_8h.html#815bb6d2da3fd5f3750a42e5eb3bf3bb" title="Convert degrees Celsius to Kelvin.">DEGREES_C_TO_K</a>( 70 <a class="code" href="battery__pack__parameters_8h.html#cc5ec578ced5d032234e83703b4b352a" title="Units: degrees Celcius.">dC</a>);
<a name="l00079"></a>00079 
<a name="l00081"></a><a class="code" href="main_8c.html#0f7149db7892cd59cfc8806e789ec906">00081</a> <span class="keyword">static</span> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="main_8c.html#0f7149db7892cd59cfc8806e789ec906" title="State of Charge.">SoC_State</a> = 50;
<a name="l00082"></a>00082 
<a name="l00083"></a>00083 <span class="preprocessor">#if CELLTEMPERATURE_INPUTS != 0</span>
<a name="l00085"></a>00085 <span class="preprocessor">static uint16_t cellTemperature[CELLTEMPERATURE_INPUTS];</span>
<a name="l00086"></a>00086 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00087"></a>00087 <span class="preprocessor"></span>
<a name="l00089"></a><a class="code" href="main_8c.html#9681fe281db5d507e970242053df7c67">00089</a> <span class="keyword">static</span> <span class="keyword">volatile</span> <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> <a class="code" href="main_8c.html#9681fe281db5d507e970242053df7c67" title="Variable for storing the latest calculated slow RC period.">slowRcOscillatorPeriod</a> = <a class="code" href="rc__calibration_8h.html#c78616992bc1a0ac1bad19e62237d33a" title="Nominal period time for the Slow RC oscillator (1/131072), scaled by 2^10.">SLOW_RC_NOMINAL_PERIOD</a>;
<a name="l00090"></a>00090 
<a name="l00092"></a><a class="code" href="main_8c.html#6e04271edf1604d84995f6bbdf432911">00092</a> <a class="code" href="unionSBS__command__union.html">SBS_command_t</a> <a class="code" href="main_8c.html#6e04271edf1604d84995f6bbdf432911" title="Struct that contains incoming messages from the communication.">sbs</a>;
<a name="l00093"></a><a class="code" href="main_8c.html#79cdcc825d6c642cfb1115bb757a4e82">00093</a> <a class="code" href="unionSBS__command__union.html">SBS_command_t</a> *<a class="code" href="main_8c.html#79cdcc825d6c642cfb1115bb757a4e82">sbsReply</a>;
<a name="l00094"></a>00094 
<a name="l00096"></a>00096 <span class="keyword">struct </span>{
<a name="l00097"></a><a class="code" href="main_8c.html#04d41ec6a430742b5b7baab3caadcf85">00097</a>     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="main_8c.html#04d41ec6a430742b5b7baab3caadcf85">criticalConditionDetected</a> : 1 ;
<a name="l00098"></a><a class="code" href="main_8c.html#97b7f3f2f99cd0a500f946a26c7d8911">00098</a>     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="main_8c.html#97b7f3f2f99cd0a500f946a26c7d8911">cellTemperatureTooLow</a> : 1;
<a name="l00099"></a><a class="code" href="main_8c.html#c8261f86bd31024d75a639a04040c28d">00099</a>     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="main_8c.html#c8261f86bd31024d75a639a04040c28d">cellTemperatureTooHigh</a> : 1;
<a name="l00100"></a><a class="code" href="main_8c.html#9c943b3e23a884cb7eabaa355d1db5e7">00100</a>     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="main_8c.html#9c943b3e23a884cb7eabaa355d1db5e7">voltageTooHigh</a> : 1;
<a name="l00101"></a><a class="code" href="main_8c.html#d4be0779d9f1d004afe7a83364d7a3a1">00101</a>     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="main_8c.html#d4be0779d9f1d004afe7a83364d7a3a1">voltageTooLow</a> : 1;
<a name="l00102"></a><a class="code" href="main_8c.html#8f56cf8df255bd3de9d42ed2a681df8b">00102</a>     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="main_8c.html#8f56cf8df255bd3de9d42ed2a681df8b">reoccuringChargeProtection</a> : 1;
<a name="l00103"></a><a class="code" href="main_8c.html#bd715c173c7a67cb0611c5b862548bfe">00103</a>     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="main_8c.html#bd715c173c7a67cb0611c5b862548bfe">checksumFailure</a> : 1;
<a name="l00104"></a>00104     
<a name="l00105"></a>00105 } <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a> = {0,0,0,0,0,0,0};
<a name="l00106"></a>00106 
<a name="l00108"></a>00108 <span class="keyword">struct </span>{
<a name="l00109"></a><a class="code" href="main_8c.html#462539603ea0d29e094108bc39f3fdac">00109</a>     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="main_8c.html#462539603ea0d29e094108bc39f3fdac" title="Set when current is lower than defined in battParams.activeCurrentThreshold.">systemIsInStandby</a> : 1; 
<a name="l00110"></a><a class="code" href="main_8c.html#c4738345f0e8b817244836ed9fe98fad">00110</a>     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="main_8c.html#c4738345f0e8b817244836ed9fe98fad" title="Set at startup and cleared when DUVR mode is disabled.">inDUVR</a> : 1; 
<a name="l00111"></a><a class="code" href="main_8c.html#ecaaf5e1ad687894c57c8bbff3b9ce00">00111</a>     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="main_8c.html#ecaaf5e1ad687894c57c8bbff3b9ce00" title="Charging is prohibited until a discharge current is detected.">chargingProhibited</a> : 1; 
<a name="l00112"></a><a class="code" href="main_8c.html#ff3759c14659cf55e20155bb74f580e5">00112</a>     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="main_8c.html#ff3759c14659cf55e20155bb74f580e5" title="Discharging is prohibited until a charge current is detected.">dischargingProhibited</a> : 1; 
<a name="l00113"></a><a class="code" href="main_8c.html#ca9206b0cf67fe28a16473f6f656ba23">00113</a>     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="main_8c.html#ca9206b0cf67fe28a16473f6f656ba23" title="Gets set when trying to power-off, but it&amp;#39;s disabled (can be used when debugging)...">simulatePowerOff</a> : 1; 
<a name="l00114"></a><a class="code" href="main_8c.html#ef5993d3ef62fef123e62ffd3b8b2cff">00114</a>     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="main_8c.html#ef5993d3ef62fef123e62ffd3b8b2cff" title="Set to 1 if remainingCapacity is based on an estimated SoC from the voltage based...">remainingCapacityInaccurate</a> : 1; 
<a name="l00115"></a>00115     
<a name="l00120"></a><a class="code" href="main_8c.html#942d8adf71f16b8cbbb1111c383f379f">00120</a>     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="main_8c.html#942d8adf71f16b8cbbb1111c383f379f">poweroffCondition</a> : 1;
<a name="l00121"></a>00121 } <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a> = {0,0,0,0,0,0,0};
<a name="l00122"></a>00122 
<a name="l00123"></a>00123 
<a name="l00124"></a>00124 <span class="keyword">struct </span>{
<a name="l00126"></a><a class="code" href="main_8c.html#cb09f84883246c4c21bb39dbd2565e31">00126</a>     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="main_8c.html#cb09f84883246c4c21bb39dbd2565e31" title="Set when the remaining capacity is lower than the set alarm value in battParams.remainingCapacityAla...">remainingCapacityAlarm</a> : 1;
<a name="l00128"></a><a class="code" href="main_8c.html#e3c05cbe0281548a80de435a2aab1fd9">00128</a>     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="main_8c.html#e3c05cbe0281548a80de435a2aab1fd9" title="Set when the remaining time at the average current is lower then the alarm value...">remainingTimeAlarm</a> : 1;
<a name="l00130"></a><a class="code" href="main_8c.html#a80e8811d1640e58b33ffb2bf7b5986b">00130</a>     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="main_8c.html#a80e8811d1640e58b33ffb2bf7b5986b" title="Set when discharge should be terminated as soon as possible. Cleared when a charge...">terminateDischarge</a> : 1;
<a name="l00132"></a><a class="code" href="main_8c.html#54d92974e72b4f72a5a452dcf70e6bfd">00132</a>     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="main_8c.html#54d92974e72b4f72a5a452dcf70e6bfd" title="Set when fully charged and cleared when a discharge current is noticed.">fullyCharged</a> : 1;
<a name="l00135"></a><a class="code" href="main_8c.html#0a6f5bc070367e75ddf660a2f7f6d91b">00135</a>     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="main_8c.html#0a6f5bc070367e75ddf660a2f7f6d91b">fullyDischarged</a> : 1;
<a name="l00136"></a>00136     
<a name="l00138"></a><a class="code" href="main_8c.html#f21e30d2c62d3fc2f578c2f3867852d8">00138</a>     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="main_8c.html#f21e30d2c62d3fc2f578c2f3867852d8" title="Force charge FET disabled.">forceChargeFETDisabled</a> : 1;
<a name="l00140"></a><a class="code" href="main_8c.html#7cbdf2e6fed5f540ac479fde1947306f">00140</a>     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="main_8c.html#7cbdf2e6fed5f540ac479fde1947306f" title="Force discharge FET disabled.">forceDischargeFETDisabled</a> : 1;
<a name="l00141"></a>00141 } <a class="code" href="main_8c.html#cbc2e758fec796eb6b48d6e625c967ef">sbsFlags</a> = {0,0,0,0,0,0,0};
<a name="l00142"></a>00142 
<a name="l00143"></a>00143 
<a name="l00145"></a>00145 <span class="keyword">struct </span>{
<a name="l00147"></a><a class="code" href="main_8c.html#297366e7c4dac2f5d599c2d1226db458">00147</a>     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="main_8c.html#297366e7c4dac2f5d599c2d1226db458" title="A new CCADC ACC result is ready to be processed.">newCurrentAvailable</a> : 1;
<a name="l00149"></a><a class="code" href="main_8c.html#53f7b12114ed0a7b97435564e69ad037">00149</a>     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="main_8c.html#53f7b12114ed0a7b97435564e69ad037" title="Temperature has changed so much that a recalibration of the fast RC is needed if...">rcCalibrationRequired</a> : 1;
<a name="l00151"></a><a class="code" href="main_8c.html#29ecab45a1799ba8ca6575970e7969d2">00151</a>     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="main_8c.html#29ecab45a1799ba8ca6575970e7969d2" title="The communication interface has received a complete message if this is set.">newSbsCommandAvailable</a> : 1;
<a name="l00153"></a><a class="code" href="main_8c.html#c15425ff043551deceff121e833e4ef0">00153</a>     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="main_8c.html#c15425ff043551deceff121e833e4ef0" title="The communication interface has received an authentication command if this is set...">doAuthentication</a> : 1;
<a name="l00154"></a>00154 } <a class="code" href="main_8c.html#96a6d06da6dd269353ef07d0dc7862af" title="Task flags.">taskFlags</a> = {0,0,0,0};
<a name="l00155"></a>00155 
<a name="l00156"></a>00156 <span class="comment">/******************************************************************************</span>
<a name="l00157"></a>00157 <span class="comment"> Prototypes for private functions</span>
<a name="l00158"></a>00158 <span class="comment">******************************************************************************/</span>
<a name="l00159"></a>00159 <a class="code" href="error_8h.html#5edd7aad54ac059bf561cf2f92017698">err_t</a> <a class="code" href="main_8c.html#e87f06a2ec38c864bc7742b012559963" title="Initialization of the Watchdog.">Reset_Initialization</a>();
<a name="l00160"></a>00160 
<a name="l00161"></a>00161 <span class="keywordtype">void</span> <a class="code" href="main_8c.html#35b1f3e0eb57bedd35d61664e5277763" title="Run this function every second.">runEverySecond</a>();
<a name="l00162"></a>00162 <span class="keywordtype">void</span> <a class="code" href="main_8c.html#e9fe9128363c0ecf3db954a1e07825e9" title="Run this function every minute.">runEveryMinute</a>();
<a name="l00163"></a>00163 
<a name="l00164"></a>00164 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="main_8c.html#d796f8e3ff37c8495c342b32d6de57a2" title="Handle a new core temperature.">handleNewCoreTemperature</a>();
<a name="l00165"></a>00165 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="main_8c.html#c5e1648830816b0f3f9ce2309e8b7da5" title="Handle a new cell temperature.">handleNewCellTemperature</a>();
<a name="l00166"></a>00166 <span class="keyword">static</span> <a class="code" href="stdint_8h.html#ef44329758059c91c76d334e8fc09700">int8_t</a> <a class="code" href="main_8c.html#a069db615d5edf9ae12c47823449c91d" title="Check if a battery temperature is within the limits.">checkBatteryTemperature</a>(<a class="code" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a> temperature, <span class="keywordtype">bool</span> <a class="code" href="battery__current__monitoring_8c.html#0331ed61d181da48bb4c5e7d3cdc26e7">discharge</a>);
<a name="l00167"></a>00167 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="main_8c.html#555166b9d50c63472698721acfc26057" title="Handle a new cell voltage for cells.">handleNewCellVoltage</a>(<a class="code" href="vadc_8h.html#5ed5da99ecfd6b14544e9fde0bbe28ed" title="Typedef used where number of cells is input to functions.">vadcIndex_t</a> TempCellVoltage);
<a name="l00168"></a>00168 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="main_8c.html#9985e5b9301e8ecdc5ef51c747d9c025" title="Handle a new result from the CC-ADC.">handleNewCCADCResult</a>();
<a name="l00169"></a>00169 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="main_8c.html#0b26b15d93cf12599106c4efc57e8272" title="Configure VADC scanning.">configureVADC</a>();
<a name="l00170"></a>00170 
<a name="l00171"></a>00171 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="main_8c.html#492861926b4fc152ad1def3695aaeaf5" title="Disable DUVR mode if possible.">disableDUVRIfPossible</a>();
<a name="l00172"></a>00172 <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="main_8c.html#a3f0a393a933d87a3e8713c4985a8ac8" title="Return true if there is any temperature error.">anyTemperatureError</a>();
<a name="l00173"></a>00173 
<a name="l00174"></a>00174 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="main_8c.html#38e11c8b50a00ef91f4be286319d904e" title="Enter power-off if allowed.">enterPoweroff</a>();
<a name="l00175"></a>00175 
<a name="l00176"></a>00176 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="main_8c.html#4cc87fab6ddd51f6598ed9bdb75bf4cf" title="Handle a SBS command.">handleSBSCommand</a>();
<a name="l00177"></a>00177 
<a name="l00178"></a>00178 
<a name="l00179"></a>00179 <span class="comment">/******************************************************************************/</span>
<a name="l00187"></a><a class="code" href="main_8c.html#840291bc02cba5474a4cb46a9b9566fe">00187</a> <span class="keywordtype">int</span> <a class="code" href="main_8c.html#840291bc02cba5474a4cb46a9b9566fe" title="The main function.">main</a>( <span class="keywordtype">void</span> )
<a name="l00188"></a>00188 {
<a name="l00189"></a>00189     <span class="comment">/*</span>
<a name="l00190"></a>00190 <span class="comment">    Initialisation of peripheral modules:</span>
<a name="l00191"></a>00191 <span class="comment">    - Watchdog (timeout must be more than longer than the longest conversion period used for the CC-ADC)</span>
<a name="l00192"></a>00192 <span class="comment">    - Turn of unneeded modules (only SPI atm)</span>
<a name="l00193"></a>00193 <span class="comment">    - Bandgap</span>
<a name="l00194"></a>00194 <span class="comment">    - Set Current protection levels/configuration</span>
<a name="l00195"></a>00195 <span class="comment">    - V-ADC</span>
<a name="l00196"></a>00196 <span class="comment">        - Get cell voltages (requires that interrupts are enabled)</span>
<a name="l00197"></a>00197 <span class="comment">        - Get temperature</span>
<a name="l00198"></a>00198 <span class="comment">        - Estimate capacity ("gas gauging")</span>
<a name="l00199"></a>00199 <span class="comment">    - Check battery voltage and release the device from DUVR mode</span>
<a name="l00200"></a>00200 <span class="comment">    - CC-ADC</span>
<a name="l00201"></a>00201 <span class="comment">        - Get initial current reading (momentary and average).</span>
<a name="l00202"></a>00202 <span class="comment">    - Communication</span>
<a name="l00203"></a>00203 <span class="comment">    */</span>
<a name="l00204"></a>00204     <span class="comment">// Initialization.</span>
<a name="l00205"></a>00205     <a class="code" href="watchdog_8h.html#e776b9716ca28065f698cc0cd37d21ab" title="Reset the Watchdog Timer.">WDT_ResetTimer</a>();
<a name="l00206"></a>00206     
<a name="l00207"></a>00207     <a class="code" href="watchdog_8c.html#d5ea7103ea05ed5a58c44433a41f3f15" title="Change the timeout period of the Watchdog.">WDT_SetTimeOut</a>( <a class="code" href="watchdog_8h.html#4d0cce72ddfdbfae4fd4bbea78c524ea1c5a42fd3b376a45c8ba5033349df399">WDTO_2Kms</a> );  <span class="comment">//Set Watchdog timeout to 2 sec</span>
<a name="l00208"></a>00208 
<a name="l00209"></a>00209 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00210"></a>00210 <span class="preprocessor"></span>    <span class="keywordflow">if</span>( <a class="code" href="error_8h.html#5edd7aad54ac059bf561cf2f92017698a5571864412c8275a2e18a931fddcaa6">FAILURE</a> == <a class="code" href="main_8c.html#e87f06a2ec38c864bc7742b012559963" title="Initialization of the Watchdog.">Reset_Initialization</a>() ){
<a name="l00211"></a>00211         <span class="comment">// TODO: The Watchdog has triggered several times - might want to shut down the battery?!</span>
<a name="l00212"></a>00212         <span class="comment">// POWMAN_Shutdown();</span>
<a name="l00213"></a>00213     }
<a name="l00214"></a>00214 <span class="preprocessor">#endif</span>
<a name="l00215"></a>00215 <span class="preprocessor"></span>    <span class="comment">// Enable power reduction for SPI</span>
<a name="l00216"></a>00216     <a class="code" href="pwr__mgmnt_8h.html#a38987b371d792aed8310a00d5b3d5cf" title="Enable power reduction mode for SPI.">PRR_DISABLE_SPI</a>();
<a name="l00217"></a>00217     <span class="comment">// Disable digital input for port a</span>
<a name="l00218"></a>00218     DIDR0 = (1&lt;&lt;PA0DID) | (1&lt;&lt;PA1DID);
<a name="l00219"></a>00219     <span class="comment">// Enable pull-ups for port b to avoid floating pins</span>
<a name="l00220"></a>00220     PORTB = (1&lt;&lt;PORTB0) | (1&lt;&lt;PORTB1) | (1&lt;&lt;PORTB2) | (1&lt;&lt;PORTB3) | (1&lt;&lt;PORTB4) | (1&lt;&lt;PORTB5) | (1&lt;&lt;PORTB6) | (1&lt;&lt;PORTB7);
<a name="l00221"></a>00221     DDRB = (1&lt;&lt;PORTB0) | (1&lt;&lt;PORTB1) | (1&lt;&lt;PORTB2) | (1&lt;&lt;PORTB3) | (1&lt;&lt;PORTB4);
<a name="l00222"></a>00222     
<a name="l00223"></a>00223     <span class="comment">// Check the CRC checksum of the battery parameters struct</span>
<a name="l00224"></a>00224     <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.checksumFailure = (! <a class="code" href="battery__pack__parameters_8c.html#5065b71bee21fadbac655dea93a3bfd0" title="Checks that the saved checksum in the battParams struct is correct.">BATTPARAM_CheckCRC</a>()) | (! <a class="code" href="crc16_8c.html#84c20ac9ab8217c2c29983b203e3bb39" title="Check if the CRC of the data in the signature row is correct.">CheckSignatureCRC</a>());
<a name="l00225"></a>00225 
<a name="l00226"></a>00226     <span class="comment">// Initialize Bandgap reference.</span>
<a name="l00227"></a>00227     <span class="keywordflow">if</span>( <a class="code" href="error_8h.html#5edd7aad54ac059bf561cf2f92017698a5571864412c8275a2e18a931fddcaa6">FAILURE</a> == <a class="code" href="bandgap_8c.html#31dc899ff247c936eba72e8ba456f242" title="Bandgap initialisation.">BANDGAP_Initialization</a>() ){
<a name="l00228"></a>00228         <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.criticalConditionDetected = <span class="keyword">true</span>;
<a name="l00229"></a>00229     }
<a name="l00230"></a>00230     
<a name="l00231"></a>00231     <span class="comment">// Initialize the battery protection module (enabled by default - if default settings are good</span>
<a name="l00232"></a>00232     <span class="comment">// this is not required).</span>
<a name="l00233"></a>00233     <a class="code" href="battery__protection_8c.html#cf9f300141b94fb760005ec4fef51d4c" title="Set the short-circuit current detection level and reaction time.">BATTPROT_SetShortCircuitDetection</a>( battParams.shortcircuitCurrent, battParams.shortcircuitReactionTime );
<a name="l00234"></a>00234     <a class="code" href="battery__protection_8c.html#6edd08201b3fe6c1bfecc984bd9a9cd1" title="Set the discharging/charging over-current detection level and reaction time.">BATTPROT_SetOverCurrentDetection</a>( battParams.overcurrentDischarge, battParams.overcurrentCharge, battParams.overcurrentReactionTime );
<a name="l00235"></a>00235     <a class="code" href="battery__protection_8c.html#3a75a8b4bc543399e6d6b4d6418ccb0d" title="Set the charging high-current detection level and reaction time.">BATTPROT_SetHighCurrentDetection</a>( battParams.highcurrentDischarge, battParams.highcurrentCharge, battParams.highcurrentReactionTime );
<a name="l00236"></a>00236     
<a name="l00237"></a>00237     <a class="code" href="battery__protection_8h.html#c05fcea28b3ae230bd1c4092029c0b7b" title="Disable the discharging high-current.">BATTPROT_DisableDischargeHighCurrentProtection</a>(); <span class="comment">// Don't want a high discharging current to disable the FETs (in this example)</span>
<a name="l00238"></a>00238     <a class="code" href="battery__protection_8h.html#9878bada47d508ebab3ab13a0447d27f" title="Enable all Battery Protection interrupts.">BATTPROT_EnableAllInterrupts</a>();
<a name="l00239"></a>00239 
<a name="l00240"></a>00240     <span class="comment">//Enable DUVR from the start, so we are always in DUVR mode.</span>
<a name="l00241"></a>00241     <a class="code" href="fet__control_8c.html#1d1c3c6a4ed8941736f166753c8bbf46" title="Enable the Deep Under Voltage mode (precharging at very low battery voltage).">FETCTRL_EnableDeepUnderVoltageMode</a>();
<a name="l00242"></a>00242     
<a name="l00243"></a>00243     <span class="comment">// On reset, the device is in DUVR mode depending on the fuse setting DUVRINIT</span>
<a name="l00244"></a>00244     <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.inDUVR = <span class="keyword">true</span>;
<a name="l00245"></a>00245     
<a name="l00246"></a>00246     <span class="comment">// Enable the voltage regulator monitor interrupt</span>
<a name="l00247"></a>00247     <a class="code" href="vreg__mon_8h.html#bf82628c7089181e0e20758bd7e5d0ec" title="Enable VREGMON Interrupt.">VREGMON_InterruptEnable</a>();
<a name="l00248"></a>00248     
<a name="l00249"></a>00249     <span class="comment">// Initialize V-ADC and configure a full scan</span>
<a name="l00250"></a>00250     <a class="code" href="vadc_8c.html#baaa20b9d383080b1f434dbaa5999e12" title="Return true if new cell2 voltage readings are available.">VADC_InitializeVadcCoefficients</a>();
<a name="l00251"></a>00251     <a class="code" href="vadc_8c.html#d643e5b97a0eb9cd93ae80e2527bbade" title="Select VADC channels to be scanned.">VADC_ScanConfig</a>( (<a class="code" href="vadc_8h.html#5ed5da99ecfd6b14544e9fde0bbe28ed" title="Typedef used where number of cells is input to functions.">vadcIndex_t</a>)HIGHEST_CELL, (<a class="code" href="vadc_8h.html#5ed5da99ecfd6b14544e9fde0bbe28ed" title="Typedef used where number of cells is input to functions.">vadcIndex_t</a>)<a class="code" href="battery__pack__parameters_8h.html#78d4599a88da8ae09a2a0d829d2ffec8">HIGHEST_VADC</a>, (<a class="code" href="vadc_8h.html#5ed5da99ecfd6b14544e9fde0bbe28ed" title="Typedef used where number of cells is input to functions.">vadcIndex_t</a>)<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac6714499726d93b81232e1e9a84c16e5355e77b">VTEMP</a> );
<a name="l00252"></a>00252 
<a name="l00253"></a>00253     <span class="comment">// This can only fail if the VADC is set-up with an invalid ScanConfig</span>
<a name="l00254"></a>00254     <span class="keywordflow">if</span>( <a class="code" href="error_8h.html#5edd7aad54ac059bf561cf2f92017698a5571864412c8275a2e18a931fddcaa6">FAILURE</a> == <a class="code" href="vadc_8c.html#ed438796e781f411ac4cfbd3a89b2429" title="Start a scan of all VADC channels.">VADC_StartScan</a>() ){
<a name="l00255"></a>00255         <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.criticalConditionDetected = <span class="keyword">true</span>;
<a name="l00256"></a>00256     } <span class="keywordflow">else</span> {
<a name="l00257"></a>00257         __enable_interrupt();
<a name="l00258"></a>00258         <span class="keywordflow">while</span>( <a class="code" href="vadc_8h.html#174ac16661827ae97404ee065e8ecf5e5fc0704fc5cb466b1d72ce9c2a2b5548">VADC_RUNNING</a> == <a class="code" href="vadc_8c.html#a36cbd40622b622424c4d6af8fb2bef3" title="Check VADC scan status.">VADC_ScanState</a>() );
<a name="l00259"></a>00259         __disable_interrupt();
<a name="l00260"></a>00260         
<a name="l00261"></a>00261         <a class="code" href="vadc_8c.html#2394682eaa80101d85ce5d023beeaf5d" title="Clear the ready flags.">VADC_ClearReadyFlags</a>();
<a name="l00262"></a>00262         
<a name="l00263"></a>00263         <a class="code" href="main_8c.html#492861926b4fc152ad1def3695aaeaf5" title="Disable DUVR mode if possible.">disableDUVRIfPossible</a>();
<a name="l00264"></a>00264         <a class="code" href="voltage__based__SoC_8c.html#78d7f4f0eb9968d7e0468dc7eb01c2a2" title="Calculate the initial SoC.">VBSoC_Init</a>();
<a name="l00265"></a>00265     }
<a name="l00266"></a>00266     
<a name="l00267"></a>00267     <span class="comment">// Calculate the coefficient numbers for ccadc_ticks to mA and gas_gauging to mAh functions</span>
<a name="l00268"></a>00268     <a class="code" href="battery__current__monitoring_8c.html#3f516153abe33ea81943f5121a723ff1" title="Calculate the Shunt Coefficient for CCADC_Value to mA conversion.">BATTCUR_CalculateShuntCoeffient</a>(battParams.shuntResistance, <a class="code" href="battery__pack__parameters_8h.html#e331ad89b2c40c7aad20be532f8c9d94">CCADC_VOLTREF</a>);
<a name="l00269"></a>00269         <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> temp = <a class="code" href="rc__calibration_8c.html#80054145825d11a31568f5d7ddbe948d" title="Calculate Ultra-low power RC (Ulp RC) period time.">RCCAL_CalculateUlpRCperiod</a>(<a class="code" href="main_8c.html#87de25a56cfc5857df059f510fe3b049" title="The internal chip temperature in 0.1 Kelvin.">coreTemperature</a>/10);
<a name="l00270"></a>00270     <a class="code" href="cc__gas__gauging_8c.html#bb85088f311c13a7ca2dcc3c46a68935" title="Calculate the Shunt Coefficient for converting between accumulated and mAh.">CCGASG_CalculateShuntCoefficients</a>(temp, battParams.shuntResistance, <a class="code" href="battery__pack__parameters_8h.html#e331ad89b2c40c7aad20be532f8c9d94">CCADC_VOLTREF</a>);
<a name="l00271"></a>00271     
<a name="l00272"></a>00272     <span class="comment">// Calculate values for the sram battery parameters struct</span>
<a name="l00273"></a>00273     <a class="code" href="battery__pack__parameters_8c.html#2a74ba9369494e14ab1f69399f1b98dd">BATTPARAM_InitSramParameters</a>();
<a name="l00274"></a>00274     
<a name="l00275"></a>00275     <span class="comment">// Copy key from eeprom to sram if using AES</span>
<a name="l00276"></a>00276 <span class="preprocessor">#if defined(AUTH_USE_AES)</span>
<a name="l00277"></a>00277 <span class="preprocessor"></span>    AUTH_CopyKeyToSram();
<a name="l00278"></a>00278 <span class="preprocessor">#endif</span>
<a name="l00279"></a>00279 <span class="preprocessor"></span>        
<a name="l00280"></a>00280     
<a name="l00281"></a>00281     <span class="comment">// If a critical condition occured, (either bandgap didn't work or VADC was configured wrong)</span>
<a name="l00282"></a>00282     <span class="comment">// don't do any of the battery related initialization and disable DUVR mode (so charging is impossible)</span>
<a name="l00283"></a>00283     <span class="keywordflow">if</span>( <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.criticalConditionDetected ) {
<a name="l00284"></a>00284         <a class="code" href="fet__control_8c.html#f783fdb3c3c3f69cf47b72ab89df5f6c" title="Disable the Deep Under Voltage mode (precharging at very low battery voltage).">FETCTRL_DisableDeepUnderVoltageMode</a>();
<a name="l00285"></a>00285         <a class="code" href="fet__control_8c.html#16b63cca34a388992fee275392cb4c71" title="Disable both the charge and the discharge FETs.">FETCTRL_DisableFets</a>();
<a name="l00286"></a>00286         
<a name="l00287"></a>00287     } <span class="keywordflow">else</span> {
<a name="l00288"></a>00288         <span class="comment">// Initialize the CC-ADC (sample every second and set regular current level)</span>
<a name="l00289"></a>00289         <a class="code" href="ccadc_8c.html#d33fcbcc8cffde4e80167e91d4c4ee41" title="Configuration of the CC-ADC and Regular Current Level.">CCADC_Init</a>( <a class="code" href="ccadc_8h.html#8f764a261e7b721a09c97552cb70502724d6a9b6479884cb910196f63fbf2cd0" title="Equals to 128K (131072) ULP cycles.">ACCT_1024</a>, <a class="code" href="ccadc_8h.html#20450e932c971e9190c28a39dd14944d32d3ec2c3cc1e9ba2271b3447257be72" title="Equals to 128K (131072) ULP cycles.">RCCI_1024</a>, 10 <a class="code" href="battery__pack__parameters_8h.html#12fc82329d8ebacab6ace2d7e2c2110e" title="Units Milli amps.">mA</a> );
<a name="l00290"></a>00290         <a class="code" href="ccadc_8c.html#afad5ab69f7a7df09fee8205f5c9a710" title="Selects mode of operation for the CC-ADC.">CCADC_SetMode</a>( <a class="code" href="ccadc_8h.html#8e4f515e173ca5bf4c0f461ea298c09605dbfa432ea2f1224b5c6b499b58a2a5" title="CC_ADC is enabled and Accumulated Current Conversions generate interrupts.">CCADC_ACC</a> );
<a name="l00291"></a>00291         
<a name="l00292"></a>00292         <span class="comment">// Set initial remaining capacity in the CCGASG module, it is marked as in-</span>
<a name="l00293"></a>00293         <span class="comment">// accurate and updated the first time the VBSoC have an accurate reading.</span>
<a name="l00294"></a>00294         <a class="code" href="cc__gas__gauging_8c.html#524ffb0c818f674a80049a992a29928b" title="Update State of Charge.">CCGASG_SetStateofCharge</a>(<a class="code" href="voltage__based__SoC_8c.html#ce1479a5937438f72f5357e20ee39db0" title="Returns the the latest estimated state of charge.">VBSoC_EstimatedSoC</a>());
<a name="l00295"></a>00295         <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.remainingCapacityInaccurate = 1;
<a name="l00296"></a>00296         
<a name="l00297"></a>00297         __enable_interrupt();
<a name="l00298"></a>00298         <span class="comment">// Needs to run a conversion before the value is correct</span>
<a name="l00299"></a>00299         <span class="keywordflow">while</span>( !<a class="code" href="ccadc_8c.html#e1fa828dd58f653f3beec1a90b27a3a4" title="Used to determine if a new CCADC accumulated current result is ready.">CCADC_isAccResultReady</a>() );
<a name="l00300"></a>00300         <a class="code" href="watchdog_8h.html#e776b9716ca28065f698cc0cd37d21ab" title="Reset the Watchdog Timer.">WDT_ResetTimer</a>();
<a name="l00301"></a>00301         __disable_interrupt();
<a name="l00302"></a>00302         
<a name="l00303"></a>00303         
<a name="l00304"></a>00304         <span class="comment">// Calculate the CCADC Accumulating conversion offset if it is invalid and</span>
<a name="l00305"></a>00305         <span class="comment">// DUVR mode is disabled</span>
<a name="l00306"></a>00306         <span class="keywordflow">if</span>(<a class="code" href="ccadc_8c.html#0b0c7df0d9cdfdbd2ed93dff245b123b" title="Returns the raw offset for the accumulating conversion.">CCADC_GetRawAccOffset</a>() == 32767 &amp;&amp; ! <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.inDUVR) {
<a name="l00307"></a>00307             <a class="code" href="fet__control_8c.html#16b63cca34a388992fee275392cb4c71" title="Disable both the charge and the discharge FETs.">FETCTRL_DisableFets</a>(); <span class="comment">// Disable FETs when measuring offset as changes in current not is good</span>
<a name="l00308"></a>00308             __enable_interrupt();
<a name="l00309"></a>00309             <a class="code" href="ccadc_8c.html#a0713dd1fe379d8acea94e7f9844cb92" title="Calculates the accumulating conversion offset.">CCADC_CalculateAccOffset</a>();
<a name="l00310"></a>00310             __disable_interrupt();
<a name="l00311"></a>00311         }
<a name="l00312"></a>00312         
<a name="l00313"></a>00313         <span class="comment">// If two or more cells, init the misbalance corrector</span>
<a name="l00314"></a>00314 <span class="preprocessor">#if BATTPARAM_CELLS_IN_SERIES &gt;= 2</span>
<a name="l00315"></a>00315 <span class="preprocessor"></span>        BATTVMON_InitializeBalancing();
<a name="l00316"></a>00316 <span class="preprocessor">#endif</span>
<a name="l00317"></a>00317 <span class="preprocessor"></span>        
<a name="l00318"></a>00318         <span class="comment">//Store information about the current (to be able to reply if host asks...)</span>
<a name="l00319"></a>00319         <a class="code" href="battery__current__monitoring_8c.html#8baedbc3e31405ed1b2d642808d21933" title="Stores the current from the last CC-ADC reading ( mV, 18-bit signed).">BATTCUR_StoreCurrent</a>( <a class="code" href="ccadc_8c.html#a10e785327fcbf1bc692c30d790145b7" title="Returns result of an CC-ADC Accumulated Conversion.">CCADC_GetAccResult</a>() );
<a name="l00320"></a>00320         <a class="code" href="battery__current__monitoring_8c.html#8b9942c60483ab80e9daf26fd8c98782" title="Init the average current counter.">BATTCUR_InitializeAverageCurrent</a>( <a class="code" href="battery__current__monitoring_8c.html#6a557e4dca31a58b1683861bf8f154e6" title="Provides the offset calibrated current from the last CC-ADC reading.">BATTCUR_GetOffsetCalibratedCurrent</a>() );
<a name="l00321"></a>00321     }
<a name="l00322"></a>00322     
<a name="l00323"></a>00323     <span class="comment">//init communication bus</span>
<a name="l00324"></a>00324     <a class="code" href="timer_8c.html#0e464e8336ef775ece1a46c5ee102513">T1init</a>();   <span class="comment">// Used for SmBus timeout and LED</span>
<a name="l00325"></a>00325 
<a name="l00326"></a>00326     <a class="code" href="communication_8c.html#98a59b5ab5cde59154465aab070afa30" title="Initialize TWI module.">Comm_Init</a>();
<a name="l00327"></a>00327 
<a name="l00328"></a>00328     <span class="comment">// Ready to run - enable interrupts and enter main loop.</span>
<a name="l00329"></a>00329     __enable_interrupt();
<a name="l00330"></a>00330     
<a name="l00331"></a>00331     
<a name="l00332"></a>00332     <span class="comment">/*******************************************************************</span>
<a name="l00333"></a>00333 <span class="comment">    Main loop:</span>
<a name="l00334"></a>00334 <span class="comment">    If any of the task flags are set the corresponding task should be run.</span>
<a name="l00335"></a>00335 <span class="comment">    </span>
<a name="l00336"></a>00336 <span class="comment">    The following things are done:</span>
<a name="l00337"></a>00337 <span class="comment">    - Reset watchdog</span>
<a name="l00338"></a>00338 <span class="comment">    - If a new CCADC result is ready, start a VADC conversion</span>
<a name="l00339"></a>00339 <span class="comment">    - If the communication interface have a new byte, handle it</span>
<a name="l00340"></a>00340 <span class="comment">    - and if a whole new command has arrived, handle that</span>
<a name="l00341"></a>00341 <span class="comment">    - Handle new CCADC result if it's ready</span>
<a name="l00342"></a>00342 <span class="comment">    - Check new core temperature if ready, and run a fast RC calibration if needed</span>
<a name="l00343"></a>00343 <span class="comment">    - Check new cell temperature if ready</span>
<a name="l00344"></a>00344 <span class="comment">    - Check new cell voltage if ready</span>
<a name="l00345"></a>00345 <span class="comment">    - Set different sleep modes depending on what's running</span>
<a name="l00346"></a>00346 <span class="comment">      - If in communication or RC calibration (any timer running) can only enter idle mode</span>
<a name="l00347"></a>00347 <span class="comment">      - If VADC is running, can't go deeper than ADC noise reduction mode</span>
<a name="l00348"></a>00348 <span class="comment">      - If "nothing" is running, enter power-save</span>
<a name="l00349"></a>00349 <span class="comment">    - Disable/enable fets depeding on various things</span>
<a name="l00350"></a>00350 <span class="comment">    - Go to sleep</span>
<a name="l00351"></a>00351 <span class="comment">    */</span>
<a name="l00352"></a>00352     <span class="keywordflow">while</span>(1) {
<a name="l00353"></a>00353 
<a name="l00354"></a>00354         <span class="comment">//Tickle the watchdog every cycle</span>
<a name="l00355"></a>00355         <a class="code" href="watchdog_8h.html#e776b9716ca28065f698cc0cd37d21ab" title="Reset the Watchdog Timer.">WDT_ResetTimer</a>();
<a name="l00356"></a>00356         
<a name="l00357"></a>00357         <span class="keywordflow">if</span>( <a class="code" href="ccadc_8c.html#e1fa828dd58f653f3beec1a90b27a3a4" title="Used to determine if a new CCADC accumulated current result is ready.">CCADC_isAccResultReady</a>() )
<a name="l00358"></a>00358         {
<a name="l00359"></a>00359             <span class="comment">// Start a new VADC scan as fast as possible so that all scans hopefully are</span>
<a name="l00360"></a>00360             <span class="comment">// ready before the main loop ends, to avoid having to cycle again.</span>
<a name="l00361"></a>00361             
<a name="l00362"></a>00362             
<a name="l00363"></a>00363 <span class="preprocessor">#if BATTPARAM_CELLS_IN_SERIES &gt;= 2</span>
<a name="l00364"></a>00364 <span class="preprocessor"></span>            <span class="comment">// Disable cell balancing if more than one cell</span>
<a name="l00365"></a>00365             BATTVMON_DisableCellBalancing();
<a name="l00366"></a>00366 <span class="preprocessor">#endif</span>
<a name="l00367"></a>00367 <span class="preprocessor"></span>            
<a name="l00368"></a>00368             <span class="comment">// Start a new VADC scan</span>
<a name="l00369"></a>00369             <a class="code" href="main_8c.html#0b26b15d93cf12599106c4efc57e8272" title="Configure VADC scanning.">configureVADC</a>();
<a name="l00370"></a>00370             <a class="code" href="vadc_8c.html#ed438796e781f411ac4cfbd3a89b2429" title="Start a scan of all VADC channels.">VADC_StartScan</a>();
<a name="l00371"></a>00371             
<a name="l00372"></a>00372             <a class="code" href="main_8c.html#96a6d06da6dd269353ef07d0dc7862af" title="Task flags.">taskFlags</a>.newCurrentAvailable = <span class="keyword">true</span>;
<a name="l00373"></a>00373         }
<a name="l00374"></a>00374         
<a name="l00375"></a>00375         <span class="comment">//See if there were any received commands.</span>
<a name="l00376"></a>00376         <a class="code" href="main_8c.html#96a6d06da6dd269353ef07d0dc7862af" title="Task flags.">taskFlags</a>.newSbsCommandAvailable = <a class="code" href="communication_8c.html#bebcf5dbdcea576a31271721d411de4d" title="Parse command.">Comm_Handle</a>( &amp;sbs );
<a name="l00377"></a>00377 
<a name="l00378"></a>00378         
<a name="l00379"></a>00379         <span class="comment">//If complete sbs command has been received: process it</span>
<a name="l00380"></a>00380         <span class="keywordflow">if</span>( <a class="code" href="main_8c.html#96a6d06da6dd269353ef07d0dc7862af" title="Task flags.">taskFlags</a>.newSbsCommandAvailable )
<a name="l00381"></a>00381         {
<a name="l00382"></a>00382             <a class="code" href="main_8c.html#4cc87fab6ddd51f6598ed9bdb75bf4cf" title="Handle a SBS command.">handleSBSCommand</a>();
<a name="l00383"></a>00383             <span class="comment">// If authentication is needed, run. It will use and change the values in sbs,</span>
<a name="l00384"></a>00384             <span class="comment">// make sure the communication interrupt does not write directly to it.</span>
<a name="l00385"></a>00385             <span class="comment">// Note that this can take long time and communication will not work</span>
<a name="l00386"></a>00386             <span class="comment">// during that time.</span>
<a name="l00387"></a>00387             <span class="keywordflow">if</span>(<a class="code" href="main_8c.html#96a6d06da6dd269353ef07d0dc7862af" title="Task flags.">taskFlags</a>.doAuthentication) {
<a name="l00388"></a>00388                 <a class="code" href="authentication_8c.html#b778a74bafbac2beb0b762b7a7dfc692" title="Run the chosen authentication algorithm.">AUTH_Execute</a>(&amp;sbs);
<a name="l00389"></a>00389                 <a class="code" href="main_8c.html#96a6d06da6dd269353ef07d0dc7862af" title="Task flags.">taskFlags</a>.doAuthentication = <span class="keyword">false</span>;
<a name="l00390"></a>00390             }
<a name="l00391"></a>00391         }
<a name="l00392"></a>00392         
<a name="l00393"></a>00393         
<a name="l00394"></a>00394         <span class="comment">/*</span>
<a name="l00395"></a>00395 <span class="comment">        A new CC-ADC conversion is available. Update momentary current, average current,</span>
<a name="l00396"></a>00396 <span class="comment">        and calculate new battery capacity. Update discharge_cycle_accumulator (and increment</span>
<a name="l00397"></a>00397 <span class="comment">        cycle_count if required).</span>
<a name="l00398"></a>00398 <span class="comment">        */</span>
<a name="l00399"></a>00399         <span class="keywordflow">if</span>( <a class="code" href="main_8c.html#96a6d06da6dd269353ef07d0dc7862af" title="Task flags.">taskFlags</a>.newCurrentAvailable )
<a name="l00400"></a>00400         {
<a name="l00401"></a>00401             <a class="code" href="main_8c.html#96a6d06da6dd269353ef07d0dc7862af" title="Task flags.">taskFlags</a>.newCurrentAvailable = <span class="keyword">false</span>;
<a name="l00402"></a>00402             
<a name="l00403"></a>00403             <span class="comment">// We use the CCADC interrupt as counter for the RTC</span>
<a name="l00404"></a>00404             <a class="code" href="main_8c.html#35b1f3e0eb57bedd35d61664e5277763" title="Run this function every second.">runEverySecond</a>();
<a name="l00405"></a>00405             <a class="code" href="battery__current__monitoring_8c.html#8baedbc3e31405ed1b2d642808d21933" title="Stores the current from the last CC-ADC reading ( mV, 18-bit signed).">BATTCUR_StoreCurrent</a>( <a class="code" href="ccadc_8c.html#a10e785327fcbf1bc692c30d790145b7" title="Returns result of an CC-ADC Accumulated Conversion.">CCADC_GetAccResult</a>() );
<a name="l00406"></a>00406             <a class="code" href="main_8c.html#9985e5b9301e8ecdc5ef51c747d9c025" title="Handle a new result from the CC-ADC.">handleNewCCADCResult</a>();
<a name="l00407"></a>00407             <a class="code" href="cc__gas__gauging_8c.html#a668152277e743de4a6dcdd2079136dc" title="Accumulation of CCADC measurements.">CCGASG_AccumulateCCADCMeasurements</a>( <a class="code" href="battery__current__monitoring_8c.html#ae8592ed4c14b5a00048fe1ed1c68e4a" title="Provides the current from the last CC-ADC reading (18-bit signed).">BATTCUR_GetCurrent</a>(), <a class="code" href="main_8c.html#9681fe281db5d507e970242053df7c67" title="Variable for storing the latest calculated slow RC period.">slowRcOscillatorPeriod</a> );
<a name="l00408"></a>00408             
<a name="l00409"></a>00409             <span class="comment">//Set ledstatus</span>
<a name="l00410"></a>00410             <a class="code" href="main_8c.html#0f7149db7892cd59cfc8806e789ec906" title="State of Charge.">SoC_State</a> = <a class="code" href="gas__gauging_8c.html#cfbc7e47153ec1e54e6fc85ddde14d26" title="Returns state of charge.">GASG_StateOfCharge</a>(<a class="code" href="battery__current__monitoring_8c.html#0959c4b3bb0cee63ad2a3bdb89a92a6d" title="Provide an estimate for the average current throughout the last minute (18-bit signed)...">BATTCUR_GetAverageCurrent</a>(), <a class="code" href="battery__pack__parameters_8c.html#465d57b9c9b2b607be86de50f09ed7ba" title="Battery parameters that are calculated at startup from eeprom variables.">battParams_sram</a>.<a class="code" href="structbattParam__sramstruct.html#76fcb4f7f90d64e089eab59b5bc69b6b" title="Full charge capacity in CC accumulated.">capacityInCCAccumulated</a>);
<a name="l00411"></a>00411             <a class="code" href="timer_8c.html#796038a9e9fe2f9ba2085423601c006b">SetLEDs</a>((<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>)<a class="code" href="main_8c.html#0f7149db7892cd59cfc8806e789ec906" title="State of Charge.">SoC_State</a>);
<a name="l00412"></a>00412         }
<a name="l00413"></a>00413 
<a name="l00414"></a>00414         <span class="comment">/*</span>
<a name="l00415"></a>00415 <span class="comment">        New core temperature reading is available and should be processed. If</span>
<a name="l00416"></a>00416 <span class="comment">        temperature has changed set RC_calibration_required flag.</span>
<a name="l00417"></a>00417 <span class="comment">        */</span>
<a name="l00418"></a>00418         <span class="keywordflow">if</span>( <a class="code" href="vadc_8c.html#0b978ff704a91cd39fc99bd6dbe2031d" title="Return true if new core temperature reading s available.">VADC_VTempReady</a>() )
<a name="l00419"></a>00419         {
<a name="l00420"></a>00420             <a class="code" href="main_8c.html#d796f8e3ff37c8495c342b32d6de57a2" title="Handle a new core temperature.">handleNewCoreTemperature</a>();
<a name="l00421"></a>00421         }
<a name="l00422"></a>00422 
<a name="l00423"></a>00423         <span class="comment">/*</span>
<a name="l00424"></a>00424 <span class="comment">        RC oscillator requires calibration (new CC_ADC conversion period time should</span>
<a name="l00425"></a>00425 <span class="comment">        be calculated and stored.</span>
<a name="l00426"></a>00426 <span class="comment">        */</span>
<a name="l00427"></a>00427         <span class="keywordflow">if</span>( <a class="code" href="main_8c.html#96a6d06da6dd269353ef07d0dc7862af" title="Task flags.">taskFlags</a>.rcCalibrationRequired )
<a name="l00428"></a>00428         {
<a name="l00429"></a>00429             <a class="code" href="main_8c.html#96a6d06da6dd269353ef07d0dc7862af" title="Task flags.">taskFlags</a>.rcCalibrationRequired = <span class="keyword">false</span>;
<a name="l00430"></a>00430             <a class="code" href="rc__calibration_8c.html#3324e52d9c103e1c3889824170dd7d08" title="Start the Fast RC calibration.">RCCAL_StartCalibrateFastRC</a>();
<a name="l00431"></a>00431             
<a name="l00432"></a>00432             <span class="comment">// Calculating slow RC period works on whole kelvins</span>
<a name="l00433"></a>00433             <a class="code" href="main_8c.html#9681fe281db5d507e970242053df7c67" title="Variable for storing the latest calculated slow RC period.">slowRcOscillatorPeriod</a> = <a class="code" href="rc__calibration_8c.html#01eda13db136451568e1c22f17b3ac40" title="Calculate Slow RC period time.">RCCAL_CalculateSlowRCperiod</a>( <a class="code" href="main_8c.html#87de25a56cfc5857df059f510fe3b049" title="The internal chip temperature in 0.1 Kelvin.">coreTemperature</a>/10 );
<a name="l00434"></a>00434         }
<a name="l00435"></a>00435         
<a name="l00436"></a>00436         <span class="keywordflow">if</span>( <a class="code" href="rc__calibration_8c.html#d31c4916062296248c228bdee0e81395" title="Returns the current state of fast rc calibration.">RCCAL_GetState</a>() == <a class="code" href="rc__calibration_8h.html#8c494e607329ee1c12964f340c250ceacefbf3e28965a0cd990ace3b1d515cdf">RCCAL_CALIB_INIT</a> || <a class="code" href="rc__calibration_8c.html#d31c4916062296248c228bdee0e81395" title="Returns the current state of fast rc calibration.">RCCAL_GetState</a>() == <a class="code" href="rc__calibration_8h.html#8c494e607329ee1c12964f340c250ceabff3a10d059a47420ee760225ef4dbec">RCCAL_CALIB_WORKING</a> ) {
<a name="l00437"></a>00437             <a class="code" href="rc__calibration_8c.html#344e46598bc6ed3bc1d025d10edd2578" title="Calibrate the Fast RC against the Slow RC oscillator runtime.">RCCAL_CalibrateFastRCruntime</a>(<a class="code" href="main_8c.html#9681fe281db5d507e970242053df7c67" title="Variable for storing the latest calculated slow RC period.">slowRcOscillatorPeriod</a>);
<a name="l00438"></a>00438         }
<a name="l00439"></a>00439         
<a name="l00440"></a>00440         <span class="comment">/*</span>
<a name="l00441"></a>00441 <span class="comment">        Battery cell temperature is available. Check it and disable FETs if too high/low</span>
<a name="l00442"></a>00442 <span class="comment">        */</span>
<a name="l00443"></a>00443         <span class="keywordflow">if</span>( <a class="code" href="vadc_8c.html#ae4676ebbd808e1908f8163a9972aa2a" title="Return true if new cell temperature readings are available.">VADC_CellTempReady</a>() )
<a name="l00444"></a>00444         {
<a name="l00445"></a>00445             <a class="code" href="main_8c.html#c5e1648830816b0f3f9ce2309e8b7da5" title="Handle a new cell temperature.">handleNewCellTemperature</a>();
<a name="l00446"></a>00446         }
<a name="l00447"></a>00447         
<a name="l00448"></a>00448         
<a name="l00449"></a>00449         <span class="comment">/*</span>
<a name="l00450"></a>00450 <span class="comment">        Check battery voltage cell . Check if critical (high/low voltage)</span>
<a name="l00451"></a>00451 <span class="comment">        */</span>
<a name="l00452"></a>00452         <span class="keywordflow">if</span>( <a class="code" href="vadc_8c.html#e5465bb86b1978fdcdd6b962e050f373" title="Return true if new cell1 voltage readings are available.">VADC_Cell1VoltageReady</a>() )
<a name="l00453"></a>00453         {
<a name="l00454"></a>00454             <a class="code" href="main_8c.html#555166b9d50c63472698721acfc26057" title="Handle a new cell voltage for cells.">handleNewCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac671449b08613e4845ef2a5d657b8562c394673">CELL1</a>);
<a name="l00455"></a>00455         }
<a name="l00456"></a>00456             
<a name="l00457"></a>00457         <span class="comment">/*</span>
<a name="l00458"></a>00458 <span class="comment">        Check battery voltage cell . Check if critical (high/low voltage) and misbalance</span>
<a name="l00459"></a>00459 <span class="comment">        */</span>
<a name="l00460"></a>00460 <span class="preprocessor">#if BATTPARAM_CELLS_IN_SERIES &gt;= 2</span>
<a name="l00461"></a>00461 <span class="preprocessor"></span>        <span class="keywordflow">if</span>( <a class="code" href="vadc_8h.html#99b4057dda042a6c75bcb9c65438278e">VADC_Cell2VoltageReady</a>() )
<a name="l00462"></a>00462         {
<a name="l00463"></a>00463             <a class="code" href="main_8c.html#555166b9d50c63472698721acfc26057" title="Handle a new cell voltage for cells.">handleNewCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac67144983bc57407aa6f82e37d495ff9d28ed81">CELL2</a>);
<a name="l00464"></a>00464         }
<a name="l00465"></a>00465 
<a name="l00466"></a>00466 <span class="preprocessor">#if BATTPARAM_CELLS_IN_SERIES &gt;= 3</span>
<a name="l00467"></a>00467 <span class="preprocessor"></span>        <span class="keywordflow">if</span>( <a class="code" href="vadc_8h.html#fb8ec45b3cfb76d7ef8b20f76a0fea8c">VADC_Cell3VoltageReady</a>() )
<a name="l00468"></a>00468         {
<a name="l00469"></a>00469             <a class="code" href="main_8c.html#555166b9d50c63472698721acfc26057" title="Handle a new cell voltage for cells.">handleNewCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac6714494ab35dc613899d959b4e063d736deb2d">CELL3</a>);
<a name="l00470"></a>00470         }
<a name="l00471"></a>00471 
<a name="l00472"></a>00472 <span class="preprocessor">#if BATTPARAM_CELLS_IN_SERIES &gt;= 4</span>
<a name="l00473"></a>00473 <span class="preprocessor"></span>        <span class="keywordflow">if</span>( <a class="code" href="vadc_8h.html#8277147eb095a6c442743e4f04166db9">VADC_Cell4VoltageReady</a>() )
<a name="l00474"></a>00474         {
<a name="l00475"></a>00475             <a class="code" href="main_8c.html#555166b9d50c63472698721acfc26057" title="Handle a new cell voltage for cells.">handleNewCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac6714495dc31be69defc09d627e487ce6a56c1a">CELL4</a>);
<a name="l00476"></a>00476         }
<a name="l00477"></a>00477 <span class="preprocessor">#endif</span>
<a name="l00478"></a>00478 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00479"></a>00479 <span class="preprocessor"></span><span class="preprocessor">#endif  </span>
<a name="l00480"></a>00480 <span class="preprocessor"></span>        
<a name="l00481"></a>00481         <span class="comment">// Check what sleep mode we can enter. Needs disable interrupt because otherwise it might</span>
<a name="l00482"></a>00482         <span class="comment">// overwrite what interrupts write to SMCR (for example, if external interrupt is triggered and</span>
<a name="l00483"></a>00483         <span class="comment">// wants the sleep mode to be no higher than idle, it should be run after all those checks)</span>
<a name="l00484"></a>00484         <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> interruptState = __save_interrupt();
<a name="l00485"></a>00485         __disable_interrupt();
<a name="l00486"></a>00486         <span class="keywordflow">if</span>( <a class="code" href="communication_8c.html#671390135cd0d30125661704332715a5" title="Check Communication State.">Comm_IsIdle</a>() &amp;&amp; ! <a class="code" href="rc__calibration_8h.html#5af78b68459723658ef4a196997534d7" title="Checks if calibration is running (ie, if the input capture interrupt is enabled)...">RCCAL_IS_RUNNING</a>() ) {
<a name="l00487"></a>00487             <span class="keywordflow">if</span>( <a class="code" href="vadc_8h.html#174ac16661827ae97404ee065e8ecf5e5fc0704fc5cb466b1d72ce9c2a2b5548">VADC_RUNNING</a> == <a class="code" href="vadc_8c.html#a36cbd40622b622424c4d6af8fb2bef3" title="Check VADC scan status.">VADC_ScanState</a>() ) {
<a name="l00488"></a>00488                 <a class="code" href="pwr__mgmnt_8h.html#5474c544dd96d674c0b9c92fe166b170" title="Set ADC noise reduction mode.">SLEEP_SET_ADC_NR_MODE</a>();
<a name="l00489"></a>00489             } <span class="keywordflow">else</span> {
<a name="l00490"></a>00490                 <a class="code" href="pwr__mgmnt_8h.html#291ba4f8fe890ea274a043671906132e" title="Set powersave mode.">SLEEP_SET_POWER_SAVE_MODE</a>();
<a name="l00491"></a>00491             }
<a name="l00492"></a>00492         } <span class="keywordflow">else</span> {
<a name="l00493"></a>00493             <a class="code" href="pwr__mgmnt_8h.html#29080a2ac2d6632cbe8059e4a89f486a" title="Set idle sleep mode.">SLEEP_SET_IDLE_MODE</a>();
<a name="l00494"></a>00494         }
<a name="l00495"></a>00495         __restore_interrupt(interruptState);
<a name="l00496"></a>00496         
<a name="l00497"></a>00497         <span class="comment">/*</span>
<a name="l00498"></a>00498 <span class="comment">        Disable FETs if critical condition have been detected.</span>
<a name="l00499"></a>00499 <span class="comment">        Enable them if that is okey, depending om various factors like</span>
<a name="l00500"></a>00500 <span class="comment">        temperature and voltage.</span>
<a name="l00501"></a>00501 <span class="comment">        */</span>
<a name="l00502"></a>00502         <span class="keywordflow">if</span>(   <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.criticalConditionDetected
<a name="l00503"></a>00503              || <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.simulatePowerOff)
<a name="l00504"></a>00504         {
<a name="l00505"></a>00505             <a class="code" href="fet__control_8c.html#16b63cca34a388992fee275392cb4c71" title="Disable both the charge and the discharge FETs.">FETCTRL_DisableFets</a>();
<a name="l00506"></a>00506         }
<a name="l00507"></a>00507         <span class="keywordflow">else</span> <span class="keywordflow">if</span>( ! <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.cellTemperatureTooHigh &amp;&amp;
<a name="l00508"></a>00508                  ! <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.cellTemperatureTooLow &amp;&amp;
<a name="l00509"></a>00509                  ! <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.inDUVR)
<a name="l00510"></a>00510         {
<a name="l00511"></a>00511             <span class="keywordflow">if</span>(   ! <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.voltageTooHigh
<a name="l00512"></a>00512                &amp;&amp; ! <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.reoccuringChargeProtection
<a name="l00513"></a>00513                &amp;&amp; ! <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.chargingProhibited
<a name="l00514"></a>00514                &amp;&amp; ! <a class="code" href="main_8c.html#cbc2e758fec796eb6b48d6e625c967ef">sbsFlags</a>.forceChargeFETDisabled)
<a name="l00515"></a>00515             {
<a name="l00516"></a>00516                 <a class="code" href="fet__control_8c.html#e9f760140f333a11a7e0c8085ab0abe3" title="Enable the charge FET.">FETCTRL_EnableChargeFet</a>();
<a name="l00517"></a>00517             }
<a name="l00518"></a>00518             
<a name="l00519"></a>00519             <span class="keywordflow">if</span>(   ! <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.voltageTooLow
<a name="l00520"></a>00520                &amp;&amp; ! <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.dischargingProhibited
<a name="l00521"></a>00521                &amp;&amp; ! <a class="code" href="main_8c.html#cbc2e758fec796eb6b48d6e625c967ef">sbsFlags</a>.forceDischargeFETDisabled)
<a name="l00522"></a>00522             {
<a name="l00523"></a>00523                 <a class="code" href="fet__control_8c.html#3432d1c889ed86fd981bce7725d0682d" title="Enable the discharge FET.">FETCTRL_EnableDischargeFet</a>();
<a name="l00524"></a>00524             }
<a name="l00525"></a>00525         }
<a name="l00526"></a>00526         
<a name="l00527"></a>00527         <span class="comment">// The reason to do this is that on short-circuit, the cell voltage reading can</span>
<a name="l00528"></a>00528         <span class="comment">// be wrong and if that causes both chargingProhibited and dischargingProhibited</span>
<a name="l00529"></a>00529         <span class="comment">// to get set, they would never be cleared unless we do this.</span>
<a name="l00530"></a>00530         <span class="comment">// If they should be set, they will be set again before the FETs are enabled again</span>
<a name="l00531"></a>00531         <span class="comment">// on next cycle.</span>
<a name="l00532"></a>00532         <span class="keywordflow">if</span>( <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.chargingProhibited &amp;&amp; <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.dischargingProhibited ) {
<a name="l00533"></a>00533             <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.chargingProhibited = <span class="keyword">false</span>;
<a name="l00534"></a>00534             <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.dischargingProhibited = <span class="keyword">false</span>;
<a name="l00535"></a>00535         }
<a name="l00536"></a>00536         
<a name="l00537"></a>00537         <span class="comment">// Enter sleep if no new byte just have been received on the communication</span>
<a name="l00538"></a>00538         <span class="comment">// If a byte is received between the check for Comm_Flag and __sleep is</span>
<a name="l00539"></a>00539         <span class="comment">// executed, the sleep function will have no effect as the software communication</span>
<a name="l00540"></a>00540         <span class="comment">// interrupt clears sleep mode enable.</span>
<a name="l00541"></a>00541         <span class="keywordflow">if</span>( (<a class="code" href="communication_8c.html#2bab1f3bd066faa428e782b7417bc18a" title="Check Communication Status.">Comm_Flag</a>() == 0 ) &amp;&amp; (<a class="code" href="timer_8c.html#ce4de846d0e828d0f88226e06c6289eb">ShowLedBusy</a>()==<span class="keyword">false</span>) ){
<a name="l00542"></a>00542             __sleep();
<a name="l00543"></a>00543         }
<a name="l00544"></a>00544     }
<a name="l00545"></a>00545 }
<a name="l00546"></a>00546 
<a name="l00547"></a>00547 <span class="comment">/******************************************************************************/</span>
<a name="l00557"></a><a class="code" href="main_8c.html#e87f06a2ec38c864bc7742b012559963">00557</a> <a class="code" href="error_8h.html#5edd7aad54ac059bf561cf2f92017698">err_t</a> <a class="code" href="main_8c.html#e87f06a2ec38c864bc7742b012559963" title="Initialization of the Watchdog.">Reset_Initialization</a>()
<a name="l00558"></a>00558 {
<a name="l00559"></a>00559     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> reset_flags;
<a name="l00560"></a>00560     
<a name="l00561"></a>00561     <span class="comment">/* Read and clear reset flags */</span>
<a name="l00562"></a>00562     reset_flags = MCUSR;                <span class="comment">// Save reset flags.</span>
<a name="l00563"></a>00563     MCUSR       = 0;                    <span class="comment">// Clear all flags previously set.</span>
<a name="l00564"></a>00564     
<a name="l00565"></a>00565     <span class="comment">/* If no reset flags are set, runaway code wrapped back to address 0 */</span>
<a name="l00566"></a>00566     <span class="keywordflow">if</span>( reset_flags == 0 )
<a name="l00567"></a>00567     {
<a name="l00568"></a>00568         __disable_interrupt();
<a name="l00569"></a>00569         <span class="comment">// If desired, code for handling this error can be added here.</span>
<a name="l00570"></a>00570         <span class="keywordflow">for</span>(;;);                        <span class="comment">// Let the Watchdog time out and cause a Watchdog System Reset.</span>
<a name="l00571"></a>00571     }
<a name="l00572"></a>00572     
<a name="l00573"></a>00573     <span class="comment">/* Check for Watchdog System Reset */</span>
<a name="l00574"></a>00574     <span class="keywordflow">if</span>( reset_flags &amp; (1&lt;&lt;WDRF) )
<a name="l00575"></a>00575     {
<a name="l00576"></a>00576         <a class="code" href="battery__pack__parameters_8h.html#275a856590939e7ec3cf1e6bb435776e" title="Counts number of Watchdog resets. Initialize to 0 on first programming.">wdr_count</a>++;                    <span class="comment">// Increase Watchdog System Reset counter.</span>
<a name="l00577"></a>00577         
<a name="l00578"></a>00578         <span class="comment">/* Has the number of subsequent Watchdog System Resets exceeded its max limits? */</span>
<a name="l00579"></a>00579         <span class="keywordflow">if</span>( <a class="code" href="battery__pack__parameters_8h.html#275a856590939e7ec3cf1e6bb435776e" title="Counts number of Watchdog resets. Initialize to 0 on first programming.">wdr_count</a> &gt;= <a class="code" href="battery__pack__parameters_8h.html#a042f053175aceb6e9efa509c66196b8" title="Watchdog System Reset count cannot exceed this limit.">WDR_LIMIT</a> )
<a name="l00580"></a>00580         {
<a name="l00581"></a>00581             <span class="keywordflow">return</span> <a class="code" href="error_8h.html#5edd7aad54ac059bf561cf2f92017698a5571864412c8275a2e18a931fddcaa6">FAILURE</a>;             <span class="comment">// Report back an error message.</span>
<a name="l00582"></a>00582         }
<a name="l00583"></a>00583     }
<a name="l00584"></a>00584     
<a name="l00585"></a>00585     <span class="comment">/* Clear the Watchdog System Reset Counter on power-up or external reset */</span>
<a name="l00586"></a>00586     <span class="keywordflow">if</span>( reset_flags &amp; (1&lt;&lt;PORF) || reset_flags &amp; (1&lt;&lt;EXTRF) )
<a name="l00587"></a>00587     {
<a name="l00588"></a>00588         <a class="code" href="battery__pack__parameters_8h.html#275a856590939e7ec3cf1e6bb435776e" title="Counts number of Watchdog resets. Initialize to 0 on first programming.">wdr_count</a> = 0;
<a name="l00589"></a>00589     }
<a name="l00590"></a>00590     
<a name="l00591"></a>00591     <span class="keywordflow">return</span> <a class="code" href="error_8h.html#5edd7aad54ac059bf561cf2f92017698c7f69f7c9e5aea9b8f54cf02870e2bf8">SUCCESS</a>;
<a name="l00592"></a>00592 }
<a name="l00593"></a>00593 
<a name="l00594"></a>00594 
<a name="l00595"></a>00595 <span class="comment">/******************************************/</span>
<a name="l00602"></a>00602 <span class="preprocessor">#pragma inline=forced</span>
<a name="l00603"></a><a class="code" href="main_8c.html#35b1f3e0eb57bedd35d61664e5277763">00603</a> <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="main_8c.html#35b1f3e0eb57bedd35d61664e5277763" title="Run this function every second.">runEverySecond</a>() { 
<a name="l00604"></a>00604     <span class="comment">// Update the RTC</span>
<a name="l00605"></a>00605     <span class="comment">// Returns true if a new minute has occured, if it has, run that function</span>
<a name="l00606"></a>00606     <span class="keywordflow">if</span>( <a class="code" href="rtc_8c.html#001aef73d9b426aa872b4e8555e772a3" title="Add one second to the time.">RTC_AddSecond</a>() ) {
<a name="l00607"></a>00607         <a class="code" href="main_8c.html#e9fe9128363c0ecf3db954a1e07825e9" title="Run this function every minute.">runEveryMinute</a>();
<a name="l00608"></a>00608     }
<a name="l00609"></a>00609     
<a name="l00610"></a>00610     <span class="comment">/*</span>
<a name="l00611"></a>00611 <span class="comment">    If no battery protection interrupt has occured for BATTPROT_REOCCURING_CHARGE_PROTECTION_GAP</span>
<a name="l00612"></a>00612 <span class="comment">    seconds, clear chargeProtectionCounter ( the flag will be set to false when a discharge</span>
<a name="l00613"></a>00613 <span class="comment">    current is detected)</span>
<a name="l00614"></a>00614 <span class="comment">    It it has occured, and the counter is above the limit, set the reoccuringChargeProtection</span>
<a name="l00615"></a>00615 <span class="comment">    flag</span>
<a name="l00616"></a>00616 <span class="comment">    */</span>
<a name="l00617"></a>00617     <span class="keyword">static</span> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> reoccuringChargeProtectionGapCounter = 0;
<a name="l00618"></a>00618     <span class="keywordflow">if</span>( <a class="code" href="battery__protection_8c.html#988aff3a3cceb987229ece4fce86308a" title="Checks if Battery Protection has been triggered.">BATTPROT_IsProtectionTriggered</a>() ) {
<a name="l00619"></a>00619         <span class="keywordflow">if</span>( <a class="code" href="battery__protection_8c.html#6fc50879f599043fda7207475aace781" title="Get charge protection counter.">BATTPROT_GetChargeProtectionCounter</a>() &gt;= <a class="code" href="battery__protection_8h.html#1293c56bee76d3eabd35f1cdee21b470">BATTPROT_REOCCURING_CHARGE_PROTECTION_LIMIT</a> ) {
<a name="l00620"></a>00620             <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.reoccuringChargeProtection = <span class="keyword">true</span>;
<a name="l00621"></a>00621         }
<a name="l00622"></a>00622     } <span class="keywordflow">else</span> {
<a name="l00623"></a>00623         <span class="keywordflow">if</span>(<a class="code" href="battery__protection_8c.html#6fc50879f599043fda7207475aace781" title="Get charge protection counter.">BATTPROT_GetChargeProtectionCounter</a>() != 0) {
<a name="l00624"></a>00624             ++reoccuringChargeProtectionGapCounter;
<a name="l00625"></a>00625             <span class="keywordflow">if</span>(reoccuringChargeProtectionGapCounter &gt;= <a class="code" href="battery__protection_8h.html#bf131e98b04c1462b256a137013403d5">BATTPROT_REOCCURING_CHARGE_PROTECTION_GAP</a>) {
<a name="l00626"></a>00626                 <a class="code" href="battery__protection_8c.html#3584a066791a0ce5c3ac7357c9d5a3b9" title="Clear charge protection counter.">BATTPROT_ClearChargeProtectionCounter</a>();
<a name="l00627"></a>00627                 reoccuringChargeProtectionGapCounter = 0;
<a name="l00628"></a>00628             }
<a name="l00629"></a>00629         }
<a name="l00630"></a>00630     }
<a name="l00631"></a>00631 }
<a name="l00632"></a>00632 
<a name="l00633"></a>00633 
<a name="l00640"></a>00640 <span class="preprocessor">#pragma inline=forced</span>
<a name="l00641"></a><a class="code" href="main_8c.html#e9fe9128363c0ecf3db954a1e07825e9">00641</a> <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="main_8c.html#e9fe9128363c0ecf3db954a1e07825e9" title="Run this function every minute.">runEveryMinute</a>() {
<a name="l00642"></a>00642     <span class="comment">// Update remaining capacity and time alarm</span>
<a name="l00643"></a>00643     <span class="comment">// If they are set to 0, the alarms are disabled</span>
<a name="l00644"></a>00644     <span class="keywordflow">if</span>(   battParams.remainingCapacityAlarm != 0
<a name="l00645"></a>00645          &amp;&amp; <a class="code" href="cc__gas__gauging_8c.html#4a1ad76628aa8d3905b820ee0822dcf0" title="Convert accumulated to mAh.">CCGASG_Acc2mAh</a>(<a class="code" href="cc__gas__gauging_8c.html#6bd8ffcf294bdac1f08ce9b4406e834e" title="Read out raw values accumulated.">CCGASG_ReadAccumulatedCC</a>()) &lt; battParams.remainingCapacityAlarm)
<a name="l00646"></a>00646     {
<a name="l00647"></a>00647         <a class="code" href="main_8c.html#cbc2e758fec796eb6b48d6e625c967ef">sbsFlags</a>.remainingCapacityAlarm = <span class="keyword">true</span>;
<a name="l00648"></a>00648     } <span class="keywordflow">else</span> {
<a name="l00649"></a>00649         <a class="code" href="main_8c.html#cbc2e758fec796eb6b48d6e625c967ef">sbsFlags</a>.remainingCapacityAlarm = <span class="keyword">false</span>;
<a name="l00650"></a>00650     }
<a name="l00651"></a>00651     
<a name="l00652"></a>00652     <span class="keywordflow">if</span>(   battParams.remainingTimeAlarm != 0
<a name="l00653"></a>00653          &amp;&amp; <a class="code" href="gas__gauging_8c.html#17d5adf37f8f1ab7851727ec3335f501" title="Estimate time to empty.">GASG_TimeToEmpty</a>( <a class="code" href="battery__current__monitoring_8c.html#0959c4b3bb0cee63ad2a3bdb89a92a6d" title="Provide an estimate for the average current throughout the last minute (18-bit signed)...">BATTCUR_GetAverageCurrent</a>() ) &lt; battParams.remainingTimeAlarm)
<a name="l00654"></a>00654     {
<a name="l00655"></a>00655         <a class="code" href="main_8c.html#cbc2e758fec796eb6b48d6e625c967ef">sbsFlags</a>.remainingTimeAlarm = <span class="keyword">true</span>;
<a name="l00656"></a>00656     } <span class="keywordflow">else</span> {
<a name="l00657"></a>00657         <a class="code" href="main_8c.html#cbc2e758fec796eb6b48d6e625c967ef">sbsFlags</a>.remainingTimeAlarm = <span class="keyword">false</span>;
<a name="l00658"></a>00658     }
<a name="l00659"></a>00659     
<a name="l00660"></a>00660     <span class="comment">// Check if the SBS terminate flag and/or fully discharge flag should be set.</span>
<a name="l00661"></a>00661     <a class="code" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a> remCap = <a class="code" href="gas__gauging_8c.html#86386fa7dbd384f1d29de0dc72d8820c" title="Returns the remaining capacity at specified current.">GASG_RemainingCapacity</a>(<a class="code" href="battery__current__monitoring_8c.html#0959c4b3bb0cee63ad2a3bdb89a92a6d" title="Provide an estimate for the average current throughout the last minute (18-bit signed)...">BATTCUR_GetAverageCurrent</a>());
<a name="l00662"></a>00662     <span class="keywordflow">if</span>( remCap &lt; <a class="code" href="battery__pack__parameters_8c.html#465d57b9c9b2b607be86de50f09ed7ba" title="Battery parameters that are calculated at startup from eeprom variables.">battParams_sram</a>.<a class="code" href="structbattParam__sramstruct.html#fb9d0432d920397ad587516223b7bd5f" title="Terminate discharge limit in CC accumulated.">terminateDischargeLimit</a> ) {
<a name="l00663"></a>00663         <a class="code" href="main_8c.html#cbc2e758fec796eb6b48d6e625c967ef">sbsFlags</a>.terminateDischarge = <span class="keyword">true</span>;
<a name="l00664"></a>00664         
<a name="l00665"></a>00665         <span class="keywordflow">if</span>( remCap &lt;= 0 ) {
<a name="l00666"></a>00666             <a class="code" href="main_8c.html#cbc2e758fec796eb6b48d6e625c967ef">sbsFlags</a>.fullyDischarged = <span class="keyword">true</span>;
<a name="l00667"></a>00667         }
<a name="l00668"></a>00668     }
<a name="l00669"></a>00669 }
<a name="l00670"></a>00670 
<a name="l00671"></a>00671 
<a name="l00672"></a>00672 <span class="comment">/***********************************/</span>
<a name="l00683"></a><a class="code" href="main_8c.html#d796f8e3ff37c8495c342b32d6de57a2">00683</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="main_8c.html#d796f8e3ff37c8495c342b32d6de57a2" title="Handle a new core temperature.">handleNewCoreTemperature</a>() {
<a name="l00684"></a>00684     <a class="code" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a> newCoreTemperature = <a class="code" href="vadc_8c.html#ae4c822ab63bf82a578b0489e1b52129" title="Calculation of chip temperature.">VADC_readSystemTemperature</a>( );
<a name="l00685"></a>00685     
<a name="l00686"></a>00686     <span class="comment">//If the temperature has changed with more than CORE_TEMPERATURE_CHANGE_THRESHOLD the</span>
<a name="l00687"></a>00687     <span class="comment">// RC oscillator needs calibration to ensure that communication works correctly and</span>
<a name="l00688"></a>00688     <span class="comment">// that the CC-ADC readings are accurate.</span>
<a name="l00689"></a>00689     <span class="keywordflow">if</span>( (<a class="code" href="main_8c.html#87de25a56cfc5857df059f510fe3b049" title="The internal chip temperature in 0.1 Kelvin.">coreTemperature</a> + <a class="code" href="battery__pack__parameters_8h.html#76e543fc09c35a193baa63d3a6f3d8b6" title="If temperature changes more than 2 degrees Kelvin - it is an official change. *10...">CORE_TEMPERATURE_CHANGE_THRESHOLD</a>) &lt;= newCoreTemperature ||
<a name="l00690"></a>00690          (<a class="code" href="main_8c.html#87de25a56cfc5857df059f510fe3b049" title="The internal chip temperature in 0.1 Kelvin.">coreTemperature</a> - <a class="code" href="battery__pack__parameters_8h.html#76e543fc09c35a193baa63d3a6f3d8b6" title="If temperature changes more than 2 degrees Kelvin - it is an official change. *10...">CORE_TEMPERATURE_CHANGE_THRESHOLD</a>) &gt;= newCoreTemperature )
<a name="l00691"></a>00691     {
<a name="l00692"></a>00692         <a class="code" href="main_8c.html#87de25a56cfc5857df059f510fe3b049" title="The internal chip temperature in 0.1 Kelvin.">coreTemperature</a> = newCoreTemperature;
<a name="l00693"></a>00693         <a class="code" href="main_8c.html#96a6d06da6dd269353ef07d0dc7862af" title="Task flags.">taskFlags</a>.rcCalibrationRequired = <span class="keyword">true</span>;
<a name="l00694"></a>00694     }
<a name="l00695"></a>00695     
<a name="l00696"></a>00696     <span class="comment">// If the temperature is outside the operating range for the chip, enter power-off</span>
<a name="l00697"></a>00697     <span class="keywordflow">if</span>( <a class="code" href="main_8c.html#87de25a56cfc5857df059f510fe3b049" title="The internal chip temperature in 0.1 Kelvin.">coreTemperature</a> &gt;= <a class="code" href="battery__pack__parameters_8h.html#dfb23c00cc738ca6bb65328daea58b30" title="85C converted to 0.1 degrees Kelvin">CORE_MAX_TEMPERATURE</a> || <a class="code" href="main_8c.html#87de25a56cfc5857df059f510fe3b049" title="The internal chip temperature in 0.1 Kelvin.">coreTemperature</a> &lt;= <a class="code" href="battery__pack__parameters_8h.html#019da1b4d95da7205757fbe327a25381" title="-22C converted to 0.1 degress Kelvin">CORE_MIN_TEMPERATURE</a> ) {
<a name="l00698"></a>00698         <span class="comment">// Warning: Maybe check that it happens a couple of times in a row before powering off, to</span>
<a name="l00699"></a>00699         <span class="comment">//          avoid faulty values.</span>
<a name="l00700"></a>00700         <a class="code" href="main_8c.html#38e11c8b50a00ef91f4be286319d904e" title="Enter power-off if allowed.">enterPoweroff</a>();
<a name="l00701"></a>00701     }
<a name="l00702"></a>00702     
<a name="l00703"></a>00703     <span class="comment">// Assume that the core temperature is the same as the battery temperature when</span>
<a name="l00704"></a>00704     <span class="comment">// no thermistor are used</span>
<a name="l00705"></a>00705 <span class="preprocessor">#if HIGHEST_VADC == 0</span>
<a name="l00706"></a>00706 <span class="preprocessor"></span>    <span class="keywordflow">if</span>( ! <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.systemIsInStandby || <a class="code" href="main_8c.html#a3f0a393a933d87a3e8713c4985a8ac8" title="Return true if there is any temperature error.">anyTemperatureError</a>() ) {
<a name="l00707"></a>00707         <span class="keywordflow">if</span> (<a class="code" href="main_8c.html#a069db615d5edf9ae12c47823449c91d" title="Check if a battery temperature is within the limits.">checkBatteryTemperature</a>(newCoreTemperature, <a class="code" href="battery__current__monitoring_8c.html#7509bf2a6930a4ba1a5a1927582c40bb" title="Is the current charging or discharging the battery.">BATTCUR_IsDischargeOngoing</a>() ) ) {
<a name="l00708"></a>00708             <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.cellTemperatureTooHigh = <span class="keyword">false</span>;
<a name="l00709"></a>00709             <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.cellTemperatureTooLow = <span class="keyword">false</span>;
<a name="l00710"></a>00710         }
<a name="l00711"></a>00711     }
<a name="l00712"></a>00712 <span class="preprocessor">#endif</span>
<a name="l00713"></a>00713 <span class="preprocessor"></span>}
<a name="l00714"></a>00714 
<a name="l00715"></a>00715 <span class="comment">/***********************************/</span>
<a name="l00725"></a><a class="code" href="main_8c.html#c5e1648830816b0f3f9ce2309e8b7da5">00725</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="main_8c.html#c5e1648830816b0f3f9ce2309e8b7da5" title="Handle a new cell temperature.">handleNewCellTemperature</a>() {
<a name="l00726"></a>00726     
<a name="l00727"></a>00727     <span class="comment">// If no thermistor are configured, this function should never be called</span>
<a name="l00728"></a>00728     <span class="comment">// , but to be safe, do a check anyway</span>
<a name="l00729"></a>00729 <span class="preprocessor">#if HIGHEST_VADC == 0</span>
<a name="l00730"></a>00730 <span class="preprocessor"></span>        <span class="keywordflow">return</span>;
<a name="l00731"></a>00731     
<a name="l00732"></a>00732 <span class="preprocessor">#else</span>
<a name="l00733"></a>00733 <span class="preprocessor"></span>        <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> battCellTempVoltage = <a class="code" href="vadc_8h.html#fe2bff8c0faa27e7b05b6049267150cc">VADC_readVadc</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac6714493a7e51ebd764fa9744a13488cd41a39e">VADC0</a> );
<a name="l00734"></a>00734         cellTemperature[0] = <a class="code" href="ntc__rh163h103f_8c.html#155078c5f59862038f49ed2fbe7fb542" title="Convert ADC reading to degress kelvin.">NTC_ReadTemperatureKelvin</a>(battCellTempVoltage);
<a name="l00735"></a>00735         
<a name="l00736"></a>00736 <span class="preprocessor">#if HIGHEST_VADC == DEF_VADC1</span>
<a name="l00737"></a>00737 <span class="preprocessor"></span>        battCellTempVoltage = <a class="code" href="vadc_8h.html#fe2bff8c0faa27e7b05b6049267150cc">VADC_readVadc</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac67144934a20579d8ecc17304f9c59844e33fd4">VADC1</a> );
<a name="l00738"></a>00738         cellTemperature[1] = <a class="code" href="ntc__rh163h103f_8c.html#155078c5f59862038f49ed2fbe7fb542" title="Convert ADC reading to degress kelvin.">NTC_ReadTemperatureKelvin</a>(battCellTempVoltage);
<a name="l00739"></a>00739 <span class="preprocessor">#endif</span>
<a name="l00740"></a>00740 <span class="preprocessor"></span>        
<a name="l00741"></a>00741         <span class="keywordflow">if</span>( ! <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.systemIsInStandby  || <a class="code" href="main_8c.html#a3f0a393a933d87a3e8713c4985a8ac8" title="Return true if there is any temperature error.">anyTemperatureError</a>() ) {
<a name="l00742"></a>00742             
<a name="l00743"></a>00743             <span class="keywordtype">bool</span> <a class="code" href="battery__current__monitoring_8c.html#0331ed61d181da48bb4c5e7d3cdc26e7">discharge</a> = <a class="code" href="battery__current__monitoring_8c.html#7509bf2a6930a4ba1a5a1927582c40bb" title="Is the current charging or discharging the battery.">BATTCUR_IsDischargeOngoing</a>();
<a name="l00744"></a>00744             <span class="keywordtype">bool</span> allOK = <a class="code" href="main_8c.html#a069db615d5edf9ae12c47823449c91d" title="Check if a battery temperature is within the limits.">checkBatteryTemperature</a>(cellTemperature[0], discharge);
<a name="l00745"></a>00745             
<a name="l00746"></a>00746             <span class="comment">// Check the second thermistor if configured and first was okey. No need to check if one battery already outside limits</span>
<a name="l00747"></a>00747 <span class="preprocessor">#if HIGHEST_VADC == DEF_VADC1</span>
<a name="l00748"></a>00748 <span class="preprocessor"></span>            {
<a name="l00749"></a>00749                 <span class="keywordflow">if</span>( allOK ) {
<a name="l00750"></a>00750                     allOK = <a class="code" href="main_8c.html#a069db615d5edf9ae12c47823449c91d" title="Check if a battery temperature is within the limits.">checkBatteryTemperature</a>(cellTemperature[1], discharge);
<a name="l00751"></a>00751                 }
<a name="l00752"></a>00752             }
<a name="l00753"></a>00753 <span class="preprocessor">#endif //HIGHEST_VADC == DEF_VADC1</span>
<a name="l00754"></a>00754 <span class="preprocessor"></span>            
<a name="l00755"></a>00755             <span class="comment">// If all temperatures were okay, set flags to safe</span>
<a name="l00756"></a>00756             <span class="keywordflow">if</span>( allOK ) {
<a name="l00757"></a>00757                 <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.cellTemperatureTooHigh = <span class="keyword">false</span>;
<a name="l00758"></a>00758                 <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.cellTemperatureTooLow = <span class="keyword">false</span>;
<a name="l00759"></a>00759             }
<a name="l00760"></a>00760         }
<a name="l00761"></a>00761 <span class="preprocessor">#endif // else from HIGHEST_VADC == 0</span>
<a name="l00762"></a>00762 <span class="preprocessor"></span>}
<a name="l00763"></a>00763 
<a name="l00764"></a>00764 <span class="comment">/**************************/</span>
<a name="l00774"></a><a class="code" href="main_8c.html#a069db615d5edf9ae12c47823449c91d">00774</a> <span class="keyword">static</span> <a class="code" href="stdint_8h.html#ef44329758059c91c76d334e8fc09700">int8_t</a> <a class="code" href="main_8c.html#a069db615d5edf9ae12c47823449c91d" title="Check if a battery temperature is within the limits.">checkBatteryTemperature</a>(<a class="code" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a> temperature, <span class="keywordtype">bool</span> <a class="code" href="battery__current__monitoring_8c.html#0331ed61d181da48bb4c5e7d3cdc26e7">discharge</a>) {
<a name="l00775"></a>00775     <span class="keywordtype">bool</span> ret = <span class="keyword">true</span>;
<a name="l00776"></a>00776     
<a name="l00777"></a>00777     <span class="keywordflow">if</span>( discharge ) {
<a name="l00778"></a>00778         <span class="keywordflow">if</span>( battParams.cellMaxDischargeTemperature &lt; temperature ) {
<a name="l00779"></a>00779             <a class="code" href="fet__control_8c.html#047090a368a0a95c3c47a9c8f7602b8b" title="Disable the discharge FET.">FETCTRL_DisableDischargeFet</a>();
<a name="l00780"></a>00780             <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.cellTemperatureTooHigh = <span class="keyword">true</span>;
<a name="l00781"></a>00781             ret = <span class="keyword">false</span>;
<a name="l00782"></a>00782             
<a name="l00783"></a>00783         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( battParams.cellMinDischargeTemperature &gt; temperature ) {
<a name="l00784"></a>00784             <a class="code" href="fet__control_8c.html#047090a368a0a95c3c47a9c8f7602b8b" title="Disable the discharge FET.">FETCTRL_DisableDischargeFet</a>();
<a name="l00785"></a>00785             <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.cellTemperatureTooLow = <span class="keyword">true</span>;
<a name="l00786"></a>00786             ret = <span class="keyword">false</span>;
<a name="l00787"></a>00787         }
<a name="l00788"></a>00788     } <span class="keywordflow">else</span> {
<a name="l00789"></a>00789         <span class="keywordflow">if</span>( battParams.cellMaxChargeTemperature &lt; temperature ) {
<a name="l00790"></a>00790             <a class="code" href="fet__control_8c.html#0258102f1334bb8a65f364e43b2e41fe" title="Disable the charge FET.">FETCTRL_DisableChargeFet</a>();
<a name="l00791"></a>00791             <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.cellTemperatureTooHigh = <span class="keyword">true</span>;
<a name="l00792"></a>00792             ret = <span class="keyword">false</span>;
<a name="l00793"></a>00793             
<a name="l00794"></a>00794         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( battParams.cellMinChargeTemperature &gt; temperature ) {
<a name="l00795"></a>00795             <a class="code" href="fet__control_8c.html#0258102f1334bb8a65f364e43b2e41fe" title="Disable the charge FET.">FETCTRL_DisableChargeFet</a>();
<a name="l00796"></a>00796             <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.cellTemperatureTooLow = <span class="keyword">true</span>;
<a name="l00797"></a>00797             ret = <span class="keyword">false</span>;
<a name="l00798"></a>00798         }
<a name="l00799"></a>00799     }
<a name="l00800"></a>00800     <span class="keywordflow">return</span> ret;
<a name="l00801"></a>00801 }
<a name="l00802"></a>00802 
<a name="l00803"></a>00803 <span class="comment">/***********************************/</span>
<a name="l00812"></a><a class="code" href="main_8c.html#555166b9d50c63472698721acfc26057">00812</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="main_8c.html#555166b9d50c63472698721acfc26057" title="Handle a new cell voltage for cells.">handleNewCellVoltage</a>(<a class="code" href="vadc_8h.html#5ed5da99ecfd6b14544e9fde0bbe28ed" title="Typedef used where number of cells is input to functions.">vadcIndex_t</a> TempCellVoltage) {
<a name="l00813"></a>00813     
<a name="l00814"></a>00814     <span class="comment">// Clear voltageTooHigh and tooLow flags here</span>
<a name="l00815"></a>00815     <span class="comment">// They can get set by either the handling of CELL1 or the CELL2,3 and 4,</span>
<a name="l00816"></a>00816     <span class="comment">// but can only be cleared by CELL1.</span>
<a name="l00817"></a>00817     <span class="keywordflow">if</span> (<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac671449b08613e4845ef2a5d657b8562c394673">CELL1</a> == TempCellVoltage){
<a name="l00818"></a>00818         <span class="comment">//disableDUVRIfPossible();</span>
<a name="l00819"></a>00819     <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.voltageTooLow = <span class="keyword">false</span>;
<a name="l00820"></a>00820     <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.voltageTooHigh = <span class="keyword">false</span>;
<a name="l00821"></a>00821 }
<a name="l00822"></a>00822 
<a name="l00823"></a>00823 
<a name="l00824"></a>00824     <span class="keywordflow">if</span> (HIGHEST_CELL == TempCellVoltage){
<a name="l00825"></a>00825     <span class="comment">// Update the voltage based state of charge. It assumes to be run once every second</span>
<a name="l00826"></a>00826     <span class="comment">// Returns true if a new OCV SoC have been written, so use it to calculate new</span>
<a name="l00827"></a>00827     <span class="comment">// remainingCapacity if that is considered inaccurate</span>
<a name="l00828"></a>00828     <span class="keywordflow">if</span>(<a class="code" href="voltage__based__SoC_8c.html#9708e584eda79bcf685b716b25e66765" title="Updates the SoC.">VBSoC_Update</a>() &amp;&amp; <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.remainingCapacityInaccurate) {
<a name="l00829"></a>00829         <a class="code" href="cc__gas__gauging_8c.html#524ffb0c818f674a80049a992a29928b" title="Update State of Charge.">CCGASG_SetStateofCharge</a>(<a class="code" href="voltage__based__SoC_8c.html#3cfbb7f6888a90eb03eeb14e7f4b00aa" title="Returns the the latest open circuit state of charge.">VBSoC_OCSoC</a>());
<a name="l00830"></a>00830             <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.remainingCapacityInaccurate = <span class="keyword">false</span>;
<a name="l00831"></a>00831     }
<a name="l00832"></a>00832     }
<a name="l00833"></a>00833     
<a name="l00834"></a>00834     <span class="keywordtype">bool</span> <a class="code" href="battery__current__monitoring_8c.html#0331ed61d181da48bb4c5e7d3cdc26e7">discharge</a> = <a class="code" href="battery__current__monitoring_8c.html#7509bf2a6930a4ba1a5a1927582c40bb" title="Is the current charging or discharging the battery.">BATTCUR_IsDischargeOngoing</a>();
<a name="l00835"></a>00835     
<a name="l00836"></a>00836     <span class="comment">// Check that battery voltage is within spec - if not disable the charge/discharge FET.</span>
<a name="l00837"></a>00837     <span class="keywordflow">if</span>( discharge ){
<a name="l00838"></a>00838         <span class="keywordflow">if</span>(<a class="code" href="battery__voltage__monitoring_8c.html#3896cc743e5299ec912ec41485edaaa0" title="Investigate if the battery cells are too low.">BATTVMON_IsCellVoltageTooLow</a>(TempCellVoltage) ){
<a name="l00839"></a>00839         <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.dischargingProhibited = <span class="keyword">true</span>;
<a name="l00840"></a>00840         <a class="code" href="fet__control_8c.html#047090a368a0a95c3c47a9c8f7602b8b" title="Disable the discharge FET.">FETCTRL_DisableDischargeFet</a>();
<a name="l00841"></a>00841         <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.voltageTooLow = <span class="keyword">true</span>;
<a name="l00842"></a>00842         <a class="code" href="main_8c.html#cbc2e758fec796eb6b48d6e625c967ef">sbsFlags</a>.fullyDischarged = <span class="keyword">true</span>;
<a name="l00843"></a>00843         }
<a name="l00844"></a>00844         
<a name="l00845"></a>00845         <span class="keywordflow">if</span> (HIGHEST_CELL == TempCellVoltage){
<a name="l00846"></a>00846             <span class="keywordflow">if</span>( <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.voltageTooLow ) {
<a name="l00847"></a>00847         <span class="comment">// When voltage is too low, it might also be so low that we should enter poweroff</span>
<a name="l00848"></a>00848         <span class="comment">// Require two poweroff voltage in a row to shut down</span>
<a name="l00849"></a>00849         <span class="comment">// If poweroff not is enabled, enterPoweroff() sets simulatePowerOff and disable the FETs</span>
<a name="l00850"></a>00850                 <span class="keywordflow">if</span>( <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac671449b08613e4845ef2a5d657b8562c394673">CELL1</a>) &lt;= battParams.cellPoweroffVoltage
<a name="l00851"></a>00851 #<span class="keywordflow">if</span> BATTPARAM_CELLS_IN_SERIES &gt;= 2
<a name="l00852"></a>00852            || <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac67144983bc57407aa6f82e37d495ff9d28ed81">CELL2</a>) &lt;= battParams.cellPoweroffVoltage
<a name="l00853"></a>00853 #<span class="keywordflow">if</span> BATTPARAM_CELLS_IN_SERIES &gt;= 3
<a name="l00854"></a>00854                  || <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac6714494ab35dc613899d959b4e063d736deb2d">CELL3</a>) &lt;= battParams.cellPoweroffVoltage
<a name="l00855"></a>00855 #<span class="keywordflow">if</span> BATTPARAM_CELLS_IN_SERIES &gt;= 4
<a name="l00856"></a>00856                  || <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>(<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac6714495dc31be69defc09d627e487ce6a56c1a">CELL4</a>) &lt;= battParams.cellPoweroffVoltage
<a name="l00857"></a>00857 #endif
<a name="l00858"></a>00858 #endif
<a name="l00859"></a>00859 #endif
<a name="l00860"></a>00860                 ){
<a name="l00861"></a>00861             <span class="keywordflow">if</span>( <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.poweroffCondition ) {
<a name="l00862"></a>00862                 <a class="code" href="main_8c.html#38e11c8b50a00ef91f4be286319d904e" title="Enter power-off if allowed.">enterPoweroff</a>();
<a name="l00863"></a>00863             } <span class="keywordflow">else</span> {
<a name="l00864"></a>00864                 <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.poweroffCondition = <span class="keyword">true</span>;
<a name="l00865"></a>00865             }
<a name="l00866"></a>00866         } <span class="keywordflow">else</span> {
<a name="l00867"></a>00867             <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.poweroffCondition = <span class="keyword">false</span>;
<a name="l00868"></a>00868         }
<a name="l00869"></a>00869     }
<a name="l00870"></a>00870     }
<a name="l00871"></a>00871     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !discharge ){
<a name="l00872"></a>00872         
<a name="l00873"></a>00873         <span class="comment">// Enable cell balancing if not in DUVR mode</span>
<a name="l00874"></a>00874         <span class="keywordflow">if</span>( ! <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.inDUVR ) {
<a name="l00875"></a>00875             <span class="keywordflow">if</span>( <a class="code" href="vadc_8h.html#174ac16661827ae97404ee065e8ecf5e5fc0704fc5cb466b1d72ce9c2a2b5548">VADC_RUNNING</a> != <a class="code" href="vadc_8c.html#a36cbd40622b622424c4d6af8fb2bef3" title="Check VADC scan status.">VADC_ScanState</a>() ){
<a name="l00876"></a>00876                 <span class="keywordflow">if</span>(<a class="code" href="main_8c.html#0f7149db7892cd59cfc8806e789ec906" title="State of Charge.">SoC_State</a> &gt; 80){
<a name="l00877"></a>00877                 BATTVMON_EnableCellBalancing();
<a name="l00878"></a>00878             }
<a name="l00879"></a>00879         }
<a name="l00880"></a>00880         }
<a name="l00881"></a>00881         
<a name="l00882"></a>00882         <span class="comment">// Check if voltage is too high</span>
<a name="l00883"></a>00883         <span class="keywordflow">if</span>( <a class="code" href="battery__voltage__monitoring_8c.html#5e2404a51e229d6ebbef3947c678a3c5" title="Investigate if any of the battery cells are too high.">BATTVMON_IsCellVoltageTooHigh</a>(TempCellVoltage) ) {
<a name="l00884"></a>00884             <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.chargingProhibited = <span class="keyword">true</span>;
<a name="l00885"></a>00885             <a class="code" href="fet__control_8c.html#0258102f1334bb8a65f364e43b2e41fe" title="Disable the charge FET.">FETCTRL_DisableChargeFet</a>();
<a name="l00886"></a>00886             <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.voltageTooHigh = <span class="keyword">true</span>;
<a name="l00887"></a>00887         }
<a name="l00888"></a>00888     }
<a name="l00889"></a>00889 
<a name="l00890"></a>00890 }
<a name="l00891"></a>00891 
<a name="l00892"></a>00892 
<a name="l00893"></a>00893 <span class="comment">/***********************************************/</span>
<a name="l00904"></a><a class="code" href="main_8c.html#9985e5b9301e8ecdc5ef51c747d9c025">00904</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="main_8c.html#9985e5b9301e8ecdc5ef51c747d9c025" title="Handle a new result from the CC-ADC.">handleNewCCADCResult</a>() {
<a name="l00905"></a>00905     <a class="code" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a> offsetCompensatedCurrent = <a class="code" href="battery__current__monitoring_8c.html#6a557e4dca31a58b1683861bf8f154e6" title="Provides the offset calibrated current from the last CC-ADC reading.">BATTCUR_GetOffsetCalibratedCurrent</a>();
<a name="l00906"></a>00906     
<a name="l00907"></a>00907     <a class="code" href="battery__current__monitoring_8c.html#cfd447102c06d4b657539fe1cd9f3f59" title="Calculates and stores the average current during the last minut (18-bit signed).">BATTCUR_UpdateAverageCurrent</a>( offsetCompensatedCurrent );
<a name="l00908"></a>00908     
<a name="l00909"></a>00909     <span class="comment">// Set standby flag</span>
<a name="l00910"></a>00910     <span class="comment">// Check if charge current is too high</span>
<a name="l00911"></a>00911     <span class="comment">// Reset the relaxation timer for the voltage based gas gauging if device not is in standby anymore</span>
<a name="l00912"></a>00912     <span class="keywordflow">if</span>( <a class="code" href="battery__current__monitoring_8c.html#5514ee0b54dac907d6cbb5572146f612" title="Is the current below the limit that defines standby operation (time to enter low...">BATTCUR_IsCurrentLow</a>(offsetCompensatedCurrent) )
<a name="l00913"></a>00913     {
<a name="l00914"></a>00914         <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.systemIsInStandby = <span class="keyword">true</span>;
<a name="l00915"></a>00915     }
<a name="l00916"></a>00916     <span class="keywordflow">else</span>
<a name="l00917"></a>00917     {
<a name="l00918"></a>00918         <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.systemIsInStandby = <span class="keyword">false</span>;
<a name="l00919"></a>00919         
<a name="l00920"></a>00920         <span class="comment">// Reset the relaxation counter</span>
<a name="l00921"></a>00921         <a class="code" href="voltage__based__SoC_8c.html#96735c5df96b87b60cfd1222e1420adb" title="Reset the relaxation timer.">VBSoC_ResetTimer</a>();
<a name="l00922"></a>00922         
<a name="l00923"></a>00923         <span class="comment">// If discharging (and not only standby discharge) clear charge protection flags</span>
<a name="l00924"></a>00924         <span class="comment">// And also clear the fully charged bit</span>
<a name="l00925"></a>00925         <span class="keywordflow">if</span>( <a class="code" href="battery__current__monitoring_8c.html#7509bf2a6930a4ba1a5a1927582c40bb" title="Is the current charging or discharging the battery.">BATTCUR_IsDischargeOngoing</a>() ) {
<a name="l00926"></a>00926             <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.reoccuringChargeProtection = <span class="keyword">false</span>;
<a name="l00927"></a>00927             <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.chargingProhibited = <span class="keyword">false</span>;
<a name="l00928"></a>00928             
<a name="l00929"></a>00929             <a class="code" href="main_8c.html#cbc2e758fec796eb6b48d6e625c967ef">sbsFlags</a>.fullyCharged = <span class="keyword">false</span>;
<a name="l00930"></a>00930             
<a name="l00931"></a>00931         <span class="comment">// When charging, make sure discharging not is prohibited anymore</span>
<a name="l00932"></a>00932         <span class="comment">// If charging with too high current, do something perhaps....</span>
<a name="l00933"></a>00933         } <span class="keywordflow">else</span> {
<a name="l00934"></a>00934             <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.dischargingProhibited = <span class="keyword">false</span>;
<a name="l00935"></a>00935             
<a name="l00936"></a>00936             <span class="comment">// Clear terminateDischarge as the host can start to draw power again when a charger is connected</span>
<a name="l00937"></a>00937             <a class="code" href="main_8c.html#cbc2e758fec796eb6b48d6e625c967ef">sbsFlags</a>.terminateDischarge = <span class="keyword">false</span>;
<a name="l00938"></a>00938         }
<a name="l00939"></a>00939     }
<a name="l00940"></a>00940     
<a name="l00941"></a>00941     <span class="comment">// When charging, check if battery is fully charged</span>
<a name="l00942"></a>00942     <span class="comment">// TODO: this will be wrong if the charger is on purpose charging with low current</span>
<a name="l00943"></a>00943     <span class="comment">// or if it is incapable of delivering more current.</span>
<a name="l00944"></a>00944     <span class="comment">// Also check if fullyDischarged flag can be cleared</span>
<a name="l00945"></a>00945     <span class="keywordflow">if</span>( offsetCompensatedCurrent &gt; 0 ) {
<a name="l00946"></a>00946         <span class="keywordflow">if</span>( <a class="code" href="main_8c.html#cbc2e758fec796eb6b48d6e625c967ef">sbsFlags</a>.fullyDischarged &amp;&amp; <a class="code" href="gas__gauging_8c.html#cfbc7e47153ec1e54e6fc85ddde14d26" title="Returns state of charge.">GASG_StateOfCharge</a>(offsetCompensatedCurrent, <a class="code" href="battery__pack__parameters_8c.html#465d57b9c9b2b607be86de50f09ed7ba" title="Battery parameters that are calculated at startup from eeprom variables.">battParams_sram</a>.<a class="code" href="structbattParam__sramstruct.html#76fcb4f7f90d64e089eab59b5bc69b6b" title="Full charge capacity in CC accumulated.">capacityInCCAccumulated</a>) &gt;= 20 ) {
<a name="l00947"></a>00947             <a class="code" href="main_8c.html#cbc2e758fec796eb6b48d6e625c967ef">sbsFlags</a>.fullyDischarged = <span class="keyword">false</span>;
<a name="l00948"></a>00948         }
<a name="l00949"></a>00949         
<a name="l00950"></a>00950         <span class="comment">// Note: using lowest voltage raises the possibility of charging getting stopped</span>
<a name="l00951"></a>00951         <span class="comment">//       but not considered a full charge because of cell misbalance. But this is</span>
<a name="l00952"></a>00952         <span class="comment">//       probably what you want.</span>
<a name="l00953"></a>00953         <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> lowestVoltage;
<a name="l00954"></a>00954 <span class="preprocessor">#if BATTPARAM_CELLS_IN_SERIES == 1</span>
<a name="l00955"></a>00955 <span class="preprocessor"></span>        {
<a name="l00956"></a>00956             lowestVoltage = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac671449b08613e4845ef2a5d657b8562c394673">CELL1</a> );
<a name="l00957"></a>00957         }
<a name="l00958"></a>00958 <span class="preprocessor">#elif BATTPARAM_CELLS_IN_SERIES == 2</span>
<a name="l00959"></a>00959 <span class="preprocessor"></span>        {
<a name="l00960"></a>00960             <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> cell1 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac671449b08613e4845ef2a5d657b8562c394673">CELL1</a> );
<a name="l00961"></a>00961             <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> cell2 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac67144983bc57407aa6f82e37d495ff9d28ed81">CELL2</a> );
<a name="l00962"></a>00962             lowestVoltage = cell1 &lt; cell2 ? cell1 : cell2;
<a name="l00963"></a>00963         }
<a name="l00964"></a>00964 <span class="preprocessor">#elif BATTPARAM_CELLS_IN_SERIES == 3</span>
<a name="l00965"></a>00965 <span class="preprocessor"></span>        {
<a name="l00966"></a>00966             <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> cell1 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac671449b08613e4845ef2a5d657b8562c394673">CELL1</a> );
<a name="l00967"></a>00967             <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> cell2 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac67144983bc57407aa6f82e37d495ff9d28ed81">CELL2</a> );
<a name="l00968"></a>00968             <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> cell3 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac6714494ab35dc613899d959b4e063d736deb2d">CELL3</a> );
<a name="l00969"></a>00969             lowestVoltage = cell1 &lt; cell2 ? cell1 : cell2;
<a name="l00970"></a>00970             lowestVoltage = lowestVoltage &lt; cell3 ? lowestVoltage : cell3;
<a name="l00971"></a>00971         }
<a name="l00972"></a>00972 <span class="preprocessor">#elif BATTPARAM_CELLS_IN_SERIES == 4</span>
<a name="l00973"></a>00973 <span class="preprocessor"></span>        {
<a name="l00974"></a>00974             <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> cell1 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac671449b08613e4845ef2a5d657b8562c394673">CELL1</a> );
<a name="l00975"></a>00975             <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> cell2 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac67144983bc57407aa6f82e37d495ff9d28ed81">CELL2</a> );
<a name="l00976"></a>00976             <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> cell3 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac6714494ab35dc613899d959b4e063d736deb2d">CELL3</a> );
<a name="l00977"></a>00977             <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> cell4 = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac6714495dc31be69defc09d627e487ce6a56c1a">CELL4</a> );
<a name="l00978"></a>00978             lowestVoltage = cell1 &lt; cell2 ? cell1 : cell2;
<a name="l00979"></a>00979             lowestVoltage = lowestVoltage &lt; cell3 ? lowestVoltage : cell3;
<a name="l00980"></a>00980             lowestVoltage = lowestVoltage &lt; cell4 ? lowestVoltage : cell4;
<a name="l00981"></a>00981         }
<a name="l00982"></a>00982 <span class="preprocessor">#endif</span>
<a name="l00983"></a>00983 <span class="preprocessor"></span>        
<a name="l00984"></a>00984         <span class="comment">// Update fullChargeCapacity if the battery is considered fully charged</span>
<a name="l00985"></a>00985         <span class="comment">// TODO: update remainingCapacity calibration table here</span>
<a name="l00986"></a>00986         <span class="comment">// This is only run during charging, so no point in avoiding calculations</span>
<a name="l00987"></a>00987         <span class="keywordflow">if</span>( lowestVoltage &gt; battParams.fullChargeVoltage ) {
<a name="l00988"></a>00988             <span class="keywordflow">if</span>( <a class="code" href="battery__current__monitoring_8c.html#90ab35d451c37cb0d641b5f037598441" title="Convert mA to CCADC tick.">BATTCUR_mA2Ticks</a>( battParams.fullChargeCurrent ) &gt; offsetCompensatedCurrent ) {
<a name="l00989"></a>00989                 <a class="code" href="main_8c.html#cbc2e758fec796eb6b48d6e625c967ef">sbsFlags</a>.fullyCharged = <span class="keyword">true</span>;
<a name="l00990"></a>00990                 
<a name="l00991"></a>00991                 <a class="code" href="battery__pack__parameters_8c.html#465d57b9c9b2b607be86de50f09ed7ba" title="Battery parameters that are calculated at startup from eeprom variables.">battParams_sram</a>.<a class="code" href="structbattParam__sramstruct.html#76fcb4f7f90d64e089eab59b5bc69b6b" title="Full charge capacity in CC accumulated.">capacityInCCAccumulated</a> = <a class="code" href="cc__gas__gauging_8c.html#6bd8ffcf294bdac1f08ce9b4406e834e" title="Read out raw values accumulated.">CCGASG_ReadAccumulatedCC</a>();
<a name="l00992"></a>00992                 
<a name="l00993"></a>00993                 <span class="comment">// Only update in eeprom if there was a change</span>
<a name="l00994"></a>00994                 <a class="code" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a> temp = <a class="code" href="cc__gas__gauging_8c.html#4a1ad76628aa8d3905b820ee0822dcf0" title="Convert accumulated to mAh.">CCGASG_Acc2mAh</a>(<a class="code" href="battery__pack__parameters_8c.html#465d57b9c9b2b607be86de50f09ed7ba" title="Battery parameters that are calculated at startup from eeprom variables.">battParams_sram</a>.<a class="code" href="structbattParam__sramstruct.html#76fcb4f7f90d64e089eab59b5bc69b6b" title="Full charge capacity in CC accumulated.">capacityInCCAccumulated</a>);
<a name="l00995"></a>00995                 <span class="keywordflow">if</span>(temp != battParams.fullChargeCapacity) {
<a name="l00996"></a>00996                     battParams.fullChargeCapacity = temp;
<a name="l00997"></a>00997                 }
<a name="l00998"></a>00998             }
<a name="l00999"></a>00999         }
<a name="l01000"></a>01000     }
<a name="l01001"></a>01001 }
<a name="l01002"></a>01002 
<a name="l01003"></a>01003 
<a name="l01004"></a>01004 <span class="comment">/***********************************************/</span>
<a name="l01013"></a><a class="code" href="main_8c.html#0b26b15d93cf12599106c4efc57e8272">01013</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="main_8c.html#0b26b15d93cf12599106c4efc57e8272" title="Configure VADC scanning.">configureVADC</a>() {
<a name="l01014"></a>01014     <span class="keyword">static</span> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> counter = 0;
<a name="l01015"></a>01015     
<a name="l01016"></a>01016     ++counter;
<a name="l01017"></a>01017     
<a name="l01018"></a>01018     <span class="keywordflow">if</span>(counter == 4) {
<a name="l01019"></a>01019         <a class="code" href="vadc_8c.html#d643e5b97a0eb9cd93ae80e2527bbade" title="Select VADC channels to be scanned.">VADC_ScanConfig</a>((<a class="code" href="vadc_8h.html#5ed5da99ecfd6b14544e9fde0bbe28ed" title="Typedef used where number of cells is input to functions.">vadcIndex_t</a>)HIGHEST_CELL, (<a class="code" href="vadc_8h.html#5ed5da99ecfd6b14544e9fde0bbe28ed" title="Typedef used where number of cells is input to functions.">vadcIndex_t</a>)<a class="code" href="battery__pack__parameters_8h.html#78d4599a88da8ae09a2a0d829d2ffec8">HIGHEST_VADC</a>, (<a class="code" href="vadc_8h.html#5ed5da99ecfd6b14544e9fde0bbe28ed" title="Typedef used where number of cells is input to functions.">vadcIndex_t</a>)0);
<a name="l01020"></a>01020         counter = 0;
<a name="l01021"></a>01021     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (counter == 2) {
<a name="l01022"></a>01022         <a class="code" href="vadc_8c.html#d643e5b97a0eb9cd93ae80e2527bbade" title="Select VADC channels to be scanned.">VADC_ScanConfig</a>((<a class="code" href="vadc_8h.html#5ed5da99ecfd6b14544e9fde0bbe28ed" title="Typedef used where number of cells is input to functions.">vadcIndex_t</a>)HIGHEST_CELL, (<a class="code" href="vadc_8h.html#5ed5da99ecfd6b14544e9fde0bbe28ed" title="Typedef used where number of cells is input to functions.">vadcIndex_t</a>)0, (<a class="code" href="vadc_8h.html#5ed5da99ecfd6b14544e9fde0bbe28ed" title="Typedef used where number of cells is input to functions.">vadcIndex_t</a>)<a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac6714499726d93b81232e1e9a84c16e5355e77b">VTEMP</a>);
<a name="l01023"></a>01023     } <span class="keywordflow">else</span> {
<a name="l01024"></a>01024         <a class="code" href="vadc_8c.html#d643e5b97a0eb9cd93ae80e2527bbade" title="Select VADC channels to be scanned.">VADC_ScanConfig</a>((<a class="code" href="vadc_8h.html#5ed5da99ecfd6b14544e9fde0bbe28ed" title="Typedef used where number of cells is input to functions.">vadcIndex_t</a>)HIGHEST_CELL, (<a class="code" href="vadc_8h.html#5ed5da99ecfd6b14544e9fde0bbe28ed" title="Typedef used where number of cells is input to functions.">vadcIndex_t</a>)0, (<a class="code" href="vadc_8h.html#5ed5da99ecfd6b14544e9fde0bbe28ed" title="Typedef used where number of cells is input to functions.">vadcIndex_t</a>)0);
<a name="l01025"></a>01025     }
<a name="l01026"></a>01026 }
<a name="l01027"></a>01027 
<a name="l01028"></a>01028 
<a name="l01029"></a>01029 <span class="comment">/******************************************/</span>
<a name="l01033"></a><a class="code" href="main_8c.html#492861926b4fc152ad1def3695aaeaf5">01033</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="main_8c.html#492861926b4fc152ad1def3695aaeaf5" title="Disable DUVR mode if possible.">disableDUVRIfPossible</a>()
<a name="l01034"></a>01034 {
<a name="l01035"></a>01035     <span class="keywordflow">if</span> ( !(FCSR &amp; (1&lt;&lt;DUVRD)) ) {
<a name="l01036"></a>01036         <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.inDUVR = <span class="keyword">true</span>;
<a name="l01037"></a>01037         <span class="keywordflow">if</span>( <a class="code" href="error_8h.html#5edd7aad54ac059bf561cf2f92017698c7f69f7c9e5aea9b8f54cf02870e2bf8">SUCCESS</a> == <a class="code" href="vadc_8c.html#c2fd0c6752a999af5d7b98ccbfb082f6" title="Check if DUVR mode can be disabled and if so disable it.">DUVR_DisableCheck</a>() ){
<a name="l01038"></a>01038             <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.inDUVR = <span class="keyword">false</span>;
<a name="l01039"></a>01039         }
<a name="l01040"></a>01040     }
<a name="l01041"></a>01041 }
<a name="l01042"></a>01042 
<a name="l01043"></a>01043 
<a name="l01044"></a>01044 <span class="comment">/******************************************/</span>
<a name="l01050"></a><a class="code" href="main_8c.html#a3f0a393a933d87a3e8713c4985a8ac8">01050</a> <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="main_8c.html#a3f0a393a933d87a3e8713c4985a8ac8" title="Return true if there is any temperature error.">anyTemperatureError</a>() {
<a name="l01051"></a>01051     <span class="keywordflow">return</span> (<a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.cellTemperatureTooHigh || <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.cellTemperatureTooLow );
<a name="l01052"></a>01052 }
<a name="l01053"></a>01053 
<a name="l01054"></a>01054 
<a name="l01055"></a>01055 <span class="comment">/******************************************/</span>
<a name="l01059"></a><a class="code" href="main_8c.html#38e11c8b50a00ef91f4be286319d904e">01059</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="main_8c.html#38e11c8b50a00ef91f4be286319d904e" title="Enter power-off if allowed.">enterPoweroff</a>()
<a name="l01060"></a>01060 {
<a name="l01061"></a>01061 <span class="preprocessor">#ifdef POWEROFF_ENABLED</span>
<a name="l01062"></a>01062 <span class="preprocessor"></span>    <a class="code" href="pwr__mgmnt_8h.html#7d43d45bdc9761aec54a7a94e20bc2d8" title="Enter power-off mode.">SLEEP_ENTER_POWER_OFF</a>();
<a name="l01063"></a>01063 <span class="preprocessor">#else</span>
<a name="l01064"></a>01064 <span class="preprocessor"></span>    <a class="code" href="fet__control_8c.html#16b63cca34a388992fee275392cb4c71" title="Disable both the charge and the discharge FETs.">FETCTRL_DisableFets</a>();
<a name="l01065"></a>01065     <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.simulatePowerOff = <span class="keyword">true</span>;
<a name="l01066"></a>01066 <span class="preprocessor">#endif</span>
<a name="l01067"></a>01067 <span class="preprocessor"></span>}
<a name="l01068"></a>01068 
<a name="l01069"></a>01069 
<a name="l01070"></a>01070 <span class="comment">/***********************************/</span>
<a name="l01076"></a><a class="code" href="main_8c.html#4cc87fab6ddd51f6598ed9bdb75bf4cf">01076</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="main_8c.html#4cc87fab6ddd51f6598ed9bdb75bf4cf" title="Handle a SBS command.">handleSBSCommand</a>() {
<a name="l01077"></a>01077     <a class="code" href="main_8c.html#96a6d06da6dd269353ef07d0dc7862af" title="Task flags.">taskFlags</a>.newSbsCommandAvailable = <span class="keyword">false</span>;
<a name="l01078"></a>01078     
<a name="l01079"></a>01079     
<a name="l01080"></a>01080     <span class="keywordflow">switch</span> (sbs.<a class="code" href="unionSBS__command__union.html#6100200cb255940c793af26657713005">command</a>){
<a name="l01081"></a>01081         <span class="comment">//          SBSCMD_manufacturerAccess</span>
<a name="l01082"></a>01082         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#d5500c9b9dd285eaa77e28413d7258df">SBS_WRITE</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506edeccf6b2ab578bcd721f491b89805313">SBSCMD_manufacturerAccess</a>):
<a name="l01083"></a>01083         {
<a name="l01084"></a>01084             <span class="keywordflow">break</span>;
<a name="l01085"></a>01085         }
<a name="l01086"></a>01086         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506edeccf6b2ab578bcd721f491b89805313">SBSCMD_manufacturerAccess</a>):
<a name="l01087"></a>01087         {
<a name="l01088"></a>01088             <span class="comment">// TODO: replace dummy value</span>
<a name="l01089"></a>01089             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = 0x00;
<a name="l01090"></a>01090             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01091"></a>01091             <span class="keywordflow">break</span>;
<a name="l01092"></a>01092         }
<a name="l01093"></a>01093         <span class="comment">//          SBSCMD_remainingCapacityAlarm</span>
<a name="l01094"></a>01094         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#d5500c9b9dd285eaa77e28413d7258df">SBS_WRITE</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e1511c1e95e2d1063079bbdabf35968e5">SBSCMD_remainingCapacityAlarm</a>):
<a name="l01095"></a>01095         {
<a name="l01096"></a>01096             battParams.remainingCapacityAlarm = sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a>;
<a name="l01097"></a>01097             <span class="keywordflow">break</span>;
<a name="l01098"></a>01098         }
<a name="l01099"></a>01099         <span class="comment">//          SBSCMD_remainingCapacityAlarm</span>
<a name="l01100"></a>01100         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e1511c1e95e2d1063079bbdabf35968e5">SBSCMD_remainingCapacityAlarm</a>):
<a name="l01101"></a>01101         {
<a name="l01102"></a>01102             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = battParams.remainingCapacityAlarm;
<a name="l01103"></a>01103             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01104"></a>01104             <span class="keywordflow">break</span>;
<a name="l01105"></a>01105         }
<a name="l01106"></a>01106         <span class="comment">//          SBSCMD_remainingTimeAlarm</span>
<a name="l01107"></a>01107         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#d5500c9b9dd285eaa77e28413d7258df">SBS_WRITE</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e09b1d494dba14b9c3a6f1c30a2f9d962">SBSCMD_remainingTimeAlarm</a>):
<a name="l01108"></a>01108         {
<a name="l01109"></a>01109             battParams.remainingTimeAlarm = sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a>;
<a name="l01110"></a>01110             <span class="keywordflow">break</span>;
<a name="l01111"></a>01111         }
<a name="l01112"></a>01112         <span class="comment">//          SBSCMD_remainingTimeAlarm</span>
<a name="l01113"></a>01113         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e09b1d494dba14b9c3a6f1c30a2f9d962">SBSCMD_remainingTimeAlarm</a>):
<a name="l01114"></a>01114         {
<a name="l01115"></a>01115             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = battParams.remainingTimeAlarm;
<a name="l01116"></a>01116             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01117"></a>01117             <span class="keywordflow">break</span>;
<a name="l01118"></a>01118         }
<a name="l01119"></a>01119         <span class="comment">//          SBSCMD_batteryMode</span>
<a name="l01120"></a>01120     <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#d5500c9b9dd285eaa77e28413d7258df">SBS_WRITE</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e044a684cd3a3ab63547f0d0b073b6237">SBSCMD_batteryMode</a>):
<a name="l01121"></a>01121         {
<a name="l01122"></a>01122             <span class="comment">//Only supports setting the R/W bit for CAPACITY_MODE</span>
<a name="l01123"></a>01123             <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> temp = (battParams.batteryMode &amp; 0x7FFF);
<a name="l01124"></a>01124             temp |= (sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> &amp; 0x8000);    
<a name="l01125"></a>01125             battParams.batteryMode = temp;
<a name="l01126"></a>01126             <span class="keywordflow">break</span>;
<a name="l01127"></a>01127         }
<a name="l01128"></a>01128         <span class="comment">//          SBSCMD_batteryMode</span>
<a name="l01129"></a>01129     <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e044a684cd3a3ab63547f0d0b073b6237">SBSCMD_batteryMode</a>):
<a name="l01130"></a>01130         {
<a name="l01131"></a>01131             <span class="comment">// Add FCSR (fet control status register) to bits 2-5. These bits are reservered, but use them anyway...</span>
<a name="l01132"></a>01132             <span class="comment">// Also add information about cell balancing to bits 10 and 11</span>
<a name="l01133"></a>01133             <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> temp = ((0x0F&amp;FCSR)&lt;&lt;2); <span class="comment">//DUVR, FETs &amp; Current Protection Active Bits</span>
<a name="l01134"></a>01134             
<a name="l01135"></a>01135 <span class="preprocessor">#if BATTPARAM_CELLS_IN_SERIES &gt;= 2</span>
<a name="l01136"></a>01136 <span class="preprocessor"></span>            temp |= ((CBCR &amp; 0x08) &lt;&lt; 3); <span class="comment">//Balancing CELL4 bit</span>
<a name="l01137"></a>01137             temp |= ((CBCR &amp; 0x07) &lt;&lt; 10);<span class="comment">//Balancing CELL1-3 bits</span>
<a name="l01138"></a>01138             
<a name="l01139"></a>01139 <span class="preprocessor">#endif</span>
<a name="l01140"></a>01140 <span class="preprocessor"></span>            sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = battParams.batteryMode | temp;
<a name="l01141"></a>01141             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01142"></a>01142             <span class="keywordflow">break</span>;
<a name="l01143"></a>01143         }
<a name="l01144"></a>01144         <span class="comment">//          SBSCMD_atRate</span>
<a name="l01145"></a>01145         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#d5500c9b9dd285eaa77e28413d7258df">SBS_WRITE</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e10790d9c18ba714cabddbdfaab4d34da">SBSCMD_atRate</a>):
<a name="l01146"></a>01146         {
<a name="l01147"></a>01147             <a class="code" href="battery__pack__parameters_8c.html#465d57b9c9b2b607be86de50f09ed7ba" title="Battery parameters that are calculated at startup from eeprom variables.">battParams_sram</a>.<a class="code" href="structbattParam__sramstruct.html#2888e4c99949e2995dc07402a57d37f7" title="Used by all the AtRate commands, it doesn&amp;#39;t do anything if this is reset on reset...">atRate</a> = (<a class="code" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a>)sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a>;
<a name="l01148"></a>01148             <span class="keywordflow">break</span>;
<a name="l01149"></a>01149         }
<a name="l01150"></a>01150         <span class="comment">//          SBSCMD_atRate</span>
<a name="l01151"></a>01151         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e10790d9c18ba714cabddbdfaab4d34da">SBSCMD_atRate</a>):
<a name="l01152"></a>01152         {
<a name="l01153"></a>01153             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = (<a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a>)<a class="code" href="battery__pack__parameters_8c.html#465d57b9c9b2b607be86de50f09ed7ba" title="Battery parameters that are calculated at startup from eeprom variables.">battParams_sram</a>.<a class="code" href="structbattParam__sramstruct.html#2888e4c99949e2995dc07402a57d37f7" title="Used by all the AtRate commands, it doesn&amp;#39;t do anything if this is reset on reset...">atRate</a>;
<a name="l01154"></a>01154             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01155"></a>01155             <span class="keywordflow">break</span>;
<a name="l01156"></a>01156         }
<a name="l01157"></a>01157         <span class="comment">//          SBSCMD_atRateTimeToFull</span>
<a name="l01158"></a>01158         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506ec8c3201d15bb3e28cda6feb977b843aa">SBSCMD_atRateTimeToFull</a>):
<a name="l01159"></a>01159         {
<a name="l01160"></a>01160             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = <a class="code" href="gas__gauging_8c.html#8b1dc7b992d0aaf38f84bd57ea0f1e6d" title="Estimate time to full.">GASG_TimeToFull</a>(<a class="code" href="battery__pack__parameters_8c.html#465d57b9c9b2b607be86de50f09ed7ba" title="Battery parameters that are calculated at startup from eeprom variables.">battParams_sram</a>.<a class="code" href="structbattParam__sramstruct.html#2888e4c99949e2995dc07402a57d37f7" title="Used by all the AtRate commands, it doesn&amp;#39;t do anything if this is reset on reset...">atRate</a>);
<a name="l01161"></a>01161             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01162"></a>01162             <span class="keywordflow">break</span>;
<a name="l01163"></a>01163         }
<a name="l01164"></a>01164         <span class="comment">//          SBSCMD_atRateTimeToEmpty</span>
<a name="l01165"></a>01165         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e8f8bd5629a2bf592c78e50cb69aea3fe">SBSCMD_atRateTimeToEmpty</a>):
<a name="l01166"></a>01166         {
<a name="l01167"></a>01167             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = <a class="code" href="gas__gauging_8c.html#17d5adf37f8f1ab7851727ec3335f501" title="Estimate time to empty.">GASG_TimeToEmpty</a>(<a class="code" href="battery__pack__parameters_8c.html#465d57b9c9b2b607be86de50f09ed7ba" title="Battery parameters that are calculated at startup from eeprom variables.">battParams_sram</a>.<a class="code" href="structbattParam__sramstruct.html#2888e4c99949e2995dc07402a57d37f7" title="Used by all the AtRate commands, it doesn&amp;#39;t do anything if this is reset on reset...">atRate</a>);
<a name="l01168"></a>01168             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01169"></a>01169             <span class="keywordflow">break</span>;
<a name="l01170"></a>01170         }
<a name="l01171"></a>01171         <span class="comment">//          SBSCMD_atRateOK</span>
<a name="l01172"></a>01172         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506ea1026dd6b8fc58f7e77836e3334d23f9">SBSCMD_atRateOK</a>):
<a name="l01173"></a>01173         {
<a name="l01174"></a>01174             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = <a class="code" href="gas__gauging_8c.html#1baf8de5f4fe8ba6cdb2a64e9d76a7fb" title="Check if battery can support specified discharge current for 10seconds.">GASG_AtRateOK</a>(<a class="code" href="battery__pack__parameters_8c.html#465d57b9c9b2b607be86de50f09ed7ba" title="Battery parameters that are calculated at startup from eeprom variables.">battParams_sram</a>.<a class="code" href="structbattParam__sramstruct.html#2888e4c99949e2995dc07402a57d37f7" title="Used by all the AtRate commands, it doesn&amp;#39;t do anything if this is reset on reset...">atRate</a>);
<a name="l01175"></a>01175             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01176"></a>01176             <span class="keywordflow">break</span>;
<a name="l01177"></a>01177         }
<a name="l01178"></a>01178         <span class="comment">//          SBSCMD_temperature</span>
<a name="l01179"></a>01179         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e5d9059a5a9d371506a2ce3cbf9f027f0">SBSCMD_temperature</a>):
<a name="l01180"></a>01180         {
<a name="l01181"></a>01181             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = <a class="code" href="main_8c.html#87de25a56cfc5857df059f510fe3b049" title="The internal chip temperature in 0.1 Kelvin.">coreTemperature</a>;
<a name="l01182"></a>01182             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01183"></a>01183             <span class="keywordflow">break</span>;
<a name="l01184"></a>01184         }
<a name="l01185"></a>01185         <span class="comment">//          SBSCMD_voltage</span>
<a name="l01186"></a>01186         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506eb9c2c95b9e5cf3b0ef20469ea55847d6">SBSCMD_voltage</a>):
<a name="l01187"></a>01187         {
<a name="l01188"></a>01188 <span class="preprocessor">#if BATTPARAM_CELLS_IN_SERIES == 1</span>
<a name="l01189"></a>01189 <span class="preprocessor"></span>            sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac671449b08613e4845ef2a5d657b8562c394673">CELL1</a> );
<a name="l01190"></a>01190 <span class="preprocessor">#elif BATTPARAM_CELLS_IN_SERIES == 2</span>
<a name="l01191"></a>01191 <span class="preprocessor"></span>            sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac67144983bc57407aa6f82e37d495ff9d28ed81">CELL2</a> )
<a name="l01192"></a>01192                          + <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac671449b08613e4845ef2a5d657b8562c394673">CELL1</a> );
<a name="l01193"></a>01193 <span class="preprocessor">#elif BATTPARAM_CELLS_IN_SERIES == 3</span>
<a name="l01194"></a>01194 <span class="preprocessor"></span>            sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac6714494ab35dc613899d959b4e063d736deb2d">CELL3</a> )
<a name="l01195"></a>01195                          + <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac67144983bc57407aa6f82e37d495ff9d28ed81">CELL2</a> )
<a name="l01196"></a>01196                          + <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac671449b08613e4845ef2a5d657b8562c394673">CELL1</a> );
<a name="l01197"></a>01197 <span class="preprocessor">#elif BATTPARAM_CELLS_IN_SERIES == 4</span>
<a name="l01198"></a>01198 <span class="preprocessor"></span>            sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac6714495dc31be69defc09d627e487ce6a56c1a">CELL4</a> )
<a name="l01199"></a>01199                          + <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac6714494ab35dc613899d959b4e063d736deb2d">CELL3</a> )
<a name="l01200"></a>01200                          + <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac67144983bc57407aa6f82e37d495ff9d28ed81">CELL2</a> )
<a name="l01201"></a>01201                          + <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac671449b08613e4845ef2a5d657b8562c394673">CELL1</a> );
<a name="l01202"></a>01202 <span class="preprocessor">#endif</span>
<a name="l01203"></a>01203 <span class="preprocessor"></span>            <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01204"></a>01204             <span class="keywordflow">break</span>;
<a name="l01205"></a>01205         }
<a name="l01206"></a>01206         
<a name="l01207"></a>01207         <span class="comment">//          SBSCMD_current</span>
<a name="l01208"></a>01208         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e56becb614be2d5a1f2a5ebec61727d8f">SBSCMD_current</a>):
<a name="l01209"></a>01209         {
<a name="l01210"></a>01210             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = <a class="code" href="battery__current__monitoring_8c.html#d971791f4fc1c6f54e1d7d46fea20786" title="Convert CCADC ticks to mA.">BATTCUR_Ticks2mA</a>( <a class="code" href="battery__current__monitoring_8c.html#6a557e4dca31a58b1683861bf8f154e6" title="Provides the offset calibrated current from the last CC-ADC reading.">BATTCUR_GetOffsetCalibratedCurrent</a>() );
<a name="l01211"></a>01211             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01212"></a>01212             <span class="keywordflow">break</span>;
<a name="l01213"></a>01213         }
<a name="l01214"></a>01214         <span class="comment">//          SBSCMD_averageCurrent</span>
<a name="l01215"></a>01215         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e80587130963db58cd095a7d84c765678">SBSCMD_averageCurrent</a>):
<a name="l01216"></a>01216         {
<a name="l01217"></a>01217             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = <a class="code" href="battery__current__monitoring_8c.html#d971791f4fc1c6f54e1d7d46fea20786" title="Convert CCADC ticks to mA.">BATTCUR_Ticks2mA</a>( <a class="code" href="battery__current__monitoring_8c.html#0959c4b3bb0cee63ad2a3bdb89a92a6d" title="Provide an estimate for the average current throughout the last minute (18-bit signed)...">BATTCUR_GetAverageCurrent</a>() );
<a name="l01218"></a>01218             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01219"></a>01219             <span class="keywordflow">break</span>;
<a name="l01220"></a>01220         }
<a name="l01221"></a>01221         <span class="comment">//          SBSCMD_maxError</span>
<a name="l01222"></a>01222         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e1a270e8bdd97553c8401235e4f6f1a69">SBSCMD_maxError</a>):
<a name="l01223"></a>01223         {
<a name="l01224"></a>01224             <span class="comment">// TODO REMOVE clear simulatePowerOff when read, to avoid having to go in via debugwire</span>
<a name="l01225"></a>01225             <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.simulatePowerOff = <span class="keyword">false</span>;
<a name="l01226"></a>01226             <span class="comment">// TODO replace dummy reply value with correct reply.</span>
<a name="l01227"></a>01227             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = 0x0000;
<a name="l01228"></a>01228             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01229"></a>01229             <span class="keywordflow">break</span>;
<a name="l01230"></a>01230         }
<a name="l01231"></a>01231         <span class="comment">//          SBSCMD_relativeStateOfCharge</span>
<a name="l01232"></a>01232         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e5dca36bb6bee434039f8abd0d171e9fb">SBSCMD_relativeStateOfCharge</a>):
<a name="l01233"></a>01233         {
<a name="l01234"></a>01234             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = <a class="code" href="gas__gauging_8c.html#cfbc7e47153ec1e54e6fc85ddde14d26" title="Returns state of charge.">GASG_StateOfCharge</a>(<a class="code" href="battery__current__monitoring_8c.html#0959c4b3bb0cee63ad2a3bdb89a92a6d" title="Provide an estimate for the average current throughout the last minute (18-bit signed)...">BATTCUR_GetAverageCurrent</a>(), <a class="code" href="battery__pack__parameters_8c.html#465d57b9c9b2b607be86de50f09ed7ba" title="Battery parameters that are calculated at startup from eeprom variables.">battParams_sram</a>.<a class="code" href="structbattParam__sramstruct.html#76fcb4f7f90d64e089eab59b5bc69b6b" title="Full charge capacity in CC accumulated.">capacityInCCAccumulated</a>);
<a name="l01235"></a>01235             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01236"></a>01236             <span class="keywordflow">break</span>;
<a name="l01237"></a>01237         }
<a name="l01238"></a>01238         <span class="comment">//          SBSCMD_absoluteStateOfCharge</span>
<a name="l01239"></a>01239         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e3aeee4b2a3bc856eca3e5d84ddf95df0">SBSCMD_absoluteStateOfCharge</a>):
<a name="l01240"></a>01240         {
<a name="l01241"></a>01241             
<a name="l01242"></a>01242                         sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = <a class="code" href="gas__gauging_8c.html#cfbc7e47153ec1e54e6fc85ddde14d26" title="Returns state of charge.">GASG_StateOfCharge</a>(<a class="code" href="battery__current__monitoring_8c.html#0959c4b3bb0cee63ad2a3bdb89a92a6d" title="Provide an estimate for the average current throughout the last minute (18-bit signed)...">BATTCUR_GetAverageCurrent</a>(), <a class="code" href="cc__gas__gauging_8c.html#374a10fc3c29a66f6867e608a35c3499" title="Convert mAh to accumulated.">CCGASG_mAh2Acc</a>(battParams.designCapacity));
<a name="l01243"></a>01243             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01244"></a>01244             <span class="keywordflow">break</span>;
<a name="l01245"></a>01245         }
<a name="l01246"></a>01246         <span class="comment">//          SBSCMD_remainingCapacity</span>
<a name="l01247"></a>01247         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e6636d58633c88a5df1df30b1f984e62f">SBSCMD_remainingCapacity</a>):
<a name="l01248"></a>01248         {
<a name="l01249"></a>01249             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = <a class="code" href="cc__gas__gauging_8c.html#4a1ad76628aa8d3905b820ee0822dcf0" title="Convert accumulated to mAh.">CCGASG_Acc2mAh</a>(<a class="code" href="gas__gauging_8c.html#86386fa7dbd384f1d29de0dc72d8820c" title="Returns the remaining capacity at specified current.">GASG_RemainingCapacity</a>(<a class="code" href="battery__current__monitoring_8c.html#0959c4b3bb0cee63ad2a3bdb89a92a6d" title="Provide an estimate for the average current throughout the last minute (18-bit signed)...">BATTCUR_GetAverageCurrent</a>()));
<a name="l01250"></a>01250                         <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01251"></a>01251             <span class="keywordflow">break</span>;
<a name="l01252"></a>01252         }
<a name="l01253"></a>01253         <span class="comment">//          SBSCMD_fullChargeCapacity</span>
<a name="l01254"></a>01254         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506ef81e594a4af55775c1ed02d04ff30276">SBSCMD_fullChargeCapacity</a>):
<a name="l01255"></a>01255         {
<a name="l01256"></a>01256             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = battParams.fullChargeCapacity;
<a name="l01257"></a>01257             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01258"></a>01258             <span class="keywordflow">break</span>;
<a name="l01259"></a>01259         }
<a name="l01260"></a>01260         <span class="comment">//          SBSCMD_runTimeToEmpty</span>
<a name="l01261"></a>01261         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e4a71c588da958f07f7575e54a9bc1389">SBSCMD_runTimeToEmpty</a>):
<a name="l01262"></a>01262         {
<a name="l01263"></a>01263             
<a name="l01264"></a>01264             <a class="code" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a> temp = <a class="code" href="battery__current__monitoring_8c.html#6a557e4dca31a58b1683861bf8f154e6" title="Provides the offset calibrated current from the last CC-ADC reading.">BATTCUR_GetOffsetCalibratedCurrent</a>();
<a name="l01265"></a>01265             temp = <a class="code" href="battery__current__monitoring_8c.html#d971791f4fc1c6f54e1d7d46fea20786" title="Convert CCADC ticks to mA.">BATTCUR_Ticks2mA</a>(temp);
<a name="l01266"></a>01266             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = <a class="code" href="gas__gauging_8c.html#17d5adf37f8f1ab7851727ec3335f501" title="Estimate time to empty.">GASG_TimeToEmpty</a>( (<a class="code" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a>)temp );
<a name="l01267"></a>01267             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01268"></a>01268             <span class="keywordflow">break</span>;
<a name="l01269"></a>01269         }
<a name="l01270"></a>01270         <span class="comment">//          SBSCMD_averageTimeToEmpty</span>
<a name="l01271"></a>01271         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e214934f765c97d293435c9bff78add43">SBSCMD_averageTimeToEmpty</a>):
<a name="l01272"></a>01272         {
<a name="l01273"></a>01273             <a class="code" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a> temp = <a class="code" href="battery__current__monitoring_8c.html#0959c4b3bb0cee63ad2a3bdb89a92a6d" title="Provide an estimate for the average current throughout the last minute (18-bit signed)...">BATTCUR_GetAverageCurrent</a>();
<a name="l01274"></a>01274             temp = <a class="code" href="battery__current__monitoring_8c.html#d971791f4fc1c6f54e1d7d46fea20786" title="Convert CCADC ticks to mA.">BATTCUR_Ticks2mA</a>(temp);
<a name="l01275"></a>01275             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = <a class="code" href="gas__gauging_8c.html#17d5adf37f8f1ab7851727ec3335f501" title="Estimate time to empty.">GASG_TimeToEmpty</a>((<a class="code" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a>)temp);
<a name="l01276"></a>01276             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01277"></a>01277             <span class="keywordflow">break</span>;
<a name="l01278"></a>01278         }
<a name="l01279"></a>01279         <span class="comment">//          SBSCMD_averageTimeToFull</span>
<a name="l01280"></a>01280         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506ebbba987ba90a4056a47896d6bcb33961">SBSCMD_averageTimeToFull</a>):
<a name="l01281"></a>01281         {
<a name="l01282"></a>01282             <a class="code" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a> temp = <a class="code" href="battery__current__monitoring_8c.html#0959c4b3bb0cee63ad2a3bdb89a92a6d" title="Provide an estimate for the average current throughout the last minute (18-bit signed)...">BATTCUR_GetAverageCurrent</a>();
<a name="l01283"></a>01283             temp = <a class="code" href="battery__current__monitoring_8c.html#d971791f4fc1c6f54e1d7d46fea20786" title="Convert CCADC ticks to mA.">BATTCUR_Ticks2mA</a>(temp);
<a name="l01284"></a>01284             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = <a class="code" href="gas__gauging_8c.html#8b1dc7b992d0aaf38f84bd57ea0f1e6d" title="Estimate time to full.">GASG_TimeToFull</a>((<a class="code" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a>)temp);
<a name="l01285"></a>01285             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01286"></a>01286             <span class="keywordflow">break</span>;
<a name="l01287"></a>01287         }
<a name="l01288"></a>01288         <span class="comment">//          SBSCMD_chargingCurrent</span>
<a name="l01289"></a>01289         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e57d46562210a43daf2fc716d045c275f">SBSCMD_chargingCurrent</a>):
<a name="l01290"></a>01290         {
<a name="l01291"></a>01291             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = battParams.chargingCurrent;
<a name="l01292"></a>01292             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01293"></a>01293             <span class="keywordflow">break</span>;
<a name="l01294"></a>01294         }
<a name="l01295"></a>01295         <span class="comment">//          SBSCMD_chargingVoltage</span>
<a name="l01296"></a>01296         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506eb3f06703888d051a3aafe99935300a82">SBSCMD_chargingVoltage</a>):
<a name="l01297"></a>01297         {
<a name="l01298"></a>01298             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = battParams.chargingVoltage;
<a name="l01299"></a>01299             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01300"></a>01300             <span class="keywordflow">break</span>;
<a name="l01301"></a>01301         }
<a name="l01302"></a>01302         <span class="comment">//          SBSCMD_batteryStatus</span>
<a name="l01303"></a>01303         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e671817003fed0f9663e822fc2977262c">SBSCMD_batteryStatus</a>):
<a name="l01304"></a>01304         {
<a name="l01305"></a>01305             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> =
<a name="l01306"></a>01306               (         <a class="code" href="main_8c.html#1c15e22902a49351602b2b51faab66ca" title="State flags.">stateFlags</a>.chargingProhibited &lt;&lt; <a class="code" href="battery__pack__parameters_8h.html#530ad08282407b23429595a1b6a05d702c09eea23af6856f82a18a46ae16dc81">BATTSTAT_OVER_CHARGED_ALARM_BIT</a>)
<a name="l01307"></a>01307             | (             <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.voltageTooHigh &lt;&lt; <a class="code" href="battery__pack__parameters_8h.html#530ad08282407b23429595a1b6a05d70dd73c06ada782589d9a2d0a98e84da7d">BATTSTAT_TERMINATE_CHARGE_ALARM_BIT</a>)
<a name="l01308"></a>01308             | (  (bool)(<a class="code" href="vreg__mon_8c.html#f99b8c94e354f4e792aa768f82e0a3cb" title="Number of times VREGMON has been triggered.">VREGMON_ConditionTriggered</a>()) &lt;&lt; <a class="code" href="battery__pack__parameters_8h.html#530ad08282407b23429595a1b6a05d70cc31ce462684b21de3af00529fd8dbc7" title="Reserved.">BATTSTAT_VREGMON_TRIGGERED_BIT</a>)
<a name="l01309"></a>01309             | (     <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.cellTemperatureTooHigh &lt;&lt; <a class="code" href="battery__pack__parameters_8h.html#530ad08282407b23429595a1b6a05d70b0e2bb01980fb55dc398a5bf572805db">BATTSTAT_OVER_TEMP_ALARM_BIT</a>)
<a name="l01310"></a>01310             | (           <a class="code" href="main_8c.html#cbc2e758fec796eb6b48d6e625c967ef">sbsFlags</a>.terminateDischarge &lt;&lt; <a class="code" href="battery__pack__parameters_8h.html#530ad08282407b23429595a1b6a05d704d61a0184474dad6da92130ad534a057">BATTSTAT_TERMINATE_DISCHARGE_ALARM_BIT</a>)
<a name="l01311"></a>01311             | (      <a class="code" href="battery__protection_8c.html#988aff3a3cceb987229ece4fce86308a" title="Checks if Battery Protection has been triggered.">BATTPROT_IsProtectionTriggered</a>() &lt;&lt; <a class="code" href="battery__pack__parameters_8h.html#530ad08282407b23429595a1b6a05d708f685f6b78c4628c52625062a4ccec00" title="Reserved.">BATTSTAT_BATTERY_PROTECTION_TRIGGERED_BIT</a>)
<a name="l01312"></a>01312             | (       <a class="code" href="main_8c.html#cbc2e758fec796eb6b48d6e625c967ef">sbsFlags</a>.remainingCapacityAlarm &lt;&lt; <a class="code" href="battery__pack__parameters_8h.html#530ad08282407b23429595a1b6a05d70c0210a18be5f174e1a4b6fbf488c7206">BATTSTAT_REMAINING_CAPACITY_ALARM_BIT</a>)
<a name="l01313"></a>01313             | (           <a class="code" href="main_8c.html#cbc2e758fec796eb6b48d6e625c967ef">sbsFlags</a>.remainingTimeAlarm &lt;&lt; <a class="code" href="battery__pack__parameters_8h.html#530ad08282407b23429595a1b6a05d70a9213fb0476b223edb7588ea2daa10e5">BATTSTAT_REMAINING_TIME_ALARM_BIT</a>)
<a name="l01314"></a>01314             | (! <a class="code" href="main_8c.html#358977ed1cfc4b42222114b667a63d3a" title="Error flags.">errorFlags</a>.criticalConditionDetected &lt;&lt; <a class="code" href="battery__pack__parameters_8h.html#530ad08282407b23429595a1b6a05d70a22bfa855714c8e60e7f8a7c27f1b466">BATTSTAT_INITIALIZED_BIT</a>)
<a name="l01315"></a>01315             | (          <a class="code" href="battery__current__monitoring_8c.html#7509bf2a6930a4ba1a5a1927582c40bb" title="Is the current charging or discharging the battery.">BATTCUR_IsDischargeOngoing</a>() &lt;&lt; <a class="code" href="battery__pack__parameters_8h.html#530ad08282407b23429595a1b6a05d7056d529b04467a2160db14bd90f84538a">BATTSTAT_DISCHARGING_BIT</a>)
<a name="l01316"></a>01316             | (                 <a class="code" href="main_8c.html#cbc2e758fec796eb6b48d6e625c967ef">sbsFlags</a>.fullyCharged &lt;&lt; <a class="code" href="battery__pack__parameters_8h.html#530ad08282407b23429595a1b6a05d70016f363ba5e3006870774ec44b826081">BATTSTAT_FULLY_CHARGED_BIT</a>)
<a name="l01317"></a>01317             | (              <a class="code" href="main_8c.html#cbc2e758fec796eb6b48d6e625c967ef">sbsFlags</a>.fullyDischarged &lt;&lt; <a class="code" href="battery__pack__parameters_8h.html#530ad08282407b23429595a1b6a05d706182b2a7e84087d0df428d3ec166a393">BATTSTAT_FULLY_DISCHARGED_BIT</a>) ;
<a name="l01318"></a>01318             
<a name="l01319"></a>01319             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01320"></a>01320             <span class="keywordflow">break</span>;
<a name="l01321"></a>01321         }
<a name="l01322"></a>01322         <span class="comment">//          SBSCMD_cycleCount</span>
<a name="l01323"></a>01323         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e17fdedf4a03bf4adc29803a8f0253e55">SBSCMD_cycleCount</a>):
<a name="l01324"></a>01324         {
<a name="l01325"></a>01325             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = <a class="code" href="battery__pack__parameters_8c.html#fda92ef981c1c18914a0f33453ad7a72" title="Return the number of cycles.">BATTPARAM_GetCycleCount</a>();
<a name="l01326"></a>01326             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01327"></a>01327             <span class="keywordflow">break</span>;
<a name="l01328"></a>01328         }
<a name="l01329"></a>01329         <span class="comment">//          SBSCMD_designCapacity</span>
<a name="l01330"></a>01330         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506ead3be1996beb9a6835b3d2d7e9da6eca">SBSCMD_designCapacity</a>):
<a name="l01331"></a>01331         {
<a name="l01332"></a>01332             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = battParams.designCapacity;
<a name="l01333"></a>01333             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01334"></a>01334             <span class="keywordflow">break</span>;
<a name="l01335"></a>01335         }
<a name="l01336"></a>01336         <span class="comment">//          SBSCMD_designVoltage</span>
<a name="l01337"></a>01337         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e4462036f04f600bdb7b37651b74a3559">SBSCMD_designVoltage</a>):
<a name="l01338"></a>01338         {
<a name="l01339"></a>01339             
<a name="l01340"></a>01340             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = battParams.designVoltage;
<a name="l01341"></a>01341             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01342"></a>01342             <span class="keywordflow">break</span>;
<a name="l01343"></a>01343         }
<a name="l01344"></a>01344         <span class="comment">//          SBSCMD_specificationInfo</span>
<a name="l01345"></a>01345         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e1dec11310f1e3057eab14a83e7c371ad">SBSCMD_specificationInfo</a>):
<a name="l01346"></a>01346         {
<a name="l01347"></a>01347             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = battParams.specificationInfo;
<a name="l01348"></a>01348             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01349"></a>01349             <span class="keywordflow">break</span>;
<a name="l01350"></a>01350         }
<a name="l01351"></a>01351         <span class="comment">//          SBSCMD_manufactureDate</span>
<a name="l01352"></a>01352         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e630de7398e51e081e9b30ed2701a4f87">SBSCMD_manufactureDate</a>):
<a name="l01353"></a>01353         {
<a name="l01354"></a>01354             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = battParams.manufactureDate;
<a name="l01355"></a>01355             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01356"></a>01356             <span class="keywordflow">break</span>;
<a name="l01357"></a>01357         }
<a name="l01358"></a>01358         <span class="comment">//          SBSCMD_serialNumber</span>
<a name="l01359"></a>01359         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e8380b57ab10eed477acac9f0d76ccae0">SBSCMD_serialNumber</a>):
<a name="l01360"></a>01360         {
<a name="l01361"></a>01361             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = battParams.serialNumber;
<a name="l01362"></a>01362             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01363"></a>01363             <span class="keywordflow">break</span>;
<a name="l01364"></a>01364         }
<a name="l01365"></a>01365         <span class="comment">//          SBSCMD_manufacturerName</span>
<a name="l01366"></a>01366         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e6a832c86723a4b7020cb972f881b1330">SBSCMD_manufacturerName</a>):
<a name="l01367"></a>01367         {
<a name="l01368"></a>01368             <a class="code" href="battery__pack__parameters_8c.html#ac467dae84145a955bd85ad5198bc807" title="Copy a SBS block.">BATTPARAM_GetString</a>( (<a class="code" href="battery__pack__parameters_8h.html#a74f47dcda74c81dbe96bee95a42dd14">BATTPARAM_blockParameter_t</a>*)&amp;battParams.manufacturerName, (<a class="code" href="unionSBS__command__union.html">SBS_command_t</a>*)&amp;sbs );
<a name="l01369"></a>01369             <a class="code" href="communication_8c.html#1efd4641b8a2e2b7d2daddb0b38245a6" title="Reply to a SBS read block command.">Comm_SbsBlockCommandReply</a>( &amp;sbs );
<a name="l01370"></a>01370             <span class="keywordflow">break</span>;
<a name="l01371"></a>01371         }
<a name="l01372"></a>01372         <span class="comment">//          SBSCMD_deviceName</span>
<a name="l01373"></a>01373         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e21d808377d804525c13645c075e3c306">SBSCMD_deviceName</a>):
<a name="l01374"></a>01374         {
<a name="l01375"></a>01375             <a class="code" href="battery__pack__parameters_8c.html#ac467dae84145a955bd85ad5198bc807" title="Copy a SBS block.">BATTPARAM_GetString</a>( (<a class="code" href="battery__pack__parameters_8h.html#a74f47dcda74c81dbe96bee95a42dd14">BATTPARAM_blockParameter_t</a>*)&amp;battParams.deviceName, (<a class="code" href="unionSBS__command__union.html">SBS_command_t</a>*)&amp;sbs );
<a name="l01376"></a>01376             <a class="code" href="communication_8c.html#1efd4641b8a2e2b7d2daddb0b38245a6" title="Reply to a SBS read block command.">Comm_SbsBlockCommandReply</a>( &amp;sbs );
<a name="l01377"></a>01377             <span class="keywordflow">break</span>;
<a name="l01378"></a>01378         }
<a name="l01379"></a>01379         <span class="comment">//          SBSCMD_deviceChemistry</span>
<a name="l01380"></a>01380         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e01a07381a9cef96eff910f8131ffa727">SBSCMD_deviceChemistry</a>):
<a name="l01381"></a>01381         {
<a name="l01382"></a>01382             <a class="code" href="battery__pack__parameters_8c.html#ac467dae84145a955bd85ad5198bc807" title="Copy a SBS block.">BATTPARAM_GetString</a>( (<a class="code" href="battery__pack__parameters_8h.html#a74f47dcda74c81dbe96bee95a42dd14">BATTPARAM_blockParameter_t</a>*)&amp;battParams.deviceChemistry, (<a class="code" href="unionSBS__command__union.html">SBS_command_t</a>*)&amp;sbs );
<a name="l01383"></a>01383             <a class="code" href="communication_8c.html#1efd4641b8a2e2b7d2daddb0b38245a6" title="Reply to a SBS read block command.">Comm_SbsBlockCommandReply</a>( &amp;sbs );
<a name="l01384"></a>01384             <span class="keywordflow">break</span>;
<a name="l01385"></a>01385         }
<a name="l01386"></a>01386         <span class="comment">//          SBSCMD_manufacturerData</span>
<a name="l01387"></a>01387         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e3cac84cfb8bf16dacf8c14999214c995">SBSCMD_manufacturerData</a>):
<a name="l01388"></a>01388         {
<a name="l01389"></a>01389             <a class="code" href="battery__pack__parameters_8c.html#ac467dae84145a955bd85ad5198bc807" title="Copy a SBS block.">BATTPARAM_GetString</a>( (<a class="code" href="battery__pack__parameters_8h.html#a74f47dcda74c81dbe96bee95a42dd14">BATTPARAM_blockParameter_t</a>*)&amp;battParams.manufacturerData, (<a class="code" href="unionSBS__command__union.html">SBS_command_t</a>*)&amp;sbs );
<a name="l01390"></a>01390             <a class="code" href="communication_8c.html#1efd4641b8a2e2b7d2daddb0b38245a6" title="Reply to a SBS read block command.">Comm_SbsBlockCommandReply</a>( &amp;sbs );
<a name="l01391"></a>01391             <span class="keywordflow">break</span>;
<a name="l01392"></a>01392         }
<a name="l01393"></a>01393         <span class="comment">//          SBSCMD_authentication</span>
<a name="l01394"></a>01394         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#d5500c9b9dd285eaa77e28413d7258df">SBS_WRITE</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e3b3e2a2c455a81c01e131cb730cff871">SBSCMD_authentication</a>):
<a name="l01395"></a>01395         {
<a name="l01396"></a>01396             <span class="comment">// Run the authentication in the main loop</span>
<a name="l01397"></a>01397             <a class="code" href="main_8c.html#96a6d06da6dd269353ef07d0dc7862af" title="Task flags.">taskFlags</a>.doAuthentication = <span class="keyword">true</span>;
<a name="l01398"></a>01398             <span class="keywordflow">break</span>;
<a name="l01399"></a>01399         }
<a name="l01400"></a>01400         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e3b3e2a2c455a81c01e131cb730cff871">SBSCMD_authentication</a>):
<a name="l01401"></a>01401         {
<a name="l01402"></a>01402             <span class="comment">//Get pointer to the authenticated message.</span>
<a name="l01403"></a>01403             sbsReply = <a class="code" href="authentication_8c.html#4c74408e63faa5967888c6b81c348a28" title="Copy key from eeprom to sram.">AUTH_GetResponse</a>();
<a name="l01404"></a>01404             <span class="comment">// Pass pointer to authenticated message to communication module.</span>
<a name="l01405"></a>01405             <a class="code" href="communication_8c.html#1efd4641b8a2e2b7d2daddb0b38245a6" title="Reply to a SBS read block command.">Comm_SbsBlockCommandReply</a>( sbsReply );
<a name="l01406"></a>01406             <span class="keywordflow">break</span>;
<a name="l01407"></a>01407         }
<a name="l01408"></a>01408         <span class="comment">//          SBSCMD_shuntCalibration</span>
<a name="l01409"></a>01409         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#d5500c9b9dd285eaa77e28413d7258df">SBS_WRITE</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e0c304726caf27cae42fa071618b0fbe9">SBSCMD_shuntCalibration</a>):
<a name="l01410"></a>01410         {
<a name="l01411"></a>01411             <span class="comment">// This is the shunt resistance in microOhms</span>
<a name="l01412"></a>01412             <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> shuntTemp = sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a>; <span class="comment">// Get variable as soon as possible to avoid overwriting</span>
<a name="l01413"></a>01413             battParams.shuntResistance = shuntTemp;
<a name="l01414"></a>01414             <a class="code" href="battery__current__monitoring_8c.html#3f516153abe33ea81943f5121a723ff1" title="Calculate the Shunt Coefficient for CCADC_Value to mA conversion.">BATTCUR_CalculateShuntCoeffient</a>(shuntTemp,<a class="code" href="battery__pack__parameters_8h.html#e331ad89b2c40c7aad20be532f8c9d94">CCADC_VOLTREF</a>);
<a name="l01415"></a>01415                         <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> temp = <a class="code" href="rc__calibration_8c.html#80054145825d11a31568f5d7ddbe948d" title="Calculate Ultra-low power RC (Ulp RC) period time.">RCCAL_CalculateUlpRCperiod</a>(<a class="code" href="main_8c.html#87de25a56cfc5857df059f510fe3b049" title="The internal chip temperature in 0.1 Kelvin.">coreTemperature</a>/10);
<a name="l01416"></a>01416             <a class="code" href="cc__gas__gauging_8c.html#bb85088f311c13a7ca2dcc3c46a68935" title="Calculate the Shunt Coefficient for converting between accumulated and mAh.">CCGASG_CalculateShuntCoefficients</a>(temp,shuntTemp,<a class="code" href="battery__pack__parameters_8h.html#e331ad89b2c40c7aad20be532f8c9d94">CCADC_VOLTREF</a>);
<a name="l01417"></a>01417             <span class="keywordflow">break</span>;
<a name="l01418"></a>01418         }
<a name="l01419"></a>01419         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e0c304726caf27cae42fa071618b0fbe9">SBSCMD_shuntCalibration</a>):
<a name="l01420"></a>01420         {
<a name="l01421"></a>01421             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = battParams.shuntResistance;
<a name="l01422"></a>01422             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01423"></a>01423             <span class="keywordflow">break</span>;
<a name="l01424"></a>01424         }
<a name="l01425"></a>01425         <span class="comment">// SBSCMD_FETdisable</span>
<a name="l01426"></a>01426         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#d5500c9b9dd285eaa77e28413d7258df">SBS_WRITE</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506eda7150350572a1d6a53bd9bf44c6bfca">SBSCMD_FETdisable</a>):
<a name="l01427"></a>01427         {
<a name="l01428"></a>01428             <span class="keywordflow">if</span>(sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> &amp; (1&lt;&lt;<a class="code" href="battery__pack__parameters_8h.html#91ca314651828b3c8e3518802289e41e08f30223bb141a18c5f5191a0151f65e">FETDIS_CHARGE</a>)) {
<a name="l01429"></a>01429                 <a class="code" href="main_8c.html#cbc2e758fec796eb6b48d6e625c967ef">sbsFlags</a>.forceChargeFETDisabled = <span class="keyword">true</span>;
<a name="l01430"></a>01430                 <a class="code" href="fet__control_8c.html#0258102f1334bb8a65f364e43b2e41fe" title="Disable the charge FET.">FETCTRL_DisableChargeFet</a>();
<a name="l01431"></a>01431             } <span class="keywordflow">else</span> {
<a name="l01432"></a>01432                 <a class="code" href="main_8c.html#cbc2e758fec796eb6b48d6e625c967ef">sbsFlags</a>.forceChargeFETDisabled = <span class="keyword">false</span>;
<a name="l01433"></a>01433             }
<a name="l01434"></a>01434             
<a name="l01435"></a>01435             <span class="keywordflow">if</span>(sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> &amp; (1&lt;&lt;<a class="code" href="battery__pack__parameters_8h.html#91ca314651828b3c8e3518802289e41efa67e9b4f69887d909ccf94196454858">FETDIS_DISCHARGE</a>)) {
<a name="l01436"></a>01436                 <a class="code" href="main_8c.html#cbc2e758fec796eb6b48d6e625c967ef">sbsFlags</a>.forceDischargeFETDisabled = <span class="keyword">true</span>;
<a name="l01437"></a>01437                 <a class="code" href="fet__control_8c.html#047090a368a0a95c3c47a9c8f7602b8b" title="Disable the discharge FET.">FETCTRL_DisableDischargeFet</a>();
<a name="l01438"></a>01438             } <span class="keywordflow">else</span> {
<a name="l01439"></a>01439                 <a class="code" href="main_8c.html#cbc2e758fec796eb6b48d6e625c967ef">sbsFlags</a>.forceDischargeFETDisabled = <span class="keyword">false</span>;
<a name="l01440"></a>01440             }
<a name="l01441"></a>01441             <span class="keywordflow">break</span>;
<a name="l01442"></a>01442         }
<a name="l01443"></a>01443         <span class="comment">// SBSCMD_storageMode</span>
<a name="l01444"></a>01444         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#d5500c9b9dd285eaa77e28413d7258df">SBS_WRITE</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e0b00a209fbbfa0eaafdc97d8c6d7fd1a">SBSCMD_storageMode</a>):
<a name="l01445"></a>01445         {
<a name="l01446"></a>01446             <span class="comment">// Enter poweroff if the received word is correct</span>
<a name="l01447"></a>01447             <span class="keywordflow">if</span>(sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> == 0xFADE) {
<a name="l01448"></a>01448                 <a class="code" href="main_8c.html#38e11c8b50a00ef91f4be286319d904e" title="Enter power-off if allowed.">enterPoweroff</a>();
<a name="l01449"></a>01449             }
<a name="l01450"></a>01450             <span class="keywordflow">break</span>;
<a name="l01451"></a>01451         }
<a name="l01452"></a>01452         <span class="comment">//          SBSCMD_temperatureCell2</span>
<a name="l01453"></a>01453         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506edd501bc8337f54e087c92a706844f32e">SBSCMD_temperatureNTC2</a>):
<a name="l01454"></a>01454         {
<a name="l01455"></a>01455             <span class="comment">// If no thermistor, return invalid value</span>
<a name="l01456"></a>01456             <span class="comment">// If thermistor, return second temperature</span>
<a name="l01457"></a>01457 <span class="preprocessor">#if HIGHEST_VADC &lt; DEF_VADC1</span>
<a name="l01458"></a>01458 <span class="preprocessor"></span>            sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = 0x0000;
<a name="l01459"></a>01459 <span class="preprocessor">#else</span>
<a name="l01460"></a>01460 <span class="preprocessor"></span>            sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = cellTemperature[1];
<a name="l01461"></a>01461 <span class="preprocessor">#endif</span>
<a name="l01462"></a>01462 <span class="preprocessor"></span>            <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01463"></a>01463             <span class="keywordflow">break</span>;
<a name="l01464"></a>01464         }
<a name="l01465"></a>01465         <span class="comment">//          SBSCMD_temperatureCell1</span>
<a name="l01466"></a>01466         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e1870c01d1f4b6ddb7fe2298528dda40b">SBSCMD_temperatureNTC1</a>):
<a name="l01467"></a>01467         {
<a name="l01468"></a>01468             <span class="comment">// If no thermistor, return invalid value</span>
<a name="l01469"></a>01469             <span class="comment">// If thermistor, return first temperature</span>
<a name="l01470"></a>01470 <span class="preprocessor">#if HIGHEST_VADC &lt; DEF_VADC0</span>
<a name="l01471"></a>01471 <span class="preprocessor"></span>            sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = 0x0000;
<a name="l01472"></a>01472 <span class="preprocessor">#else</span>
<a name="l01473"></a>01473 <span class="preprocessor"></span>            sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = cellTemperature[0];
<a name="l01474"></a>01474 <span class="preprocessor">#endif</span>
<a name="l01475"></a>01475 <span class="preprocessor"></span>            <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01476"></a>01476             <span class="keywordflow">break</span>;
<a name="l01477"></a>01477         }
<a name="l01478"></a>01478         <span class="comment">//          SBSCMD_OptionalMfgFunction5</span>
<a name="l01479"></a>01479         <span class="comment">//          SBSCMD_voltageCell4            // Commonly referred to as OptionalMfgFunction4, read only</span>
<a name="l01480"></a>01480         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e81eb96229fbef001a75212f8c7e344fc">SBSCMD_voltageCell4</a>):
<a name="l01481"></a>01481         {
<a name="l01482"></a>01482             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac6714495dc31be69defc09d627e487ce6a56c1a">CELL4</a> );
<a name="l01483"></a>01483             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01484"></a>01484             <span class="keywordflow">break</span>;
<a name="l01485"></a>01485         }
<a name="l01486"></a>01486         <span class="comment">//          SBSCMD_voltageCell3            // Commonly referred to as OptionalMfgFunction3, read only</span>
<a name="l01487"></a>01487         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506ecb182033436792f963fcdfcb2f669c07">SBSCMD_voltageCell3</a>):
<a name="l01488"></a>01488         {
<a name="l01489"></a>01489             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac6714494ab35dc613899d959b4e063d736deb2d">CELL3</a> );
<a name="l01490"></a>01490             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01491"></a>01491             <span class="keywordflow">break</span>;
<a name="l01492"></a>01492         }
<a name="l01493"></a>01493         <span class="comment">//          SBSCMD_voltageCell2            // Commonly referred to as OptionalMfgFunction2, read only</span>
<a name="l01494"></a>01494         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506e87880d9f11e9dab4590c60bc66219650">SBSCMD_voltageCell2</a>):
<a name="l01495"></a>01495         {
<a name="l01496"></a>01496             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac67144983bc57407aa6f82e37d495ff9d28ed81">CELL2</a> );
<a name="l01497"></a>01497             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01498"></a>01498             <span class="keywordflow">break</span>;
<a name="l01499"></a>01499         }
<a name="l01500"></a>01500         <span class="comment">//          SBSCMD_voltageCell1            // Commonly referred to as OptionalMfgFunction1, read only</span>
<a name="l01501"></a>01501         <span class="keywordflow">case</span> (<a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a> | <a class="code" href="sbs__commands_8h.html#42a42ac24dbaa775654dd5b442a9506eb580f6cdb9c23181678bcbf35475d5ec">SBSCMD_voltageCell1</a>):
<a name="l01502"></a>01502         {
<a name="l01503"></a>01503             sbs.<a class="code" href="unionSBS__command__union.html#94dd4b842c54509a9269ece5c95b1dda">payloadW</a> = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac671449b08613e4845ef2a5d657b8562c394673">CELL1</a> );
<a name="l01504"></a>01504             <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( &amp;sbs );
<a name="l01505"></a>01505             <span class="keywordflow">break</span>;
<a name="l01506"></a>01506         }
<a name="l01507"></a>01507         
<a name="l01508"></a>01508         <span class="keywordflow">default</span>:
<a name="l01509"></a>01509         <span class="keywordflow">break</span>;
<a name="l01510"></a>01510     }
<a name="l01511"></a>01511     
<a name="l01512"></a>01512 }
</pre></div></div>
<html>
 <head>
  <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
  <title>@DOC_TITLE@</title>
  <link href="doxygen.css" rel="stylesheet" type="text/css">
</head>
<body>

<table width="100%" height="10%" bgcolor="#FFFFFF">
  <tr>
    <td colspan="6" height="1" background="blue.gif"></td>
  </tr>

  <tr>
    <td colspan="6">
    <address style="align: right;"><small>
Generated on Wed Aug 4 10:59:55 2010 for AVR474 Firmware User's Guide for SB202 by <a href="http://www.doxygen.org/index.html"><img src="doxygen.png" alt="doxygen" align="middle" border=0></a> 1.5.6</small></address>
    </td>
  </tr>

</table>
