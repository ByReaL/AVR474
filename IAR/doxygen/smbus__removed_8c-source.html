<html xmlns:v="urn:schemas-microsoft-com:vml"
xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns="http://www.w3.org/TR/REC-html40">

<head>
<meta http-equiv=Content-Type content="text/html; charset=iso-8859-1">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 11">
<meta name=Originator content="Microsoft Word 11">
<link rel=File-List href="atmel-header_files/filelist.xml">
<link rel=Edit-Time-Data href="atmel-header_files/editdata.mso">
<!--[if !mso]>
<style>
v\:* {behavior:url(#default#VML);}
o\:* {behavior:url(#default#VML);}
w\:* {behavior:url(#default#VML);}
.shape {behavior:url(#default#VML);}
</style>
<![endif]-->
<title>@DOC_TITLE@</title>
<!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>ping.zhou</o:Author>
  <o:Template>Normal</o:Template>
  <o:LastAuthor>ping.zhou</o:LastAuthor>
  <o:Revision>3</o:Revision>
  <o:TotalTime>0</o:TotalTime>
  <o:Created>2010-08-04T02:58:00Z</o:Created>
  <o:LastSaved>2010-08-04T02:58:00Z</o:LastSaved>
  <o:Pages>1</o:Pages>
  <o:Words>51</o:Words>
  <o:Characters>297</o:Characters>
  <o:Company>Atmel</o:Company>
  <o:Lines>2</o:Lines>
  <o:Paragraphs>1</o:Paragraphs>
  <o:CharactersWithSpaces>347</o:CharactersWithSpaces>
  <o:Version>11.9999</o:Version>
 </o:DocumentProperties>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:Zoom>150</w:Zoom>
  <w:SpellingState>Clean</w:SpellingState>
  <w:GrammarState>Clean</w:GrammarState>
  <w:ValidateAgainstSchemas/>
  <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid>
  <w:IgnoreMixedContent>false</w:IgnoreMixedContent>
  <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText>
  <w:Compatibility>
   <w:UseFELayout/>
  </w:Compatibility>
  <w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel>
 </w:WordDocument>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:LatentStyles DefLockedState="false" LatentStyleCount="156">
 </w:LatentStyles>
</xml><![endif]-->
<link rel=Stylesheet type="text/css" media=all href="doxygen.css">
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Helvetica;
	panose-1:2 11 6 4 2 2 2 2 2 4;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:536902279 -2147483648 8 0 511 0;}
@font-face
	{font-family:SimSun;
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-alt:SimSun;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 135135232 16 0 262145 0;}
@font-face
	{font-family:SimSun;
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 135135232 16 0 262145 0;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:SimSun;}
p
	{font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:SimSun;}
span.SpellE
	{mso-style-name:"";
	mso-spl-e:yes;}
@page Section1
	{size:8.5in 11.0in;
	margin:1.0in 1.25in 1.0in 1.25in;
	mso-header-margin:.5in;
	mso-footer-margin:.5in;
	mso-paper-source:0;}
div.Section1
	{page:Section1;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
	{mso-style-name:"Table Normal";
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-parent:"";
	mso-padding-alt:0in 5.4pt 0in 5.4pt;
	mso-para-margin:0in;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-ansi-language:#0400;
	mso-fareast-language:#0400;
	mso-bidi-language:#0400;}
</style>
<![endif]--><!--[if gte mso 9]><xml>
 <o:shapedefaults v:ext="edit" spidmax="2050"/>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <o:shapelayout v:ext="edit">
  <o:idmap v:ext="edit" data="1"/>
 </o:shapelayout></xml><![endif]-->
</head>

<body lang=EN-US link=blue vlink=blue style='tab-interval:.5in'>

<div class=Section1>

<table class=MsoNormalTable border=0 cellpadding=0 width="100%"
 style='width:100.0%;mso-cellspacing:1.5pt;background:white'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes'>
  <td style='padding:.75pt .75pt .75pt .75pt'>
  <p><a href="http://www.atmel.com"><span style='text-decoration:none;
  text-underline:none'><img border=0 width=109 height=50 id="_x0000_i1025"
  src=atmel.jpg></span></a></p>
  <p class=MsoNormal><o:p>&nbsp;</o:p></p>
  </td>
  <td style='padding:.75pt .75pt .75pt .75pt'>
  <p class=MsoNormal><span class=SpellE><strong><span style='font-size:24.0pt;
  font-family:Helvetica;color:black'>SmartBattery</span></strong></span><strong><span
  style='font-size:24.0pt;font-family:Helvetica;color:black'> Device
  Application Note</span></strong></p>
  </td>
  <td style='padding:.75pt .75pt .75pt .75pt'>
  <p><a href="http://www.atmel.com/products/AVR"><span style='text-decoration:
  none;text-underline:none'><img border=0 width=138 height=77 id="_x0000_i1026"
  src="AVR_logo_blue.gif"></span></a></p>
  <p class=MsoNormal><o:p>&nbsp;</o:p></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:1;mso-yfti-lastrow:yes;height:.75pt'>
  <td colspan=3 style='padding:.75pt .75pt .75pt .75pt;height:.75pt'
  background=blue.gif>
  <p class=MsoNormal><span style='font-size:1.0pt;mso-bidi-font-size:12.0pt'><o:p>&nbsp;</o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

</div>

</body>

</html>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_29ae905079a6eb1b30b29288f24757bc.html">lib_mcu</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_c2f2e611aade4b362b2bd89f67a7ad7a.html">sm_bus</a>
  </div>
</div>
<div class="contents">
<h1>smbus_removed.c</h1><a href="smbus__removed_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="smbus__removed_8c.html#b04a0655cd1e3bcac5e8f48c18df1a57ce05baed30278f132f7d9d27a502e7a0">00001</a> <span class="keyword">enum</span> <span class="comment">/*TWISR_State*/</span> {<a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>=0, <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5ce05baed30278f132f7d9d27a502e7a0">TW_Wait4Stop</a>, <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b594d13a4b6be6ef4404b13908d933e1ad">TW_Wait4Cmd</a>, <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5bc8bda251da4d6aae1c2bfb2900c1444">TW_Wait4RW</a>, <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5e4714c204fd9c4052ca3208a63493baa">TW_Wait4Data</a>, <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b583d27cae0915c8a8002877623dcb0dc9">TW_ReplyData</a>, <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5d258cb231677f6a95dcf1c9f239e2b36">TW_MSLA_W</a>, <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b52166c37a639d0f299b5195aa8672bd41">TW_MCMD_W</a>, <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b55e645a72fc9d3ddf3f193019985ffab5">TW_MDATA_W</a> };
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 <span class="preprocessor">#pragma vector = TWI_vect</span>
<a name="l00004"></a><a class="code" href="smbus__removed_8c.html#1f03d433517342e03440452013989dc4">00004</a> <span class="preprocessor"></span>__interrupt <span class="keywordtype">void</span> <a class="code" href="communication_8c.html#1f03d433517342e03440452013989dc4">TWI_ISR</a>(<span class="keywordtype">void</span>)
<a name="l00005"></a>00005 {
<a name="l00006"></a>00006     <span class="keyword">static</span> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> TWISR_CmdFeatures = 0;   <span class="comment">//Command-related feature flags</span>
<a name="l00007"></a>00007     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> Status;
<a name="l00008"></a>00008     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> tmp;
<a name="l00009"></a>00009 
<a name="l00010"></a>00010     Status = TWSR &amp; 0xF8;       <span class="comment">//This identifies what caused the interrupt to fire.</span>
<a name="l00011"></a>00011 
<a name="l00012"></a>00012     <span class="keywordflow">switch</span>(<a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a>)
<a name="l00013"></a>00013     {
<a name="l00014"></a>00014     <span class="keywordflow">default</span>:
<a name="l00015"></a>00015     <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>:   <span class="comment">//If not SLA_W or RSTOP, is an error!</span>
<a name="l00016"></a>00016         <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#13ec926035138d61a7e90193645942ee">TWS_SLA_W</a> == Status) <span class="comment">// saw Slave address match with a Write bit</span>
<a name="l00017"></a>00017         {
<a name="l00018"></a>00018             <span class="keywordflow">if</span>(<a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> == <a class="code" href="communication_8c.html#07b00aac11ba389d5b53e2f9d54bd0bd">SMB_GotCmdData</a>)
<a name="l00019"></a>00019             {
<a name="l00020"></a>00020                 <span class="comment">//Assert that we're 'busy' to SMBus Master by leaving TWEA *off* until we get a STOP.</span>
<a name="l00021"></a>00021                 <span class="comment">//Note that this is 'legal' because we have ALREADY sent an ACK to our Slave Address,</span>
<a name="l00022"></a>00022                 <span class="comment">// as is required by the SMBus specification.</span>
<a name="l00023"></a>00023                 <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5ce05baed30278f132f7d9d27a502e7a0">TW_Wait4Stop</a>;
<a name="l00024"></a>00024                 TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//must NOT re-enable ACKing!</span>
<a name="l00025"></a>00025                 <span class="keywordflow">return</span>;
<a name="l00026"></a>00026             }
<a name="l00027"></a>00027             <span class="keywordflow">else</span>
<a name="l00028"></a>00028                 <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b594d13a4b6be6ef4404b13908d933e1ad">TW_Wait4Cmd</a>;
<a name="l00029"></a>00029         }
<a name="l00030"></a>00030         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#ea29a640c276fdaea02372a2c1ac5f78">TWS_RSTOP</a> == Status)    <span class="comment">//Saw a Stop, possibly left over from previous cmd.</span>
<a name="l00031"></a>00031         {
<a name="l00032"></a>00032             ;           <span class="comment">//Everything is probably OK.  Take no action.</span>
<a name="l00033"></a>00033         }
<a name="l00034"></a>00034         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#5bee3e494d47b810f24429d69585e967">TWS_START</a> == Status)    <span class="comment">//we have successfully sent a START bit. Handle MASTER mode.</span>
<a name="l00035"></a>00035         {
<a name="l00036"></a>00036             TWDR = <a class="code" href="communication_8c.html#c47af82e11278b79be8fb40152038444">TW_MTxBuf</a>[<a class="code" href="communication_8c.html#c8ae296e1c1a72b91325c789bbdff1a0">TW_MTxBufIndex</a>++];
<a name="l00037"></a>00037             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5d258cb231677f6a95dcf1c9f239e2b36">TW_MSLA_W</a>;
<a name="l00038"></a>00038         }
<a name="l00039"></a>00039         <span class="keywordflow">else</span> <span class="comment">//had some type of error!</span>
<a name="l00040"></a>00040         {
<a name="l00041"></a>00041             <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] |= <a class="code" href="SMBSlave_8h.html#2bdc5a6b268dc4322b1f032918629a0b">SMBerr_UnknownError</a>;
<a name="l00042"></a>00042             <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;   <span class="comment">//generate a bus timeout.</span>
<a name="l00043"></a>00043             TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);       <span class="comment">//disable int, and DON'T clear the TWINT flag!</span>
<a name="l00044"></a>00044             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;          <span class="comment">//Reset the state machine.</span>
<a name="l00045"></a>00045             <span class="keywordflow">return</span>;
<a name="l00046"></a>00046         }
<a name="l00047"></a>00047         TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//must re-enable ACKing</span>
<a name="l00048"></a>00048         <span class="keywordflow">break</span>;
<a name="l00049"></a>00049 
<a name="l00050"></a>00050     <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5ce05baed30278f132f7d9d27a502e7a0">TW_Wait4Stop</a>:
<a name="l00051"></a>00051         <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#ea29a640c276fdaea02372a2c1ac5f78">TWS_RSTOP</a> == Status) <span class="comment">//Saw a Stop, possibly left over from previous cmd.</span>
<a name="l00052"></a>00052         {
<a name="l00053"></a>00053             TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//must re-enable ACKing</span>
<a name="l00054"></a>00054             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;          <span class="comment">//Reset the state machine.</span>
<a name="l00055"></a>00055         }
<a name="l00056"></a>00056         <span class="keywordflow">else</span>
<a name="l00057"></a>00057             TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//must NOT re-enable ACKing yet!</span>
<a name="l00058"></a>00058         <span class="keywordflow">break</span>;
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 
<a name="l00061"></a>00061         <span class="comment">//SLAVE-mode states follow.</span>
<a name="l00062"></a>00062 
<a name="l00063"></a>00063     <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b594d13a4b6be6ef4404b13908d933e1ad">TW_Wait4Cmd</a>:   <span class="comment">//upon entry, we expect to have received a Cmd byte.</span>
<a name="l00064"></a>00064         <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#494d83524c0a35a9680f8abf43538088">TWS_RCMD</a> == Status)      <span class="comment">//It appears that we have received a Command byte now.</span>
<a name="l00065"></a>00065         {
<a name="l00066"></a>00066             tmp = TWDR;
<a name="l00067"></a>00067             <span class="keywordflow">if</span>(tmp &lt;= <a class="code" href="SMBSlave_8h.html#335910998ef911de0e71a0c1b059e565">HIGHEST_SMB_CMD</a>)  <span class="comment">//Is the Cmd within valid range?</span>
<a name="l00068"></a>00068             {
<a name="l00069"></a>00069                 <a class="code" href="communication_8c.html#50d57ab7cb03b10099411f378522dadd">CurrentCmd</a> = tmp;       <span class="comment">//Save a copy.</span>
<a name="l00070"></a>00070                 tmp = <a class="code" href="communication_2interpreter_8h.html#98f76d05b9eb74053793b1fc1835b663">SM_Cmd_Table</a>[tmp][0]; <span class="comment">//Grab the Command Characteristics/Features flags.</span>
<a name="l00071"></a>00071                 <span class="keywordflow">if</span>(tmp &amp; <a class="code" href="communication_2interpreter_8h.html#3ffa90cb904c7f395662aa7573e79b4f">SMBslave</a>)      <span class="comment">//Is the Command valid for Slaves?</span>
<a name="l00072"></a>00072                 {               <span class="comment">//The command appears to be valid.</span>
<a name="l00073"></a>00073                     TWISR_CmdFeatures = tmp;    <span class="comment">//Save the Feature flags for use in Wait4RW state.</span>
<a name="l00074"></a>00074                     <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5bc8bda251da4d6aae1c2bfb2900c1444">TW_Wait4RW</a>;   <span class="comment">//set up next state</span>
<a name="l00075"></a>00075                     TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//enable ACKing</span>
<a name="l00076"></a>00076                     <span class="keywordflow">return</span>;
<a name="l00077"></a>00077                 }
<a name="l00078"></a>00078             }
<a name="l00079"></a>00079         }
<a name="l00080"></a>00080         <span class="comment">//In all cases except those that 'return' (above), it's an error.</span>
<a name="l00081"></a>00081 <span class="comment">//      SMBvariables[SMBV_BattStatus][lobyte] |= SMBerr_UnknownError;</span>
<a name="l00082"></a>00082 <span class="comment">//      TWI_CmdFlags = SMB_GenBusTimeout;   //generate a bus timeout.</span>
<a name="l00083"></a>00083 <span class="comment">//      TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);     //disable int, and DON'T clear the TWINT flag!</span>
<a name="l00084"></a>00084 <span class="comment">//      TWISR_state = TW_IDLE;      //Reset the state machine.</span>
<a name="l00085"></a>00085         <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = 0;   <span class="comment">//generate a bus timeout.</span>
<a name="l00086"></a>00086         TWCR = (1&lt;&lt;TWINT) | (0&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);
<a name="l00087"></a>00087         <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;      <span class="comment">//Reset the state machine.</span>
<a name="l00088"></a>00088         <span class="keywordflow">return</span>;
<a name="l00089"></a>00089         <span class="comment">//    break;</span>
<a name="l00090"></a>00090 
<a name="l00091"></a>00091 
<a name="l00092"></a>00092     <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5bc8bda251da4d6aae1c2bfb2900c1444">TW_Wait4RW</a>:    <span class="comment">//We will now find out if we will RX more, or we need to TX a reply instead.</span>
<a name="l00093"></a>00093         <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#be4452976a52cc5e091f32ead12669ce">TWS_RDATA</a> == Status)     <span class="comment">//It is a WRITE-type command. Prep the RX buffer to accept more data.</span>
<a name="l00094"></a>00094         {   <span class="comment">//NOTE: except for OptionalMfgFunction5, all WRITE cmds are 2-byte, plus optional PEC.</span>
<a name="l00095"></a>00095             <span class="comment">//Place all bytes of the transaction into the buffer so we can do a PEC on it if needed.</span>
<a name="l00096"></a>00096             <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[0] = TWAR &amp; 0xFE;  <span class="comment">//store everything incl. the slave address for computing PEC.</span>
<a name="l00097"></a>00097             <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[1] = <a class="code" href="communication_8c.html#50d57ab7cb03b10099411f378522dadd">CurrentCmd</a>;   <span class="comment">//store the previously-send Command.</span>
<a name="l00098"></a>00098             <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[2] = TWDR;     <span class="comment">//store this first DATA byte</span>
<a name="l00099"></a>00099             <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a> = 3;      <span class="comment">//use RxBufIndex as the index to store data in the buffer.</span>
<a name="l00100"></a>00100             <span class="keywordflow">if</span>(TWISR_CmdFeatures &amp; <a class="code" href="communication_2interpreter_8h.html#1200a2673b359fcd7568b69b684cc625">SCWW</a>)    <span class="comment">//is it a Write-WORD command type?</span>
<a name="l00101"></a>00101             {
<a name="l00102"></a>00102                 <a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> = 1;        <span class="comment">//We expect 1 more data byte, and possibly PEC after that.</span>
<a name="l00103"></a>00103             }
<a name="l00104"></a>00104             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(TWISR_CmdFeatures &amp; <a class="code" href="communication_2interpreter_8h.html#fb396475fb3fa7a935530e516e420c76">SCWG</a>)   <span class="comment">//is it a write-BLOCK command (must be OptionalMfgFunction5 then)</span>
<a name="l00105"></a>00105             {
<a name="l00106"></a>00106                 tmp = TWDR;
<a name="l00107"></a>00107                 <span class="keywordflow">if</span>((tmp &gt;= 1) &amp;&amp; (tmp &lt;= 32))
<a name="l00108"></a>00108                     <a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> = TWDR;
<a name="l00109"></a>00109                 <span class="keywordflow">else</span>
<a name="l00110"></a>00110                 {
<a name="l00111"></a>00111                     <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] |= <a class="code" href="SMBSlave_8h.html#4a42c77a65eb6185d98043e9a9e0bf64">SMBerr_BadSize</a>;
<a name="l00112"></a>00112                     <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;   <span class="comment">//generate a bus timeout.</span>
<a name="l00113"></a>00113                     TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);       <span class="comment">//disable int, and DON'T clear the TWINT flag!</span>
<a name="l00114"></a>00114                     <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;      <span class="comment">//Reset the state machine.</span>
<a name="l00115"></a>00115                     <span class="keywordflow">return</span>;
<a name="l00116"></a>00116                 }
<a name="l00117"></a>00117             }
<a name="l00118"></a>00118             <span class="keywordflow">else</span>    <span class="comment">//this Command doesn't allow EITHER word OR group/block Writes! It's Read-only!</span>
<a name="l00119"></a>00119             {
<a name="l00120"></a>00120                 <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] |= <a class="code" href="SMBSlave_8h.html#57b202debe9843681ec52b63736308ed">SMBerr_AccessDenied</a>;
<a name="l00121"></a>00121                 <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;   <span class="comment">//Not a WRITE-type cmd, so generate a bus timeout.</span>
<a name="l00122"></a>00122                 TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);         <span class="comment">//disable int, and DON'T clear the TWINT flag!</span>
<a name="l00123"></a>00123                 <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;      <span class="comment">//Reset the state machine.</span>
<a name="l00124"></a>00124                 <span class="keywordflow">return</span>;
<a name="l00125"></a>00125             }
<a name="l00126"></a>00126             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5e4714c204fd9c4052ca3208a63493baa">TW_Wait4Data</a>;
<a name="l00127"></a>00127             TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//enable ACKing</span>
<a name="l00128"></a>00128         }
<a name="l00129"></a>00129         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#6ab2d53631ce164e3cd5fb1d1d1658ab">TWS_REPEAT</a> == Status)   <span class="comment">//We saw a re-Start, so must be getting ready for a Read cmd.</span>
<a name="l00130"></a>00130         {   <span class="comment">//Must now interpret previously-sent CurrentCmd &amp; set up Reply data.</span>
<a name="l00131"></a>00131             <span class="keywordflow">if</span>(TWISR_CmdFeatures &amp; (<a class="code" href="communication_2interpreter_8h.html#a85af9d88231ee9fe08e31e03ba2d11b">SCRW</a> | <a class="code" href="communication_2interpreter_8h.html#f5e6b90ad1abedbf1c8b369dca830d8a">SCRG</a>))   <span class="comment">//Is it a 'ReadWord' or 'ReadGroup' command type?</span>
<a name="l00132"></a>00132             {
<a name="l00133"></a>00133                 <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#1fef3300524ef987fa146cc892813b20">SMB_SetUpReply</a>;  <span class="comment">//Foreground decoder will set up TWCR.</span>
<a name="l00134"></a>00134                 <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b583d27cae0915c8a8002877623dcb0dc9">TW_ReplyData</a>;     <span class="comment">//Move to next state.</span>
<a name="l00135"></a>00135             }
<a name="l00136"></a>00136             <span class="keywordflow">else</span>
<a name="l00137"></a>00137             {
<a name="l00138"></a>00138                 <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] |= <a class="code" href="SMBSlave_8h.html#2bdc5a6b268dc4322b1f032918629a0b">SMBerr_UnknownError</a>;
<a name="l00139"></a>00139                 <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;   <span class="comment">//Not a READ-type cmd, so generate a bus timeout.</span>
<a name="l00140"></a>00140                 TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);       <span class="comment">//disable int, and DON'T clear the TWINT flag!</span>
<a name="l00141"></a>00141                 <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;      <span class="comment">//Reset the state machine.</span>
<a name="l00142"></a>00142                 <span class="keywordflow">return</span>;
<a name="l00143"></a>00143             }
<a name="l00144"></a>00144             TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);         <span class="comment">//disable int, and DON'T clear the TWINT flag!</span>
<a name="l00145"></a>00145             <span class="keywordflow">return</span>;
<a name="l00146"></a>00146         }
<a name="l00147"></a>00147         <span class="keywordflow">else</span>  <span class="comment">//some type of error!</span>
<a name="l00148"></a>00148         {
<a name="l00149"></a>00149             <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] |= <a class="code" href="SMBSlave_8h.html#2bdc5a6b268dc4322b1f032918629a0b">SMBerr_UnknownError</a>;
<a name="l00150"></a>00150             <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;   <span class="comment">//Generate a bus timeout.</span>
<a name="l00151"></a>00151             TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);       <span class="comment">//disable int, and DON'T clear the TWINT flag!</span>
<a name="l00152"></a>00152             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;          <span class="comment">//Reset the state machine.</span>
<a name="l00153"></a>00153             <span class="keywordflow">return</span>;
<a name="l00154"></a>00154         }
<a name="l00155"></a>00155         <span class="keywordflow">break</span>;
<a name="l00156"></a>00156 
<a name="l00157"></a>00157 
<a name="l00158"></a>00158     <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5e4714c204fd9c4052ca3208a63493baa">TW_Wait4Data</a>:  <span class="comment">//We are in Slave Receive operating mode.</span>
<a name="l00159"></a>00159         <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#be4452976a52cc5e091f32ead12669ce">TWS_RDATA</a> == Status)         <span class="comment">//received a data byte</span>
<a name="l00160"></a>00160         {
<a name="l00161"></a>00161             tmp = TWDR;
<a name="l00162"></a>00162             <span class="keywordflow">if</span>(--<a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> &lt; -1)          <span class="comment">//Are we past the PEC byte and still getting more data?</span>
<a name="l00163"></a>00163             {
<a name="l00164"></a>00164                 <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] |= <a class="code" href="SMBSlave_8h.html#4a42c77a65eb6185d98043e9a9e0bf64">SMBerr_BadSize</a>;    <span class="comment">//throw away the data &amp; flag error</span>
<a name="l00165"></a>00165                 <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;   <span class="comment">//Generate a bus timeout.</span>
<a name="l00166"></a>00166                 TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);       <span class="comment">//disable int, and DON'T clear the TWINT flag!</span>
<a name="l00167"></a>00167                 <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;          <span class="comment">//Reset the state machine.</span>
<a name="l00168"></a>00168                 <span class="keywordflow">return</span>;
<a name="l00169"></a>00169             }
<a name="l00170"></a>00170             <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[<a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>++] = TWDR;   <span class="comment">//store the byte</span>
<a name="l00171"></a>00171         }
<a name="l00172"></a>00172 
<a name="l00173"></a>00173         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#ea29a640c276fdaea02372a2c1ac5f78">TWS_RSTOP</a> == Status)            <span class="comment">//got a STOP; all done RXing data now.</span>
<a name="l00174"></a>00174         { <span class="comment">//Note: if we get a STOP prematurely, then we simply ignore the command,</span>
<a name="l00175"></a>00175             <span class="comment">//  since it is too late to inform the Master of the error.</span>
<a name="l00176"></a>00176             <span class="keywordflow">if</span>((<a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> &gt; 0) || (<a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> &lt; -1)) <span class="comment">//We got a premature STOP or too much data; ERROR!</span>
<a name="l00177"></a>00177             {
<a name="l00178"></a>00178                 <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] |= <a class="code" href="SMBSlave_8h.html#4a42c77a65eb6185d98043e9a9e0bf64">SMBerr_BadSize</a>;    <span class="comment">//throw away the data.</span>
<a name="l00179"></a>00179             }
<a name="l00180"></a>00180             <span class="keywordflow">else</span>
<a name="l00181"></a>00181             {
<a name="l00182"></a>00182                 <span class="keywordflow">if</span>(0 == <a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a>)
<a name="l00183"></a>00183                     <a class="code" href="communication_8c.html#fd9b3e99365b45af6cf763b2dda41546">UsePEC</a> = 0;             <span class="comment">//there is no PEC coming for this packet.</span>
<a name="l00184"></a>00184                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(-1 == <a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a>)
<a name="l00185"></a>00185                     <a class="code" href="communication_8c.html#fd9b3e99365b45af6cf763b2dda41546">UsePEC</a> = 1;             <span class="comment">//PEC was included.</span>
<a name="l00186"></a>00186 
<a name="l00187"></a>00187                 <a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> = <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>;        <span class="comment">//re-use the Write Index's value as the Valid Byte Count.</span>
<a name="l00188"></a>00188                 <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a> = 0;          <span class="comment">//clear the index in preparation for interpreting it.</span>
<a name="l00189"></a>00189                 <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#07b00aac11ba389d5b53e2f9d54bd0bd">SMB_GotCmdData</a>;  <span class="comment">//tell Foreground to process this now.</span>
<a name="l00190"></a>00190                 <span class="comment">//Note that when (TWI_CmdFlags == SMB_GotCmdData), TWI ISR will respond with BUSY condition.</span>
<a name="l00191"></a>00191             }
<a name="l00192"></a>00192             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;      <span class="comment">//Reset the state machine in all cases.</span>
<a name="l00193"></a>00193         }
<a name="l00194"></a>00194 
<a name="l00195"></a>00195         <span class="keywordflow">else</span>  <span class="comment">//some type of error during transmission!</span>
<a name="l00196"></a>00196         {
<a name="l00197"></a>00197             <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] |= <a class="code" href="SMBSlave_8h.html#2bdc5a6b268dc4322b1f032918629a0b">SMBerr_UnknownError</a>;
<a name="l00198"></a>00198             <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;   <span class="comment">//Not a WRITE-type cmd, so generate a bus timeout.</span>
<a name="l00199"></a>00199             TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);       <span class="comment">//disable int, and DON'T clear the TWINT flag!</span>
<a name="l00200"></a>00200             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;          <span class="comment">//Reset the state machine.</span>
<a name="l00201"></a>00201             <span class="keywordflow">return</span>;
<a name="l00202"></a>00202         }
<a name="l00203"></a>00203 
<a name="l00204"></a>00204         TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//enable ACKing</span>
<a name="l00205"></a>00205         <span class="keywordflow">break</span>;
<a name="l00206"></a>00206 
<a name="l00207"></a>00207 
<a name="l00208"></a>00208     <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b583d27cae0915c8a8002877623dcb0dc9">TW_ReplyData</a>:  <span class="comment">//We are now in Slave Transmit operating mode.</span>
<a name="l00209"></a>00209         <span class="comment">//The foreground code has set up the response that we are now sending.</span>
<a name="l00210"></a>00210         <span class="comment">//Note: TW_TxBufCnt *always* includes the PEC byte! Since we don't</span>
<a name="l00211"></a>00211         <span class="comment">// know whether the Master actually WANTS the PEC byte or not, we will</span>
<a name="l00212"></a>00212         <span class="comment">// always TRY to send it, regardless of the state of the UsePEC flag.</span>
<a name="l00213"></a>00213         <span class="comment">// If the Master does NOT want it, we will get a NAK while the PEC</span>
<a name="l00214"></a>00214         <span class="comment">// byte is still in the buffer.  In the rare case where we send it all,</span>
<a name="l00215"></a>00215         <span class="comment">// including the PEC byte, but we still get an ACK back, the TWI module</span>
<a name="l00216"></a>00216         <span class="comment">// will be off-line anyway due to not setting the TWEA bit after sending PEC,</span>
<a name="l00217"></a>00217         <span class="comment">// and we will therefore be unable to flag that an error has occurred.</span>
<a name="l00218"></a>00218         <span class="keywordflow">if</span>((<a class="code" href="SMBSlave_8h.html#56a6f2a019fcb0f004ad6a8619fd9b3f">TWS_SLA_R</a> == Status) || (<a class="code" href="SMBSlave_8h.html#69333e59f4e48bd3130a871152cc17ae">TWS_RACK</a> == Status))   <span class="comment">//send out Reply data</span>
<a name="l00219"></a>00219         {
<a name="l00220"></a>00220             TWDR = <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[<a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a>++];   <span class="comment">//send data out</span>
<a name="l00221"></a>00221             <span class="keywordflow">if</span>(--<a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a> == 0)          <span class="comment">//Have we emptied the buffer, incl. PEC?</span>
<a name="l00222"></a>00222                 TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);      <span class="comment">// Yes, so don't set TWEA.</span>
<a name="l00223"></a>00223             <span class="keywordflow">else</span>
<a name="l00224"></a>00224                 TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">// No, so assert TWEA.</span>
<a name="l00225"></a>00225         }
<a name="l00226"></a>00226         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#d3a2ba13b4f5c4ccac0d9d5a67a08c9c">TWS_RNAK</a> == Status) <span class="comment">//We may have gotten this validly or as an Error.</span>
<a name="l00227"></a>00227         {
<a name="l00228"></a>00228             <span class="keywordflow">if</span>(<a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a> == 1)    <span class="comment">//Not an error. Master didn't want PEC; clear UsePEC flag!</span>
<a name="l00229"></a>00229             {
<a name="l00230"></a>00230                 <a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a> = 0;    <span class="comment">//clear the buffer too.</span>
<a name="l00231"></a>00231                 <a class="code" href="communication_8c.html#fd9b3e99365b45af6cf763b2dda41546">UsePEC</a> = 0;
<a name="l00232"></a>00232             }
<a name="l00233"></a>00233             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a> == 0)   <span class="comment">//Not an error. Master wanted PEC (and got it); assert UsePEC.</span>
<a name="l00234"></a>00234                 <a class="code" href="communication_8c.html#fd9b3e99365b45af6cf763b2dda41546">UsePEC</a> = 1;
<a name="l00235"></a>00235             <span class="keywordflow">else</span>            <span class="comment">//some kind of error occurred; we got NAK too early!</span>
<a name="l00236"></a>00236             { <span class="comment">//Note: the TWI module is now OFF-LINE, so we can't inform Host of this error!!</span>
<a name="l00237"></a>00237                 <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] |= <a class="code" href="SMBSlave_8h.html#2bdc5a6b268dc4322b1f032918629a0b">SMBerr_UnknownError</a>;   <span class="comment">//flag it later</span>
<a name="l00238"></a>00238             }
<a name="l00239"></a>00239             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;          <span class="comment">//In all cases, go back to IDLE.</span>
<a name="l00240"></a>00240             TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);
<a name="l00241"></a>00241         }
<a name="l00242"></a>00242         <span class="keywordflow">else</span>
<a name="l00243"></a>00243             <span class="comment">//    if(TWS_FINAL == Status)   //ERROR: we got an ACK but we have no more data!</span>
<a name="l00244"></a>00244         { <span class="comment">//Since the TWI module is now in "Not Addressed Slave" mode, we can't flag the error</span>
<a name="l00245"></a>00245             <span class="comment">// back to the Master DURING this transaction; we WILL assert an error status though.</span>
<a name="l00246"></a>00246             <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] |= <a class="code" href="SMBSlave_8h.html#4a42c77a65eb6185d98043e9a9e0bf64">SMBerr_BadSize</a>;
<a name="l00247"></a>00247             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;  <span class="comment">//Reset the state machine.</span>
<a name="l00248"></a>00248             TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);
<a name="l00249"></a>00249         }
<a name="l00250"></a>00250         <span class="keywordflow">break</span>;
<a name="l00251"></a>00251 
<a name="l00252"></a>00252 
<a name="l00253"></a>00253 
<a name="l00254"></a>00254         <span class="comment">//MASTER-mode states follow.</span>
<a name="l00255"></a>00255 
<a name="l00256"></a>00256     <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5d258cb231677f6a95dcf1c9f239e2b36">TW_MSLA_W</a>: <span class="comment">//we just tried to send the SLAVE ADDRESS in Master Mode.</span>
<a name="l00257"></a>00257         <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#42b34b4323c0fd4986325ecd815b60b6">TWS_WRITE_ACK</a> == Status)     <span class="comment">// we got an ACK back from the desired SLA+W transmission</span>
<a name="l00258"></a>00258         {
<a name="l00259"></a>00259             TWDR = <a class="code" href="communication_8c.html#c47af82e11278b79be8fb40152038444">TW_MTxBuf</a>[<a class="code" href="communication_8c.html#c8ae296e1c1a72b91325c789bbdff1a0">TW_MTxBufIndex</a>++]; <span class="comment">//send out Cmd</span>
<a name="l00260"></a>00260             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b52166c37a639d0f299b5195aa8672bd41">TW_MCMD_W</a>;
<a name="l00261"></a>00261             TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);
<a name="l00262"></a>00262         }
<a name="l00263"></a>00263         <span class="keywordflow">else</span>  <span class="comment">//anything else is Unexpected or an Error result.</span>
<a name="l00264"></a>00264         { <span class="comment">//We simply delete msgs that couldn't be sent as they will be resent in 10secs anyway.</span>
<a name="l00265"></a>00265             TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWSTO) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);
<a name="l00266"></a>00266             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;  <span class="comment">//Reset the state machine.</span>
<a name="l00267"></a>00267             <a class="code" href="communication_8c.html#3543d0e9d6053dac3f9b711d440a3f93">TW_MTxBufCnt</a> = 0;
<a name="l00268"></a>00268             <a class="code" href="communication_8c.html#c8ae296e1c1a72b91325c789bbdff1a0">TW_MTxBufIndex</a> = 0;
<a name="l00269"></a>00269             <a class="code" href="communication_8c.html#83b4a23934b4a918f7615cadb682e122">TXmsgDelete</a>;                  <span class="comment">//Delete this just-sent msg from the TX buffer.</span>
<a name="l00270"></a>00270             <a class="code" href="communication_8c.html#8eb5d9128fac12df31c29313df01b1ac">SMLOCK</a> = 0;
<a name="l00271"></a>00271         }
<a name="l00272"></a>00272         <span class="keywordflow">break</span>;
<a name="l00273"></a>00273 
<a name="l00274"></a>00274     <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b52166c37a639d0f299b5195aa8672bd41">TW_MCMD_W</a>: <span class="comment">//we just sent a Master COMMAND byte or a Data byte</span>
<a name="l00275"></a>00275         <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#8241a83cf96e3888d0e070ca3b05c394">TWS_TXDATA_ACK</a> == Status)    <span class="comment">// we got an ACK from data we sent.</span>
<a name="l00276"></a>00276         {
<a name="l00277"></a>00277             <span class="keywordflow">if</span>(<a class="code" href="communication_8c.html#3543d0e9d6053dac3f9b711d440a3f93">TW_MTxBufCnt</a> &gt; <a class="code" href="communication_8c.html#c8ae296e1c1a72b91325c789bbdff1a0">TW_MTxBufIndex</a>)
<a name="l00278"></a>00278             {
<a name="l00279"></a>00279                 TWDR = <a class="code" href="communication_8c.html#c47af82e11278b79be8fb40152038444">TW_MTxBuf</a>[<a class="code" href="communication_8c.html#c8ae296e1c1a72b91325c789bbdff1a0">TW_MTxBufIndex</a>++]; <span class="comment">//send out Data byte</span>
<a name="l00280"></a>00280                 <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b52166c37a639d0f299b5195aa8672bd41">TW_MCMD_W</a>;
<a name="l00281"></a>00281                 TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);
<a name="l00282"></a>00282             }
<a name="l00283"></a>00283             <span class="keywordflow">else</span>  <span class="comment">//we've sent everything in the buffer, so send STOP now.</span>
<a name="l00284"></a>00284             {
<a name="l00285"></a>00285                 TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWSTO) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);
<a name="l00286"></a>00286                 <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;
<a name="l00287"></a>00287                 <a class="code" href="communication_8c.html#3543d0e9d6053dac3f9b711d440a3f93">TW_MTxBufCnt</a> = 0;
<a name="l00288"></a>00288                 <a class="code" href="communication_8c.html#c8ae296e1c1a72b91325c789bbdff1a0">TW_MTxBufIndex</a> = 0;
<a name="l00289"></a>00289                 <a class="code" href="communication_8c.html#83b4a23934b4a918f7615cadb682e122">TXmsgDelete</a>;                  <span class="comment">//Delete this just-sent msg from the TX buffer.</span>
<a name="l00290"></a>00290                 <a class="code" href="communication_8c.html#8eb5d9128fac12df31c29313df01b1ac">SMLOCK</a> = 0;
<a name="l00291"></a>00291             }
<a name="l00292"></a>00292         }
<a name="l00293"></a>00293         <span class="keywordflow">else</span>  <span class="comment">//Unexpected or Error response.</span>
<a name="l00294"></a>00294         {
<a name="l00295"></a>00295             TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWSTO) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);
<a name="l00296"></a>00296             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;
<a name="l00297"></a>00297             <a class="code" href="communication_8c.html#3543d0e9d6053dac3f9b711d440a3f93">TW_MTxBufCnt</a> = 0;
<a name="l00298"></a>00298             <a class="code" href="communication_8c.html#c8ae296e1c1a72b91325c789bbdff1a0">TW_MTxBufIndex</a> = 0;
<a name="l00299"></a>00299             <a class="code" href="communication_8c.html#83b4a23934b4a918f7615cadb682e122">TXmsgDelete</a>;                  <span class="comment">//Delete this just-sent msg from the TX buffer.</span>
<a name="l00300"></a>00300             <a class="code" href="communication_8c.html#8eb5d9128fac12df31c29313df01b1ac">SMLOCK</a> = 0;
<a name="l00301"></a>00301         }
<a name="l00302"></a>00302         <span class="keywordflow">break</span>;
<a name="l00303"></a>00303 
<a name="l00304"></a>00304     } <span class="comment">// end of switch(TWISR_state)</span>
<a name="l00305"></a>00305 }
<a name="l00306"></a>00306 
<a name="l00307"></a>00307 
<a name="l00308"></a>00308 <span class="comment">/* *************************************************************************</span>
<a name="l00309"></a>00309 <span class="comment"> *</span>
<a name="l00310"></a>00310 <span class="comment"> *   Foreground SMBus Command Interpreter</span>
<a name="l00311"></a>00311 <span class="comment"> *</span>
<a name="l00312"></a>00312 <span class="comment"> ************************************************************************* */</span>
<a name="l00313"></a>00313 
<a name="l00314"></a>00314 
<a name="l00315"></a><a class="code" href="smbus__removed_8c.html#bee976a1ba64bc7089b0d73ea432900e">00315</a> <span class="keywordtype">void</span> <a class="code" href="communication_8c.html#bee976a1ba64bc7089b0d73ea432900e">SMB_CmdInterpreter</a>(<span class="keywordtype">void</span>)
<a name="l00316"></a>00316 {
<a name="l00317"></a>00317     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> temp;
<a name="l00318"></a>00318 
<a name="l00319"></a>00319     <span class="keywordflow">if</span>(<a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a> == <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a>)   <span class="comment">//The ISR detected an error condition.</span>
<a name="l00320"></a>00320     {
<a name="l00321"></a>00321         <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = 0;           <span class="comment">//clear the flag that brought us here.</span>
<a name="l00322"></a>00322         <span class="comment">//start the 26mS timer.  When it is done, the Timer handler will re-init the TWI peripheral.</span>
<a name="l00323"></a>00323         <span class="comment">//SetGenericTimer(SMBfaultTimer, 26);</span>
<a name="l00324"></a>00324         <span class="keywordflow">return</span>;
<a name="l00325"></a>00325     }
<a name="l00326"></a>00326     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="communication_8c.html#1fef3300524ef987fa146cc892813b20">SMB_SetUpReply</a> == <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a>) <span class="comment">//interpret a 'Read' Command.</span>
<a name="l00327"></a>00327     {
<a name="l00328"></a>00328         <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = 0;           <span class="comment">//clear the flag that brought us here.</span>
<a name="l00329"></a>00329         <a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a> = 0;          <span class="comment">//initialize</span>
<a name="l00330"></a>00330         <a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a> = 0;            <span class="comment">//initialize</span>
<a name="l00331"></a>00331         <span class="keywordflow">if</span>(0 != <a class="code" href="smbus__removed_8c.html#a2df3e1c35180cf0af73f7723167d696">SMB_ReadCmd</a>[<a class="code" href="communication_8c.html#50d57ab7cb03b10099411f378522dadd">CurrentCmd</a>]())  <span class="comment">//After interpreting, was there an error??</span>
<a name="l00332"></a>00332         {
<a name="l00333"></a>00333             <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] |= <a class="code" href="SMBSlave_8h.html#a5a26e8cc169c82b3f951c20be0a103b">SMBerr_UnsuptdCommand</a>;
<a name="l00334"></a>00334             <a class="code" href="timer_8c.html#3ad6d4c2cd213c29e403adeff96c71d4">SetGenericTimer</a>(<a class="code" href="timer_8h.html#1e9c8bb728946234c7ca94eefed0d4c1">SMBfaultTimer</a>, 26); <span class="comment">//generate a bus timeout error.</span>
<a name="l00335"></a>00335             <a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a> = 0;        <span class="comment">//Wipe out anything in the buffer, just in case.</span>
<a name="l00336"></a>00336             <a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a> = 0;
<a name="l00337"></a>00337             <span class="keywordflow">return</span>;
<a name="l00338"></a>00338         }
<a name="l00339"></a>00339         <span class="keywordflow">else</span> <span class="comment">//generate PEC now for the *entire* transaction, including the original request!</span>
<a name="l00340"></a>00340         {
<a name="l00341"></a>00341             <span class="comment">//Assume (TW_TxBufIndex == 0) and (TW_TxBufCtr == # of bytes of data, not incl PEC).</span>
<a name="l00342"></a>00342             temp = <a class="code" href="smbus__removed_8c.html#5236dde88b9f0817fabad10165faf02c">FastCRC</a>(0, (TWAR &amp; 0xFE));   <span class="comment">//use the SLA+W address</span>
<a name="l00343"></a>00343             temp = <a class="code" href="smbus__removed_8c.html#5236dde88b9f0817fabad10165faf02c">FastCRC</a>(temp, <a class="code" href="communication_8c.html#50d57ab7cb03b10099411f378522dadd">CurrentCmd</a>);
<a name="l00344"></a>00344             temp = <a class="code" href="smbus__removed_8c.html#5236dde88b9f0817fabad10165faf02c">FastCRC</a>(temp, (TWAR | 1));   <span class="comment">//use the SLA+R address</span>
<a name="l00345"></a>00345 
<a name="l00346"></a>00346             <span class="keywordflow">do</span> {temp = <a class="code" href="smbus__removed_8c.html#5236dde88b9f0817fabad10165faf02c">FastCRC</a>(temp, <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[<a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a>++]);}
<a name="l00347"></a>00347             <span class="keywordflow">while</span>(<a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a> != <a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a>);
<a name="l00348"></a>00348 
<a name="l00349"></a>00349             <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[<a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a>] = temp; <span class="comment">//append the CRC value on the end.</span>
<a name="l00350"></a>00350             <a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a>++;          <span class="comment">//increase the byte count for the PEC.</span>
<a name="l00351"></a>00351             <a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a> = 0;      <span class="comment">//Reset the buffer pointer.</span>
<a name="l00352"></a>00352             TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//have TWI continue from where it stalled.</span>
<a name="l00353"></a>00353         }
<a name="l00354"></a>00354         <span class="keywordflow">return</span>;
<a name="l00355"></a>00355     }
<a name="l00356"></a>00356     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="communication_8c.html#07b00aac11ba389d5b53e2f9d54bd0bd">SMB_GotCmdData</a> == <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a>) <span class="comment">//process some received command+data.</span>
<a name="l00357"></a>00357     {
<a name="l00358"></a>00358         <span class="comment">//NOTE: as of 6/17/2005, TWI_CmdFlags should NOT be cleared until we are</span>
<a name="l00359"></a>00359         <span class="comment">// completely done processing this message, else the TWI ISR will overwrite</span>
<a name="l00360"></a>00360         <span class="comment">// the RX buffer and won't respond with BUSY as it should.  Note also that</span>
<a name="l00361"></a>00361         <span class="comment">// the TWI is fully re-enabled when entering here, so we MUST NOT write</span>
<a name="l00362"></a>00362         <span class="comment">// to any of the TWI h/w registers or we could create havoc.  -rgf</span>
<a name="l00363"></a>00363 
<a name="l00364"></a>00364         <span class="keywordflow">if</span>(<a class="code" href="communication_8c.html#fd9b3e99365b45af6cf763b2dda41546">UsePEC</a>)              <span class="comment">//check the CRC of the received packet.</span>
<a name="l00365"></a>00365         {
<a name="l00366"></a>00366             temp = 0;               <span class="comment">//use this as our CRC value.</span>
<a name="l00367"></a>00367 
<a name="l00368"></a>00368             <span class="keywordflow">do</span> { temp = <a class="code" href="smbus__removed_8c.html#5236dde88b9f0817fabad10165faf02c">FastCRC</a>(temp, <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[<a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>++]); }
<a name="l00369"></a>00369             <span class="keywordflow">while</span>(<a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> != <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>);
<a name="l00370"></a>00370 
<a name="l00371"></a>00371             <span class="keywordflow">if</span>(temp)    <span class="comment">//The result of a CRC check SHOULD be =0 if all was ok.</span>
<a name="l00372"></a>00372             {
<a name="l00373"></a>00373                 <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] |= <a class="code" href="SMBSlave_8h.html#2bdc5a6b268dc4322b1f032918629a0b">SMBerr_UnknownError</a>;
<a name="l00374"></a>00374 
<a name="l00375"></a>00375                 <span class="comment">//start the 26mS timer to generate a bus timeout error.</span>
<a name="l00376"></a>00376                 <a class="code" href="timer_8c.html#3ad6d4c2cd213c29e403adeff96c71d4">SetGenericTimer</a>(<a class="code" href="timer_8h.html#1e9c8bb728946234c7ca94eefed0d4c1">SMBfaultTimer</a>, 26);
<a name="l00377"></a>00377                 <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = 0;       <span class="comment">//clear the flag that brought us here.</span>
<a name="l00378"></a>00378                 <span class="keywordflow">return</span>;
<a name="l00379"></a>00379             }
<a name="l00380"></a>00380         }
<a name="l00381"></a>00381 
<a name="l00382"></a>00382         <span class="comment">//The rcvd message is valid enough to warrant calling the command's handler now.</span>
<a name="l00383"></a>00383 
<a name="l00384"></a>00384 
<a name="l00385"></a>00385         <span class="comment">//Note that none of the regular SMBus commands use Block Mode to send info</span>
<a name="l00386"></a>00386         <span class="comment">// *TO* the Smart Battery, so TW_RxBuf[2] will NEVER be a byte count, but</span>
<a name="l00387"></a>00387         <span class="comment">// will always be DATA.  For OptionalMfgFunction(5), the associated command</span>
<a name="l00388"></a>00388         <span class="comment">// function itself is aware that [2] is the byte count and that the actual</span>
<a name="l00389"></a>00389         <span class="comment">// data starts at offset=[3].</span>
<a name="l00390"></a>00390         <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a> = 2;          <span class="comment">//point to the first byte of Received Data.</span>
<a name="l00391"></a>00391 
<a name="l00392"></a>00392 
<a name="l00393"></a>00393         <span class="keywordflow">if</span>(0 != <a class="code" href="smbus__removed_8c.html#4ddb0ec9b1efd2d94604321291ddab72">SMB_WriteCmd</a>[<a class="code" href="communication_8c.html#50d57ab7cb03b10099411f378522dadd">CurrentCmd</a>]()) <span class="comment">//After interpreting, was there an error??</span>
<a name="l00394"></a>00394         {
<a name="l00395"></a>00395             <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a> = 0;      <span class="comment">//Wipe out anything in the buffer, just in case.</span>
<a name="l00396"></a>00396             <a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> = 0;
<a name="l00397"></a>00397 
<a name="l00398"></a>00398             <span class="comment">//start the 26mS timer to generate a bus timeout error.</span>
<a name="l00399"></a>00399             <a class="code" href="timer_8c.html#3ad6d4c2cd213c29e403adeff96c71d4">SetGenericTimer</a>(<a class="code" href="timer_8h.html#1e9c8bb728946234c7ca94eefed0d4c1">SMBfaultTimer</a>, 26);
<a name="l00400"></a>00400             <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = 0;           <span class="comment">//clear the flag that brought us here.</span>
<a name="l00401"></a>00401             <span class="keywordflow">return</span>;
<a name="l00402"></a>00402         }
<a name="l00403"></a>00403         <span class="comment">//At this point it looks like everything went OK.</span>
<a name="l00404"></a>00404         <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = 0;           <span class="comment">//clear the flag that brought us here.</span>
<a name="l00405"></a>00405         <span class="keywordflow">return</span>;
<a name="l00406"></a>00406     }
<a name="l00407"></a>00407 }
<a name="l00408"></a>00408 
<a name="l00409"></a>00409 
<a name="l00410"></a>00410 
<a name="l00411"></a>00411 
<a name="l00412"></a><a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">00412</a> <span class="keywordtype">void</span> <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>(<a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> info)
<a name="l00413"></a>00413 {
<a name="l00414"></a>00414     <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[0] = (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) info;
<a name="l00415"></a>00415     <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[1] = (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) (info &gt;&gt; 8);
<a name="l00416"></a>00416 
<a name="l00417"></a>00417     <a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a> = 0;
<a name="l00418"></a>00418     <a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a> = 2;
<a name="l00419"></a>00419 }
<a name="l00420"></a>00420 
<a name="l00421"></a>00421 
<a name="l00422"></a><a class="code" href="smbus__removed_8c.html#c936e39317ee9bdcc5399b33044eca8c">00422</a> <span class="keywordtype">void</span> <a class="code" href="smbus__removed_8c.html#c936e39317ee9bdcc5399b33044eca8c">FillResponseStr</a>(<span class="keywordtype">char</span> __flash * source)
<a name="l00423"></a>00423 {
<a name="l00424"></a>00424     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> * dest = <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>;
<a name="l00425"></a>00425     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> ctr = 0;
<a name="l00426"></a>00426 
<a name="l00427"></a>00427     <span class="keywordflow">for</span>(;;)
<a name="l00428"></a>00428     {
<a name="l00429"></a>00429         <span class="keywordflow">if</span>(*dest++ = *source++)
<a name="l00430"></a>00430             ctr++;
<a name="l00431"></a>00431         <span class="keywordflow">else</span>
<a name="l00432"></a>00432             <span class="keywordflow">break</span>;
<a name="l00433"></a>00433     }
<a name="l00434"></a>00434 
<a name="l00435"></a>00435     <a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a> = 0;
<a name="l00436"></a>00436     <a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a> = ctr;
<a name="l00437"></a>00437 }
<a name="l00438"></a>00438 
<a name="l00439"></a>00439 
<a name="l00440"></a>00440 
<a name="l00441"></a>00441 
<a name="l00442"></a>00442 <span class="comment">/* ************************************************** */</span>
<a name="l00443"></a>00443 
<a name="l00444"></a><a class="code" href="smbus__removed_8c.html#73f1bf63ecd0d2aa6ecb0eb025a71103">00444</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#73f1bf63ecd0d2aa6ecb0eb025a71103">SMBR_MfrAccess</a>(<span class="keywordtype">void</span>)    <span class="comment">// Cmd # 0</span>
<a name="l00445"></a>00445 {
<a name="l00446"></a>00446   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>(<a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#509023a35671e6a6a37394e126b17278">SMBV_MfrAccess</a>]);
<a name="l00447"></a>00447   <span class="keywordflow">return</span> 0;
<a name="l00448"></a>00448 }
<a name="l00449"></a>00449 
<a name="l00450"></a>00450 
<a name="l00451"></a>00451 
<a name="l00452"></a><a class="code" href="smbus__removed_8c.html#630c35b597267b58a33795af2a00a435">00452</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#630c35b597267b58a33795af2a00a435">SMBR_RemCapAlm</a>(<span class="keywordtype">void</span>)    <span class="comment">// 1</span>
<a name="l00453"></a>00453 {
<a name="l00454"></a>00454   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>(<a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#796d810f2c76d8ec9f0837011fbf4e93">SMBV_RemCapAlm</a>]);
<a name="l00455"></a>00455   <span class="keywordflow">return</span> 0;
<a name="l00456"></a>00456 }
<a name="l00457"></a>00457 
<a name="l00458"></a>00458 
<a name="l00459"></a><a class="code" href="smbus__removed_8c.html#1aa734a8f6571c02ddb597130427ba88">00459</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#1aa734a8f6571c02ddb597130427ba88">SMBR_RemTimeAlm</a>(<span class="keywordtype">void</span>)   <span class="comment">// 2</span>
<a name="l00460"></a>00460 {
<a name="l00461"></a>00461   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>(<a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#5291017d88766e09b4aa1df97f5d8ba6">SMBV_RemTimeAlm</a>]);
<a name="l00462"></a>00462   <span class="keywordflow">return</span> 0;
<a name="l00463"></a>00463 }
<a name="l00464"></a>00464 
<a name="l00465"></a>00465 
<a name="l00466"></a><a class="code" href="smbus__removed_8c.html#1f2f22bf92cf394faa0198591787ea62">00466</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#1f2f22bf92cf394faa0198591787ea62">SMBR_BattMode</a>(<span class="keywordtype">void</span>) <span class="comment">// 3</span>
<a name="l00467"></a>00467 {
<a name="l00468"></a>00468   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>(<a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#9b9498cc5b1927e9d63da15b33c851a4">SMBV_BattMode</a>]);
<a name="l00469"></a>00469   <span class="keywordflow">return</span> 0;
<a name="l00470"></a>00470 }
<a name="l00471"></a>00471 
<a name="l00472"></a>00472 
<a name="l00473"></a><a class="code" href="smbus__removed_8c.html#8c05e95201f2092c6c991e68eca82c6f">00473</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#8c05e95201f2092c6c991e68eca82c6f">SMBR_AtRate</a>(<span class="keywordtype">void</span>)       <span class="comment">// 4</span>
<a name="l00474"></a>00474 {
<a name="l00475"></a>00475   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>((<a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a>)<a class="code" href="battery__pack__parameters_8c.html#465d57b9c9b2b607be86de50f09ed7ba" title="Battery parameters that are calculated at startup from eeprom variables.">battParams_sram</a>.<a class="code" href="structbattParam__sramstruct.html#2888e4c99949e2995dc07402a57d37f7" title="Used by all the AtRate commands, it doesn&amp;#39;t do anything if this is reset on reset...">atRate</a>);
<a name="l00476"></a>00476   <span class="keywordflow">return</span> 0;
<a name="l00477"></a>00477 }
<a name="l00478"></a>00478 
<a name="l00479"></a>00479 
<a name="l00480"></a><a class="code" href="smbus__removed_8c.html#e9447066726b5b36e1d9fbae1ca73b8a">00480</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#e9447066726b5b36e1d9fbae1ca73b8a">SMBR_AtRateTTF</a>(<span class="keywordtype">void</span>)    <span class="comment">// 5</span>
<a name="l00481"></a>00481 {
<a name="l00482"></a>00482   <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> temp = <a class="code" href="gas__gauging_8c.html#8b1dc7b992d0aaf38f84bd57ea0f1e6d" title="Estimate time to full.">GASG_TimeToFull</a>(<a class="code" href="battery__pack__parameters_8c.html#465d57b9c9b2b607be86de50f09ed7ba" title="Battery parameters that are calculated at startup from eeprom variables.">battParams_sram</a>.<a class="code" href="structbattParam__sramstruct.html#2888e4c99949e2995dc07402a57d37f7" title="Used by all the AtRate commands, it doesn&amp;#39;t do anything if this is reset on reset...">atRate</a>); <span class="comment">//AtRateTTF();</span>
<a name="l00483"></a>00483   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#9e2cc6d9606a14c33183df268056f124">SMBV_AtRateTTF</a>] = temp;    <span class="comment">//save local copy of result for DEBUG PURPOSES ONLY</span>
<a name="l00484"></a>00484   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>(temp);
<a name="l00485"></a>00485   <span class="keywordflow">return</span> 0;
<a name="l00486"></a>00486 }
<a name="l00487"></a>00487 
<a name="l00488"></a>00488 
<a name="l00489"></a><a class="code" href="smbus__removed_8c.html#6ecefc796f140b5bf7b2aca3a9b6c5b3">00489</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#6ecefc796f140b5bf7b2aca3a9b6c5b3">SMBR_AtRateTTE</a>(<span class="keywordtype">void</span>)    <span class="comment">// 6</span>
<a name="l00490"></a>00490 {
<a name="l00491"></a>00491   <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> temp = <a class="code" href="gas__gauging_8c.html#17d5adf37f8f1ab7851727ec3335f501" title="Estimate time to empty.">GASG_TimeToEmpty</a>(<a class="code" href="battery__pack__parameters_8c.html#465d57b9c9b2b607be86de50f09ed7ba" title="Battery parameters that are calculated at startup from eeprom variables.">battParams_sram</a>.<a class="code" href="structbattParam__sramstruct.html#2888e4c99949e2995dc07402a57d37f7" title="Used by all the AtRate commands, it doesn&amp;#39;t do anything if this is reset on reset...">atRate</a>); <span class="comment">//AtRateTTE();</span>
<a name="l00492"></a>00492   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#f9c39a34369817075dfc3ce187fa9288">SMBV_AtRateTTE</a>] = temp;
<a name="l00493"></a>00493   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>(temp);
<a name="l00494"></a>00494   <span class="keywordflow">return</span> 0;
<a name="l00495"></a>00495 }
<a name="l00496"></a>00496 
<a name="l00497"></a>00497 
<a name="l00498"></a><a class="code" href="smbus__removed_8c.html#5127ca8d082572ee984b9e4a79f08835">00498</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#5127ca8d082572ee984b9e4a79f08835">SMBR_AtRateOK</a>(<span class="keywordtype">void</span>) <span class="comment">// 7</span>
<a name="l00499"></a>00499 {
<a name="l00500"></a>00500   <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> temp = <a class="code" href="gas__gauging_8c.html#1baf8de5f4fe8ba6cdb2a64e9d76a7fb" title="Check if battery can support specified discharge current for 10seconds.">GASG_AtRateOK</a>(<a class="code" href="battery__pack__parameters_8c.html#465d57b9c9b2b607be86de50f09ed7ba" title="Battery parameters that are calculated at startup from eeprom variables.">battParams_sram</a>.<a class="code" href="structbattParam__sramstruct.html#2888e4c99949e2995dc07402a57d37f7" title="Used by all the AtRate commands, it doesn&amp;#39;t do anything if this is reset on reset...">atRate</a>); <span class="comment">//AtRateOK();</span>
<a name="l00501"></a>00501   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#3ab0d8166020f3dba9a8ea581ee7a79b">SMBV_AtRateOK</a>] = temp;
<a name="l00502"></a>00502   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>(temp);
<a name="l00503"></a>00503   <span class="keywordflow">return</span> 0;
<a name="l00504"></a>00504 }
<a name="l00505"></a>00505 
<a name="l00506"></a>00506 <span class="keyword">extern</span> <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> <a class="code" href="smbus__removed_8c.html#bc3e5f99cfa261044b8c55b936041e40">GetTemperature</a>(<span class="keywordtype">void</span>);
<a name="l00507"></a>00507 
<a name="l00508"></a><a class="code" href="smbus__removed_8c.html#ec0372d888714d689077f22dee32abb8">00508</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#ec0372d888714d689077f22dee32abb8">SMBR_Temperature</a>(<span class="keywordtype">void</span>)  <span class="comment">//  8</span>
<a name="l00509"></a>00509 {
<a name="l00510"></a>00510   <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> temp = <a class="code" href="smbus__removed_8c.html#bc3e5f99cfa261044b8c55b936041e40">GetTemperature</a>();
<a name="l00511"></a>00511   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#f0bdb1e0db8ac08742af6b44979d86c0">SMBV_Temperature</a>] = temp;
<a name="l00512"></a>00512   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>(temp);
<a name="l00513"></a>00513   <span class="keywordflow">return</span> 0;
<a name="l00514"></a>00514 }
<a name="l00515"></a>00515 
<a name="l00516"></a>00516 
<a name="l00517"></a><a class="code" href="smbus__removed_8c.html#3b9bb1917845dd73407232d9e1497a8c">00517</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#3b9bb1917845dd73407232d9e1497a8c">SMBR_Voltage</a>(<span class="keywordtype">void</span>)  <span class="comment">//  9</span>
<a name="l00518"></a>00518 {
<a name="l00519"></a>00519   <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> volt = <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac6714495dc31be69defc09d627e487ce6a56c1a">CELL4</a> )+
<a name="l00520"></a>00520                   <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac6714494ab35dc613899d959b4e063d736deb2d">CELL3</a> )+
<a name="l00521"></a>00521                   <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac67144983bc57407aa6f82e37d495ff9d28ed81">CELL2</a> )+
<a name="l00522"></a>00522                   <a class="code" href="vadc_8c.html#dc8b0995e310a115bb72c23830abdf49" title="Calculation of cell voltage.">VADC_readCellVoltage</a>( <a class="code" href="vadc_8h.html#c0b5c20a479d5ecd6b20b99dac671449b08613e4845ef2a5d657b8562c394673">CELL1</a> ); <span class="comment">//GetVoltage();</span>
<a name="l00523"></a>00523   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#de2bcea11ea691618bbeb9863f6f8c98">SMBV_Voltage</a>] = volt;
<a name="l00524"></a>00524   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>(volt);
<a name="l00525"></a>00525   <span class="keywordflow">return</span> 0;
<a name="l00526"></a>00526 }
<a name="l00527"></a>00527 
<a name="l00528"></a>00528 
<a name="l00529"></a><a class="code" href="smbus__removed_8c.html#d28821ff7a1264aefef8df9c87568b60">00529</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#d28821ff7a1264aefef8df9c87568b60">SMBR_Current</a>(<span class="keywordtype">void</span>)  <span class="comment">// 10</span>
<a name="l00530"></a>00530 {
<a name="l00531"></a>00531   <span class="keywordtype">signed</span> <span class="keywordtype">int</span> current = <a class="code" href="battery__current__monitoring_8c.html#d971791f4fc1c6f54e1d7d46fea20786" title="Convert CCADC ticks to mA.">BATTCUR_Ticks2mA</a>( <a class="code" href="battery__current__monitoring_8c.html#ae8592ed4c14b5a00048fe1ed1c68e4a" title="Provides the current from the last CC-ADC reading (18-bit signed).">BATTCUR_GetCurrent</a>() ); <span class="comment">//Current1Sec();</span>
<a name="l00532"></a>00532 
<a name="l00533"></a>00533   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#f38a0628b7466ebe5a453b9c889c1c4a">SMBV_Current</a>] = (<a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a>) current;
<a name="l00534"></a>00534   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>((<a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a>) current);
<a name="l00535"></a>00535   <span class="keywordflow">return</span> 0;
<a name="l00536"></a>00536 }
<a name="l00537"></a>00537 
<a name="l00538"></a>00538 
<a name="l00539"></a><a class="code" href="smbus__removed_8c.html#abc8a4c43a9bcc24754c0b002ba82d58">00539</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#abc8a4c43a9bcc24754c0b002ba82d58">SMBR_AvgCurrent</a>(<span class="keywordtype">void</span>)   <span class="comment">// 11</span>
<a name="l00540"></a>00540 {
<a name="l00541"></a>00541   <span class="keywordtype">signed</span> <span class="keywordtype">int</span> current = <a class="code" href="battery__current__monitoring_8c.html#d971791f4fc1c6f54e1d7d46fea20786" title="Convert CCADC ticks to mA.">BATTCUR_Ticks2mA</a>( <a class="code" href="battery__current__monitoring_8c.html#0959c4b3bb0cee63ad2a3bdb89a92a6d" title="Provide an estimate for the average current throughout the last minute (18-bit signed)...">BATTCUR_GetAverageCurrent</a>() ); <span class="comment">//CCarray_Average();</span>
<a name="l00542"></a>00542 
<a name="l00543"></a>00543   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#8b694e7a6c8d3471f48c93f3dff1ce9c">SMBV_AvgCurrent</a>] = (<a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a>) current;
<a name="l00544"></a>00544   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>((<a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a>) current);
<a name="l00545"></a>00545   <span class="keywordflow">return</span> 0;
<a name="l00546"></a>00546 }
<a name="l00547"></a>00547 
<a name="l00548"></a>00548 
<a name="l00549"></a><a class="code" href="smbus__removed_8c.html#f5f2294b912cd2289e16c1c25f81e3b5">00549</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#f5f2294b912cd2289e16c1c25f81e3b5">SMBR_MaxError</a>(<span class="keywordtype">void</span>) <span class="comment">// 12</span>
<a name="l00550"></a>00550 {
<a name="l00551"></a>00551   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>(<a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#e1664c8bc772348bf27470a400924c82">SMBV_MaxError</a>] = 0);
<a name="l00552"></a>00552   <span class="keywordflow">return</span> 0;
<a name="l00553"></a>00553 }
<a name="l00554"></a>00554 
<a name="l00555"></a>00555 
<a name="l00556"></a><a class="code" href="smbus__removed_8c.html#b2f4fa127fdea3a695a479f1f40445d7">00556</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#b2f4fa127fdea3a695a479f1f40445d7">SMBR_RelSOC</a>(<span class="keywordtype">void</span>)       <span class="comment">// 13</span>
<a name="l00557"></a>00557 {
<a name="l00558"></a>00558   <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> temp = <a class="code" href="gas__gauging_8c.html#cfbc7e47153ec1e54e6fc85ddde14d26" title="Returns state of charge.">GASG_StateOfCharge</a>(<a class="code" href="battery__current__monitoring_8c.html#0959c4b3bb0cee63ad2a3bdb89a92a6d" title="Provide an estimate for the average current throughout the last minute (18-bit signed)...">BATTCUR_GetAverageCurrent</a>(), <a class="code" href="battery__pack__parameters_8c.html#465d57b9c9b2b607be86de50f09ed7ba" title="Battery parameters that are calculated at startup from eeprom variables.">battParams_sram</a>.<a class="code" href="structbattParam__sramstruct.html#76fcb4f7f90d64e089eab59b5bc69b6b" title="Full charge capacity in CC accumulated.">capacityInCCAccumulated</a>); <span class="comment">//RelativeSOC();</span>
<a name="l00559"></a>00559 
<a name="l00560"></a>00560   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#d8cf2ed032f53ecb9628c5c6fd7fd26f">SMBV_RelSOC</a>] = temp;
<a name="l00561"></a>00561   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>(temp);
<a name="l00562"></a>00562   <span class="keywordflow">return</span> 0;
<a name="l00563"></a>00563 }
<a name="l00564"></a>00564 
<a name="l00565"></a>00565 
<a name="l00566"></a><a class="code" href="smbus__removed_8c.html#e61bfa756f75dfa5d32731870330078e">00566</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#e61bfa756f75dfa5d32731870330078e">SMBR_AbsSOC</a>(<span class="keywordtype">void</span>)       <span class="comment">// 14</span>
<a name="l00567"></a>00567 {
<a name="l00568"></a>00568   <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> temp = <a class="code" href="gas__gauging_8c.html#cfbc7e47153ec1e54e6fc85ddde14d26" title="Returns state of charge.">GASG_StateOfCharge</a>(<a class="code" href="battery__current__monitoring_8c.html#0959c4b3bb0cee63ad2a3bdb89a92a6d" title="Provide an estimate for the average current throughout the last minute (18-bit signed)...">BATTCUR_GetAverageCurrent</a>(), <a class="code" href="cc__gas__gauging_8c.html#374a10fc3c29a66f6867e608a35c3499" title="Convert mAh to accumulated.">CCGASG_mAh2Acc</a>(battParams.designCapacity)); <span class="comment">//AbsoluteSOC();</span>
<a name="l00569"></a>00569   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#c74e928d44d62ae5ca371e744912c0b0">SMBV_AbsSOC</a>] = temp;
<a name="l00570"></a>00570   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>(temp);
<a name="l00571"></a>00571   <span class="keywordflow">return</span> 0;
<a name="l00572"></a>00572 }
<a name="l00573"></a>00573 
<a name="l00574"></a>00574 
<a name="l00575"></a><a class="code" href="smbus__removed_8c.html#3bacdb49fb11a4c8eea256979e529d2d">00575</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#3bacdb49fb11a4c8eea256979e529d2d">SMBR_RemCap</a>(<span class="keywordtype">void</span>)       <span class="comment">// 15</span>
<a name="l00576"></a>00576 {
<a name="l00577"></a>00577   <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> cap = <a class="code" href="cc__gas__gauging_8c.html#4a1ad76628aa8d3905b820ee0822dcf0" title="Convert accumulated to mAh.">CCGASG_Acc2mAh</a>(<a class="code" href="gas__gauging_8c.html#86386fa7dbd384f1d29de0dc72d8820c" title="Returns the remaining capacity at specified current.">GASG_RemainingCapacity</a>(<a class="code" href="battery__current__monitoring_8c.html#0959c4b3bb0cee63ad2a3bdb89a92a6d" title="Provide an estimate for the average current throughout the last minute (18-bit signed)...">BATTCUR_GetAverageCurrent</a>())); <span class="comment">//RemainingCap();</span>
<a name="l00578"></a>00578   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>(cap);
<a name="l00579"></a>00579   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#5e6c13227d3b3591e4ba58b022949276">SMBV_RemCap</a>] = cap;
<a name="l00580"></a>00580   <span class="keywordflow">return</span> 0;
<a name="l00581"></a>00581 }
<a name="l00582"></a>00582 
<a name="l00583"></a>00583 
<a name="l00584"></a><a class="code" href="smbus__removed_8c.html#dc9fdea75fc7d5f70f3fcef718216460">00584</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#dc9fdea75fc7d5f70f3fcef718216460">SMBR_FullChgCap</a>(<span class="keywordtype">void</span>)   <span class="comment">// 16</span>
<a name="l00585"></a>00585 {
<a name="l00586"></a>00586   <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> cap = battParams.fullChargeCapacity; <span class="comment">//FullChgCap();</span>
<a name="l00587"></a>00587   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>(cap);
<a name="l00588"></a>00588   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#f04207603725c6d24300048cd3f6e5c5">SMBV_FullChgCap</a>] = cap;
<a name="l00589"></a>00589   <span class="keywordflow">return</span> 0;
<a name="l00590"></a>00590 }
<a name="l00591"></a>00591 
<a name="l00592"></a>00592 
<a name="l00593"></a><a class="code" href="smbus__removed_8c.html#4e2a0116ec8e1ca7cb1fad0b243c4eb9">00593</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#4e2a0116ec8e1ca7cb1fad0b243c4eb9">SMBR_RunTTE</a>(<span class="keywordtype">void</span>)       <span class="comment">// 17</span>
<a name="l00594"></a>00594 {
<a name="l00595"></a>00595     <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> tte;
<a name="l00596"></a>00596     <a class="code" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a> temp = <a class="code" href="battery__current__monitoring_8c.html#ae8592ed4c14b5a00048fe1ed1c68e4a" title="Provides the current from the last CC-ADC reading (18-bit signed).">BATTCUR_GetCurrent</a>();
<a name="l00597"></a>00597     temp = <a class="code" href="battery__current__monitoring_8c.html#d971791f4fc1c6f54e1d7d46fea20786" title="Convert CCADC ticks to mA.">BATTCUR_Ticks2mA</a>(temp);
<a name="l00598"></a>00598 
<a name="l00599"></a>00599   tte = <a class="code" href="gas__gauging_8c.html#17d5adf37f8f1ab7851727ec3335f501" title="Estimate time to empty.">GASG_TimeToEmpty</a>( (<a class="code" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a>)temp ); <span class="comment">//TimeToEmpty(0);</span>
<a name="l00600"></a>00600   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>(tte);
<a name="l00601"></a>00601   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#7de46833657ff761f8d29da7c27ab2b2">SMBV_RunTTE</a>] = tte;
<a name="l00602"></a>00602   <span class="keywordflow">return</span> 0;
<a name="l00603"></a>00603 }
<a name="l00604"></a>00604 
<a name="l00605"></a>00605 
<a name="l00606"></a><a class="code" href="smbus__removed_8c.html#c47f2a93dd5ce58e73ba742a9170d7c2">00606</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#c47f2a93dd5ce58e73ba742a9170d7c2">SMBR_AvgTTE</a>(<span class="keywordtype">void</span>)       <span class="comment">// 18</span>
<a name="l00607"></a>00607 {
<a name="l00608"></a>00608     <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> tte;
<a name="l00609"></a>00609     <a class="code" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a> temp = <a class="code" href="battery__current__monitoring_8c.html#0959c4b3bb0cee63ad2a3bdb89a92a6d" title="Provide an estimate for the average current throughout the last minute (18-bit signed)...">BATTCUR_GetAverageCurrent</a>();
<a name="l00610"></a>00610     temp = <a class="code" href="battery__current__monitoring_8c.html#d971791f4fc1c6f54e1d7d46fea20786" title="Convert CCADC ticks to mA.">BATTCUR_Ticks2mA</a>(temp);
<a name="l00611"></a>00611 
<a name="l00612"></a>00612   tte = <a class="code" href="gas__gauging_8c.html#17d5adf37f8f1ab7851727ec3335f501" title="Estimate time to empty.">GASG_TimeToEmpty</a>( (<a class="code" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a>)temp ); <span class="comment">//TimeToEmpty(0);</span>
<a name="l00613"></a>00613   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>(tte);
<a name="l00614"></a>00614   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#52847ed865536b12427c03d1ae55b5a8">SMBV_AvgTTE</a>] = tte;
<a name="l00615"></a>00615   <span class="keywordflow">return</span> 0;
<a name="l00616"></a>00616 }
<a name="l00617"></a>00617 
<a name="l00618"></a>00618 
<a name="l00619"></a><a class="code" href="smbus__removed_8c.html#9f5b63743c6d95ea9bc03e9aebdce3b6">00619</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#9f5b63743c6d95ea9bc03e9aebdce3b6">SMBR_AvgTTF</a>(<span class="keywordtype">void</span>)       <span class="comment">// 19</span>
<a name="l00620"></a>00620 {
<a name="l00621"></a>00621     <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> ttf;
<a name="l00622"></a>00622     <a class="code" href="stdint_8h.html#2ba621978a511250f7250fb10e05ffbe">int32_t</a> temp = <a class="code" href="battery__current__monitoring_8c.html#0959c4b3bb0cee63ad2a3bdb89a92a6d" title="Provide an estimate for the average current throughout the last minute (18-bit signed)...">BATTCUR_GetAverageCurrent</a>();
<a name="l00623"></a>00623     temp = <a class="code" href="battery__current__monitoring_8c.html#d971791f4fc1c6f54e1d7d46fea20786" title="Convert CCADC ticks to mA.">BATTCUR_Ticks2mA</a>(temp);
<a name="l00624"></a>00624 
<a name="l00625"></a>00625   ttf = <a class="code" href="gas__gauging_8c.html#8b1dc7b992d0aaf38f84bd57ea0f1e6d" title="Estimate time to full.">GASG_TimeToFull</a>( (<a class="code" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a>)temp ); <span class="comment">//AvgTimeToFull();</span>
<a name="l00626"></a>00626   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>(ttf);
<a name="l00627"></a>00627   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#d92005db1671e6227d72313b785b9929">SMBV_AvgTTF</a>] = ttf;
<a name="l00628"></a>00628   <span class="keywordflow">return</span> 0;
<a name="l00629"></a>00629 }
<a name="l00630"></a>00630 
<a name="l00631"></a>00631 
<a name="l00632"></a>00632 
<a name="l00633"></a>00633 <span class="comment">/* ********************************************** */</span>
<a name="l00634"></a>00634 
<a name="l00635"></a>00635 <span class="comment">// These two messages are sent from either a Charger or a Host</span>
<a name="l00636"></a><a class="code" href="smbus__removed_8c.html#9c055a715960c789fc40d26bc318b5fa">00636</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#9c055a715960c789fc40d26bc318b5fa">SMBR_ChgCurrent</a>(<span class="keywordtype">void</span>)   <span class="comment">// 20</span>
<a name="l00637"></a>00637 {
<a name="l00638"></a>00638   <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] &amp;= 0xF0;  <span class="comment">//since this cmd is OK, clear Error bits per sbdat110, 4.3.2</span>
<a name="l00639"></a>00639   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>(<a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#f421a62e4da6843b5522816c4064021f">SMBV_ChgCurrent</a>]);
<a name="l00640"></a>00640   <span class="keywordflow">return</span> 0;
<a name="l00641"></a>00641 }
<a name="l00642"></a>00642 
<a name="l00643"></a>00643 
<a name="l00644"></a><a class="code" href="smbus__removed_8c.html#3cb0859c42e80708b7f6c274c3844373">00644</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#3cb0859c42e80708b7f6c274c3844373">SMBR_ChgVoltage</a>(<span class="keywordtype">void</span>)   <span class="comment">// 21</span>
<a name="l00645"></a>00645 {
<a name="l00646"></a>00646   <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] &amp;= 0xF0;  <span class="comment">//since this cmd is OK, clear Error bits per sbdat110, 4.3.2</span>
<a name="l00647"></a>00647   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>(<a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#48aafe16e98a89260f7878c2e9e07fed">SMBV_ChgVoltage</a>]);
<a name="l00648"></a>00648   <span class="keywordflow">return</span> 0;
<a name="l00649"></a>00649 }
<a name="l00650"></a>00650 
<a name="l00651"></a>00651 
<a name="l00652"></a>00652 <span class="comment">/* ********************************************** */</span>
<a name="l00653"></a>00653 
<a name="l00654"></a>00654 
<a name="l00655"></a><a class="code" href="smbus__removed_8c.html#dff7bdab9e37a158a7cfd5d215497659">00655</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#dff7bdab9e37a158a7cfd5d215497659">SMBR_BattStatus</a>(<span class="keywordtype">void</span>)   <span class="comment">// 22</span>
<a name="l00656"></a>00656 {
<a name="l00657"></a>00657   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>(<a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>]);
<a name="l00658"></a>00658   <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[SMBV_BattStatus][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] &amp;= 0xF0;
<a name="l00659"></a>00659   <span class="keywordflow">return</span> 0;
<a name="l00660"></a>00660 }
<a name="l00661"></a>00661 
<a name="l00662"></a>00662 
<a name="l00663"></a><a class="code" href="smbus__removed_8c.html#4ab0fa5f5cb0e6b53eed1526a2d41616">00663</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#4ab0fa5f5cb0e6b53eed1526a2d41616">SMBR_CycleCount</a>(<span class="keywordtype">void</span>)   <span class="comment">// 23</span>
<a name="l00664"></a>00664 {
<a name="l00665"></a>00665   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>(<a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#ae329b136e7f2bd16ab17360e0522908">SMBV_CycleCount</a>]);
<a name="l00666"></a>00666   <span class="keywordflow">return</span> 0;
<a name="l00667"></a>00667 }
<a name="l00668"></a>00668 
<a name="l00669"></a>00669 
<a name="l00670"></a><a class="code" href="smbus__removed_8c.html#3bff21970408664963b34b516bbd8a24">00670</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#3bff21970408664963b34b516bbd8a24">SMBR_DesignCap</a>(<span class="keywordtype">void</span>)    <span class="comment">// 24</span>
<a name="l00671"></a>00671 {
<a name="l00672"></a>00672   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> temp;
<a name="l00673"></a>00673 
<a name="l00674"></a>00674   <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#9b9498cc5b1927e9d63da15b33c851a4">SMBV_BattMode</a>][<a class="code" href="SMBSlave_8h.html#c1d4ce681b76fba522c9e4b1c9b08e43">hibyte</a>] &amp; <a class="code" href="SMBSlave_8h.html#7444c17c928cb175b15b8ed2309a02eb">CAPACITY_MODE</a>)   <span class="comment">//use mW in calculations</span>
<a name="l00675"></a>00675     temp = <a class="code" href="pack_8h.html#7e31a2cb3f560c7715bad89cacc02a9c">PACK_DESIGNCAPMW</a>;
<a name="l00676"></a>00676   <span class="keywordflow">else</span>
<a name="l00677"></a>00677     temp = <a class="code" href="pack_8h.html#f9cbb9622d91ce191d119b1e402ef32b">PACK_DESIGNCAPC5</a>;
<a name="l00678"></a>00678 
<a name="l00679"></a>00679   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>(temp);
<a name="l00680"></a>00680   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#7b24d5ef5be18a7b866cafe8ac5a6e7d">SMBV_DesignCap</a>] = (<a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a>)temp;
<a name="l00681"></a>00681   <span class="keywordflow">return</span> 0;
<a name="l00682"></a>00682 }
<a name="l00683"></a>00683 
<a name="l00684"></a>00684 
<a name="l00685"></a><a class="code" href="smbus__removed_8c.html#a50d3413c8abfaa9bc2591074d6c3181">00685</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#a50d3413c8abfaa9bc2591074d6c3181">SMBR_DesignVolt</a>(<span class="keywordtype">void</span>)   <span class="comment">// 25</span>
<a name="l00686"></a>00686 {
<a name="l00687"></a>00687   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>(<a class="code" href="pack_8h.html#b700b50dd791836e9152b2ded282b10d">PACK_NOMINALV</a>);
<a name="l00688"></a>00688   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#738ed1c310c6e23dbc5329bf02253e70">SMBV_DesignVolt</a>] = <a class="code" href="pack_8h.html#b700b50dd791836e9152b2ded282b10d">PACK_NOMINALV</a>;
<a name="l00689"></a>00689   <span class="keywordflow">return</span> 0;
<a name="l00690"></a>00690 }
<a name="l00691"></a>00691 
<a name="l00692"></a>00692 
<a name="l00693"></a><a class="code" href="smbus__removed_8c.html#cb6503ce89c067f6640615d3036556d1">00693</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#cb6503ce89c067f6640615d3036556d1">SMBR_SpecInfo</a>(<span class="keywordtype">void</span>) <span class="comment">// 26</span>
<a name="l00694"></a>00694 {
<a name="l00695"></a>00695   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>(<a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#7aef5fa6a6d5e9727030296fc7eeded0">SMBV_SpecInfo</a>]);   
<a name="l00696"></a>00696   <span class="keywordflow">return</span> 0;
<a name="l00697"></a>00697 }
<a name="l00698"></a>00698 
<a name="l00699"></a>00699 
<a name="l00700"></a><a class="code" href="smbus__removed_8c.html#315fcfc9e24fa20144ea2ae757a1671c">00700</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#315fcfc9e24fa20144ea2ae757a1671c">SMBR_MfrDate</a>(<span class="keywordtype">void</span>)  <span class="comment">// 27</span>
<a name="l00701"></a>00701 {
<a name="l00702"></a>00702   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>(<a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#99caa9a2c6e36dd27ef66be5c6bfc37a">SMBV_MfrDate</a>]);    
<a name="l00703"></a>00703   <span class="keywordflow">return</span> 0;
<a name="l00704"></a>00704 }
<a name="l00705"></a>00705 
<a name="l00706"></a>00706 
<a name="l00707"></a><a class="code" href="smbus__removed_8c.html#b004fe0733fbb6b5b486b8b1e34d6f24">00707</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#b004fe0733fbb6b5b486b8b1e34d6f24">SMBR_SerialNo</a>(<span class="keywordtype">void</span>) <span class="comment">// 28</span>
<a name="l00708"></a>00708 {
<a name="l00709"></a>00709   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>(<a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#a940b29b924defd01c2954f723a25a3c">SMBV_SerialNo</a>]);   
<a name="l00710"></a>00710   <span class="keywordflow">return</span> 0;
<a name="l00711"></a>00711 
<a name="l00712"></a>00712 }
<a name="l00713"></a>00713 
<a name="l00714"></a>00714 
<a name="l00715"></a><a class="code" href="smbus__removed_8c.html#0b2c434f53fb8094efe87d2845a51ff7">00715</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#0b2c434f53fb8094efe87d2845a51ff7">SMBR_MfrName</a>(<span class="keywordtype">void</span>)  <span class="comment">// 32</span>
<a name="l00716"></a>00716 {
<a name="l00717"></a>00717   <a class="code" href="smbus__removed_8c.html#c936e39317ee9bdcc5399b33044eca8c">FillResponseStr</a>(str_MfrName);         
<a name="l00718"></a>00718   <span class="keywordflow">return</span> 0;
<a name="l00719"></a>00719 }
<a name="l00720"></a>00720 
<a name="l00721"></a>00721 
<a name="l00722"></a>00722 
<a name="l00723"></a><a class="code" href="smbus__removed_8c.html#9558acedaf73be967861f1c4ebd6cbde">00723</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#9558acedaf73be967861f1c4ebd6cbde">SMBR_DeviceName</a>(<span class="keywordtype">void</span>)   <span class="comment">// 33</span>
<a name="l00724"></a>00724 {
<a name="l00725"></a>00725   <a class="code" href="smbus__removed_8c.html#c936e39317ee9bdcc5399b33044eca8c">FillResponseStr</a>(str_DeviceName);      
<a name="l00726"></a>00726   <span class="keywordflow">return</span> 0;
<a name="l00727"></a>00727 }
<a name="l00728"></a>00728 
<a name="l00729"></a>00729 
<a name="l00730"></a><a class="code" href="smbus__removed_8c.html#ac08ad9e6af081f22024f31b3d476605">00730</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#ac08ad9e6af081f22024f31b3d476605">SMBR_DeviceChem</a>(<span class="keywordtype">void</span>)   <span class="comment">// 34</span>
<a name="l00731"></a>00731 {
<a name="l00732"></a>00732   <a class="code" href="smbus__removed_8c.html#c936e39317ee9bdcc5399b33044eca8c">FillResponseStr</a>(str_DeviceChem);      
<a name="l00733"></a>00733   <span class="keywordflow">return</span> 0;
<a name="l00734"></a>00734 }
<a name="l00735"></a>00735 
<a name="l00736"></a>00736 
<a name="l00737"></a><a class="code" href="smbus__removed_8c.html#47ab34c76cfc04df7d4b0422f1f6cec6">00737</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#47ab34c76cfc04df7d4b0422f1f6cec6">SMBR_MfrData</a>(<span class="keywordtype">void</span>)  <span class="comment">// 35</span>
<a name="l00738"></a>00738 {
<a name="l00739"></a>00739   <a class="code" href="smbus__removed_8c.html#c936e39317ee9bdcc5399b33044eca8c">FillResponseStr</a>(str_MfrData);         
<a name="l00740"></a>00740   <span class="keywordflow">return</span> 0;
<a name="l00741"></a>00741 }
<a name="l00742"></a>00742 
<a name="l00743"></a>00743 
<a name="l00744"></a><a class="code" href="smbus__removed_8c.html#e96206dea7c78f41add68ead7d2d3d8d">00744</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#e96206dea7c78f41add68ead7d2d3d8d">SMBR_Opt5</a>(<span class="keywordtype">void</span>)     <span class="comment">// 0x2F</span>
<a name="l00745"></a>00745 {
<a name="l00746"></a>00746   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>(12345);           
<a name="l00747"></a>00747   <span class="keywordflow">return</span> 0;
<a name="l00748"></a>00748 <span class="comment">//  return SMBerr_ReservedCommand;</span>
<a name="l00749"></a>00749 }
<a name="l00750"></a>00750 
<a name="l00751"></a>00751 
<a name="l00752"></a><a class="code" href="smbus__removed_8c.html#4e2302e9c16f81b87317180d8e8f7167">00752</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#4e2302e9c16f81b87317180d8e8f7167">SMBR_Opt4</a>(<span class="keywordtype">void</span>)     <span class="comment">// 0x3C</span>
<a name="l00753"></a>00753 {
<a name="l00754"></a>00754   <a class="code" href="smbus__removed_8c.html#7e26bdd453b4e280347491f250b54b5b">FillResponseInt</a>( 54321 ); 
<a name="l00755"></a>00755   <span class="keywordflow">return</span> 0; <span class="comment">// Return "OK, there are data to transmitted".</span>
<a name="l00756"></a>00756 
<a name="l00757"></a>00757 }
<a name="l00758"></a>00758 
<a name="l00759"></a>00759 
<a name="l00760"></a><a class="code" href="smbus__removed_8c.html#d57cb4d0303b4e904a1bbfa77ab0e2b1">00760</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#d57cb4d0303b4e904a1bbfa77ab0e2b1">SMBR_Opt3</a>(<span class="keywordtype">void</span>)     <span class="comment">// 0x3D</span>
<a name="l00761"></a>00761 {
<a name="l00762"></a>00762 
<a name="l00763"></a>00763   <span class="keywordflow">return</span> <a class="code" href="SMBSlave_8h.html#eff375ce53077f7dd18dfefab147434c">SMBerr_ReservedCommand</a>;    <span class="comment">//unused</span>
<a name="l00764"></a>00764 }
<a name="l00765"></a>00765 
<a name="l00766"></a>00766 
<a name="l00767"></a><a class="code" href="smbus__removed_8c.html#7322ba9e7349c3afb8c3bf00c4df1e69">00767</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#7322ba9e7349c3afb8c3bf00c4df1e69">SMBR_Opt2</a>(<span class="keywordtype">void</span>)     <span class="comment">// 0x3E</span>
<a name="l00768"></a>00768 {
<a name="l00769"></a>00769 
<a name="l00770"></a>00770   <span class="keywordflow">return</span> <a class="code" href="SMBSlave_8h.html#eff375ce53077f7dd18dfefab147434c">SMBerr_ReservedCommand</a>;    <span class="comment">//unused</span>
<a name="l00771"></a>00771 }
<a name="l00772"></a>00772 
<a name="l00773"></a>00773 
<a name="l00774"></a><a class="code" href="smbus__removed_8c.html#8c6267c91fd084048c92dfc45539c54b">00774</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#8c6267c91fd084048c92dfc45539c54b">SMBR_Opt1</a>(<span class="keywordtype">void</span>)     <span class="comment">// 0x3F</span>
<a name="l00775"></a>00775 {
<a name="l00776"></a>00776 
<a name="l00777"></a>00777   <span class="keywordflow">return</span> <a class="code" href="SMBSlave_8h.html#eff375ce53077f7dd18dfefab147434c">SMBerr_ReservedCommand</a>;    <span class="comment">//unused</span>
<a name="l00778"></a>00778 }
<a name="l00779"></a>00779 
<a name="l00780"></a>00780 
<a name="l00781"></a><a class="code" href="smbus__removed_8c.html#fd65bae83d3e7dac9aac17a09195e378">00781</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#fd65bae83d3e7dac9aac17a09195e378">SMBR_invalid</a>(<span class="keywordtype">void</span>)  <span class="comment">//This should never execute, if error is caught early!</span>
<a name="l00782"></a>00782 {
<a name="l00783"></a>00783   <span class="keywordflow">return</span> <a class="code" href="SMBSlave_8h.html#a5a26e8cc169c82b3f951c20be0a103b">SMBerr_UnsuptdCommand</a>;
<a name="l00784"></a>00784 }
<a name="l00785"></a>00785 
<a name="l00786"></a>00786 
<a name="l00787"></a>00787 
<a name="l00788"></a>00788 <span class="comment">//typedef uint8_t (*ptr2funcUC_V)(void);</span>
<a name="l00789"></a>00789 
<a name="l00790"></a>00790 <span class="comment">//Table of pointers to functions, indexed from the received SMBus Command byte.</span>
<a name="l00791"></a><a class="code" href="smbus__removed_8c.html#a2df3e1c35180cf0af73f7723167d696">00791</a> ptr2funcUC_V <a class="code" href="smbus__removed_8c.html#a2df3e1c35180cf0af73f7723167d696">SMB_ReadCmd</a>[<a class="code" href="SMBSlave_8h.html#335910998ef911de0e71a0c1b059e565">HIGHEST_SMB_CMD</a>+1] =
<a name="l00792"></a>00792 {
<a name="l00793"></a>00793   <a class="code" href="smbus__removed_8c.html#73f1bf63ecd0d2aa6ecb0eb025a71103">SMBR_MfrAccess</a>,   <span class="comment">//  0</span>
<a name="l00794"></a>00794   <a class="code" href="smbus__removed_8c.html#630c35b597267b58a33795af2a00a435">SMBR_RemCapAlm</a>,   <span class="comment">//  1</span>
<a name="l00795"></a>00795   <a class="code" href="smbus__removed_8c.html#1aa734a8f6571c02ddb597130427ba88">SMBR_RemTimeAlm</a>,  <span class="comment">//  2</span>
<a name="l00796"></a>00796   <a class="code" href="smbus__removed_8c.html#1f2f22bf92cf394faa0198591787ea62">SMBR_BattMode</a>,    <span class="comment">//  3</span>
<a name="l00797"></a>00797   <a class="code" href="smbus__removed_8c.html#8c05e95201f2092c6c991e68eca82c6f">SMBR_AtRate</a>,      <span class="comment">//  4</span>
<a name="l00798"></a>00798   <a class="code" href="smbus__removed_8c.html#e9447066726b5b36e1d9fbae1ca73b8a">SMBR_AtRateTTF</a>,   <span class="comment">//  5</span>
<a name="l00799"></a>00799   <a class="code" href="smbus__removed_8c.html#6ecefc796f140b5bf7b2aca3a9b6c5b3">SMBR_AtRateTTE</a>,   <span class="comment">//  6</span>
<a name="l00800"></a>00800   <a class="code" href="smbus__removed_8c.html#5127ca8d082572ee984b9e4a79f08835">SMBR_AtRateOK</a>,    <span class="comment">//  7</span>
<a name="l00801"></a>00801   <a class="code" href="smbus__removed_8c.html#ec0372d888714d689077f22dee32abb8">SMBR_Temperature</a>, <span class="comment">//  8</span>
<a name="l00802"></a>00802   <a class="code" href="smbus__removed_8c.html#3b9bb1917845dd73407232d9e1497a8c">SMBR_Voltage</a>,     <span class="comment">//  9</span>
<a name="l00803"></a>00803   <a class="code" href="smbus__removed_8c.html#d28821ff7a1264aefef8df9c87568b60">SMBR_Current</a>,     <span class="comment">// 10</span>
<a name="l00804"></a>00804   <a class="code" href="smbus__removed_8c.html#abc8a4c43a9bcc24754c0b002ba82d58">SMBR_AvgCurrent</a>,  <span class="comment">// 11</span>
<a name="l00805"></a>00805   <a class="code" href="smbus__removed_8c.html#f5f2294b912cd2289e16c1c25f81e3b5">SMBR_MaxError</a>,    <span class="comment">// 12</span>
<a name="l00806"></a>00806   <a class="code" href="smbus__removed_8c.html#b2f4fa127fdea3a695a479f1f40445d7">SMBR_RelSOC</a>,      <span class="comment">// 13</span>
<a name="l00807"></a>00807   <a class="code" href="smbus__removed_8c.html#e61bfa756f75dfa5d32731870330078e">SMBR_AbsSOC</a>,      <span class="comment">// 14</span>
<a name="l00808"></a>00808   <a class="code" href="smbus__removed_8c.html#3bacdb49fb11a4c8eea256979e529d2d">SMBR_RemCap</a>,      <span class="comment">// 15</span>
<a name="l00809"></a>00809   <a class="code" href="smbus__removed_8c.html#dc9fdea75fc7d5f70f3fcef718216460">SMBR_FullChgCap</a>,  <span class="comment">// 16</span>
<a name="l00810"></a>00810   <a class="code" href="smbus__removed_8c.html#4e2a0116ec8e1ca7cb1fad0b243c4eb9">SMBR_RunTTE</a>,      <span class="comment">// 17</span>
<a name="l00811"></a>00811   <a class="code" href="smbus__removed_8c.html#c47f2a93dd5ce58e73ba742a9170d7c2">SMBR_AvgTTE</a>,      <span class="comment">// 18</span>
<a name="l00812"></a>00812   <a class="code" href="smbus__removed_8c.html#9f5b63743c6d95ea9bc03e9aebdce3b6">SMBR_AvgTTF</a>,      <span class="comment">// 19</span>
<a name="l00813"></a>00813   <a class="code" href="smbus__removed_8c.html#9c055a715960c789fc40d26bc318b5fa">SMBR_ChgCurrent</a>,  <span class="comment">// 20</span>
<a name="l00814"></a>00814   <a class="code" href="smbus__removed_8c.html#3cb0859c42e80708b7f6c274c3844373">SMBR_ChgVoltage</a>,  <span class="comment">// 21</span>
<a name="l00815"></a>00815   <a class="code" href="smbus__removed_8c.html#dff7bdab9e37a158a7cfd5d215497659">SMBR_BattStatus</a>,  <span class="comment">// 22</span>
<a name="l00816"></a>00816   <a class="code" href="smbus__removed_8c.html#4ab0fa5f5cb0e6b53eed1526a2d41616">SMBR_CycleCount</a>,  <span class="comment">// 23</span>
<a name="l00817"></a>00817   <a class="code" href="smbus__removed_8c.html#3bff21970408664963b34b516bbd8a24">SMBR_DesignCap</a>,   <span class="comment">// 24</span>
<a name="l00818"></a>00818   <a class="code" href="smbus__removed_8c.html#a50d3413c8abfaa9bc2591074d6c3181">SMBR_DesignVolt</a>,  <span class="comment">// 25</span>
<a name="l00819"></a>00819   <a class="code" href="smbus__removed_8c.html#cb6503ce89c067f6640615d3036556d1">SMBR_SpecInfo</a>,    <span class="comment">// 26</span>
<a name="l00820"></a>00820   <a class="code" href="smbus__removed_8c.html#315fcfc9e24fa20144ea2ae757a1671c">SMBR_MfrDate</a>,     <span class="comment">// 27</span>
<a name="l00821"></a>00821   <a class="code" href="smbus__removed_8c.html#b004fe0733fbb6b5b486b8b1e34d6f24">SMBR_SerialNo</a>,    <span class="comment">// 28</span>
<a name="l00822"></a>00822   <a class="code" href="smbus__removed_8c.html#fd65bae83d3e7dac9aac17a09195e378">SMBR_invalid</a>,
<a name="l00823"></a>00823   SMBR_invalid,
<a name="l00824"></a>00824   SMBR_invalid,
<a name="l00825"></a>00825   <a class="code" href="smbus__removed_8c.html#0b2c434f53fb8094efe87d2845a51ff7">SMBR_MfrName</a>,     <span class="comment">// 32</span>
<a name="l00826"></a>00826   <a class="code" href="smbus__removed_8c.html#9558acedaf73be967861f1c4ebd6cbde">SMBR_DeviceName</a>,  <span class="comment">// 33</span>
<a name="l00827"></a>00827   <a class="code" href="smbus__removed_8c.html#ac08ad9e6af081f22024f31b3d476605">SMBR_DeviceChem</a>,  <span class="comment">// 34</span>
<a name="l00828"></a>00828   <a class="code" href="smbus__removed_8c.html#47ab34c76cfc04df7d4b0422f1f6cec6">SMBR_MfrData</a>,     <span class="comment">// 35</span>
<a name="l00829"></a>00829   SMBR_invalid,
<a name="l00830"></a>00830   SMBR_invalid,
<a name="l00831"></a>00831   SMBR_invalid,
<a name="l00832"></a>00832   SMBR_invalid,
<a name="l00833"></a>00833   SMBR_invalid,
<a name="l00834"></a>00834   SMBR_invalid,
<a name="l00835"></a>00835   SMBR_invalid,
<a name="l00836"></a>00836   SMBR_invalid,
<a name="l00837"></a>00837   SMBR_invalid,
<a name="l00838"></a>00838   SMBR_invalid,
<a name="l00839"></a>00839   SMBR_invalid,
<a name="l00840"></a>00840   <a class="code" href="smbus__removed_8c.html#e96206dea7c78f41add68ead7d2d3d8d">SMBR_Opt5</a>,        <span class="comment">// 0x2F</span>
<a name="l00841"></a>00841   SMBR_invalid,
<a name="l00842"></a>00842   SMBR_invalid,
<a name="l00843"></a>00843   SMBR_invalid,
<a name="l00844"></a>00844   SMBR_invalid,
<a name="l00845"></a>00845   SMBR_invalid,
<a name="l00846"></a>00846   SMBR_invalid,
<a name="l00847"></a>00847   SMBR_invalid,
<a name="l00848"></a>00848   SMBR_invalid,
<a name="l00849"></a>00849   SMBR_invalid,
<a name="l00850"></a>00850   SMBR_invalid,
<a name="l00851"></a>00851   SMBR_invalid,
<a name="l00852"></a>00852   SMBR_invalid,
<a name="l00853"></a>00853   <a class="code" href="smbus__removed_8c.html#4e2302e9c16f81b87317180d8e8f7167">SMBR_Opt4</a>,        <span class="comment">// 0x3C</span>
<a name="l00854"></a>00854   <a class="code" href="smbus__removed_8c.html#d57cb4d0303b4e904a1bbfa77ab0e2b1">SMBR_Opt3</a>,        <span class="comment">// 0x3D</span>
<a name="l00855"></a>00855   <a class="code" href="smbus__removed_8c.html#7322ba9e7349c3afb8c3bf00c4df1e69">SMBR_Opt2</a>,        <span class="comment">// 0x3E</span>
<a name="l00856"></a>00856   <a class="code" href="smbus__removed_8c.html#8c6267c91fd084048c92dfc45539c54b">SMBR_Opt1</a>         <span class="comment">// 0x3F</span>
<a name="l00857"></a>00857 };
<a name="l00858"></a>00858 
<a name="l00859"></a>00859 
<a name="l00860"></a>00860 
<a name="l00861"></a>00861 <span class="comment">/* *************************************************************************</span>
<a name="l00862"></a>00862 <span class="comment"> *</span>
<a name="l00863"></a>00863 <span class="comment"> *   Individual handlers for SMBus WRITE-type commands</span>
<a name="l00864"></a>00864 <span class="comment"> *</span>
<a name="l00865"></a>00865 <span class="comment"> ************************************************************************* */</span>
<a name="l00866"></a>00866 
<a name="l00867"></a>00867 
<a name="l00868"></a><a class="code" href="smbus__removed_8c.html#8ef8a1c50bbbeb8d42d3b22bd84b948a">00868</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#8ef8a1c50bbbeb8d42d3b22bd84b948a">SMBW_MfrAccess</a>(<span class="keywordtype">void</span>)    <span class="comment">//  0</span>
<a name="l00869"></a>00869 {
<a name="l00870"></a>00870   <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> temp = <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[<a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>++];
<a name="l00871"></a>00871   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#509023a35671e6a6a37394e126b17278">SMBV_MfrAccess</a>] = temp | (<a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[<a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>]&lt;&lt;8);
<a name="l00872"></a>00872   <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] &amp;= 0xF0;  <span class="comment">//since this cmd is OK, clear Error bits per sbdat110, 4.3.2</span>
<a name="l00873"></a>00873   <span class="keywordflow">return</span> 0;
<a name="l00874"></a>00874 }
<a name="l00875"></a>00875 
<a name="l00876"></a>00876 
<a name="l00877"></a><a class="code" href="smbus__removed_8c.html#703ddaccaa10da204ba384d1664e7db3">00877</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#703ddaccaa10da204ba384d1664e7db3">SMBW_RemCapAlm</a>(<span class="keywordtype">void</span>)    <span class="comment">//  1</span>
<a name="l00878"></a>00878 {
<a name="l00879"></a>00879   <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> temp = <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[<a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>++];
<a name="l00880"></a>00880   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#796d810f2c76d8ec9f0837011fbf4e93">SMBV_RemCapAlm</a>] = temp | (<a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[<a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>]&lt;&lt;8);
<a name="l00881"></a>00881   <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] &amp;= 0xF0;  <span class="comment">//since this cmd is OK, clear Error bits per sbdat110, 4.3.2</span>
<a name="l00882"></a>00882   <span class="keywordflow">return</span> 0;
<a name="l00883"></a>00883 }
<a name="l00884"></a>00884 
<a name="l00885"></a>00885 
<a name="l00886"></a><a class="code" href="smbus__removed_8c.html#e61d7e845119a960c2d70f881364b5e0">00886</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#e61d7e845119a960c2d70f881364b5e0">SMBW_RemTimeAlm</a>(<span class="keywordtype">void</span>)   <span class="comment">//  2</span>
<a name="l00887"></a>00887 {
<a name="l00888"></a>00888   <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> temp = <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[<a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>++];
<a name="l00889"></a>00889   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#5291017d88766e09b4aa1df97f5d8ba6">SMBV_RemTimeAlm</a>] = temp | (<a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[<a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>]&lt;&lt;8);
<a name="l00890"></a>00890   <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] &amp;= 0xF0;  <span class="comment">//since this cmd is OK, clear Error bits per sbdat110, 4.3.2</span>
<a name="l00891"></a>00891   <span class="keywordflow">return</span> 0;
<a name="l00892"></a>00892 }
<a name="l00893"></a>00893 
<a name="l00894"></a>00894 
<a name="l00895"></a><a class="code" href="smbus__removed_8c.html#418cf3ab7bce61c8ecf02ccba3170430">00895</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#418cf3ab7bce61c8ecf02ccba3170430">SMBW_BattMode</a>(<span class="keywordtype">void</span>)     <span class="comment">//  3</span>
<a name="l00896"></a>00896 {
<a name="l00897"></a>00897   <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> tempH = <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[<a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>+1];
<a name="l00898"></a>00898   <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> tempL;
<a name="l00899"></a>00899 
<a name="l00900"></a>00900   tempL = <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#9b9498cc5b1927e9d63da15b33c851a4">SMBV_BattMode</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] &amp; 0xF0;
<a name="l00901"></a>00901 
<a name="l00902"></a>00902   <span class="keywordflow">if</span>(tempH &amp; 0x1C)
<a name="l00903"></a>00903     <span class="keywordflow">return</span> <a class="code" href="SMBSlave_8h.html#57b202debe9843681ec52b63736308ed">SMBerr_AccessDenied</a>;     <span class="comment">//attempt to write to reserved bits!</span>
<a name="l00904"></a>00904 
<a name="l00905"></a>00905 
<a name="l00906"></a>00906   <span class="keywordflow">if</span>(~(tempL &amp; <a class="code" href="SMBSlave_8h.html#9ba63c2eaecaff528ce83676ba471531">INTERNAL_CHARGE_CONTROLLER</a>))
<a name="l00907"></a>00907   {
<a name="l00908"></a>00908     tempH &amp;= ~<a class="code" href="SMBSlave_8h.html#23694b700930ed489b17613a8f676159">CHARGE_CONTROLLER_ENABLED</a>;  <span class="comment">//feature not present, don't let it get turned on.</span>
<a name="l00909"></a>00909   }
<a name="l00910"></a>00910 
<a name="l00911"></a>00911 
<a name="l00912"></a>00912   <span class="keywordflow">if</span>(tempH &amp; <a class="code" href="SMBSlave_8h.html#cac306b454035be7e801ee93b47a231d">PRIMARY_BATTERY</a>)
<a name="l00913"></a>00913   {
<a name="l00914"></a>00914     ;   <span class="comment">//let the Host do what it wants with this flag; we ignore it.</span>
<a name="l00915"></a>00915   }
<a name="l00916"></a>00916 
<a name="l00917"></a>00917   <span class="keywordflow">if</span>(tempH &amp; <a class="code" href="SMBSlave_8h.html#602030e200233883f4b28ebe58541d26">ALARM_MODE</a>)
<a name="l00918"></a>00918     ; <span class="comment">//SetAlarmMode;   //this DISABLES sending alarm msgs for 60 secs</span>
<a name="l00919"></a>00919 
<a name="l00920"></a>00920 
<a name="l00921"></a>00921   <span class="keywordflow">if</span>(tempH &amp; <a class="code" href="SMBSlave_8h.html#2b44702cb7af617daee36d17cb0f13c9">CHARGER_MODE</a>)
<a name="l00922"></a>00922   {
<a name="l00923"></a>00923     ;   <span class="comment">//Allow Host to enable us to send Master-mode Charger-Voltage/Current msgs to the Charger</span>
<a name="l00924"></a>00924   }
<a name="l00925"></a>00925 
<a name="l00926"></a>00926 
<a name="l00927"></a>00927   <span class="keywordflow">if</span>(tempH &amp; <a class="code" href="SMBSlave_8h.html#7444c17c928cb175b15b8ed2309a02eb">CAPACITY_MODE</a>)
<a name="l00928"></a>00928   {
<a name="l00929"></a>00929     ;   <span class="comment">//Host must be allowed to control this bit (report in mAH or 10mWH)</span>
<a name="l00930"></a>00930   }
<a name="l00931"></a>00931 
<a name="l00932"></a>00932 
<a name="l00933"></a>00933   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#9b9498cc5b1927e9d63da15b33c851a4">SMBV_BattMode</a>] = tempL | (tempH&lt;&lt;8);   <span class="comment">//write the modified bits.</span>
<a name="l00934"></a>00934 
<a name="l00935"></a>00935   <span class="keywordflow">return</span> 0;
<a name="l00936"></a>00936 }
<a name="l00937"></a>00937 
<a name="l00938"></a>00938 
<a name="l00939"></a>00939 
<a name="l00940"></a><a class="code" href="smbus__removed_8c.html#30d6b7a1e0cdd4793f8a3874b70b76aa">00940</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#30d6b7a1e0cdd4793f8a3874b70b76aa">SMBW_AtRate</a>(<span class="keywordtype">void</span>)       <span class="comment">//  4</span>
<a name="l00941"></a>00941 {
<a name="l00942"></a>00942   <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> temp = <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[<a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>++];
<a name="l00943"></a>00943   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#a1524e950b31cc765e9520a57e6fa3df">SMBV_AtRate</a>] = temp | (<a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[<a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>++]&lt;&lt;8);
<a name="l00944"></a>00944   <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] &amp;= 0xF0;  <span class="comment">//since this cmd is OK, clear Error bits per sbdat110, 4.3.2</span>
<a name="l00945"></a>00945   <span class="keywordflow">return</span> 0;
<a name="l00946"></a>00946 }
<a name="l00947"></a>00947 
<a name="l00948"></a><a class="code" href="smbus__removed_8c.html#11269ddd9bfcda831499469b903b5169">00948</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#11269ddd9bfcda831499469b903b5169">SMBW_Opt5</a>(<span class="keywordtype">void</span>)         <span class="comment">// 0x2F</span>
<a name="l00949"></a>00949 {
<a name="l00950"></a>00950   __disable_interrupt();
<a name="l00951"></a>00951   MCUSR = 0x1F;                         <span class="comment">//clear all reset sources before jumping to bootloader code.</span>
<a name="l00952"></a>00952 <span class="comment">//  __watchdog_reset;                   //</span>
<a name="l00953"></a>00953 
<a name="l00954"></a>00954   <span class="keyword">asm</span>(<span class="stringliteral">"jmp 0x9000"</span>);                    <span class="comment">// Byte adress</span>
<a name="l00955"></a>00955 
<a name="l00956"></a>00956 <span class="comment">//  __watchdog_reset;                       // reset watchdog</span>
<a name="l00957"></a>00957   <span class="keywordflow">return</span>(1);                            <span class="comment">// to avoid compiler warning, should never be reached</span>
<a name="l00958"></a>00958 
<a name="l00959"></a>00959 <span class="comment">//  return SMBerr_ReservedCommand; // &lt;-- Compiler generates warning if return statement is missing.</span>
<a name="l00960"></a>00960 }
<a name="l00961"></a>00961 
<a name="l00962"></a><a class="code" href="smbus__removed_8c.html#02625450dc414e5a2db22c8fa2682428">00962</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#02625450dc414e5a2db22c8fa2682428">SMBW_Opt4</a>(<span class="keywordtype">void</span>)         <span class="comment">// 0x3C</span>
<a name="l00963"></a>00963 {
<a name="l00964"></a>00964 <span class="comment">/*  calibration_state_req = TW_RxBuf[TW_RxBufIndex++];</span>
<a name="l00965"></a>00965 <span class="comment">  calibration_state_req |= (uint16_t)TW_RxBuf[TW_RxBufIndex++] &lt;&lt; 8; // Store request details.</span>
<a name="l00966"></a>00966 <span class="comment">  SetCalibRequest; // Set action flag so that main loop starts calibrating.</span>
<a name="l00967"></a>00967 <span class="comment">  return 0; // Return OK.</span>
<a name="l00968"></a>00968 <span class="comment">    */</span>
<a name="l00969"></a>00969       <span class="keywordflow">return</span> <a class="code" href="SMBSlave_8h.html#eff375ce53077f7dd18dfefab147434c">SMBerr_ReservedCommand</a>;
<a name="l00970"></a>00970 
<a name="l00971"></a>00971 }
<a name="l00972"></a>00972 
<a name="l00973"></a><a class="code" href="smbus__removed_8c.html#56a58a6a47b690a4d6765b1576698e1d">00973</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#56a58a6a47b690a4d6765b1576698e1d">SMBW_Opt3</a>(<span class="keywordtype">void</span>)         <span class="comment">// 0x3D</span>
<a name="l00974"></a>00974 {
<a name="l00975"></a>00975   <span class="keywordflow">return</span> <a class="code" href="SMBSlave_8h.html#eff375ce53077f7dd18dfefab147434c">SMBerr_ReservedCommand</a>;
<a name="l00976"></a>00976 }
<a name="l00977"></a>00977 
<a name="l00978"></a><a class="code" href="smbus__removed_8c.html#5bb86f0a9f0d0b482a68e9c3de2c72a6">00978</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#5bb86f0a9f0d0b482a68e9c3de2c72a6">SMBW_Opt2</a>(<span class="keywordtype">void</span>)         <span class="comment">// 0x3E</span>
<a name="l00979"></a>00979 {
<a name="l00980"></a>00980   <span class="keywordflow">return</span> <a class="code" href="SMBSlave_8h.html#eff375ce53077f7dd18dfefab147434c">SMBerr_ReservedCommand</a>;
<a name="l00981"></a>00981 }
<a name="l00982"></a>00982 
<a name="l00983"></a><a class="code" href="smbus__removed_8c.html#6fb759eb4c572c010a8e5f8f14486c27">00983</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#6fb759eb4c572c010a8e5f8f14486c27">SMBW_Opt1</a>(<span class="keywordtype">void</span>)         <span class="comment">// 0x3F</span>
<a name="l00984"></a>00984 {
<a name="l00985"></a>00985   <span class="keywordflow">return</span> <a class="code" href="SMBSlave_8h.html#eff375ce53077f7dd18dfefab147434c">SMBerr_ReservedCommand</a>;
<a name="l00986"></a>00986 }
<a name="l00987"></a>00987 
<a name="l00988"></a><a class="code" href="smbus__removed_8c.html#5b91560acfba7497ef26d15742fa670f">00988</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#5b91560acfba7497ef26d15742fa670f">SMBW_Invalid</a>(<span class="keywordtype">void</span>)  <span class="comment">//This should never execute, if error is caught early!</span>
<a name="l00989"></a>00989 {
<a name="l00990"></a>00990   <span class="keywordflow">return</span> <a class="code" href="SMBSlave_8h.html#57b202debe9843681ec52b63736308ed">SMBerr_AccessDenied</a>;
<a name="l00991"></a>00991 }
<a name="l00992"></a>00992 
<a name="l00993"></a>00993 
<a name="l00994"></a>00994 
<a name="l00995"></a>00995 <span class="comment">//Table of pointers to functions, indexed from the received SMBus Command byte.</span>
<a name="l00996"></a><a class="code" href="smbus__removed_8c.html#4ddb0ec9b1efd2d94604321291ddab72">00996</a> ptr2funcUC_V <a class="code" href="smbus__removed_8c.html#4ddb0ec9b1efd2d94604321291ddab72">SMB_WriteCmd</a>[<a class="code" href="SMBSlave_8h.html#335910998ef911de0e71a0c1b059e565">HIGHEST_SMB_CMD</a>+1] =
<a name="l00997"></a>00997 {
<a name="l00998"></a>00998   <a class="code" href="smbus__removed_8c.html#8ef8a1c50bbbeb8d42d3b22bd84b948a">SMBW_MfrAccess</a>,   <span class="comment">//  0</span>
<a name="l00999"></a>00999   <a class="code" href="smbus__removed_8c.html#703ddaccaa10da204ba384d1664e7db3">SMBW_RemCapAlm</a>,   <span class="comment">//  1</span>
<a name="l01000"></a>01000   <a class="code" href="smbus__removed_8c.html#e61d7e845119a960c2d70f881364b5e0">SMBW_RemTimeAlm</a>,  <span class="comment">//  2</span>
<a name="l01001"></a>01001   <a class="code" href="smbus__removed_8c.html#418cf3ab7bce61c8ecf02ccba3170430">SMBW_BattMode</a>,    <span class="comment">//  3</span>
<a name="l01002"></a>01002   <a class="code" href="smbus__removed_8c.html#30d6b7a1e0cdd4793f8a3874b70b76aa">SMBW_AtRate</a>,      <span class="comment">//  4</span>
<a name="l01003"></a>01003   <a class="code" href="smbus__removed_8c.html#5b91560acfba7497ef26d15742fa670f">SMBW_Invalid</a>,
<a name="l01004"></a>01004   SMBW_Invalid,
<a name="l01005"></a>01005   SMBW_Invalid,
<a name="l01006"></a>01006   SMBW_Invalid,
<a name="l01007"></a>01007   SMBW_Invalid,
<a name="l01008"></a>01008   SMBW_Invalid,
<a name="l01009"></a>01009   SMBW_Invalid,
<a name="l01010"></a>01010   SMBW_Invalid,
<a name="l01011"></a>01011   SMBW_Invalid,
<a name="l01012"></a>01012   SMBW_Invalid,
<a name="l01013"></a>01013   SMBW_Invalid,     <span class="comment">//0x0F</span>
<a name="l01014"></a>01014 
<a name="l01015"></a>01015   SMBW_Invalid,
<a name="l01016"></a>01016   SMBW_Invalid,
<a name="l01017"></a>01017   SMBW_Invalid,
<a name="l01018"></a>01018   SMBW_Invalid,
<a name="l01019"></a>01019   SMBW_Invalid,
<a name="l01020"></a>01020   SMBW_Invalid,
<a name="l01021"></a>01021   SMBW_Invalid,
<a name="l01022"></a>01022   SMBW_Invalid,
<a name="l01023"></a>01023   SMBW_Invalid,
<a name="l01024"></a>01024   SMBW_Invalid,
<a name="l01025"></a>01025   SMBW_Invalid,
<a name="l01026"></a>01026   SMBW_Invalid,
<a name="l01027"></a>01027   SMBW_Invalid,
<a name="l01028"></a>01028   SMBW_Invalid,
<a name="l01029"></a>01029   SMBW_Invalid,
<a name="l01030"></a>01030   SMBW_Invalid,     <span class="comment">//0x1F</span>
<a name="l01031"></a>01031 
<a name="l01032"></a>01032   SMBW_Invalid,
<a name="l01033"></a>01033   SMBW_Invalid,
<a name="l01034"></a>01034   SMBW_Invalid,
<a name="l01035"></a>01035   SMBW_Invalid,
<a name="l01036"></a>01036   SMBW_Invalid,
<a name="l01037"></a>01037   SMBW_Invalid,
<a name="l01038"></a>01038   SMBW_Invalid,
<a name="l01039"></a>01039   SMBW_Invalid,
<a name="l01040"></a>01040   SMBW_Invalid,
<a name="l01041"></a>01041   SMBW_Invalid,
<a name="l01042"></a>01042   SMBW_Invalid,
<a name="l01043"></a>01043   SMBW_Invalid,
<a name="l01044"></a>01044   SMBW_Invalid,
<a name="l01045"></a>01045   SMBW_Invalid,
<a name="l01046"></a>01046   SMBW_Invalid,
<a name="l01047"></a>01047   <a class="code" href="smbus__removed_8c.html#11269ddd9bfcda831499469b903b5169">SMBW_Opt5</a>,        <span class="comment">// 0x2F</span>
<a name="l01048"></a>01048 
<a name="l01049"></a>01049   SMBW_Invalid,
<a name="l01050"></a>01050   SMBW_Invalid,
<a name="l01051"></a>01051   SMBW_Invalid,
<a name="l01052"></a>01052   SMBW_Invalid,
<a name="l01053"></a>01053   SMBW_Invalid,
<a name="l01054"></a>01054   SMBW_Invalid,
<a name="l01055"></a>01055   SMBW_Invalid,
<a name="l01056"></a>01056   SMBW_Invalid,
<a name="l01057"></a>01057   SMBW_Invalid,
<a name="l01058"></a>01058   SMBW_Invalid,
<a name="l01059"></a>01059   SMBW_Invalid,
<a name="l01060"></a>01060   SMBW_Invalid,
<a name="l01061"></a>01061   <a class="code" href="smbus__removed_8c.html#02625450dc414e5a2db22c8fa2682428">SMBW_Opt4</a>,        <span class="comment">// 0x3C</span>
<a name="l01062"></a>01062   <a class="code" href="smbus__removed_8c.html#56a58a6a47b690a4d6765b1576698e1d">SMBW_Opt3</a>,        <span class="comment">// 0x3D</span>
<a name="l01063"></a>01063   <a class="code" href="smbus__removed_8c.html#5bb86f0a9f0d0b482a68e9c3de2c72a6">SMBW_Opt2</a>,        <span class="comment">// 0x3E</span>
<a name="l01064"></a>01064   <a class="code" href="smbus__removed_8c.html#6fb759eb4c572c010a8e5f8f14486c27">SMBW_Opt1</a>         <span class="comment">// 0x3F</span>
<a name="l01065"></a>01065 };
<a name="l01066"></a>01066 
<a name="l01067"></a>01067 
<a name="l01068"></a>01068 
<a name="l01069"></a>01069 
<a name="l01070"></a>01070 <span class="comment">/* *************************************************************************</span>
<a name="l01071"></a>01071 <span class="comment"> *</span>
<a name="l01072"></a>01072 <span class="comment"> *   Utilities for SMBus commmunications</span>
<a name="l01073"></a>01073 <span class="comment"> *</span>
<a name="l01074"></a>01074 <span class="comment"> ************************************************************************* */</span>
<a name="l01075"></a>01075 
<a name="l01076"></a>01076 
<a name="l01077"></a>01077 
<a name="l01078"></a><a class="code" href="smbus__removed_8c.html#76ee3d04d28fc29dbe95e631c8f8d5bf">01078</a> __flash <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#76ee3d04d28fc29dbe95e631c8f8d5bf">crctable</a>[16] =  {0,0x07,0x0E,0x90, 0x1c,0x1b,0x12,0x15, 0x38,0x3F,0x36,0x31, 0x24,0x23,0x2A,0x2D};
<a name="l01079"></a><a class="code" href="smbus__removed_8c.html#69f01fc4395bce1f96e32db7dd79d845">01079</a> __flash <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#69f01fc4395bce1f96e32db7dd79d845">crctable2</a>[16] = {0,0x70,0xE0,0x09, 0xC1,0xB1,0x21,0x51, 0x83,0xF3,0x63,0x13, 0x42,0x32,0xA2,0xD2};
<a name="l01080"></a>01080 
<a name="l01081"></a><a class="code" href="smbus__removed_8c.html#5236dde88b9f0817fabad10165faf02c">01081</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="smbus__removed_8c.html#5236dde88b9f0817fabad10165faf02c">FastCRC</a>(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> LastCRC, <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> newbyte)
<a name="l01082"></a>01082 {
<a name="l01083"></a>01083   <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> index;
<a name="l01084"></a>01084 
<a name="l01085"></a>01085   index = newbyte;
<a name="l01086"></a>01086   index ^= LastCRC;
<a name="l01087"></a>01087   index &gt;&gt;= 4;
<a name="l01088"></a>01088   LastCRC &amp;= 0x0F;
<a name="l01089"></a>01089   LastCRC ^= <a class="code" href="smbus__removed_8c.html#69f01fc4395bce1f96e32db7dd79d845">crctable2</a>[index];
<a name="l01090"></a>01090 
<a name="l01091"></a>01091   index = LastCRC;
<a name="l01092"></a>01092   index ^= newbyte;
<a name="l01093"></a>01093   index &amp;= 0x0F;
<a name="l01094"></a>01094   LastCRC &amp;= 0xF0;
<a name="l01095"></a>01095   LastCRC ^= <a class="code" href="smbus__removed_8c.html#76ee3d04d28fc29dbe95e631c8f8d5bf">crctable</a>[index];
<a name="l01096"></a>01096 
<a name="l01097"></a>01097   <span class="keywordflow">return</span>(LastCRC);
<a name="l01098"></a>01098 }
<a name="l01099"></a>01099 
<a name="l01100"></a>01100 
<a name="l01102"></a>01102 <span class="comment">// This sets power-up defaults.</span>
<a name="l01103"></a><a class="code" href="smbus__removed_8c.html#cb16f3c4a5a7687bc2803fa4882d8cee">01103</a> <span class="keywordtype">void</span> <a class="code" href="smbus__removed_8c.html#cb16f3c4a5a7687bc2803fa4882d8cee">InitSMBvariables</a>(<span class="keywordtype">void</span>)
<a name="l01104"></a>01104 {
<a name="l01105"></a>01105   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#509023a35671e6a6a37394e126b17278">SMBV_MfrAccess</a>] = 0x4060;              <span class="comment">// Mega406 ap-note, revision 0 code</span>
<a name="l01106"></a>01106   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#796d810f2c76d8ec9f0837011fbf4e93">SMBV_RemCapAlm</a>] = (<a class="code" href="pack_8h.html#354d79dad6f137ecc73a52a87062984b">PACK_DESIGNCAPTYP</a> / 10);    <span class="comment">// per sbdat110, 4.4.1</span>
<a name="l01107"></a>01107   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#5291017d88766e09b4aa1df97f5d8ba6">SMBV_RemTimeAlm</a>] = 0x000A;         <span class="comment">// per sbdat110, 4.4.1</span>
<a name="l01108"></a>01108   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#9b9498cc5b1927e9d63da15b33c851a4">SMBV_BattMode</a>  ] = 0x0000; <span class="comment">//</span>
<a name="l01109"></a>01109   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#a1524e950b31cc765e9520a57e6fa3df">SMBV_AtRate</a>    ] = 0x0000; <span class="comment">//</span>
<a name="l01110"></a>01110 
<a name="l01111"></a>01111 <span class="comment">/* For testing with no calcs</span>
<a name="l01112"></a>01112 <span class="comment">  SMBvar_int[SMBV_AtRateTTF ] = 0x0000; //</span>
<a name="l01113"></a>01113 <span class="comment">  SMBvar_int[SMBV_AtRateTTE ] = 0x0000; //</span>
<a name="l01114"></a>01114 <span class="comment">  SMBvar_int[SMBV_AtRateOK  ] = 0x0000; //</span>
<a name="l01115"></a>01115 <span class="comment"></span>
<a name="l01116"></a>01116 <span class="comment">  SMBvar_int[SMBV_Temperature] = 0x0000;    //</span>
<a name="l01117"></a>01117 <span class="comment">  SMBvar_int[SMBV_Voltage    ] = 0x0000;    //</span>
<a name="l01118"></a>01118 <span class="comment">  SMBvar_int[SMBV_Current    ] = 0x0000;    //</span>
<a name="l01119"></a>01119 <span class="comment">  SMBvar_int[SMBV_AvgCurrent ] = 0x0000;    //</span>
<a name="l01120"></a>01120 <span class="comment">  SMBvar_int[SMBV_MaxError   ] = 0x0000;    //</span>
<a name="l01121"></a>01121 <span class="comment">  SMBvar_int[SMBV_RelSOC     ] = 0x0000;    //</span>
<a name="l01122"></a>01122 <span class="comment">  SMBvar_int[SMBV_AbsSOC     ] = 0x0000;    //</span>
<a name="l01123"></a>01123 <span class="comment">  SMBvar_int[SMBV_RemCap     ] = 0x0000;    //</span>
<a name="l01124"></a>01124 <span class="comment"></span>
<a name="l01125"></a>01125 <span class="comment">  SMBvar_int[SMBV_FullChgCap] = 0x0000; //</span>
<a name="l01126"></a>01126 <span class="comment">  SMBvar_int[SMBV_RunTTE    ] = 0x0000; //</span>
<a name="l01127"></a>01127 <span class="comment">  SMBvar_int[SMBV_AvgTTE    ] = 0x0000; //</span>
<a name="l01128"></a>01128 <span class="comment">  SMBvar_int[SMBV_AvgTTF    ] = 0x0000; //</span>
<a name="l01129"></a>01129 <span class="comment">  SMBvar_int[SMBV_ChgCurrent] = 0x0000; //</span>
<a name="l01130"></a>01130 <span class="comment">  SMBvar_int[SMBV_ChgVoltage] = 0x0000; //</span>
<a name="l01131"></a>01131 <span class="comment">*/</span>
<a name="l01132"></a>01132   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>] = 0x0080; <span class="comment">//per sbdat110, 4.4.1</span>
<a name="l01133"></a>01133   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#ae329b136e7f2bd16ab17360e0522908">SMBV_CycleCount</a>] = 0x0000; <span class="comment">//per sbdat110, 4.4.1</span>
<a name="l01134"></a>01134 
<a name="l01135"></a>01135 <span class="comment">/* For testing with no calcs</span>
<a name="l01136"></a>01136 <span class="comment">  SMBvar_int[SMBV_DesignCap ] = 0x0000; //</span>
<a name="l01137"></a>01137 <span class="comment">  SMBvar_int[SMBV_DesignVolt] = 0x0000; //</span>
<a name="l01138"></a>01138 <span class="comment">*/</span>
<a name="l01139"></a>01139 
<a name="l01140"></a>01140   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#7aef5fa6a6d5e9727030296fc7eeded0">SMBV_SpecInfo</a>  ] = 0x0031; <span class="comment">// no scaling of I or V; we support PEC, and we're V1.1</span>
<a name="l01141"></a>01141   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#99caa9a2c6e36dd27ef66be5c6bfc37a">SMBV_MfrDate</a>   ] = ((2005-1980)&lt;&lt;9)+(8&lt;&lt;5)+(31);   
<a name="l01142"></a>01142   <a class="code" href="SMBSlave_8h.html#577088f1d553884a9efe4d128010f081">SMBvar_int</a>[<a class="code" href="SMBSlave_8h.html#a940b29b924defd01c2954f723a25a3c">SMBV_SerialNo</a>  ] = 12345;  <span class="comment">// arbitrary...</span>
<a name="l01143"></a>01143 
<a name="l01144"></a>01144   <span class="comment">//Note that for the Block-Read variables, we copy those into a RAM buffer only as needed.</span>
<a name="l01145"></a>01145   <span class="comment">// These are MfrName, DeviceName, DeviceChem, and MfrData.</span>
<a name="l01146"></a>01146 
<a name="l01147"></a>01147 <span class="comment">//SH  SetMaxTopAcc((long)6600*10727);   //! \todo for testing, initialized value before reaching fully charged, 6600mAh * 10727</span>
<a name="l01148"></a>01148 <span class="comment">//  RunningAcc = (long)1000*10727;    //for testing, to start at other point than 0, 1000 * 10727</span>
<a name="l01149"></a>01149 }
<a name="l01150"></a>01150 
</pre></div></div>
<html>
 <head>
  <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
  <title>@DOC_TITLE@</title>
  <link href="doxygen.css" rel="stylesheet" type="text/css">
</head>
<body>

<table width="100%" height="10%" bgcolor="#FFFFFF">
  <tr>
    <td colspan="6" height="1" background="blue.gif"></td>
  </tr>

  <tr>
    <td colspan="6">
    <address style="align: right;"><small>
Generated on Wed Aug 4 10:59:55 2010 for AVR474 Firmware User's Guide for SB202 by <a href="http://www.doxygen.org/index.html"><img src="doxygen.png" alt="doxygen" align="middle" border=0></a> 1.5.6</small></address>
    </td>
  </tr>

</table>
