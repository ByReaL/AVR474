<html xmlns:v="urn:schemas-microsoft-com:vml"
xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns="http://www.w3.org/TR/REC-html40">

<head>
<meta http-equiv=Content-Type content="text/html; charset=iso-8859-1">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 11">
<meta name=Originator content="Microsoft Word 11">
<link rel=File-List href="atmel-header_files/filelist.xml">
<link rel=Edit-Time-Data href="atmel-header_files/editdata.mso">
<!--[if !mso]>
<style>
v\:* {behavior:url(#default#VML);}
o\:* {behavior:url(#default#VML);}
w\:* {behavior:url(#default#VML);}
.shape {behavior:url(#default#VML);}
</style>
<![endif]-->
<title>@DOC_TITLE@</title>
<!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>ping.zhou</o:Author>
  <o:Template>Normal</o:Template>
  <o:LastAuthor>ping.zhou</o:LastAuthor>
  <o:Revision>3</o:Revision>
  <o:TotalTime>0</o:TotalTime>
  <o:Created>2010-08-04T02:58:00Z</o:Created>
  <o:LastSaved>2010-08-04T02:58:00Z</o:LastSaved>
  <o:Pages>1</o:Pages>
  <o:Words>51</o:Words>
  <o:Characters>297</o:Characters>
  <o:Company>Atmel</o:Company>
  <o:Lines>2</o:Lines>
  <o:Paragraphs>1</o:Paragraphs>
  <o:CharactersWithSpaces>347</o:CharactersWithSpaces>
  <o:Version>11.9999</o:Version>
 </o:DocumentProperties>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:Zoom>150</w:Zoom>
  <w:SpellingState>Clean</w:SpellingState>
  <w:GrammarState>Clean</w:GrammarState>
  <w:ValidateAgainstSchemas/>
  <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid>
  <w:IgnoreMixedContent>false</w:IgnoreMixedContent>
  <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText>
  <w:Compatibility>
   <w:UseFELayout/>
  </w:Compatibility>
  <w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel>
 </w:WordDocument>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:LatentStyles DefLockedState="false" LatentStyleCount="156">
 </w:LatentStyles>
</xml><![endif]-->
<link rel=Stylesheet type="text/css" media=all href="doxygen.css">
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Helvetica;
	panose-1:2 11 6 4 2 2 2 2 2 4;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:536902279 -2147483648 8 0 511 0;}
@font-face
	{font-family:SimSun;
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-alt:SimSun;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 135135232 16 0 262145 0;}
@font-face
	{font-family:SimSun;
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 135135232 16 0 262145 0;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:SimSun;}
p
	{font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:SimSun;}
span.SpellE
	{mso-style-name:"";
	mso-spl-e:yes;}
@page Section1
	{size:8.5in 11.0in;
	margin:1.0in 1.25in 1.0in 1.25in;
	mso-header-margin:.5in;
	mso-footer-margin:.5in;
	mso-paper-source:0;}
div.Section1
	{page:Section1;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
	{mso-style-name:"Table Normal";
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-parent:"";
	mso-padding-alt:0in 5.4pt 0in 5.4pt;
	mso-para-margin:0in;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-ansi-language:#0400;
	mso-fareast-language:#0400;
	mso-bidi-language:#0400;}
</style>
<![endif]--><!--[if gte mso 9]><xml>
 <o:shapedefaults v:ext="edit" spidmax="2050"/>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <o:shapelayout v:ext="edit">
  <o:idmap v:ext="edit" data="1"/>
 </o:shapelayout></xml><![endif]-->
</head>

<body lang=EN-US link=blue vlink=blue style='tab-interval:.5in'>

<div class=Section1>

<table class=MsoNormalTable border=0 cellpadding=0 width="100%"
 style='width:100.0%;mso-cellspacing:1.5pt;background:white'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes'>
  <td style='padding:.75pt .75pt .75pt .75pt'>
  <p><a href="http://www.atmel.com"><span style='text-decoration:none;
  text-underline:none'><img border=0 width=109 height=50 id="_x0000_i1025"
  src=atmel.jpg></span></a></p>
  <p class=MsoNormal><o:p>&nbsp;</o:p></p>
  </td>
  <td style='padding:.75pt .75pt .75pt .75pt'>
  <p class=MsoNormal><span class=SpellE><strong><span style='font-size:24.0pt;
  font-family:Helvetica;color:black'>SmartBattery</span></strong></span><strong><span
  style='font-size:24.0pt;font-family:Helvetica;color:black'> Device
  Application Note</span></strong></p>
  </td>
  <td style='padding:.75pt .75pt .75pt .75pt'>
  <p><a href="http://www.atmel.com/products/AVR"><span style='text-decoration:
  none;text-underline:none'><img border=0 width=138 height=77 id="_x0000_i1026"
  src="AVR_logo_blue.gif"></span></a></p>
  <p class=MsoNormal><o:p>&nbsp;</o:p></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:1;mso-yfti-lastrow:yes;height:.75pt'>
  <td colspan=3 style='padding:.75pt .75pt .75pt .75pt;height:.75pt'
  background=blue.gif>
  <p class=MsoNormal><span style='font-size:1.0pt;mso-bidi-font-size:12.0pt'><o:p>&nbsp;</o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

</div>

</body>

</html>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_29ae905079a6eb1b30b29288f24757bc.html">lib_mcu</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_37e9098495dcc10ac45fd55bc295899d.html">communication</a>
  </div>
</div>
<div class="contents">
<h1>communication.c</h1><a href="communication_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*This file has been prepared for Doxygen automatic documentation generation.*/</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include "<a class="code" href="common_8h.html" title="Common headerfile.">common.h</a>"</span>
<a name="l00051"></a>00051 
<a name="l00052"></a><a class="code" href="communication_8c.html#ae08ff0a047918e0245782dd183dad98">00052</a> <span class="preprocessor">#define MODULE_SMBUS        </span><span class="comment">/* ensure that we instantiate our variables in smbus.h */</span>
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="preprocessor">#include "<a class="code" href="smbus_8h.html" title="Headerfile for smbus.c.">smbus.h</a>"</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include "<a class="code" href="communication_8h.html" title="This file contains the Communication definitions.">communication.h</a>"</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include "SBS_commands.h"</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include "<a class="code" href="communication_2interpreter_8h.html" title="SMBus Protocol command interpreter.">interpreter.h</a>"</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include "<a class="code" href="crc8_8h.html" title="Simple 8bit CRC.">crc8.h</a>"</span>
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 <span class="comment">//---------------------------------------------------------------------</span>
<a name="l00063"></a><a class="code" href="communication_8c.html#bd43f4ac549de63ca6ad46bd406ea17f">00063</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="communication_8c.html#bd43f4ac549de63ca6ad46bd406ea17f">TEST50US</a> = 0;
<a name="l00064"></a><a class="code" href="communication_8c.html#8eb5d9128fac12df31c29313df01b1ac">00064</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="communication_8c.html#8eb5d9128fac12df31c29313df01b1ac">SMLOCK</a>   = 0;       <span class="comment">//prevents Master bus grab attempts WHILE BUS IS IN MASTER MODE.</span>
<a name="l00065"></a>00065 
<a name="l00066"></a><a class="code" href="communication_8c.html#c47af82e11278b79be8fb40152038444">00066</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="communication_8c.html#c47af82e11278b79be8fb40152038444">TW_MTxBuf</a>[8];       <span class="comment">//Master-mode TX buffer</span>
<a name="l00067"></a><a class="code" href="communication_8c.html#3543d0e9d6053dac3f9b711d440a3f93">00067</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="communication_8c.html#3543d0e9d6053dac3f9b711d440a3f93">TW_MTxBufCnt</a>   = 0; <span class="comment">//how many valid bytes are in the buffer</span>
<a name="l00068"></a><a class="code" href="communication_8c.html#c8ae296e1c1a72b91325c789bbdff1a0">00068</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="communication_8c.html#c8ae296e1c1a72b91325c789bbdff1a0">TW_MTxBufIndex</a> = 0;
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 <span class="comment">// Note for the buffers below, these must be able to contain:</span>
<a name="l00071"></a>00071 <span class="comment">// Slave Address, SMBus Command, Byte Count (if Block-mode), up to 32 bytes, plus PEC.</span>
<a name="l00072"></a><a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">00072</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[36];       <span class="comment">//must be long enough for any outbound strings</span>
<a name="l00073"></a><a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">00073</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a>    = 0; <span class="comment">//how many valid bytes are in the buffer</span>
<a name="l00074"></a><a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">00074</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a>  = 0;
<a name="l00075"></a>00075 
<a name="l00076"></a><a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">00076</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[10];       <span class="comment">//In Application mode (non-ISP mode), only receive WORD commands.</span>
<a name="l00077"></a><a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">00077</a> <span class="keywordtype">signed</span> <span class="keywordtype">char</span> <a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a>      = 0;
<a name="l00078"></a><a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">00078</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>  = 0;
<a name="l00079"></a>00079 
<a name="l00080"></a>00080 
<a name="l00081"></a>00081 <span class="comment">//This byte contains flags from the TWI ISR to tell the Foreground code what to do.</span>
<a name="l00082"></a>00082 <span class="comment">//If this byte is ever non-zero, the foreground code will act on its contents.</span>
<a name="l00083"></a>00083 <span class="comment">//Although it is written by both the ISR and the Foreground code, it does not</span>
<a name="l00084"></a>00084 <span class="comment">//  need to be declared VOLATILE because the SMBus is halted until the foreground</span>
<a name="l00085"></a>00085 <span class="comment">//  code finishes processing the associated command and has cleared this flag byte.</span>
<a name="l00086"></a><a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">00086</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a>;
<a name="l00087"></a><a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">00087</a> <span class="preprocessor">  #define SMB_GenBusTimeout 1   </span><span class="comment">/* Tell Foreground to generate a bus timeout, as we saw an error! */</span>
<a name="l00088"></a><a class="code" href="communication_8c.html#1fef3300524ef987fa146cc892813b20">00088</a> <span class="preprocessor">  #define SMB_SetUpReply    2   </span><span class="comment">/* Have Foreground set up TW_TxBuf[]. */</span>
<a name="l00089"></a><a class="code" href="communication_8c.html#07b00aac11ba389d5b53e2f9d54bd0bd">00089</a> <span class="preprocessor">  #define SMB_GotCmdData    4   </span><span class="comment">/* Have Foreground interpret the complete received command. */</span>
<a name="l00090"></a>00090 
<a name="l00091"></a><a class="code" href="communication_8c.html#50d57ab7cb03b10099411f378522dadd">00091</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="communication_8c.html#50d57ab7cb03b10099411f378522dadd">CurrentCmd</a> = 0xFF;
<a name="l00092"></a><a class="code" href="communication_8c.html#fd9b3e99365b45af6cf763b2dda41546">00092</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="communication_8c.html#fd9b3e99365b45af6cf763b2dda41546">UsePEC</a> = 0;   <span class="comment">//PEC usage is disabled by default.</span>
<a name="l00093"></a>00093 
<a name="l00094"></a>00094 
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 <span class="comment">/* *************************************************************************</span>
<a name="l00097"></a>00097 <span class="comment"> *</span>
<a name="l00098"></a>00098 <span class="comment"> *   SMBus Initialization routine</span>
<a name="l00099"></a>00099 <span class="comment"> *</span>
<a name="l00100"></a>00100 <span class="comment"> ************************************************************************* */</span>
<a name="l00106"></a><a class="code" href="smbus_8h.html#98a59b5ab5cde59154465aab070afa30">00106</a> <span class="keywordtype">void</span> <a class="code" href="communication_8c.html#98a59b5ab5cde59154465aab070afa30" title="Initialize TWI module.">Comm_Init</a>(<span class="keywordtype">void</span>)
<a name="l00107"></a>00107 {
<a name="l00108"></a>00108     <a class="code" href="communication_8c.html#a43740bb86658af2f20234cc35e87e1c">SMB_RestoreBus</a>();
<a name="l00109"></a>00109     TWBCSR = (1&lt;&lt;TWBCIF) | (1&lt;&lt;TWBCIE) | (1&lt;&lt;TWBDT1) | (1&lt;&lt;TWBDT0) | (0&lt;&lt;TWBCIP);
<a name="l00110"></a>00110 }
<a name="l00111"></a>00111 
<a name="l00112"></a>00112 
<a name="l00113"></a>00113 
<a name="l00114"></a>00114 
<a name="l00115"></a>00115 <span class="comment">/* *************************************************************************</span>
<a name="l00116"></a>00116 <span class="comment"> *</span>
<a name="l00117"></a>00117 <span class="comment"> *   SMBus Wakeup Interrupt</span>
<a name="l00118"></a>00118 <span class="comment"> *</span>
<a name="l00119"></a>00119 <span class="comment"> ************************************************************************* */</span>
<a name="l00120"></a>00120 
<a name="l00121"></a>00121 
<a name="l00122"></a>00122 <span class="comment">//This wakes up a battery from sleep mode into the "On" state, per sbdat110, 4.4.2</span>
<a name="l00123"></a>00123 
<a name="l00124"></a>00124 <span class="preprocessor">#pragma vector = TWI_BUS_CD_vect</span>
<a name="l00125"></a><a class="code" href="communication_8c.html#6ad83522570a9dfb8df36852769b5393">00125</a> <span class="preprocessor"></span>__interrupt <span class="keywordtype">void</span> <a class="code" href="communication_8c.html#6ad83522570a9dfb8df36852769b5393">TWICD_ISR</a>(<span class="keywordtype">void</span>)
<a name="l00126"></a>00126 {
<a name="l00127"></a>00127     <span class="comment">//clear bits per sbdat110, 4.4.2</span>
<a name="l00128"></a>00128     <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#9b9498cc5b1927e9d63da15b33c851a4">SMBV_BattMode</a>][<a class="code" href="SMBSlave_8h.html#c1d4ce681b76fba522c9e4b1c9b08e43">hibyte</a>] &amp;= ~(0xE3); 
<a name="l00129"></a>00129     
<a name="l00130"></a>00130     <span class="keywordflow">if</span>(TWBCSR &amp; (1&lt;&lt;TWBCIP))    <span class="comment">//this int was caused by bus DISCONNECT event.</span>
<a name="l00131"></a>00131     {
<a name="l00132"></a>00132         TWBCSR &amp;= ~(1&lt;&lt;TWBCIP);
<a name="l00133"></a>00133 <span class="comment">//SH        ChangePowerMode(POWERMODE_IDLE,0);</span>
<a name="l00134"></a>00134     }
<a name="l00135"></a>00135     <span class="keywordflow">else</span>    <span class="comment">//this int occurred due to a bus CONNECT event.</span>
<a name="l00136"></a>00136     {
<a name="l00137"></a>00137         TWBCSR |= (1&lt;&lt;TWBCIP);
<a name="l00138"></a>00138 <span class="comment">//SH        ChangePowerMode(POWERMODE_ACTIVE,0);</span>
<a name="l00139"></a>00139     }
<a name="l00140"></a>00140 }
<a name="l00141"></a>00141 
<a name="l00142"></a>00142 
<a name="l00143"></a>00143 
<a name="l00144"></a>00144 
<a name="l00145"></a>00145 
<a name="l00146"></a>00146 
<a name="l00153"></a><a class="code" href="smbus_8h.html#1efd4641b8a2e2b7d2daddb0b38245a6">00153</a> <span class="keywordtype">void</span> <a class="code" href="communication_8c.html#1efd4641b8a2e2b7d2daddb0b38245a6" title="Reply to a SBS read block command.">Comm_SbsBlockCommandReply</a>( <a class="code" href="unionSBS__command__union.html">SBS_command_t</a>* <a class="code" href="main_8c.html#79cdcc825d6c642cfb1115bb757a4e82">sbsReply</a> )
<a name="l00154"></a>00154 {
<a name="l00155"></a>00155 <span class="comment">/*  // Send the Data Payload and update PEC</span>
<a name="l00156"></a>00156 <span class="comment">    for( uint8_t i=0; i &lt; SBSDATA_BLOCK_LENGTH; i++)</span>
<a name="l00157"></a>00157 <span class="comment">    {</span>
<a name="l00158"></a>00158 <span class="comment">        SW_UART_Transmit( sbsReply-&gt;payload[i] );</span>
<a name="l00159"></a>00159 <span class="comment">        CRC8_Update(&amp;COMM_CalculatedPEC, sbsReply-&gt;payload[i] );</span>
<a name="l00160"></a>00160 <span class="comment">    }</span>
<a name="l00161"></a>00161 <span class="comment">    // Send the PEC</span>
<a name="l00162"></a>00162 <span class="comment">    SW_UART_Transmit( COMM_CalculatedPEC );</span>
<a name="l00163"></a>00163 <span class="comment">    */</span>
<a name="l00164"></a>00164 }
<a name="l00165"></a>00165 
<a name="l00170"></a><a class="code" href="smbus_8h.html#6f68436ccb337585587e7fa8ca888bda">00170</a> <span class="keywordtype">void</span> <a class="code" href="communication_8c.html#6f68436ccb337585587e7fa8ca888bda" title="Reply to a SBS read word command.">Comm_SbsWordCommandReply</a>( <a class="code" href="unionSBS__command__union.html">SBS_command_t</a>* <a class="code" href="main_8c.html#79cdcc825d6c642cfb1115bb757a4e82">sbsReply</a> )
<a name="l00171"></a>00171 {
<a name="l00172"></a>00172 <span class="comment">/*  // Send the Data Payload</span>
<a name="l00173"></a>00173 <span class="comment">    SW_UART_Transmit( sbsReply-&gt;payload[0] );</span>
<a name="l00174"></a>00174 <span class="comment">    SW_UART_Transmit( sbsReply-&gt;payload[1] );</span>
<a name="l00175"></a>00175 <span class="comment">    // Calculate the PEC and send it</span>
<a name="l00176"></a>00176 <span class="comment">    CRC8_Update( &amp;COMM_CalculatedPEC, sbsReply-&gt;payload[0] );</span>
<a name="l00177"></a>00177 <span class="comment">    CRC8_Update( &amp;COMM_CalculatedPEC, sbsReply-&gt;payload[1] );</span>
<a name="l00178"></a>00178 <span class="comment">    SW_UART_Transmit( COMM_CalculatedPEC );</span>
<a name="l00179"></a>00179 <span class="comment">    */</span>
<a name="l00180"></a>00180 }
<a name="l00181"></a>00181 
<a name="l00194"></a><a class="code" href="smbus_8h.html#bebcf5dbdcea576a31271721d411de4d">00194</a> <span class="keywordtype">bool</span> <a class="code" href="communication_8c.html#bebcf5dbdcea576a31271721d411de4d" title="Parse command.">Comm_Handle</a>( <a class="code" href="unionSBS__command__union.html">SBS_command_t</a>* sbsCmdDestination )
<a name="l00195"></a>00195 {
<a name="l00196"></a>00196     <span class="keywordtype">bool</span> receiveComplete = <span class="keyword">false</span>;
<a name="l00197"></a>00197     <span class="comment">/*</span>
<a name="l00198"></a>00198 <span class="comment">    // Clear the flag as early as possible to allow it to be set again and this</span>
<a name="l00199"></a>00199 <span class="comment">    // function called again</span>
<a name="l00200"></a>00200 <span class="comment">    CLEAR_FLAG(SW_UART_status, SW_UART_RX_COMPLETE );</span>
<a name="l00201"></a>00201 <span class="comment">    </span>
<a name="l00202"></a>00202 <span class="comment">    if( READ_FLAG(SW_UART_status, SW_UART_FRAME_ERROR) ) {</span>
<a name="l00203"></a>00203 <span class="comment">        // If a frame error has been received, treat it as a break and wait for </span>
<a name="l00204"></a>00204 <span class="comment">        // next command</span>
<a name="l00205"></a>00205 <span class="comment">        CLEAR_FLAG(SW_UART_status, SW_UART_FRAME_ERROR);</span>
<a name="l00206"></a>00206 <span class="comment">        CLEAR_FLAG(SW_UART_status, SW_UART_RX_BUFFER_OVERFLOW);</span>
<a name="l00207"></a>00207 <span class="comment">        COMM_State = COMM_WAITING_FOR_COMMAND;</span>
<a name="l00208"></a>00208 <span class="comment">        </span>
<a name="l00209"></a>00209 <span class="comment">    } else if( READ_FLAG(SW_UART_status, SW_UART_RX_BUFFER_OVERFLOW) ) {</span>
<a name="l00210"></a>00210 <span class="comment">        // If a buffer overflow occured, wait for a break</span>
<a name="l00211"></a>00211 <span class="comment">        CLEAR_FLAG(SW_UART_status, SW_UART_RX_BUFFER_OVERFLOW);</span>
<a name="l00212"></a>00212 <span class="comment">        COMM_State = COMM_WAITING_FOR_BREAK;</span>
<a name="l00213"></a>00213 <span class="comment">    } else {</span>
<a name="l00214"></a>00214 <span class="comment">        </span>
<a name="l00215"></a>00215 <span class="comment">        // Handle received data if any</span>
<a name="l00216"></a>00216 <span class="comment">        while( SW_UART_Data_Available() ) {</span>
<a name="l00217"></a>00217 <span class="comment">            if(receiveComplete) {</span>
<a name="l00218"></a>00218 <span class="comment">                // If receive is complete, but there is still data in the RX buffer, </span>
<a name="l00219"></a>00219 <span class="comment">                // something went wrong so reset everything and wait for a break</span>
<a name="l00220"></a>00220 <span class="comment">                CLEAR_FLAG(SW_UART_status, SW_UART_FRAME_ERROR);</span>
<a name="l00221"></a>00221 <span class="comment">                CLEAR_FLAG(SW_UART_status, SW_UART_RX_BUFFER_OVERFLOW);</span>
<a name="l00222"></a>00222 <span class="comment">                receiveComplete = false;</span>
<a name="l00223"></a>00223 <span class="comment">                SW_UART_Flush_Buffers();</span>
<a name="l00224"></a>00224 <span class="comment">                COMM_State = COMM_WAITING_FOR_BREAK;</span>
<a name="l00225"></a>00225 <span class="comment">                </span>
<a name="l00226"></a>00226 <span class="comment">            } else if( READ_FLAG(SW_UART_status, SW_UART_FRAME_ERROR) ) {</span>
<a name="l00227"></a>00227 <span class="comment">                // If a frame error has been received, treat it as a break and wait for </span>
<a name="l00228"></a>00228 <span class="comment">                // next command</span>
<a name="l00229"></a>00229 <span class="comment">                CLEAR_FLAG(SW_UART_status, SW_UART_FRAME_ERROR);</span>
<a name="l00230"></a>00230 <span class="comment">                CLEAR_FLAG(SW_UART_status, SW_UART_RX_BUFFER_OVERFLOW);</span>
<a name="l00231"></a>00231 <span class="comment">                COMM_State = COMM_WAITING_FOR_COMMAND;</span>
<a name="l00232"></a>00232 <span class="comment">                </span>
<a name="l00233"></a>00233 <span class="comment">            } else if( READ_FLAG(SW_UART_status, SW_UART_RX_BUFFER_OVERFLOW) ) {</span>
<a name="l00234"></a>00234 <span class="comment">                // If a buffer overflow occured, wait for a break</span>
<a name="l00235"></a>00235 <span class="comment">                CLEAR_FLAG(SW_UART_status, SW_UART_RX_BUFFER_OVERFLOW);</span>
<a name="l00236"></a>00236 <span class="comment">                COMM_State = COMM_WAITING_FOR_BREAK;</span>
<a name="l00237"></a>00237 <span class="comment">                </span>
<a name="l00238"></a>00238 <span class="comment">            } else {</span>
<a name="l00239"></a>00239 <span class="comment">                // Get the received data</span>
<a name="l00240"></a>00240 <span class="comment">                uint8_t data = SW_UART_Getchar();</span>
<a name="l00241"></a>00241 <span class="comment">                </span>
<a name="l00242"></a>00242 <span class="comment">                switch( COMM_State ) {</span>
<a name="l00243"></a>00243 <span class="comment">                case COMM_WAITING_FOR_BREAK:</span>
<a name="l00244"></a>00244 <span class="comment">                    {</span>
<a name="l00245"></a>00245 <span class="comment">                        // Do nothing. Break is handled outside the case switch</span>
<a name="l00246"></a>00246 <span class="comment">                        break;</span>
<a name="l00247"></a>00247 <span class="comment">                    }</span>
<a name="l00248"></a>00248 <span class="comment">                case COMM_WAITING_FOR_COMMAND:</span>
<a name="l00249"></a>00249 <span class="comment">                    {</span>
<a name="l00250"></a>00250 <span class="comment">                        // Allow to transmit data</span>
<a name="l00251"></a>00251 <span class="comment">                        CLEAR_FLAG(SW_UART_status, SW_UART_DECLINE_NEW_TX_DATA);</span>
<a name="l00252"></a>00252 <span class="comment">                        // Save command</span>
<a name="l00253"></a>00253 <span class="comment">                        sbsCmdDestination-&gt;command = (SBS_commands_t)data;</span>
<a name="l00254"></a>00254 <span class="comment">                        if( data &amp; 0x80 ) {</span>
<a name="l00255"></a>00255 <span class="comment">                            // Read command</span>
<a name="l00256"></a>00256 <span class="comment">                            receiveComplete = true;</span>
<a name="l00257"></a>00257 <span class="comment">                            COMM_State = COMM_WAITING_FOR_COMMAND;</span>
<a name="l00258"></a>00258 <span class="comment">                        } else {</span>
<a name="l00259"></a>00259 <span class="comment">                            // Write command</span>
<a name="l00260"></a>00260 <span class="comment">                            COMM_State = COMM_RECEIVING_DATA;</span>
<a name="l00261"></a>00261 <span class="comment">                            COMM_ReceivedBytes = 0;</span>
<a name="l00262"></a>00262 <span class="comment">                            </span>
<a name="l00263"></a>00263 <span class="comment">                            // Since only write commands are handled here, no need to remove</span>
<a name="l00264"></a>00264 <span class="comment">                            // the read/write bit when checking for block</span>
<a name="l00265"></a>00265 <span class="comment">                            if(   SBS_IsCommandStaticStringType((SBS_commands_t)(data))</span>
<a name="l00266"></a>00266 <span class="comment">                                 || SBS_IsCommandBlockDataType((SBS_commands_t)(data)) )</span>
<a name="l00267"></a>00267 <span class="comment">                            {</span>
<a name="l00268"></a>00268 <span class="comment">                                // Block command</span>
<a name="l00269"></a>00269 <span class="comment">                                COMM_BytesToReceive = SBSDATA_BLOCK_LENGTH ;</span>
<a name="l00270"></a>00270 <span class="comment">                            } else {</span>
<a name="l00271"></a>00271 <span class="comment">                                // Word command</span>
<a name="l00272"></a>00272 <span class="comment">                                COMM_BytesToReceive = 2;</span>
<a name="l00273"></a>00273 <span class="comment">                            }</span>
<a name="l00274"></a>00274 <span class="comment">                        }</span>
<a name="l00275"></a>00275 <span class="comment">                        //Send command back to the host and initialize the PEC</span>
<a name="l00276"></a>00276 <span class="comment">                        SW_UART_Transmit( data );</span>
<a name="l00277"></a>00277 <span class="comment">                        COMM_CalculatedPEC = 0;</span>
<a name="l00278"></a>00278 <span class="comment">                        CRC8_Update( &amp;COMM_CalculatedPEC, data);</span>
<a name="l00279"></a>00279 <span class="comment">                        break;</span>
<a name="l00280"></a>00280 <span class="comment">                    }</span>
<a name="l00281"></a>00281 <span class="comment">                    </span>
<a name="l00282"></a>00282 <span class="comment">                case COMM_RECEIVING_DATA:</span>
<a name="l00283"></a>00283 <span class="comment">                    {</span>
<a name="l00284"></a>00284 <span class="comment">                        if(COMM_ReceivedBytes == COMM_BytesToReceive) {</span>
<a name="l00285"></a>00285 <span class="comment">                            // All data bytes have been received, this is the PEC</span>
<a name="l00286"></a>00286 <span class="comment">                            if( data == COMM_CalculatedPEC ) {</span>
<a name="l00287"></a>00287 <span class="comment">                                receiveComplete = true;</span>
<a name="l00288"></a>00288 <span class="comment">                                // The function that handles receiveComplete has to send ACK</span>
<a name="l00289"></a>00289 <span class="comment">                                //  for write commands</span>
<a name="l00290"></a>00290 <span class="comment">                            } else {</span>
<a name="l00291"></a>00291 <span class="comment">                                // If the PEC was wrong, send NACK</span>
<a name="l00292"></a>00292 <span class="comment">                                SW_UART_Transmit(COMM_NACK);</span>
<a name="l00293"></a>00293 <span class="comment">                                COMM_State = COMM_WAITING_FOR_COMMAND;</span>
<a name="l00294"></a>00294 <span class="comment">                            }</span>
<a name="l00295"></a>00295 <span class="comment">                        } else {</span>
<a name="l00296"></a>00296 <span class="comment">                            // Add received byte to receive buffer and update PEC</span>
<a name="l00297"></a>00297 <span class="comment">                            sbsCmdDestination-&gt;payload[COMM_ReceivedBytes++] = data;</span>
<a name="l00298"></a>00298 <span class="comment">                            CRC8_Update(&amp;COMM_CalculatedPEC, data);</span>
<a name="l00299"></a>00299 <span class="comment">                        }</span>
<a name="l00300"></a>00300 <span class="comment">                        break;</span>
<a name="l00301"></a>00301 <span class="comment">                    }</span>
<a name="l00302"></a>00302 <span class="comment">                } // switch(COMM_state)</span>
<a name="l00303"></a>00303 <span class="comment">            }</span>
<a name="l00304"></a>00304 <span class="comment">        } // while( SW_UART_Data_Available() )</span>
<a name="l00305"></a>00305 <span class="comment">    }</span>
<a name="l00306"></a>00306 <span class="comment">    */</span>
<a name="l00307"></a>00307     <span class="keywordflow">return</span> receiveComplete;
<a name="l00308"></a>00308 }
<a name="l00309"></a>00309 
<a name="l00310"></a>00310 
<a name="l00318"></a><a class="code" href="smbus_8h.html#671390135cd0d30125661704332715a5">00318</a> <span class="keywordtype">bool</span> <a class="code" href="communication_8c.html#671390135cd0d30125661704332715a5" title="Check Communication State.">Comm_IsIdle</a>(<span class="keywordtype">void</span>)
<a name="l00319"></a>00319 {
<a name="l00320"></a>00320     <span class="keywordflow">return</span> 1;
<a name="l00321"></a>00321 }
<a name="l00322"></a>00322 
<a name="l00323"></a>00323 
<a name="l00331"></a><a class="code" href="smbus_8h.html#2bab1f3bd066faa428e782b7417bc18a">00331</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="communication_8c.html#2bab1f3bd066faa428e782b7417bc18a" title="Check Communication Status.">Comm_Flag</a>(<span class="keywordtype">void</span>)
<a name="l00332"></a>00332 {
<a name="l00333"></a>00333     <span class="keywordflow">return</span> 0;
<a name="l00334"></a>00334 }
<a name="l00335"></a>00335 
<a name="l00336"></a>00336 
<a name="l00337"></a><a class="code" href="communication_8c.html#a7bbbb66632f1e6d02a04a2fcce1a174">00337</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="communication_8c.html#a7bbbb66632f1e6d02a04a2fcce1a174">TXmsg</a>[4][4];    <span class="comment">//leave room for PEC</span>
<a name="l00338"></a><a class="code" href="communication_8c.html#dbc81bdb8619edc772bba8dbf436d27a">00338</a> <span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="communication_8c.html#dbc81bdb8619edc772bba8dbf436d27a">TXmsgHead</a> = 0;
<a name="l00339"></a><a class="code" href="communication_8c.html#dbf168926577042100974bfb5f729abb">00339</a> <span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="communication_8c.html#dbf168926577042100974bfb5f729abb">TXmsgTail</a> = 0;
<a name="l00340"></a><a class="code" href="communication_8c.html#4f16d3ad762cebfa2b2b640f7c40b086">00340</a> <span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="communication_8c.html#4f16d3ad762cebfa2b2b640f7c40b086">TXmsgQty</a> = 0;
<a name="l00341"></a>00341 
<a name="l00342"></a><a class="code" href="communication_8c.html#052be4fcee0ac81e1c63a06f4c7f6dbc">00342</a> <span class="preprocessor">#define TXmsgEmpty (TXmsgQty == 0)</span>
<a name="l00343"></a><a class="code" href="communication_8c.html#c2304377235fd9b59c79034242b5bd25">00343</a> <span class="preprocessor"></span><span class="preprocessor">#define TXmsgFull (TXmsgQty == 4)</span>
<a name="l00344"></a><a class="code" href="communication_8c.html#83b4a23934b4a918f7615cadb682e122">00344</a> <span class="preprocessor"></span><span class="preprocessor">#define TXmsgDelete {++TXmsgTail; TXmsgTail &amp;= (4-1);  TXmsgQty--;}</span>
<a name="l00345"></a>00345 <span class="preprocessor"></span>
<a name="l00346"></a>00346 <span class="comment">//We will compute the PEC for the message as well.</span>
<a name="l00347"></a><a class="code" href="communication_8c.html#34b79a751618c0940e95f347f627baec">00347</a> <span class="keywordtype">void</span> <a class="code" href="communication_8c.html#34b79a751618c0940e95f347f627baec">MasterInsertMsg</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> addr, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> cmd, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> data)
<a name="l00348"></a>00348 { <span class="comment">//Note that the Charger address is ALWAYS 0x12! (sbsm100.pdf, 5.2)</span>
<a name="l00349"></a>00349     <span class="comment">//The Host address is always 0x16.</span>
<a name="l00350"></a>00350     <span class="comment">//The addr always assumes WRITE.</span>
<a name="l00351"></a>00351     <span class="comment">//We only do a WORD WRITE.</span>
<a name="l00352"></a>00352     
<a name="l00353"></a>00353     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * ptr = <a class="code" href="communication_8c.html#a7bbbb66632f1e6d02a04a2fcce1a174">TXmsg</a>[<a class="code" href="communication_8c.html#dbc81bdb8619edc772bba8dbf436d27a">TXmsgHead</a>];
<a name="l00354"></a>00354     
<a name="l00355"></a>00355     *ptr++ = addr;
<a name="l00356"></a>00356     *ptr++ = cmd;
<a name="l00357"></a>00357     *ptr++ = (<span class="keywordtype">unsigned</span> char) data;
<a name="l00358"></a>00358     *ptr = (<span class="keywordtype">unsigned</span> char)(data&gt;&gt;8);
<a name="l00359"></a>00359     
<a name="l00360"></a>00360     <span class="keywordflow">if</span>(<a class="code" href="communication_8c.html#c2304377235fd9b59c79034242b5bd25">TXmsgFull</a>)
<a name="l00361"></a>00361         <span class="keywordflow">return</span>;
<a name="l00362"></a>00362     
<a name="l00363"></a>00363     
<a name="l00364"></a>00364     ++<a class="code" href="communication_8c.html#dbc81bdb8619edc772bba8dbf436d27a">TXmsgHead</a>;
<a name="l00365"></a>00365     <a class="code" href="communication_8c.html#dbc81bdb8619edc772bba8dbf436d27a">TXmsgHead</a> &amp;= (4-1);
<a name="l00366"></a>00366     <a class="code" href="communication_8c.html#4f16d3ad762cebfa2b2b640f7c40b086">TXmsgQty</a>++;
<a name="l00367"></a>00367 }
<a name="l00368"></a>00368 
<a name="l00369"></a>00369 
<a name="l00370"></a>00370 
<a name="l00371"></a>00371 
<a name="l00372"></a>00372 
<a name="l00373"></a>00373 <span class="comment">//TWI Interrupt Service Routine</span>
<a name="l00374"></a>00374 <span class="comment">//  This ISR contains a state machine for handling the low-level bus communications.</span>
<a name="l00375"></a>00375 <span class="comment">//  It uses the variable TWI_CmdFlags to communicate the need for message processing</span>
<a name="l00376"></a>00376 <span class="comment">//    to the foreground-based command interpreter.  Whenever it passes control off</span>
<a name="l00377"></a>00377 <span class="comment">//    to the foreground routine, the SMBus is halted.</span>
<a name="l00378"></a>00378 
<a name="l00379"></a>00379 <span class="comment">/* Changes to the operation of the SMBus State Machine as of 6/17/2005 (rgf):</span>
<a name="l00380"></a>00380 <span class="comment"></span>
<a name="l00381"></a>00381 <span class="comment">   Since there can be multiple Masters on the bus addressing a Smart Battery,</span>
<a name="l00382"></a>00382 <span class="comment">   namely either a Host or a Charger, it is entirely possible that one Master</span>
<a name="l00383"></a>00383 <span class="comment">   may support PEC while the other does not.  For maximum reliability, we must</span>
<a name="l00384"></a>00384 <span class="comment">   be able to support the reception of PEC on-the-fly regardless of whether it</span>
<a name="l00385"></a>00385 <span class="comment">   was used in the past or not.</span>
<a name="l00386"></a>00386 <span class="comment"></span>
<a name="l00387"></a>00387 <span class="comment">   To do so, we determine an expected byte count WITHOUT PEC.  While receiving,</span>
<a name="l00388"></a>00388 <span class="comment">   we decrement this counter and store received bytes until either (a) the counter</span>
<a name="l00389"></a>00389 <span class="comment">   drops below a value of (-1), or (b) we receive a STOP.  If we receive a STOP</span>
<a name="l00390"></a>00390 <span class="comment">   and the counter is not either 0 or -1, this is an error and is flagged as such.</span>
<a name="l00391"></a>00391 <span class="comment">   (Note that AFTER receiving a STOP, it is not possible to flag an error to the</span>
<a name="l00392"></a>00392 <span class="comment">   Host or Charger except through the Battery Status flags.)  If the counter is</span>
<a name="l00393"></a>00393 <span class="comment">   zero, this indicates that PEC is disabled.  If the counter is -1, this indicates</span>
<a name="l00394"></a>00394 <span class="comment">   that PEC is enabled.  The message will be processed with this knowledge.</span>
<a name="l00395"></a>00395 <span class="comment"></span>
<a name="l00396"></a>00396 <span class="comment">   However, since the SCL line is not being held low due to TWINT being left asserted,</span>
<a name="l00397"></a>00397 <span class="comment">   a different mechanism is needed to hold off incoming messages to the battery</span>
<a name="l00398"></a>00398 <span class="comment">   until the previous message has been processed.  This is done by turning off</span>
<a name="l00399"></a>00399 <span class="comment">   the generation of ACK on any subsequent bytes and/or messages until the foreground</span>
<a name="l00400"></a>00400 <span class="comment">   code has finished processing the prior message.</span>
<a name="l00401"></a>00401 <span class="comment"></span>
<a name="l00402"></a>00402 <span class="comment">   It is crucial therefore that the foreground code does not change the</span>
<a name="l00403"></a>00403 <span class="comment">   value of the TWI_CmdFlags variable from being equal to 'SMB_GotCmdData'</span>
<a name="l00404"></a>00404 <span class="comment">   until after it is completely done with processing of the prior message.</span>
<a name="l00405"></a>00405 <span class="comment"></span>
<a name="l00406"></a>00406 <span class="comment">   This mechanism also is valid if a Master attempts to perform a Master Read</span>
<a name="l00407"></a>00407 <span class="comment">   while the battery is busy.  In this case, the second byte from the Master,</span>
<a name="l00408"></a>00408 <span class="comment">   specifically the SMBus Command byte, will not be acknowledged.  The Master</span>
<a name="l00409"></a>00409 <span class="comment">   is thereby required to generate a STOP condition.</span>
<a name="l00410"></a>00410 <span class="comment"></span>
<a name="l00411"></a>00411 <span class="comment">*/</span>
<a name="l00412"></a>00412 
<a name="l00413"></a>00413 <span class="comment">//State Machine states</span>
<a name="l00414"></a><a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5ce05baed30278f132f7d9d27a502e7a0">00414</a> <span class="keyword">enum</span> <span class="comment">/*TWISR_State*/</span> {<a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>=0, <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5ce05baed30278f132f7d9d27a502e7a0">TW_Wait4Stop</a>, <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b594d13a4b6be6ef4404b13908d933e1ad">TW_Wait4Cmd</a>, <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5bc8bda251da4d6aae1c2bfb2900c1444">TW_Wait4RW</a>, <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5e4714c204fd9c4052ca3208a63493baa">TW_Wait4Data</a>, <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b583d27cae0915c8a8002877623dcb0dc9">TW_ReplyData</a>, <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5d258cb231677f6a95dcf1c9f239e2b36">TW_MSLA_W</a>, <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b52166c37a639d0f299b5195aa8672bd41">TW_MCMD_W</a>, <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b55e645a72fc9d3ddf3f193019985ffab5">TW_MDATA_W</a> };
<a name="l00415"></a>00415 
<a name="l00416"></a><a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">00416</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;    <span class="comment">//state variable</span>
<a name="l00417"></a>00417 
<a name="l00418"></a>00418 
<a name="l00419"></a>00419 <span class="preprocessor">#pragma vector = TWI_vect</span>
<a name="l00420"></a><a class="code" href="communication_8c.html#1f03d433517342e03440452013989dc4">00420</a> <span class="preprocessor"></span>__interrupt <span class="keywordtype">void</span> <a class="code" href="communication_8c.html#1f03d433517342e03440452013989dc4">TWI_ISR</a>(<span class="keywordtype">void</span>)
<a name="l00421"></a>00421 {
<a name="l00422"></a>00422     <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> TWISR_CmdFeatures = 0; <span class="comment">//Command-related feature flags</span>
<a name="l00423"></a>00423     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> Status;
<a name="l00424"></a>00424     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> tmp;
<a name="l00425"></a>00425     
<a name="l00426"></a>00426     Status = TWSR &amp; 0xF8;       <span class="comment">//This identifies what caused the interrupt to fire.</span>
<a name="l00427"></a>00427     
<a name="l00428"></a>00428     <span class="keywordflow">switch</span>(<a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a>)
<a name="l00429"></a>00429     {
<a name="l00430"></a>00430     <span class="keywordflow">default</span>:
<a name="l00431"></a>00431     <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>:   <span class="comment">//If not SLA_W or RSTOP, is an error!</span>
<a name="l00432"></a>00432         <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#13ec926035138d61a7e90193645942ee">TWS_SLA_W</a> == Status) <span class="comment">// saw Slave address match with a Write bit</span>
<a name="l00433"></a>00433         {
<a name="l00434"></a>00434             <span class="keywordflow">if</span>(<a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> == <a class="code" href="communication_8c.html#07b00aac11ba389d5b53e2f9d54bd0bd">SMB_GotCmdData</a>)
<a name="l00435"></a>00435             {
<a name="l00436"></a>00436                 <span class="comment">//Assert that we're 'busy' to SMBus Master by leaving TWEA *off* until we get a STOP.</span>
<a name="l00437"></a>00437                 <span class="comment">//Note that this is 'legal' because we have ALREADY sent an ACK to our Slave Address,</span>
<a name="l00438"></a>00438                 <span class="comment">// as is required by the SMBus specification.</span>
<a name="l00439"></a>00439                 <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5ce05baed30278f132f7d9d27a502e7a0">TW_Wait4Stop</a>;
<a name="l00440"></a>00440                 TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//must NOT re-enable ACKing!</span>
<a name="l00441"></a>00441                 <span class="keywordflow">return</span>;
<a name="l00442"></a>00442             }
<a name="l00443"></a>00443             <span class="keywordflow">else</span>
<a name="l00444"></a>00444                 <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b594d13a4b6be6ef4404b13908d933e1ad">TW_Wait4Cmd</a>;
<a name="l00445"></a>00445         }
<a name="l00446"></a>00446         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#ea29a640c276fdaea02372a2c1ac5f78">TWS_RSTOP</a> == Status)    <span class="comment">//Saw a Stop, possibly left over from previous cmd.</span>
<a name="l00447"></a>00447         {
<a name="l00448"></a>00448             ;           <span class="comment">//Everything is probably OK.  Take no action.</span>
<a name="l00449"></a>00449         }
<a name="l00450"></a>00450         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#5bee3e494d47b810f24429d69585e967">TWS_START</a> == Status)    <span class="comment">//we have successfully sent a START bit. Handle MASTER mode.</span>
<a name="l00451"></a>00451         {
<a name="l00452"></a>00452             TWDR = <a class="code" href="communication_8c.html#c47af82e11278b79be8fb40152038444">TW_MTxBuf</a>[<a class="code" href="communication_8c.html#c8ae296e1c1a72b91325c789bbdff1a0">TW_MTxBufIndex</a>++];
<a name="l00453"></a>00453             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5d258cb231677f6a95dcf1c9f239e2b36">TW_MSLA_W</a>;
<a name="l00454"></a>00454         }
<a name="l00455"></a>00455         <span class="keywordflow">else</span> <span class="comment">//had some type of error!</span>
<a name="l00456"></a>00456         {
<a name="l00457"></a>00457             <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] |= <a class="code" href="SMBSlave_8h.html#2bdc5a6b268dc4322b1f032918629a0b">SMBerr_UnknownError</a>;
<a name="l00458"></a>00458             <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;   <span class="comment">//generate a bus timeout.</span>
<a name="l00459"></a>00459             TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);       <span class="comment">//disable int, and DON'T clear the TWINT flag!</span>
<a name="l00460"></a>00460             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;          <span class="comment">//Reset the state machine.</span>
<a name="l00461"></a>00461             <span class="keywordflow">return</span>;
<a name="l00462"></a>00462         }
<a name="l00463"></a>00463         TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//must re-enable ACKing</span>
<a name="l00464"></a>00464         <span class="keywordflow">break</span>;
<a name="l00465"></a>00465         
<a name="l00466"></a>00466     <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5ce05baed30278f132f7d9d27a502e7a0">TW_Wait4Stop</a>:
<a name="l00467"></a>00467         <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#ea29a640c276fdaea02372a2c1ac5f78">TWS_RSTOP</a> == Status) <span class="comment">//Saw a Stop, possibly left over from previous cmd.</span>
<a name="l00468"></a>00468         {
<a name="l00469"></a>00469             TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//must re-enable ACKing</span>
<a name="l00470"></a>00470             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;          <span class="comment">//Reset the state machine.</span>
<a name="l00471"></a>00471         }
<a name="l00472"></a>00472         <span class="keywordflow">else</span>
<a name="l00473"></a>00473             TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//must NOT re-enable ACKing yet!</span>
<a name="l00474"></a>00474         <span class="keywordflow">break</span>;
<a name="l00475"></a>00475         
<a name="l00476"></a>00476         
<a name="l00477"></a>00477         <span class="comment">//SLAVE-mode states follow.</span>
<a name="l00478"></a>00478         
<a name="l00479"></a>00479     <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b594d13a4b6be6ef4404b13908d933e1ad">TW_Wait4Cmd</a>:   <span class="comment">//upon entry, we expect to have received a Cmd byte.</span>
<a name="l00480"></a>00480         <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#494d83524c0a35a9680f8abf43538088">TWS_RCMD</a> == Status)      <span class="comment">//It appears that we have received a Command byte now.</span>
<a name="l00481"></a>00481         {
<a name="l00482"></a>00482             tmp = TWDR;
<a name="l00483"></a>00483             <span class="keywordflow">if</span>(tmp &lt;= <a class="code" href="SMBSlave_8h.html#335910998ef911de0e71a0c1b059e565">HIGHEST_SMB_CMD</a>)  <span class="comment">//Is the Cmd within valid range?</span>
<a name="l00484"></a>00484             {
<a name="l00485"></a>00485                 <a class="code" href="communication_8c.html#50d57ab7cb03b10099411f378522dadd">CurrentCmd</a> = tmp;       <span class="comment">//Save a copy.</span>
<a name="l00486"></a>00486                 tmp = <a class="code" href="communication_2interpreter_8h.html#98f76d05b9eb74053793b1fc1835b663">SM_Cmd_Table</a>[tmp][0]; <span class="comment">//Grab the Command Characteristics/Features flags.</span>
<a name="l00487"></a>00487                 <span class="keywordflow">if</span>(tmp &amp; <a class="code" href="communication_2interpreter_8h.html#3ffa90cb904c7f395662aa7573e79b4f">SMBslave</a>)      <span class="comment">//Is the Command valid for Slaves?</span>
<a name="l00488"></a>00488                 {               <span class="comment">//The command appears to be valid.</span>
<a name="l00489"></a>00489                     TWISR_CmdFeatures = tmp;    <span class="comment">//Save the Feature flags for use in Wait4RW state.</span>
<a name="l00490"></a>00490                     <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5bc8bda251da4d6aae1c2bfb2900c1444">TW_Wait4RW</a>;   <span class="comment">//set up next state</span>
<a name="l00491"></a>00491                     TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//enable ACKing</span>
<a name="l00492"></a>00492                     <span class="keywordflow">return</span>;
<a name="l00493"></a>00493                 }
<a name="l00494"></a>00494             }
<a name="l00495"></a>00495         }
<a name="l00496"></a>00496         <span class="comment">//In all cases except those that 'return' (above), it's an error.</span>
<a name="l00497"></a>00497         <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] |= <a class="code" href="SMBSlave_8h.html#2bdc5a6b268dc4322b1f032918629a0b">SMBerr_UnknownError</a>;
<a name="l00498"></a>00498         <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;   <span class="comment">//generate a bus timeout.</span>
<a name="l00499"></a>00499         TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);     <span class="comment">//disable int, and DON'T clear the TWINT flag!</span>
<a name="l00500"></a>00500         <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;      <span class="comment">//Reset the state machine.</span>
<a name="l00501"></a>00501         <span class="keywordflow">return</span>;
<a name="l00502"></a>00502         <span class="comment">//    break;</span>
<a name="l00503"></a>00503         
<a name="l00504"></a>00504         
<a name="l00505"></a>00505     <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5bc8bda251da4d6aae1c2bfb2900c1444">TW_Wait4RW</a>:    <span class="comment">//We will now find out if we will RX more, or we need to TX a reply instead.</span>
<a name="l00506"></a>00506         <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#be4452976a52cc5e091f32ead12669ce">TWS_RDATA</a> == Status)     <span class="comment">//It is a WRITE-type command. Prep the RX buffer to accept more data.</span>
<a name="l00507"></a>00507         {   <span class="comment">//NOTE: except for OptionalMfgFunction5, all WRITE cmds are 2-byte, plus optional PEC.</span>
<a name="l00508"></a>00508             <span class="comment">//Place all bytes of the transaction into the buffer so we can do a PEC on it if needed.</span>
<a name="l00509"></a>00509             <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[0] = TWAR &amp; 0xFE;  <span class="comment">//store everything incl. the slave address for computing PEC.</span>
<a name="l00510"></a>00510             <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[1] = <a class="code" href="communication_8c.html#50d57ab7cb03b10099411f378522dadd">CurrentCmd</a>;   <span class="comment">//store the previously-send Command.</span>
<a name="l00511"></a>00511             <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[2] = TWDR;     <span class="comment">//store this first DATA byte</span>
<a name="l00512"></a>00512             <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a> = 3;      <span class="comment">//use RxBufIndex as the index to store data in the buffer.</span>
<a name="l00513"></a>00513             <span class="keywordflow">if</span>(TWISR_CmdFeatures &amp; <a class="code" href="communication_2interpreter_8h.html#1200a2673b359fcd7568b69b684cc625">SCWW</a>)    <span class="comment">//is it a Write-WORD command type?</span>
<a name="l00514"></a>00514             {
<a name="l00515"></a>00515                 <a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> = 1;        <span class="comment">//We expect 1 more data byte, and possibly PEC after that.</span>
<a name="l00516"></a>00516             }
<a name="l00517"></a>00517             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(TWISR_CmdFeatures &amp; <a class="code" href="communication_2interpreter_8h.html#fb396475fb3fa7a935530e516e420c76">SCWG</a>)   <span class="comment">//is it a write-BLOCK command (must be OptionalMfgFunction5 then)</span>
<a name="l00518"></a>00518             {
<a name="l00519"></a>00519                 tmp = TWDR;
<a name="l00520"></a>00520                 <span class="keywordflow">if</span>((tmp &gt;= 1) &amp;&amp; (tmp &lt;= 32))
<a name="l00521"></a>00521                     <a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> = TWDR;
<a name="l00522"></a>00522                 <span class="keywordflow">else</span>
<a name="l00523"></a>00523                 {
<a name="l00524"></a>00524                     <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] |= <a class="code" href="SMBSlave_8h.html#4a42c77a65eb6185d98043e9a9e0bf64">SMBerr_BadSize</a>;
<a name="l00525"></a>00525                     <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;   <span class="comment">//generate a bus timeout.</span>
<a name="l00526"></a>00526                     TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);       <span class="comment">//disable int, and DON'T clear the TWINT flag!</span>
<a name="l00527"></a>00527                     <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;      <span class="comment">//Reset the state machine.</span>
<a name="l00528"></a>00528                     <span class="keywordflow">return</span>;
<a name="l00529"></a>00529                 }
<a name="l00530"></a>00530             }
<a name="l00531"></a>00531             <span class="keywordflow">else</span>    <span class="comment">//this Command doesn't allow EITHER word OR group/block Writes! It's Read-only!</span>
<a name="l00532"></a>00532             {
<a name="l00533"></a>00533                 <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] |= <a class="code" href="SMBSlave_8h.html#57b202debe9843681ec52b63736308ed">SMBerr_AccessDenied</a>;
<a name="l00534"></a>00534                 <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;   <span class="comment">//Not a WRITE-type cmd, so generate a bus timeout.</span>
<a name="l00535"></a>00535                 TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);         <span class="comment">//disable int, and DON'T clear the TWINT flag!</span>
<a name="l00536"></a>00536                 <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;      <span class="comment">//Reset the state machine.</span>
<a name="l00537"></a>00537                 <span class="keywordflow">return</span>;
<a name="l00538"></a>00538             }
<a name="l00539"></a>00539             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5e4714c204fd9c4052ca3208a63493baa">TW_Wait4Data</a>;
<a name="l00540"></a>00540             TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//enable ACKing</span>
<a name="l00541"></a>00541         }
<a name="l00542"></a>00542         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#6ab2d53631ce164e3cd5fb1d1d1658ab">TWS_REPEAT</a> == Status)   <span class="comment">//We saw a re-Start, so must be getting ready for a Read cmd.</span>
<a name="l00543"></a>00543         {   <span class="comment">//Must now interpret previously-sent CurrentCmd &amp; set up Reply data.</span>
<a name="l00544"></a>00544             <span class="keywordflow">if</span>(TWISR_CmdFeatures &amp; (<a class="code" href="communication_2interpreter_8h.html#a85af9d88231ee9fe08e31e03ba2d11b">SCRW</a> | <a class="code" href="communication_2interpreter_8h.html#f5e6b90ad1abedbf1c8b369dca830d8a">SCRG</a>))   <span class="comment">//Is it a 'ReadWord' or 'ReadGroup' command type?</span>
<a name="l00545"></a>00545             {
<a name="l00546"></a>00546                 <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#1fef3300524ef987fa146cc892813b20">SMB_SetUpReply</a>;  <span class="comment">//Foreground decoder will set up TWCR.</span>
<a name="l00547"></a>00547                 <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b583d27cae0915c8a8002877623dcb0dc9">TW_ReplyData</a>;     <span class="comment">//Move to next state.</span>
<a name="l00548"></a>00548             }
<a name="l00549"></a>00549             <span class="keywordflow">else</span>
<a name="l00550"></a>00550             {
<a name="l00551"></a>00551                 <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] |= <a class="code" href="SMBSlave_8h.html#2bdc5a6b268dc4322b1f032918629a0b">SMBerr_UnknownError</a>;
<a name="l00552"></a>00552                 <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;   <span class="comment">//Not a READ-type cmd, so generate a bus timeout.</span>
<a name="l00553"></a>00553                 TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);       <span class="comment">//disable int, and DON'T clear the TWINT flag!</span>
<a name="l00554"></a>00554                 <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;      <span class="comment">//Reset the state machine.</span>
<a name="l00555"></a>00555                 <span class="keywordflow">return</span>;
<a name="l00556"></a>00556             }
<a name="l00557"></a>00557             TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);         <span class="comment">//disable int, and DON'T clear the TWINT flag!</span>
<a name="l00558"></a>00558             <span class="keywordflow">return</span>;                 
<a name="l00559"></a>00559         }
<a name="l00560"></a>00560         <span class="keywordflow">else</span>  <span class="comment">//some type of error!</span>
<a name="l00561"></a>00561         {
<a name="l00562"></a>00562             <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] |= <a class="code" href="SMBSlave_8h.html#2bdc5a6b268dc4322b1f032918629a0b">SMBerr_UnknownError</a>;
<a name="l00563"></a>00563             <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;   <span class="comment">//Generate a bus timeout.</span>
<a name="l00564"></a>00564             TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);       <span class="comment">//disable int, and DON'T clear the TWINT flag!</span>
<a name="l00565"></a>00565             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;          <span class="comment">//Reset the state machine.</span>
<a name="l00566"></a>00566             <span class="keywordflow">return</span>;
<a name="l00567"></a>00567         }
<a name="l00568"></a>00568         <span class="keywordflow">break</span>;
<a name="l00569"></a>00569         
<a name="l00570"></a>00570         
<a name="l00571"></a>00571     <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5e4714c204fd9c4052ca3208a63493baa">TW_Wait4Data</a>:  <span class="comment">//We are in Slave Receive operating mode.</span>
<a name="l00572"></a>00572         <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#be4452976a52cc5e091f32ead12669ce">TWS_RDATA</a> == Status)         <span class="comment">//received a data byte</span>
<a name="l00573"></a>00573         {
<a name="l00574"></a>00574             tmp = TWDR;
<a name="l00575"></a>00575             <span class="keywordflow">if</span>(--<a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> &lt; -1)          <span class="comment">//Are we past the PEC byte and still getting more data?</span>
<a name="l00576"></a>00576             {
<a name="l00577"></a>00577                 <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] |= <a class="code" href="SMBSlave_8h.html#4a42c77a65eb6185d98043e9a9e0bf64">SMBerr_BadSize</a>;    <span class="comment">//throw away the data &amp; flag error</span>
<a name="l00578"></a>00578                 <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;   <span class="comment">//Generate a bus timeout.</span>
<a name="l00579"></a>00579                 TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);       <span class="comment">//disable int, and DON'T clear the TWINT flag!</span>
<a name="l00580"></a>00580                 <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;          <span class="comment">//Reset the state machine.</span>
<a name="l00581"></a>00581                 <span class="keywordflow">return</span>;
<a name="l00582"></a>00582             }
<a name="l00583"></a>00583             <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[<a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>++] = TWDR;   <span class="comment">//store the byte</span>
<a name="l00584"></a>00584         }
<a name="l00585"></a>00585         
<a name="l00586"></a>00586         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#ea29a640c276fdaea02372a2c1ac5f78">TWS_RSTOP</a> == Status)            <span class="comment">//got a STOP; all done RXing data now.</span>
<a name="l00587"></a>00587         { <span class="comment">//Note: if we get a STOP prematurely, then we simply ignore the command,</span>
<a name="l00588"></a>00588             <span class="comment">//  since it is too late to inform the Master of the error.</span>
<a name="l00589"></a>00589             <span class="keywordflow">if</span>((<a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> &gt; 0) || (<a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> &lt; -1)) <span class="comment">//We got a premature STOP or too much data; ERROR!</span>
<a name="l00590"></a>00590             {
<a name="l00591"></a>00591                 <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] |= <a class="code" href="SMBSlave_8h.html#4a42c77a65eb6185d98043e9a9e0bf64">SMBerr_BadSize</a>;    <span class="comment">//throw away the data.</span>
<a name="l00592"></a>00592             }
<a name="l00593"></a>00593             <span class="keywordflow">else</span>
<a name="l00594"></a>00594             {
<a name="l00595"></a>00595                 <span class="keywordflow">if</span>(0 == <a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a>)
<a name="l00596"></a>00596                     <a class="code" href="communication_8c.html#fd9b3e99365b45af6cf763b2dda41546">UsePEC</a> = 0;             <span class="comment">//there is no PEC coming for this packet.</span>
<a name="l00597"></a>00597                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(-1 == <a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a>)
<a name="l00598"></a>00598                     <a class="code" href="communication_8c.html#fd9b3e99365b45af6cf763b2dda41546">UsePEC</a> = 1;             <span class="comment">//PEC was included.</span>
<a name="l00599"></a>00599                 
<a name="l00600"></a>00600                 <a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> = <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>;        <span class="comment">//re-use the Write Index's value as the Valid Byte Count.</span>
<a name="l00601"></a>00601                 <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a> = 0;          <span class="comment">//clear the index in preparation for interpreting it.</span>
<a name="l00602"></a>00602                 <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#07b00aac11ba389d5b53e2f9d54bd0bd">SMB_GotCmdData</a>;  <span class="comment">//tell Foreground to process this now.</span>
<a name="l00603"></a>00603                 <span class="comment">//Note that when (TWI_CmdFlags == SMB_GotCmdData), TWI ISR will respond with BUSY condition.</span>
<a name="l00604"></a>00604             }
<a name="l00605"></a>00605             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;      <span class="comment">//Reset the state machine in all cases.</span>
<a name="l00606"></a>00606         }
<a name="l00607"></a>00607         
<a name="l00608"></a>00608         <span class="keywordflow">else</span>  <span class="comment">//some type of error during transmission!</span>
<a name="l00609"></a>00609         {
<a name="l00610"></a>00610             <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] |= <a class="code" href="SMBSlave_8h.html#2bdc5a6b268dc4322b1f032918629a0b">SMBerr_UnknownError</a>;
<a name="l00611"></a>00611             <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;   <span class="comment">//Not a WRITE-type cmd, so generate a bus timeout.</span>
<a name="l00612"></a>00612             TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);       <span class="comment">//disable int, and DON'T clear the TWINT flag!</span>
<a name="l00613"></a>00613             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;          <span class="comment">//Reset the state machine.</span>
<a name="l00614"></a>00614             <span class="keywordflow">return</span>;
<a name="l00615"></a>00615         }
<a name="l00616"></a>00616         
<a name="l00617"></a>00617         TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//enable ACKing</span>
<a name="l00618"></a>00618         <span class="keywordflow">break</span>;
<a name="l00619"></a>00619         
<a name="l00620"></a>00620         
<a name="l00621"></a>00621     <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b583d27cae0915c8a8002877623dcb0dc9">TW_ReplyData</a>:  <span class="comment">//We are now in Slave Transmit operating mode.</span>
<a name="l00622"></a>00622         <span class="comment">//The foreground code has set up the response that we are now sending.</span>
<a name="l00623"></a>00623         <span class="comment">//Note: TW_TxBufCnt *always* includes the PEC byte! Since we don't</span>
<a name="l00624"></a>00624         <span class="comment">// know whether the Master actually WANTS the PEC byte or not, we will</span>
<a name="l00625"></a>00625         <span class="comment">// always TRY to send it, regardless of the state of the UsePEC flag.</span>
<a name="l00626"></a>00626         <span class="comment">// If the Master does NOT want it, we will get a NAK while the PEC</span>
<a name="l00627"></a>00627         <span class="comment">// byte is still in the buffer.  In the rare case where we send it all,</span>
<a name="l00628"></a>00628         <span class="comment">// including the PEC byte, but we still get an ACK back, the TWI module</span>
<a name="l00629"></a>00629         <span class="comment">// will be off-line anyway due to not setting the TWEA bit after sending PEC,</span>
<a name="l00630"></a>00630         <span class="comment">// and we will therefore be unable to flag that an error has occurred.</span>
<a name="l00631"></a>00631         <span class="keywordflow">if</span>((<a class="code" href="SMBSlave_8h.html#56a6f2a019fcb0f004ad6a8619fd9b3f">TWS_SLA_R</a> == Status) || (<a class="code" href="SMBSlave_8h.html#69333e59f4e48bd3130a871152cc17ae">TWS_RACK</a> == Status))   <span class="comment">//send out Reply data</span>
<a name="l00632"></a>00632         {
<a name="l00633"></a>00633             TWDR = <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[<a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a>++];   <span class="comment">//send data out</span>
<a name="l00634"></a>00634             <span class="keywordflow">if</span>(--<a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a> == 0)          <span class="comment">//Have we emptied the buffer, incl. PEC?</span>
<a name="l00635"></a>00635                 TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);      <span class="comment">// Yes, so don't set TWEA.</span>
<a name="l00636"></a>00636             <span class="keywordflow">else</span>
<a name="l00637"></a>00637                 TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">// No, so assert TWEA.</span>
<a name="l00638"></a>00638         }
<a name="l00639"></a>00639         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#d3a2ba13b4f5c4ccac0d9d5a67a08c9c">TWS_RNAK</a> == Status) <span class="comment">//We may have gotten this validly or as an Error.</span>
<a name="l00640"></a>00640         {
<a name="l00641"></a>00641             <span class="keywordflow">if</span>(<a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a> == 1)    <span class="comment">//Not an error. Master didn't want PEC; clear UsePEC flag!</span>
<a name="l00642"></a>00642             {
<a name="l00643"></a>00643                 <a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a> = 0;    <span class="comment">//clear the buffer too.</span>
<a name="l00644"></a>00644                 <a class="code" href="communication_8c.html#fd9b3e99365b45af6cf763b2dda41546">UsePEC</a> = 0;
<a name="l00645"></a>00645             }
<a name="l00646"></a>00646             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a> == 0)   <span class="comment">//Not an error. Master wanted PEC (and got it); assert UsePEC.</span>
<a name="l00647"></a>00647                 <a class="code" href="communication_8c.html#fd9b3e99365b45af6cf763b2dda41546">UsePEC</a> = 1;
<a name="l00648"></a>00648             <span class="keywordflow">else</span>            <span class="comment">//some kind of error occurred; we got NAK too early!</span>
<a name="l00649"></a>00649             { <span class="comment">//Note: the TWI module is now OFF-LINE, so we can't inform Host of this error!!</span>
<a name="l00650"></a>00650                 <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] |= <a class="code" href="SMBSlave_8h.html#2bdc5a6b268dc4322b1f032918629a0b">SMBerr_UnknownError</a>;   <span class="comment">//flag it later</span>
<a name="l00651"></a>00651             }
<a name="l00652"></a>00652             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;          <span class="comment">//In all cases, go back to IDLE.</span>
<a name="l00653"></a>00653             TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);
<a name="l00654"></a>00654         }
<a name="l00655"></a>00655         <span class="keywordflow">else</span>
<a name="l00656"></a>00656             <span class="comment">//    if(TWS_FINAL == Status)   //ERROR: we got an ACK but we have no more data!</span>
<a name="l00657"></a>00657         { <span class="comment">//Since the TWI module is now in "Not Addressed Slave" mode, we can't flag the error</span>
<a name="l00658"></a>00658             <span class="comment">// back to the Master DURING this transaction; we WILL assert an error status though.</span>
<a name="l00659"></a>00659             <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] |= <a class="code" href="SMBSlave_8h.html#4a42c77a65eb6185d98043e9a9e0bf64">SMBerr_BadSize</a>;
<a name="l00660"></a>00660             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;  <span class="comment">//Reset the state machine.</span>
<a name="l00661"></a>00661             TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);
<a name="l00662"></a>00662         }
<a name="l00663"></a>00663         <span class="keywordflow">break</span>;
<a name="l00664"></a>00664         
<a name="l00665"></a>00665         
<a name="l00666"></a>00666         
<a name="l00667"></a>00667         <span class="comment">//MASTER-mode states follow.</span>
<a name="l00668"></a>00668         
<a name="l00669"></a>00669     <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5d258cb231677f6a95dcf1c9f239e2b36">TW_MSLA_W</a>: <span class="comment">//we just tried to send the SLAVE ADDRESS in Master Mode.</span>
<a name="l00670"></a>00670         <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#42b34b4323c0fd4986325ecd815b60b6">TWS_WRITE_ACK</a> == Status)     <span class="comment">// we got an ACK back from the desired SLA+W transmission</span>
<a name="l00671"></a>00671         {
<a name="l00672"></a>00672             TWDR = <a class="code" href="communication_8c.html#c47af82e11278b79be8fb40152038444">TW_MTxBuf</a>[<a class="code" href="communication_8c.html#c8ae296e1c1a72b91325c789bbdff1a0">TW_MTxBufIndex</a>++]; <span class="comment">//send out Cmd</span>
<a name="l00673"></a>00673             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b52166c37a639d0f299b5195aa8672bd41">TW_MCMD_W</a>;
<a name="l00674"></a>00674             TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);
<a name="l00675"></a>00675         }
<a name="l00676"></a>00676         <span class="keywordflow">else</span>  <span class="comment">//anything else is Unexpected or an Error result.</span>
<a name="l00677"></a>00677         { <span class="comment">//We simply delete msgs that couldn't be sent as they will be resent in 10secs anyway.</span>
<a name="l00678"></a>00678             TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWSTO) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);
<a name="l00679"></a>00679             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;  <span class="comment">//Reset the state machine.</span>
<a name="l00680"></a>00680             <a class="code" href="communication_8c.html#3543d0e9d6053dac3f9b711d440a3f93">TW_MTxBufCnt</a> = 0;
<a name="l00681"></a>00681             <a class="code" href="communication_8c.html#c8ae296e1c1a72b91325c789bbdff1a0">TW_MTxBufIndex</a> = 0;
<a name="l00682"></a>00682             <a class="code" href="communication_8c.html#83b4a23934b4a918f7615cadb682e122">TXmsgDelete</a>;                  <span class="comment">//Delete this just-sent msg from the TX buffer.</span>
<a name="l00683"></a>00683             <a class="code" href="communication_8c.html#8eb5d9128fac12df31c29313df01b1ac">SMLOCK</a> = 0;
<a name="l00684"></a>00684         }
<a name="l00685"></a>00685         <span class="keywordflow">break</span>;
<a name="l00686"></a>00686         
<a name="l00687"></a>00687     <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b52166c37a639d0f299b5195aa8672bd41">TW_MCMD_W</a>: <span class="comment">//we just sent a Master COMMAND byte or a Data byte</span>
<a name="l00688"></a>00688         <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#8241a83cf96e3888d0e070ca3b05c394">TWS_TXDATA_ACK</a> == Status)    <span class="comment">// we got an ACK from data we sent.</span>
<a name="l00689"></a>00689         {
<a name="l00690"></a>00690             <span class="keywordflow">if</span>(<a class="code" href="communication_8c.html#3543d0e9d6053dac3f9b711d440a3f93">TW_MTxBufCnt</a> &gt; <a class="code" href="communication_8c.html#c8ae296e1c1a72b91325c789bbdff1a0">TW_MTxBufIndex</a>)
<a name="l00691"></a>00691             {
<a name="l00692"></a>00692                 TWDR = <a class="code" href="communication_8c.html#c47af82e11278b79be8fb40152038444">TW_MTxBuf</a>[<a class="code" href="communication_8c.html#c8ae296e1c1a72b91325c789bbdff1a0">TW_MTxBufIndex</a>++]; <span class="comment">//send out Data byte</span>
<a name="l00693"></a>00693                 <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b52166c37a639d0f299b5195aa8672bd41">TW_MCMD_W</a>;
<a name="l00694"></a>00694                 TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);
<a name="l00695"></a>00695             }
<a name="l00696"></a>00696             <span class="keywordflow">else</span>  <span class="comment">//we've sent everything in the buffer, so send STOP now.</span>
<a name="l00697"></a>00697             {
<a name="l00698"></a>00698                 TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWSTO) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);
<a name="l00699"></a>00699                 <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;
<a name="l00700"></a>00700                 <a class="code" href="communication_8c.html#3543d0e9d6053dac3f9b711d440a3f93">TW_MTxBufCnt</a> = 0;
<a name="l00701"></a>00701                 <a class="code" href="communication_8c.html#c8ae296e1c1a72b91325c789bbdff1a0">TW_MTxBufIndex</a> = 0;
<a name="l00702"></a>00702                 <a class="code" href="communication_8c.html#83b4a23934b4a918f7615cadb682e122">TXmsgDelete</a>;                  <span class="comment">//Delete this just-sent msg from the TX buffer.</span>
<a name="l00703"></a>00703                 <a class="code" href="communication_8c.html#8eb5d9128fac12df31c29313df01b1ac">SMLOCK</a> = 0;
<a name="l00704"></a>00704             }
<a name="l00705"></a>00705         }
<a name="l00706"></a>00706         <span class="keywordflow">else</span>  <span class="comment">//Unexpected or Error response.</span>
<a name="l00707"></a>00707         {
<a name="l00708"></a>00708             TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWSTO) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);
<a name="l00709"></a>00709             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;
<a name="l00710"></a>00710             <a class="code" href="communication_8c.html#3543d0e9d6053dac3f9b711d440a3f93">TW_MTxBufCnt</a> = 0;
<a name="l00711"></a>00711             <a class="code" href="communication_8c.html#c8ae296e1c1a72b91325c789bbdff1a0">TW_MTxBufIndex</a> = 0;
<a name="l00712"></a>00712             <a class="code" href="communication_8c.html#83b4a23934b4a918f7615cadb682e122">TXmsgDelete</a>;                  <span class="comment">//Delete this just-sent msg from the TX buffer.</span>
<a name="l00713"></a>00713             <a class="code" href="communication_8c.html#8eb5d9128fac12df31c29313df01b1ac">SMLOCK</a> = 0;
<a name="l00714"></a>00714         }
<a name="l00715"></a>00715         <span class="keywordflow">break</span>;
<a name="l00716"></a>00716         
<a name="l00717"></a>00717     } <span class="comment">// end of switch(TWISR_state)</span>
<a name="l00718"></a>00718 }
<a name="l00719"></a>00719 
<a name="l00720"></a>00720 
<a name="l00721"></a>00721 <span class="comment">/* *************************************************************************</span>
<a name="l00722"></a>00722 <span class="comment"> *</span>
<a name="l00723"></a>00723 <span class="comment"> *   Foreground SMBus Command Interpreter</span>
<a name="l00724"></a>00724 <span class="comment"> *</span>
<a name="l00725"></a>00725 <span class="comment"> ************************************************************************* */</span>
<a name="l00726"></a>00726 
<a name="l00727"></a>00727 
<a name="l00728"></a><a class="code" href="SMBSlave_8h.html#bee976a1ba64bc7089b0d73ea432900e">00728</a> <span class="keywordtype">void</span> <a class="code" href="communication_8c.html#bee976a1ba64bc7089b0d73ea432900e">SMB_CmdInterpreter</a>(<span class="keywordtype">void</span>)
<a name="l00729"></a>00729 {
<a name="l00730"></a>00730     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> temp;
<a name="l00731"></a>00731     
<a name="l00732"></a>00732     <span class="keywordflow">if</span>(<a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a> == <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a>)   <span class="comment">//The ISR detected an error condition.</span>
<a name="l00733"></a>00733     {
<a name="l00734"></a>00734         <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = 0;           <span class="comment">//clear the flag that brought us here.</span>
<a name="l00735"></a>00735         <span class="comment">//start the 26mS timer.  When it is done, the Timer handler will re-init the TWI peripheral.</span>
<a name="l00736"></a>00736         <a class="code" href="timer_8c.html#3ad6d4c2cd213c29e403adeff96c71d4">SetGenericTimer</a>(<a class="code" href="timer_8h.html#1e9c8bb728946234c7ca94eefed0d4c1">SMBfaultTimer</a>, 26);
<a name="l00737"></a>00737         <span class="keywordflow">return</span>;
<a name="l00738"></a>00738     }
<a name="l00739"></a>00739     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="communication_8c.html#1fef3300524ef987fa146cc892813b20">SMB_SetUpReply</a> == <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a>) <span class="comment">//interpret a 'Read' Command.</span>
<a name="l00740"></a>00740     {
<a name="l00741"></a>00741         <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = 0;           <span class="comment">//clear the flag that brought us here.</span>
<a name="l00742"></a>00742         <a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a> = 0;          <span class="comment">//initialize</span>
<a name="l00743"></a>00743         <a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a> = 0;            <span class="comment">//initialize</span>
<a name="l00744"></a>00744         <span class="keywordflow">if</span>(0 != <a class="code" href="smbus__removed_8c.html#a2df3e1c35180cf0af73f7723167d696">SMB_ReadCmd</a>[<a class="code" href="communication_8c.html#50d57ab7cb03b10099411f378522dadd">CurrentCmd</a>]())  <span class="comment">//After interpreting, was there an error??</span>
<a name="l00745"></a>00745         {
<a name="l00746"></a>00746             <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] |= <a class="code" href="SMBSlave_8h.html#a5a26e8cc169c82b3f951c20be0a103b">SMBerr_UnsuptdCommand</a>;
<a name="l00747"></a>00747             <a class="code" href="timer_8c.html#3ad6d4c2cd213c29e403adeff96c71d4">SetGenericTimer</a>(<a class="code" href="timer_8h.html#1e9c8bb728946234c7ca94eefed0d4c1">SMBfaultTimer</a>, 26); <span class="comment">//generate a bus timeout error.</span>
<a name="l00748"></a>00748             <a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a> = 0;        <span class="comment">//Wipe out anything in the buffer, just in case.</span>
<a name="l00749"></a>00749             <a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a> = 0;            
<a name="l00750"></a>00750             <span class="keywordflow">return</span>;
<a name="l00751"></a>00751         }
<a name="l00752"></a>00752         <span class="keywordflow">else</span> <span class="comment">//generate PEC now for the *entire* transaction, including the original request!</span>
<a name="l00753"></a>00753         {
<a name="l00754"></a>00754             <span class="comment">//Assume (TW_TxBufIndex == 0) and (TW_TxBufCtr == # of bytes of data, not incl PEC).</span>
<a name="l00755"></a>00755             temp = <a class="code" href="smbus__removed_8c.html#5236dde88b9f0817fabad10165faf02c">FastCRC</a>(0, (TWAR &amp; 0xFE));   <span class="comment">//use the SLA+W address</span>
<a name="l00756"></a>00756             temp = <a class="code" href="smbus__removed_8c.html#5236dde88b9f0817fabad10165faf02c">FastCRC</a>(temp, <a class="code" href="communication_8c.html#50d57ab7cb03b10099411f378522dadd">CurrentCmd</a>);
<a name="l00757"></a>00757             temp = <a class="code" href="smbus__removed_8c.html#5236dde88b9f0817fabad10165faf02c">FastCRC</a>(temp, (TWAR | 1));   <span class="comment">//use the SLA+R address</span>
<a name="l00758"></a>00758             
<a name="l00759"></a>00759             <span class="keywordflow">do</span> {temp = <a class="code" href="smbus__removed_8c.html#5236dde88b9f0817fabad10165faf02c">FastCRC</a>(temp, <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[<a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a>++]);}
<a name="l00760"></a>00760             <span class="keywordflow">while</span>(<a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a> != <a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a>);
<a name="l00761"></a>00761             
<a name="l00762"></a>00762             <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[<a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a>] = temp; <span class="comment">//append the CRC value on the end.</span>
<a name="l00763"></a>00763             <a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a>++;          <span class="comment">//increase the byte count for the PEC.</span>
<a name="l00764"></a>00764             <a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a> = 0;      <span class="comment">//Reset the buffer pointer.</span>
<a name="l00765"></a>00765             TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//have TWI continue from where it stalled.</span>
<a name="l00766"></a>00766         }
<a name="l00767"></a>00767         <span class="keywordflow">return</span>;
<a name="l00768"></a>00768     }
<a name="l00769"></a>00769     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="communication_8c.html#07b00aac11ba389d5b53e2f9d54bd0bd">SMB_GotCmdData</a> == <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a>) <span class="comment">//process some received command+data.</span>
<a name="l00770"></a>00770     {
<a name="l00771"></a>00771         <span class="comment">//NOTE: as of 6/17/2005, TWI_CmdFlags should NOT be cleared until we are</span>
<a name="l00772"></a>00772         <span class="comment">// completely done processing this message, else the TWI ISR will overwrite</span>
<a name="l00773"></a>00773         <span class="comment">// the RX buffer and won't respond with BUSY as it should.  Note also that</span>
<a name="l00774"></a>00774         <span class="comment">// the TWI is fully re-enabled when entering here, so we MUST NOT write</span>
<a name="l00775"></a>00775         <span class="comment">// to any of the TWI h/w registers or we could create havoc.  -rgf</span>
<a name="l00776"></a>00776         
<a name="l00777"></a>00777         <span class="keywordflow">if</span>(<a class="code" href="communication_8c.html#fd9b3e99365b45af6cf763b2dda41546">UsePEC</a>)              <span class="comment">//check the CRC of the received packet.</span>
<a name="l00778"></a>00778         {
<a name="l00779"></a>00779             temp = 0;               <span class="comment">//use this as our CRC value.</span>
<a name="l00780"></a>00780             
<a name="l00781"></a>00781             <span class="keywordflow">do</span> { temp = <a class="code" href="smbus__removed_8c.html#5236dde88b9f0817fabad10165faf02c">FastCRC</a>(temp, <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[<a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>++]); }
<a name="l00782"></a>00782             <span class="keywordflow">while</span>(<a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> != <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>);
<a name="l00783"></a>00783             
<a name="l00784"></a>00784             <span class="keywordflow">if</span>(temp)    <span class="comment">//The result of a CRC check SHOULD be =0 if all was ok.</span>
<a name="l00785"></a>00785             {
<a name="l00786"></a>00786                 <a class="code" href="SMBSlave_8h.html#c7f9993307a3c3559f56d0353613de62">SMBvariables</a>[<a class="code" href="SMBSlave_8h.html#8b71774d964d8895ae3091bcb40bf2fe">SMBV_BattStatus</a>][<a class="code" href="SMBSlave_8h.html#7341bfdcbd33f530cc0b75d2e62358cc">lobyte</a>] |= <a class="code" href="SMBSlave_8h.html#2bdc5a6b268dc4322b1f032918629a0b">SMBerr_UnknownError</a>;
<a name="l00787"></a>00787                 
<a name="l00788"></a>00788                 <span class="comment">//start the 26mS timer to generate a bus timeout error.</span>
<a name="l00789"></a>00789                 <a class="code" href="timer_8c.html#3ad6d4c2cd213c29e403adeff96c71d4">SetGenericTimer</a>(<a class="code" href="timer_8h.html#1e9c8bb728946234c7ca94eefed0d4c1">SMBfaultTimer</a>, 26);
<a name="l00790"></a>00790                 <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = 0;       <span class="comment">//clear the flag that brought us here.</span>
<a name="l00791"></a>00791                 <span class="keywordflow">return</span>;
<a name="l00792"></a>00792             }
<a name="l00793"></a>00793         }
<a name="l00794"></a>00794         
<a name="l00795"></a>00795         <span class="comment">//The rcvd message is valid enough to warrant calling the command's handler now.</span>
<a name="l00796"></a>00796         
<a name="l00797"></a>00797         
<a name="l00798"></a>00798         <span class="comment">//Note that none of the regular SMBus commands use Block Mode to send info</span>
<a name="l00799"></a>00799         <span class="comment">// *TO* the Smart Battery, so TW_RxBuf[2] will NEVER be a byte count, but</span>
<a name="l00800"></a>00800         <span class="comment">// will always be DATA.  For OptionalMfgFunction(5), the associated command</span>
<a name="l00801"></a>00801         <span class="comment">// function itself is aware that [2] is the byte count and that the actual</span>
<a name="l00802"></a>00802         <span class="comment">// data starts at offset=[3].</span>
<a name="l00803"></a>00803         <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a> = 2;          <span class="comment">//point to the first byte of Received Data.</span>
<a name="l00804"></a>00804         
<a name="l00805"></a>00805         
<a name="l00806"></a>00806         <span class="keywordflow">if</span>(0 != <a class="code" href="smbus__removed_8c.html#4ddb0ec9b1efd2d94604321291ddab72">SMB_WriteCmd</a>[<a class="code" href="communication_8c.html#50d57ab7cb03b10099411f378522dadd">CurrentCmd</a>]()) <span class="comment">//After interpreting, was there an error??</span>
<a name="l00807"></a>00807         {
<a name="l00808"></a>00808             <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a> = 0;      <span class="comment">//Wipe out anything in the buffer, just in case.</span>
<a name="l00809"></a>00809             <a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> = 0;            
<a name="l00810"></a>00810             
<a name="l00811"></a>00811             <span class="comment">//start the 26mS timer to generate a bus timeout error.</span>
<a name="l00812"></a>00812             <a class="code" href="timer_8c.html#3ad6d4c2cd213c29e403adeff96c71d4">SetGenericTimer</a>(<a class="code" href="timer_8h.html#1e9c8bb728946234c7ca94eefed0d4c1">SMBfaultTimer</a>, 26);
<a name="l00813"></a>00813             <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = 0;           <span class="comment">//clear the flag that brought us here.</span>
<a name="l00814"></a>00814             <span class="keywordflow">return</span>;
<a name="l00815"></a>00815         }
<a name="l00816"></a>00816         <span class="comment">//At this point it looks like everything went OK.</span>
<a name="l00817"></a>00817         <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = 0;           <span class="comment">//clear the flag that brought us here.</span>
<a name="l00818"></a>00818         <span class="keywordflow">return</span>;
<a name="l00819"></a>00819     }
<a name="l00820"></a>00820 }
<a name="l00821"></a>00821 
<a name="l00822"></a>00822 
<a name="l00823"></a>00823 <span class="comment">//This function restores the SMBus &amp; the TWI_ISR state machine to normal after</span>
<a name="l00824"></a>00824 <span class="comment">//  we have deliberately generated a bus timeout error (in order to tell the</span>
<a name="l00825"></a>00825 <span class="comment">//  Master that something was wrong with his last command).</span>
<a name="l00826"></a><a class="code" href="smbus_8h.html#a43740bb86658af2f20234cc35e87e1c">00826</a> <span class="keywordtype">void</span> <a class="code" href="communication_8c.html#a43740bb86658af2f20234cc35e87e1c">SMB_RestoreBus</a>(<span class="keywordtype">void</span>)
<a name="l00827"></a>00827 {
<a name="l00828"></a>00828     TWCR = 0;               <span class="comment">//shut down the peripheral</span>
<a name="l00829"></a>00829     <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;  <span class="comment">//force an init of the state machine</span>
<a name="l00830"></a>00830     TWAR = <a class="code" href="SMBSlave_8h.html#fe8d42918d4038d5d5c20a30a661e57e">BATTERY_ADDR</a>&lt;&lt;1;         
<a name="l00831"></a>00831     TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">// | (1&lt;&lt;TWSTO)  re-enable</span>
<a name="l00832"></a>00832     
<a name="l00833"></a>00833     <span class="comment">//Note that we must be careful not to generate some kind of bus error</span>
<a name="l00834"></a>00834     <span class="comment">// as a result of waking back up, or we will get into an endless loop</span>
<a name="l00835"></a>00835     <span class="comment">// by generating another bus timeout if the IDLE state doesn't like</span>
<a name="l00836"></a>00836     <span class="comment">// something it sees when it comes back to life.</span>
<a name="l00837"></a>00837 }
<a name="l00838"></a>00838 
</pre></div></div>
<html>
 <head>
  <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
  <title>@DOC_TITLE@</title>
  <link href="doxygen.css" rel="stylesheet" type="text/css">
</head>
<body>

<table width="100%" height="10%" bgcolor="#FFFFFF">
  <tr>
    <td colspan="6" height="1" background="blue.gif"></td>
  </tr>

  <tr>
    <td colspan="6">
    <address style="align: right;"><small>
Generated on Wed Aug 4 10:59:54 2010 for AVR474 Firmware User's Guide for SB202 by <a href="http://www.doxygen.org/index.html"><img src="doxygen.png" alt="doxygen" align="middle" border=0></a> 1.5.6</small></address>
    </td>
  </tr>

</table>
