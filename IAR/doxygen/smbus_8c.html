<html xmlns:v="urn:schemas-microsoft-com:vml"
xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns="http://www.w3.org/TR/REC-html40">

<head>
<meta http-equiv=Content-Type content="text/html; charset=iso-8859-1">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 11">
<meta name=Originator content="Microsoft Word 11">
<link rel=File-List href="atmel-header_files/filelist.xml">
<link rel=Edit-Time-Data href="atmel-header_files/editdata.mso">
<!--[if !mso]>
<style>
v\:* {behavior:url(#default#VML);}
o\:* {behavior:url(#default#VML);}
w\:* {behavior:url(#default#VML);}
.shape {behavior:url(#default#VML);}
</style>
<![endif]-->
<title>@DOC_TITLE@</title>
<!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>ping.zhou</o:Author>
  <o:Template>Normal</o:Template>
  <o:LastAuthor>ping.zhou</o:LastAuthor>
  <o:Revision>3</o:Revision>
  <o:TotalTime>0</o:TotalTime>
  <o:Created>2010-08-04T02:58:00Z</o:Created>
  <o:LastSaved>2010-08-04T02:58:00Z</o:LastSaved>
  <o:Pages>1</o:Pages>
  <o:Words>51</o:Words>
  <o:Characters>297</o:Characters>
  <o:Company>Atmel</o:Company>
  <o:Lines>2</o:Lines>
  <o:Paragraphs>1</o:Paragraphs>
  <o:CharactersWithSpaces>347</o:CharactersWithSpaces>
  <o:Version>11.9999</o:Version>
 </o:DocumentProperties>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:Zoom>150</w:Zoom>
  <w:SpellingState>Clean</w:SpellingState>
  <w:GrammarState>Clean</w:GrammarState>
  <w:ValidateAgainstSchemas/>
  <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid>
  <w:IgnoreMixedContent>false</w:IgnoreMixedContent>
  <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText>
  <w:Compatibility>
   <w:UseFELayout/>
  </w:Compatibility>
  <w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel>
 </w:WordDocument>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:LatentStyles DefLockedState="false" LatentStyleCount="156">
 </w:LatentStyles>
</xml><![endif]-->
<link rel=Stylesheet type="text/css" media=all href="doxygen.css">
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Helvetica;
	panose-1:2 11 6 4 2 2 2 2 2 4;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:536902279 -2147483648 8 0 511 0;}
@font-face
	{font-family:SimSun;
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-alt:SimSun;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 135135232 16 0 262145 0;}
@font-face
	{font-family:SimSun;
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 135135232 16 0 262145 0;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:SimSun;}
p
	{font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:SimSun;}
span.SpellE
	{mso-style-name:"";
	mso-spl-e:yes;}
@page Section1
	{size:8.5in 11.0in;
	margin:1.0in 1.25in 1.0in 1.25in;
	mso-header-margin:.5in;
	mso-footer-margin:.5in;
	mso-paper-source:0;}
div.Section1
	{page:Section1;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
	{mso-style-name:"Table Normal";
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-parent:"";
	mso-padding-alt:0in 5.4pt 0in 5.4pt;
	mso-para-margin:0in;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-ansi-language:#0400;
	mso-fareast-language:#0400;
	mso-bidi-language:#0400;}
</style>
<![endif]--><!--[if gte mso 9]><xml>
 <o:shapedefaults v:ext="edit" spidmax="2050"/>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <o:shapelayout v:ext="edit">
  <o:idmap v:ext="edit" data="1"/>
 </o:shapelayout></xml><![endif]-->
</head>

<body lang=EN-US link=blue vlink=blue style='tab-interval:.5in'>

<div class=Section1>

<table class=MsoNormalTable border=0 cellpadding=0 width="100%"
 style='width:100.0%;mso-cellspacing:1.5pt;background:white'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes'>
  <td style='padding:.75pt .75pt .75pt .75pt'>
  <p><a href="http://www.atmel.com"><span style='text-decoration:none;
  text-underline:none'><img border=0 width=109 height=50 id="_x0000_i1025"
  src=atmel.jpg></span></a></p>
  <p class=MsoNormal><o:p>&nbsp;</o:p></p>
  </td>
  <td style='padding:.75pt .75pt .75pt .75pt'>
  <p class=MsoNormal><span class=SpellE><strong><span style='font-size:24.0pt;
  font-family:Helvetica;color:black'>SmartBattery</span></strong></span><strong><span
  style='font-size:24.0pt;font-family:Helvetica;color:black'> Device
  Application Note</span></strong></p>
  </td>
  <td style='padding:.75pt .75pt .75pt .75pt'>
  <p><a href="http://www.atmel.com/products/AVR"><span style='text-decoration:
  none;text-underline:none'><img border=0 width=138 height=77 id="_x0000_i1026"
  src="AVR_logo_blue.gif"></span></a></p>
  <p class=MsoNormal><o:p>&nbsp;</o:p></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:1;mso-yfti-lastrow:yes;height:.75pt'>
  <td colspan=3 style='padding:.75pt .75pt .75pt .75pt;height:.75pt'
  background=blue.gif>
  <p class=MsoNormal><span style='font-size:1.0pt;mso-bidi-font-size:12.0pt'><o:p>&nbsp;</o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

</div>

</body>

</html>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_29ae905079a6eb1b30b29288f24757bc.html">lib_mcu</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_c2f2e611aade4b362b2bd89f67a7ad7a.html">sm_bus</a>
  </div>
</div>
<div class="contents">
<h1>smbus.c File Reference</h1><hr><a name="_details"></a><h2>Detailed Description</h2>
The communication file reads a command from the SMB bus and sends r/w, data and length information to SBS layer. 
<p>
<dl class="user" compact><dt><b>Application note:</b></dt><dd>AVR474: SB202 Firmware user's guide.</dd></dl>
<dl class="user" compact><dt><b>Documentation</b></dt><dd>For comprehensive code documentation, supported compilers, compiler settings and supported devices see readme.html</dd></dl>
<dl class="author" compact><dt><b>Author:</b></dt><dd>Atmel Corporation: <a href="http://www.atmel.com">http://www.atmel.com</a> <br>
 Support email: <a href="mailto:avr@atmel.com">avr@atmel.com</a></dd></dl>
<dl class="rcs" compact><dt><b>Revision</b></dt><dd>6090 </dd></dl>
<dl class="rcs" compact><dt><b>Date</b></dt><dd>2009-10-05 21:40:12 +0800 (Mon, 05 Oct 2009) </dd></dl>
<br>
<p>
Copyright (c) 2009, Atmel Corporation All rights reserved.<p>
Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:<p>
1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.<p>
2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.<p>
3. The name of ATMEL may not be used to endorse or promote products derived from this software without specific prior written permission.<p>
THIS SOFTWARE IS PROVIDED BY ATMEL "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE EXPRESSLY AND SPECIFICALLY DISCLAIMED. IN NO EVENT SHALL ATMEL BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. 
<p>Definition in file <a class="el" href="smbus_8c-source.html">smbus.c</a>.</p>

<p>
<code>#include &quot;<a class="el" href="common_8h-source.html">common.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="smbus_8h-source.html">smbus.h</a>&quot;</code><br>
<code>#include &quot;SBS_commands.h&quot;</code><br>
<code>#include &quot;<a class="el" href="sm__bus_2interpreter_8h-source.html">interpreter.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="timer_8h-source.html">timer.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="battery__pack__parameters_8h-source.html">battery_pack_parameters.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="gas__gauging_8h-source.html">gas_gauging.h</a>&quot;</code><br>

<p>
<div class="dynheader">
Include dependency graph for smbus.c:</div>
<div class="dynsection">
<p><center><img src="smbus_8c__incl.gif" border="0" usemap="#lib_mcu/sm_bus/smbus.c_map" alt=""></center>
<map name="lib_mcu/sm_bus/smbus.c_map">
<area shape="rect" href="common_8h.html" title="Common headerfile." alt="" coords="401,304,484,331"><area shape="rect" href="smbus_8h.html" title="Headerfile for smbus.c." alt="" coords="165,80,237,107"><area shape="rect" href="sm__bus_2interpreter_8h.html" title="SMBus Protocol command interpreter." alt="" coords="383,80,473,107"><area shape="rect" href="timer_8h.html" title="Headerfile for timer.c." alt="" coords="497,80,559,107"><area shape="rect" href="battery__pack__parameters_8h.html" title="Definition file for a smart battery pack." alt="" coords="264,155,443,181"><area shape="rect" href="gas__gauging_8h.html" title="Gas gauging module for calculating time to empty, time to full etc." alt="" coords="583,80,687,107"><area shape="rect" href="stdint_8h.html" title="stdint.h" alt="" coords="284,379,348,405"><area shape="rect" href="error_8h.html" title="error.h" alt="" coords="537,379,596,405"><area shape="rect" href="sbs__commands_8h.html" title="Headerfile for sbs_commands.c." alt="" coords="471,229,593,256"><area shape="rect" href="vadc_8h.html" title="Headerfile for vadc_usage.c." alt="" coords="17,229,76,256"><area shape="rect" href="battery__protection_8h.html" title="Header file for Battery Protection peripheral module driver." alt="" coords="100,229,236,256"><area shape="rect" href="battery__current__monitoring_8h.html" title="Header file for CC&#45;ADC result processing firmware module." alt="" coords="260,229,447,256"><area shape="rect" href="crc16_8h.html" title="Header file for CRC16 functions." alt="" coords="191,304,255,331"><area shape="rect" href="cc__gas__gauging_8h.html" title="Gas gauging header file." alt="" coords="623,155,748,181"><area shape="rect" href="voltage__based__SoC_8h.html" title="Contains defines, typedefinitions and functions prototypes for voltage_based_SoC..." alt="" coords="772,155,919,181"></map>
</div>

<p>
<a href="smbus_8c-source.html">Go to the source code of this file.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="smbus_8c.html#ae08ff0a047918e0245782dd183dad98">MODULE_SMBUS</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="smbus_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="smbus_8c.html#07b00aac11ba389d5b53e2f9d54bd0bd">SMB_GotCmdData</a>&nbsp;&nbsp;&nbsp;4</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="smbus_8c.html#1fef3300524ef987fa146cc892813b20">SMB_SetUpReply</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td colspan="2"><br><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">enum &nbsp;</td><td class="memItemRight" valign="bottom">{ <br>
&nbsp;&nbsp;<a class="el" href="smbus_8c.html#bed82baf7f470b522273a3e37c24c600b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a> = 0, 
<a class="el" href="smbus_8c.html#bed82baf7f470b522273a3e37c24c600ce05baed30278f132f7d9d27a502e7a0">TW_Wait4Stop</a>, 
<a class="el" href="smbus_8c.html#bed82baf7f470b522273a3e37c24c60094d13a4b6be6ef4404b13908d933e1ad">TW_Wait4Cmd</a>, 
<a class="el" href="smbus_8c.html#bed82baf7f470b522273a3e37c24c600bc8bda251da4d6aae1c2bfb2900c1444">TW_Wait4RW</a>, 
<br>
&nbsp;&nbsp;<a class="el" href="smbus_8c.html#bed82baf7f470b522273a3e37c24c600e4714c204fd9c4052ca3208a63493baa">TW_Wait4Data</a>, 
<a class="el" href="smbus_8c.html#bed82baf7f470b522273a3e37c24c60083d27cae0915c8a8002877623dcb0dc9">TW_ReplyData</a>
<br>
 }</td></tr>

<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="smbus_8c.html#2bab1f3bd066faa428e782b7417bc18a">Comm_Flag</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Check Communication Status.  <a href="#2bab1f3bd066faa428e782b7417bc18a"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="smbus_8c.html#bebcf5dbdcea576a31271721d411de4d">Comm_Handle</a> (<a class="el" href="unionSBS__command__union.html">SBS_command_t</a> *sbsCmdDestination)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Parse command.  <a href="#bebcf5dbdcea576a31271721d411de4d"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="smbus_8c.html#98a59b5ab5cde59154465aab070afa30">Comm_Init</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Initialize TWI module.  <a href="#98a59b5ab5cde59154465aab070afa30"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="smbus_8c.html#671390135cd0d30125661704332715a5">Comm_IsIdle</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Check Communication State.  <a href="#671390135cd0d30125661704332715a5"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="smbus_8c.html#1efd4641b8a2e2b7d2daddb0b38245a6">Comm_SbsBlockCommandReply</a> (<a class="el" href="unionSBS__command__union.html">SBS_command_t</a> *<a class="el" href="main_8c.html#79cdcc825d6c642cfb1115bb757a4e82">sbsReply</a>)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Reply to a SBS read block command.  <a href="#1efd4641b8a2e2b7d2daddb0b38245a6"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="smbus_8c.html#6f68436ccb337585587e7fa8ca888bda">Comm_SbsWordCommandReply</a> (<a class="el" href="unionSBS__command__union.html">SBS_command_t</a> *<a class="el" href="main_8c.html#79cdcc825d6c642cfb1115bb757a4e82">sbsReply</a>)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Reply to a SBS read word command.  <a href="#6f68436ccb337585587e7fa8ca888bda"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e">SMB_PEC</a> (<a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> lastCRC, <a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> newByte)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="smbus_8c.html#a43740bb86658af2f20234cc35e87e1c">SMB_RestoreBus</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">__interrupt void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="smbus_8c.html#1f03d433517342e03440452013989dc4">TWI_ISR</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">__interrupt void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="smbus_8c.html#6ad83522570a9dfb8df36852769b5393">TWICD_ISR</a> (void)</td></tr>

<tr><td colspan="2"><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="smbus_8c.html#c0a0963896d590350fbb796f490ebd02">CurrentCmd</a> = 0xFF</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="smbus_8c.html#073f6663e89074a86174c10ad3b88a73">SMLOCK</a> = 0</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="smbus_8c.html#3d8e137fcafe4a844f4c783f5b62b2f0">TEST50US</a> = 0</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="smbus_8c.html#2ba11b9846337754474c2db586742246">TW_RxBuf</a> [36]</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#ef44329758059c91c76d334e8fc09700">int8_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="smbus_8c.html#93d72a4a884264836af00f4d32ab677e">TW_RxBufCnt</a> = 0</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="smbus_8c.html#6fb4d146b64f434730a82e2a4f10cee0">TW_RxBufIndex</a> = 0</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="smbus_8c.html#639bcaf149615285a706ea342add17d7">TW_TxBuf</a> [36]</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="smbus_8c.html#8b0021b979a3e0d2abf84c558f0022a0">TW_TxBufCnt</a> = 0</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="smbus_8c.html#eb6c852ef5c3ebe1a21b5c00de980185">TW_TxBufIndex</a> = 0</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">volatile <a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="smbus_8c.html#5d7f64488757c7f3316d68bfdea76a6d">TWI_CmdFlags</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="smbus_8c.html#988a0e4620a54c9475e880542c2c2df6">TWISR_state</a> = TW_IDLE</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="smbus_8c.html#ef8fe2dab8cfd0c7933a63418d64f462">UsePEC</a> = 0</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="ae08ff0a047918e0245782dd183dad98"></a><!-- doxytag: member="smbus.c::MODULE_SMBUS" ref="ae08ff0a047918e0245782dd183dad98" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MODULE_SMBUS          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="smbus_8c-source.html#l00051">51</a> of file <a class="el" href="smbus_8c-source.html">smbus.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="75ae04e7aaa973e59f86209a3e8f7d3c"></a><!-- doxytag: member="smbus.c::SMB_GenBusTimeout" ref="75ae04e7aaa973e59f86209a3e8f7d3c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define SMB_GenBusTimeout&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="smbus_8c-source.html#l00085">85</a> of file <a class="el" href="smbus_8c-source.html">smbus.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="07b00aac11ba389d5b53e2f9d54bd0bd"></a><!-- doxytag: member="smbus.c::SMB_GotCmdData" ref="07b00aac11ba389d5b53e2f9d54bd0bd" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define SMB_GotCmdData&nbsp;&nbsp;&nbsp;4          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="smbus_8c-source.html#l00087">87</a> of file <a class="el" href="smbus_8c-source.html">smbus.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="1fef3300524ef987fa146cc892813b20"></a><!-- doxytag: member="smbus.c::SMB_SetUpReply" ref="1fef3300524ef987fa146cc892813b20" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define SMB_SetUpReply&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="smbus_8c-source.html#l00086">86</a> of file <a class="el" href="smbus_8c-source.html">smbus.c</a>.</p>

</div>
</div><p>
<hr><h2>Enumeration Type Documentation</h2>
<a class="anchor" name="bed82baf7f470b522273a3e37c24c600"></a><!-- doxytag: member="smbus.c::@8" ref="bed82baf7f470b522273a3e37c24c600" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">anonymous enum          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<dl compact><dt><b>Enumerator: </b></dt><dd>
<table border="0" cellspacing="2" cellpadding="0">
<tr><td valign="top"><em><a class="anchor" name="bed82baf7f470b522273a3e37c24c600b2ed574d9e01f56cd38bf441a8085640"></a><!-- doxytag: member="TW_IDLE" ref="bed82baf7f470b522273a3e37c24c600b2ed574d9e01f56cd38bf441a8085640" args="" -->TW_IDLE</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" name="bed82baf7f470b522273a3e37c24c600ce05baed30278f132f7d9d27a502e7a0"></a><!-- doxytag: member="TW_Wait4Stop" ref="bed82baf7f470b522273a3e37c24c600ce05baed30278f132f7d9d27a502e7a0" args="" -->TW_Wait4Stop</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" name="bed82baf7f470b522273a3e37c24c60094d13a4b6be6ef4404b13908d933e1ad"></a><!-- doxytag: member="TW_Wait4Cmd" ref="bed82baf7f470b522273a3e37c24c60094d13a4b6be6ef4404b13908d933e1ad" args="" -->TW_Wait4Cmd</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" name="bed82baf7f470b522273a3e37c24c600bc8bda251da4d6aae1c2bfb2900c1444"></a><!-- doxytag: member="TW_Wait4RW" ref="bed82baf7f470b522273a3e37c24c600bc8bda251da4d6aae1c2bfb2900c1444" args="" -->TW_Wait4RW</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" name="bed82baf7f470b522273a3e37c24c600e4714c204fd9c4052ca3208a63493baa"></a><!-- doxytag: member="TW_Wait4Data" ref="bed82baf7f470b522273a3e37c24c600e4714c204fd9c4052ca3208a63493baa" args="" -->TW_Wait4Data</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" name="bed82baf7f470b522273a3e37c24c60083d27cae0915c8a8002877623dcb0dc9"></a><!-- doxytag: member="TW_ReplyData" ref="bed82baf7f470b522273a3e37c24c60083d27cae0915c8a8002877623dcb0dc9" args="" -->TW_ReplyData</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>Definition at line <a class="el" href="smbus_8c-source.html#l00333">333</a> of file <a class="el" href="smbus_8c-source.html">smbus.c</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00333"></a>00333 {<a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>=0, <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5ce05baed30278f132f7d9d27a502e7a0">TW_Wait4Stop</a>, <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b594d13a4b6be6ef4404b13908d933e1ad">TW_Wait4Cmd</a>, <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5bc8bda251da4d6aae1c2bfb2900c1444">TW_Wait4RW</a>, <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5e4714c204fd9c4052ca3208a63493baa">TW_Wait4Data</a>, <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b583d27cae0915c8a8002877623dcb0dc9">TW_ReplyData</a> };
</pre></div>
<p>

</div>
</div><p>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="2bab1f3bd066faa428e782b7417bc18a"></a><!-- doxytag: member="smbus.c::Comm_Flag" ref="2bab1f3bd066faa428e782b7417bc18a" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> Comm_Flag           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Check Communication Status. 
<p>
This function returns 0, if it is nothing to handle. If it is &gt; 0, then execute <a class="el" href="communication_8c.html#bebcf5dbdcea576a31271721d411de4d" title="Parse command.">Comm_Handle()</a><p>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>0 if there is nothing to handle, &gt; 0 there is </dd></dl>

<p>Definition at line <a class="el" href="smbus_8c-source.html#l00669">669</a> of file <a class="el" href="smbus_8c-source.html">smbus.c</a>.</p>

<p>References <a class="el" href="communication_8c-source.html#l00416">TWISR_state</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00670"></a>00670 {
<a name="l00671"></a>00671     <span class="keywordflow">return</span> <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a>;  <span class="comment">// TW_IDLE=0</span>
<a name="l00672"></a>00672 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="bebcf5dbdcea576a31271721d411de4d"></a><!-- doxytag: member="smbus.c::Comm_Handle" ref="bebcf5dbdcea576a31271721d411de4d" args="(SBS_command_t *sbsCmdDestination)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool Comm_Handle           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="unionSBS__command__union.html">SBS_command_t</a> *&nbsp;</td>
          <td class="paramname"> <em>sbsCmdDestination</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Parse command. 
<p>
Check the command and send message to SBS for the protocol layer<p>
It is important that if this function return true (receive is complete) that it is handles before this function is called again<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>sbsCmdDestination</em>&nbsp;</td><td>Where to save the incoming data</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>True if a new command has been received and transferred to the destination buffer. </dd></dl>

<p>Definition at line <a class="el" href="smbus_8c-source.html#l00216">216</a> of file <a class="el" href="smbus_8c-source.html">smbus.c</a>.</p>

<p>References <a class="el" href="sbs__commands_8h-source.html#l00123">SBS_command_union::command</a>, <a class="el" href="communication_8c-source.html#l00091">CurrentCmd</a>, <a class="el" href="sbs__commands_8h-source.html#l00126">SBS_command_union::payload</a>, <a class="el" href="communication_8h-source.html#l00082">SBS_READ</a>, <a class="el" href="communication_8h-source.html#l00081">SBS_WRITE</a>, <a class="el" href="timer_8c-source.html#l00243">SetGenericTimer()</a>, <a class="el" href="communication_8c-source.html#l00087">SMB_GenBusTimeout</a>, <a class="el" href="communication_8c-source.html#l00089">SMB_GotCmdData</a>, <a class="el" href="smbus_8c-source.html#l00709">SMB_PEC()</a>, <a class="el" href="communication_8c-source.html#l00088">SMB_SetUpReply</a>, <a class="el" href="timer_8h-source.html#l00080">SMBfaultTimer</a>, <a class="el" href="communication_8c-source.html#l00076">TW_RxBuf</a>, <a class="el" href="communication_8c-source.html#l00077">TW_RxBufCnt</a>, <a class="el" href="communication_8c-source.html#l00078">TW_RxBufIndex</a>, <a class="el" href="communication_8c-source.html#l00073">TW_TxBufCnt</a>, <a class="el" href="communication_8c-source.html#l00074">TW_TxBufIndex</a>, <a class="el" href="communication_8c-source.html#l00086">TWI_CmdFlags</a>, and <a class="el" href="communication_8c-source.html#l00092">UsePEC</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00217"></a>00217 {
<a name="l00218"></a>00218     <span class="keywordtype">bool</span> receiveComplete = <span class="keyword">false</span>;
<a name="l00219"></a>00219     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> temp = 0;
<a name="l00220"></a>00220     
<a name="l00221"></a>00221     <span class="keywordflow">switch</span>(<a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a>)
<a name="l00222"></a>00222     {
<a name="l00223"></a>00223         <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>: <span class="comment">//The ISR detected an error condition.</span>
<a name="l00224"></a>00224         
<a name="l00225"></a>00225         <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = 0;           <span class="comment">//clear the flag that brought us here.</span>
<a name="l00226"></a>00226         sbsCmdDestination-&gt;<a class="code" href="unionSBS__command__union.html#6100200cb255940c793af26657713005">command</a> = (<a class="code" href="sbs__commands_8h.html#c0a1d53cdf5fb4745cd0dbbac35e97f2">SBS_commands_t</a>) 0xFF;         <span class="comment">//clear command register</span>
<a name="l00227"></a>00227         <span class="comment">//start the 26mS timer.  When it is done, the Timer handler will re-init the TWI peripheral.</span>
<a name="l00228"></a>00228         <a class="code" href="timer_8c.html#3ad6d4c2cd213c29e403adeff96c71d4">SetGenericTimer</a>(<a class="code" href="timer_8h.html#1e9c8bb728946234c7ca94eefed0d4c1">SMBfaultTimer</a>, 26);
<a name="l00229"></a>00229         <span class="keywordflow">break</span>;
<a name="l00230"></a>00230         
<a name="l00231"></a>00231         <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#1fef3300524ef987fa146cc892813b20">SMB_SetUpReply</a>:       <span class="comment">//interpret a 'Read' Command.</span>
<a name="l00232"></a>00232         <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = 0;           <span class="comment">//clear the flag that brought us here.</span>
<a name="l00233"></a>00233         <a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a> = 0;          <span class="comment">//initialize</span>
<a name="l00234"></a>00234         <a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a> = 0;            <span class="comment">//initialize</span>
<a name="l00235"></a>00235         sbsCmdDestination-&gt;<a class="code" href="unionSBS__command__union.html#6100200cb255940c793af26657713005">command</a> = (<a class="code" href="sbs__commands_8h.html#c0a1d53cdf5fb4745cd0dbbac35e97f2">SBS_commands_t</a>) (<a class="code" href="communication_8c.html#50d57ab7cb03b10099411f378522dadd">CurrentCmd</a> | <a class="code" href="communication_8h.html#75189763dbbb96aa3f1e34262bab6382">SBS_READ</a>);
<a name="l00236"></a>00236         receiveComplete = <span class="keyword">true</span>;
<a name="l00237"></a>00237         <span class="keywordflow">break</span>;
<a name="l00238"></a>00238         
<a name="l00239"></a>00239         <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#07b00aac11ba389d5b53e2f9d54bd0bd">SMB_GotCmdData</a>:    <span class="comment">//process some received command+data.</span>
<a name="l00240"></a>00240         <span class="comment">//NOTE: as of 6/17/2005, TWI_CmdFlags should NOT be cleared until we are</span>
<a name="l00241"></a>00241         <span class="comment">// completely done processing this message, else the TWI ISR will overwrite</span>
<a name="l00242"></a>00242         <span class="comment">// the RX buffer and won't respond with BUSY as it should.  Note also that</span>
<a name="l00243"></a>00243         <span class="comment">// the TWI is fully re-enabled when entering here, so we MUST NOT write</span>
<a name="l00244"></a>00244         <span class="comment">// to any of the TWI h/w registers or we could create havoc.  -rgf</span>
<a name="l00245"></a>00245         <span class="keywordflow">if</span>(<a class="code" href="communication_8c.html#fd9b3e99365b45af6cf763b2dda41546">UsePEC</a>)              <span class="comment">//check the CRC of the received packet.</span>
<a name="l00246"></a>00246         {
<a name="l00247"></a>00247             temp = 0;               <span class="comment">//use this as our CRC value.</span>
<a name="l00248"></a>00248             
<a name="l00249"></a>00249             <span class="keywordflow">do</span>{
<a name="l00250"></a>00250                 temp = <a class="code" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e">SMB_PEC</a>(temp, <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[<a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>++]);
<a name="l00251"></a>00251             }<span class="keywordflow">while</span>(<a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> != <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>);
<a name="l00252"></a>00252             
<a name="l00253"></a>00253             <span class="keywordflow">if</span>(temp)    <span class="comment">//The result of a CRC check SHOULD be =0 if all was ok.</span>
<a name="l00254"></a>00254             {
<a name="l00255"></a>00255                 <span class="comment">//start the 26mS timer to generate a bus timeout error.</span>
<a name="l00256"></a>00256                 <a class="code" href="timer_8c.html#3ad6d4c2cd213c29e403adeff96c71d4">SetGenericTimer</a>(<a class="code" href="timer_8h.html#1e9c8bb728946234c7ca94eefed0d4c1">SMBfaultTimer</a>, 26);
<a name="l00257"></a>00257                 receiveComplete = <span class="keyword">false</span>;
<a name="l00258"></a>00258                 <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = 0;           <span class="comment">//clear the flag that brought us here.</span>
<a name="l00259"></a>00259                 <span class="keywordflow">break</span>;
<a name="l00260"></a>00260             }
<a name="l00261"></a>00261         }
<a name="l00262"></a>00262         
<a name="l00263"></a>00263         <span class="comment">//If more bytes than a word, a block has been received and omit length byte</span>
<a name="l00264"></a>00264         <span class="comment">// Addr + Cmd + DataWord = 4 bytes</span>
<a name="l00265"></a>00265         <span class="keywordflow">if</span>(<a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> &gt; 4){
<a name="l00266"></a>00266             <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a> = 3;      <span class="comment">//Start of data in block</span>
<a name="l00267"></a>00267         }<span class="keywordflow">else</span>{
<a name="l00268"></a>00268             <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a> = 2;      <span class="comment">//Start of data in word</span>
<a name="l00269"></a>00269         }
<a name="l00270"></a>00270         
<a name="l00271"></a>00271         temp = 0;
<a name="l00272"></a>00272         
<a name="l00273"></a>00273         <span class="keywordflow">do</span>{
<a name="l00274"></a>00274             sbsCmdDestination-&gt;<a class="code" href="unionSBS__command__union.html#e4854b8a4616b897278934082725e41f">payload</a>[temp++] = <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[<a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>++];
<a name="l00275"></a>00275         }<span class="keywordflow">while</span>(<a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> != <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>);
<a name="l00276"></a>00276         
<a name="l00277"></a>00277         sbsCmdDestination-&gt;<a class="code" href="unionSBS__command__union.html#6100200cb255940c793af26657713005">command</a> = (<a class="code" href="sbs__commands_8h.html#c0a1d53cdf5fb4745cd0dbbac35e97f2">SBS_commands_t</a>) (<a class="code" href="communication_8c.html#50d57ab7cb03b10099411f378522dadd">CurrentCmd</a> | <a class="code" href="communication_8h.html#d5500c9b9dd285eaa77e28413d7258df">SBS_WRITE</a>);
<a name="l00278"></a>00278         receiveComplete = <span class="keyword">true</span>;
<a name="l00279"></a>00279 
<a name="l00280"></a>00280         <span class="comment">//At this point it looks like everything went OK.</span>
<a name="l00281"></a>00281         <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a> = 0;      <span class="comment">//Wipe out anything in the buffer, just in case.</span>
<a name="l00282"></a>00282         <a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> = 0;            
<a name="l00283"></a>00283         <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = 0;           <span class="comment">//clear the flag that brought us here.</span>
<a name="l00284"></a>00284         <span class="keywordflow">break</span>;
<a name="l00285"></a>00285         <span class="keywordflow">default</span>:
<a name="l00286"></a>00286         receiveComplete = <span class="keyword">false</span>;
<a name="l00287"></a>00287     }
<a name="l00288"></a>00288     
<a name="l00289"></a>00289     <span class="keywordflow">return</span> receiveComplete;
<a name="l00290"></a>00290 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<p><center><img src="smbus_8c_bebcf5dbdcea576a31271721d411de4d_cgraph.gif" border="0" usemap="#smbus_8c_bebcf5dbdcea576a31271721d411de4d_cgraph_map" alt=""></center>
<map name="smbus_8c_bebcf5dbdcea576a31271721d411de4d_cgraph_map">
<area shape="rect" href="timer_8c.html#3ad6d4c2cd213c29e403adeff96c71d4" title="SetGenericTimer" alt="" coords="161,5,279,32"><area shape="rect" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e" title="SMB_PEC" alt="" coords="179,56,261,83"></map>
</div>

</div>
</div><p>
<a class="anchor" name="98a59b5ab5cde59154465aab070afa30"></a><!-- doxytag: member="smbus.c::Comm_Init" ref="98a59b5ab5cde59154465aab070afa30" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Comm_Init           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Initialize TWI module. 
<p>
This function initializes the TWI module for SMBus operation. 
<p>Definition at line <a class="el" href="smbus_8c-source.html#l00104">104</a> of file <a class="el" href="smbus_8c-source.html">smbus.c</a>.</p>

<p>References <a class="el" href="communication_8c-source.html#l00826">SMB_RestoreBus()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00105"></a>00105 {
<a name="l00106"></a>00106     <a class="code" href="communication_8c.html#a43740bb86658af2f20234cc35e87e1c">SMB_RestoreBus</a>();
<a name="l00107"></a>00107 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<p><center><img src="smbus_8c_98a59b5ab5cde59154465aab070afa30_cgraph.gif" border="0" usemap="#smbus_8c_98a59b5ab5cde59154465aab070afa30_cgraph_map" alt=""></center>
<map name="smbus_8c_98a59b5ab5cde59154465aab070afa30_cgraph_map">
<area shape="rect" href="communication_8c.html#a43740bb86658af2f20234cc35e87e1c" title="SMB_RestoreBus" alt="" coords="139,5,264,32"></map>
</div>

</div>
</div><p>
<a class="anchor" name="671390135cd0d30125661704332715a5"></a><!-- doxytag: member="smbus.c::Comm_IsIdle" ref="671390135cd0d30125661704332715a5" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool Comm_IsIdle           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Check Communication State. 
<p>
This function returns true, if it is no ongoing comm. Then it is safe to enter psave<p>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>true if idle, false if busy </dd></dl>

<p>Definition at line <a class="el" href="smbus_8c-source.html#l00656">656</a> of file <a class="el" href="smbus_8c-source.html">smbus.c</a>.</p>

<p>References <a class="el" href="communication_8c-source.html#l00414">TW_IDLE</a>, and <a class="el" href="communication_8c-source.html#l00416">TWISR_state</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00657"></a>00657 {
<a name="l00658"></a>00658     <span class="keywordflow">return</span> (<a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a> == <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a>);
<a name="l00659"></a>00659 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="1efd4641b8a2e2b7d2daddb0b38245a6"></a><!-- doxytag: member="smbus.c::Comm_SbsBlockCommandReply" ref="1efd4641b8a2e2b7d2daddb0b38245a6" args="(SBS_command_t *sbsReply)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Comm_SbsBlockCommandReply           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="unionSBS__command__union.html">SBS_command_t</a> *&nbsp;</td>
          <td class="paramname"> <em>sbsReply</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Reply to a SBS read block command. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>sbsReply</em>&nbsp;</td><td>Is a pointer to the <a class="el" href="sbs__commands_8h.html#7951eae382c2d28b982454594bb80e21">SBS_command_t</a> struct containing the data to transmit. </td></tr>
  </table>
</dl>

<p>Definition at line <a class="el" href="smbus_8c-source.html#l00150">150</a> of file <a class="el" href="smbus_8c-source.html">smbus.c</a>.</p>

<p>References <a class="el" href="communication_8c-source.html#l00091">CurrentCmd</a>, <a class="el" href="sbs__commands_8h-source.html#l00126">SBS_command_union::payload</a>, <a class="el" href="sbs__commands_8h-source.html#l00059">SBSDATA_BLOCK_LENGTH</a>, <a class="el" href="smbus_8c-source.html#l00709">SMB_PEC()</a>, <a class="el" href="communication_8c-source.html#l00072">TW_TxBuf</a>, <a class="el" href="communication_8c-source.html#l00073">TW_TxBufCnt</a>, and <a class="el" href="communication_8c-source.html#l00074">TW_TxBufIndex</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00151"></a>00151 {
<a name="l00152"></a>00152     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> temp = 0;
<a name="l00153"></a>00153     
<a name="l00154"></a>00154     temp = <a class="code" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e">SMB_PEC</a>(temp, (TWAR &amp; 0xFE));    <span class="comment">//use the SLA+W address</span>
<a name="l00155"></a>00155     temp = <a class="code" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e">SMB_PEC</a>(temp, <a class="code" href="communication_8c.html#50d57ab7cb03b10099411f378522dadd">CurrentCmd</a>);
<a name="l00156"></a>00156     temp = <a class="code" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e">SMB_PEC</a>(temp, (TWAR | 1));   <span class="comment">//use the SLA+R address</span>
<a name="l00157"></a>00157     
<a name="l00158"></a>00158     <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[0] = <a class="code" href="sbs__commands_8h.html#0b02553f29b7aca194415268255042df" title="Defines the default length of any string in the smart battery data set.">SBSDATA_BLOCK_LENGTH</a>;<span class="comment">//Block Length</span>
<a name="l00159"></a>00159     temp = <a class="code" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e">SMB_PEC</a>(temp, <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[0]);
<a name="l00160"></a>00160     
<a name="l00161"></a>00161     <a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a> = 1;
<a name="l00162"></a>00162     <a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a> = <a class="code" href="sbs__commands_8h.html#0b02553f29b7aca194415268255042df" title="Defines the default length of any string in the smart battery data set.">SBSDATA_BLOCK_LENGTH</a>+1;
<a name="l00163"></a>00163     
<a name="l00164"></a>00164     <span class="keywordflow">do</span> {
<a name="l00165"></a>00165         <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[<a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a>] = (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) sbsReply-&gt;<a class="code" href="unionSBS__command__union.html#e4854b8a4616b897278934082725e41f">payload</a>[<a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a>-1];
<a name="l00166"></a>00166         temp = <a class="code" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e">SMB_PEC</a>(temp, <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[<a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a>++]);
<a name="l00167"></a>00167     }<span class="keywordflow">while</span>(<a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a> != <a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a>);
<a name="l00168"></a>00168     
<a name="l00169"></a>00169     <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[<a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a>] = temp; <span class="comment">//append the CRC value on the end.</span>
<a name="l00170"></a>00170     <a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a>++;          <span class="comment">//increase the byte count for the PEC.</span>
<a name="l00171"></a>00171     <a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a> = 0;      <span class="comment">//Reset the buffer pointer.</span>
<a name="l00172"></a>00172     TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//have TWI continue from where it stalled.</span>
<a name="l00173"></a>00173     
<a name="l00174"></a>00174     
<a name="l00175"></a>00175 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<p><center><img src="smbus_8c_1efd4641b8a2e2b7d2daddb0b38245a6_cgraph.gif" border="0" usemap="#smbus_8c_1efd4641b8a2e2b7d2daddb0b38245a6_cgraph_map" alt=""></center>
<map name="smbus_8c_1efd4641b8a2e2b7d2daddb0b38245a6_cgraph_map">
<area shape="rect" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e" title="SMB_PEC" alt="" coords="271,5,353,32"></map>
</div>

</div>
</div><p>
<a class="anchor" name="6f68436ccb337585587e7fa8ca888bda"></a><!-- doxytag: member="smbus.c::Comm_SbsWordCommandReply" ref="6f68436ccb337585587e7fa8ca888bda" args="(SBS_command_t *sbsReply)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Comm_SbsWordCommandReply           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="unionSBS__command__union.html">SBS_command_t</a> *&nbsp;</td>
          <td class="paramname"> <em>sbsReply</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Reply to a SBS read word command. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>sbsReply</em>&nbsp;</td><td>Is a pointer to the <a class="el" href="sbs__commands_8h.html#7951eae382c2d28b982454594bb80e21">SBS_command_t</a> struct containing the data to transmit. </td></tr>
  </table>
</dl>

<p>Definition at line <a class="el" href="smbus_8c-source.html#l00181">181</a> of file <a class="el" href="smbus_8c-source.html">smbus.c</a>.</p>

<p>References <a class="el" href="communication_8c-source.html#l00091">CurrentCmd</a>, <a class="el" href="sbs__commands_8h-source.html#l00126">SBS_command_union::payload</a>, <a class="el" href="smbus_8c-source.html#l00709">SMB_PEC()</a>, <a class="el" href="communication_8c-source.html#l00072">TW_TxBuf</a>, <a class="el" href="communication_8c-source.html#l00073">TW_TxBufCnt</a>, and <a class="el" href="communication_8c-source.html#l00074">TW_TxBufIndex</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00182"></a>00182 {
<a name="l00183"></a>00183     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> temp = 0;
<a name="l00184"></a>00184     
<a name="l00185"></a>00185     <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[0] = (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) sbsReply-&gt;<a class="code" href="unionSBS__command__union.html#e4854b8a4616b897278934082725e41f">payload</a>[0];
<a name="l00186"></a>00186     <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[1] = (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) sbsReply-&gt;<a class="code" href="unionSBS__command__union.html#e4854b8a4616b897278934082725e41f">payload</a>[1];;
<a name="l00187"></a>00187     
<a name="l00188"></a>00188     temp = <a class="code" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e">SMB_PEC</a>(temp, (TWAR &amp; 0xFE));    <span class="comment">//use the SLA+W address</span>
<a name="l00189"></a>00189     temp = <a class="code" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e">SMB_PEC</a>(temp, <a class="code" href="communication_8c.html#50d57ab7cb03b10099411f378522dadd">CurrentCmd</a>);
<a name="l00190"></a>00190     temp = <a class="code" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e">SMB_PEC</a>(temp, (TWAR | 1));   <span class="comment">//use the SLA+R address</span>
<a name="l00191"></a>00191 
<a name="l00192"></a>00192     <span class="comment">//Calculate PEC for Word</span>
<a name="l00193"></a>00193     temp = <a class="code" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e">SMB_PEC</a>(temp, <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[0]);
<a name="l00194"></a>00194     temp = <a class="code" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e">SMB_PEC</a>(temp, <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[1]);
<a name="l00195"></a>00195     
<a name="l00196"></a>00196     <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[2] = temp;     <span class="comment">//Append the CRC value on the end.</span>
<a name="l00197"></a>00197     <a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a> = 3;        <span class="comment">//Set the byte count for the Word + PEC.</span>
<a name="l00198"></a>00198     <a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a> = 0;      <span class="comment">//Reset the buffer pointer.</span>
<a name="l00199"></a>00199     
<a name="l00200"></a>00200     TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//have TWI continue from where it stalled.</span>
<a name="l00201"></a>00201 
<a name="l00202"></a>00202 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<p><center><img src="smbus_8c_6f68436ccb337585587e7fa8ca888bda_cgraph.gif" border="0" usemap="#smbus_8c_6f68436ccb337585587e7fa8ca888bda_cgraph_map" alt=""></center>
<map name="smbus_8c_6f68436ccb337585587e7fa8ca888bda_cgraph_map">
<area shape="rect" href="smbus_8c.html#c095e228dbfe422c65ad59a4aa6e535e" title="SMB_PEC" alt="" coords="268,5,351,32"></map>
</div>

</div>
</div><p>
<a class="anchor" name="c095e228dbfe422c65ad59a4aa6e535e"></a><!-- doxytag: member="smbus.c::SMB_PEC" ref="c095e228dbfe422c65ad59a4aa6e535e" args="(uint8_t lastCRC, uint8_t newByte)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> SMB_PEC           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>&nbsp;</td>
          <td class="paramname"> <em>lastCRC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>&nbsp;</td>
          <td class="paramname"> <em>newByte</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="smbus_8c-source.html#l00709">709</a> of file <a class="el" href="smbus_8c-source.html">smbus.c</a>.</p>

<p>References <a class="el" href="smbus_8h-source.html#l00228">SMB_PEC_CRC_POLYNOME</a>.</p>

<p>Referenced by <a class="el" href="smbus_8c-source.html#l00216">Comm_Handle()</a>, <a class="el" href="smbus_8c-source.html#l00150">Comm_SbsBlockCommandReply()</a>, and <a class="el" href="smbus_8c-source.html#l00181">Comm_SbsWordCommandReply()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00710"></a>00710 {
<a name="l00711"></a>00711     <span class="comment">// Initial XOR</span>
<a name="l00712"></a>00712     lastCRC ^= newByte;
<a name="l00713"></a>00713     
<a name="l00714"></a>00714     <span class="keywordflow">for</span>(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> i = 0; i &lt; 8; i++){
<a name="l00715"></a>00715         <span class="keywordflow">if</span> (lastCRC &amp; 0x80){
<a name="l00716"></a>00716             lastCRC = (lastCRC &lt;&lt; 1) ^ <a class="code" href="smbus_8h.html#4af28c4425ff1b83529f5269be120be3" title="The CRC polynome used in PEC calculation.">SMB_PEC_CRC_POLYNOME</a>;
<a name="l00717"></a>00717         }<span class="keywordflow">else</span>{
<a name="l00718"></a>00718             lastCRC &lt;&lt;= 1;
<a name="l00719"></a>00719         }
<a name="l00720"></a>00720     }
<a name="l00721"></a>00721     <span class="keywordflow">return</span> lastCRC;
<a name="l00722"></a>00722 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="a43740bb86658af2f20234cc35e87e1c"></a><!-- doxytag: member="smbus.c::SMB_RestoreBus" ref="a43740bb86658af2f20234cc35e87e1c" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void SMB_RestoreBus           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="smbus_8c-source.html#l00679">679</a> of file <a class="el" href="smbus_8c-source.html">smbus.c</a>.</p>

<p>References <a class="el" href="SMBSlave_8h-source.html#l00112">BATTERY_ADDR</a>, <a class="el" href="communication_8c-source.html#l00414">TW_IDLE</a>, and <a class="el" href="communication_8c-source.html#l00416">TWISR_state</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00680"></a>00680 {
<a name="l00681"></a>00681     TWCR = 0;               <span class="comment">//shut down the peripheral</span>
<a name="l00682"></a>00682     <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;  <span class="comment">//force an init of the state machine</span>
<a name="l00683"></a>00683     TWAR = <a class="code" href="SMBSlave_8h.html#fe8d42918d4038d5d5c20a30a661e57e">BATTERY_ADDR</a>&lt;&lt;1;         
<a name="l00684"></a>00684     TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);<span class="comment">// | (1&lt;&lt;TWSTO); // re-enable</span>
<a name="l00685"></a>00685     
<a name="l00686"></a>00686     <span class="comment">//Note that we must be careful not to generate some kind of bus error</span>
<a name="l00687"></a>00687     <span class="comment">// as a result of waking back up, or we will get into an endless loop</span>
<a name="l00688"></a>00688     <span class="comment">// by generating another bus timeout if the IDLE state doesn't like</span>
<a name="l00689"></a>00689     <span class="comment">// something it sees when it comes back to life.</span>
<a name="l00690"></a>00690 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="1f03d433517342e03440452013989dc4"></a><!-- doxytag: member="smbus.c::TWI_ISR" ref="1f03d433517342e03440452013989dc4" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__interrupt void TWI_ISR           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="smbus_8c-source.html#l00339">339</a> of file <a class="el" href="smbus_8c-source.html">smbus.c</a>.</p>

<p>References <a class="el" href="communication_8c-source.html#l00091">CurrentCmd</a>, <a class="el" href="SMBSlave_8h-source.html#l00040">HIGHEST_SMB_CMD</a>, <a class="el" href="communication_2interpreter_8h-source.html#l00069">SCRG</a>, <a class="el" href="communication_2interpreter_8h-source.html#l00067">SCRW</a>, <a class="el" href="communication_2interpreter_8h-source.html#l00070">SCWG</a>, <a class="el" href="communication_2interpreter_8h-source.html#l00068">SCWW</a>, <a class="el" href="timer_8c-source.html#l00243">SetGenericTimer()</a>, <a class="el" href="communication_2interpreter_8h-source.html#l00080">SM_Cmd_Table</a>, <a class="el" href="communication_8c-source.html#l00087">SMB_GenBusTimeout</a>, <a class="el" href="communication_8c-source.html#l00089">SMB_GotCmdData</a>, <a class="el" href="communication_8c-source.html#l00088">SMB_SetUpReply</a>, <a class="el" href="timer_8h-source.html#l00080">SMBfaultTimer</a>, <a class="el" href="communication_2interpreter_8h-source.html#l00066">SMBslave</a>, <a class="el" href="communication_8c-source.html#l00414">TW_IDLE</a>, <a class="el" href="communication_8c-source.html#l00414">TW_ReplyData</a>, <a class="el" href="communication_8c-source.html#l00076">TW_RxBuf</a>, <a class="el" href="communication_8c-source.html#l00077">TW_RxBufCnt</a>, <a class="el" href="communication_8c-source.html#l00078">TW_RxBufIndex</a>, <a class="el" href="communication_8c-source.html#l00072">TW_TxBuf</a>, <a class="el" href="communication_8c-source.html#l00073">TW_TxBufCnt</a>, <a class="el" href="communication_8c-source.html#l00074">TW_TxBufIndex</a>, <a class="el" href="communication_8c-source.html#l00414">TW_Wait4Cmd</a>, <a class="el" href="communication_8c-source.html#l00414">TW_Wait4Data</a>, <a class="el" href="communication_8c-source.html#l00414">TW_Wait4RW</a>, <a class="el" href="communication_8c-source.html#l00414">TW_Wait4Stop</a>, <a class="el" href="communication_8c-source.html#l00086">TWI_CmdFlags</a>, <a class="el" href="communication_8c-source.html#l00416">TWISR_state</a>, <a class="el" href="SMBSlave_8h-source.html#l00072">TWS_RACK</a>, <a class="el" href="SMBSlave_8h-source.html#l00069">TWS_RCMD</a>, <a class="el" href="SMBSlave_8h-source.html#l00068">TWS_RDATA</a>, <a class="el" href="SMBSlave_8h-source.html#l00071">TWS_REPEAT</a>, <a class="el" href="SMBSlave_8h-source.html#l00073">TWS_RNAK</a>, <a class="el" href="SMBSlave_8h-source.html#l00070">TWS_RSTOP</a>, <a class="el" href="SMBSlave_8h-source.html#l00067">TWS_SLA_R</a>, <a class="el" href="SMBSlave_8h-source.html#l00066">TWS_SLA_W</a>, and <a class="el" href="communication_8c-source.html#l00092">UsePEC</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00340"></a>00340 {
<a name="l00341"></a>00341     <span class="comment">//Command-related feature flags</span>
<a name="l00342"></a>00342     <span class="keyword">static</span> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> TWISR_CmdFeatures = 0;
<a name="l00343"></a>00343     
<a name="l00344"></a>00344     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> Status;
<a name="l00345"></a>00345     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> tmp;
<a name="l00346"></a>00346     
<a name="l00347"></a>00347     <span class="comment">//This identifies what caused the interrupt to fire.</span>
<a name="l00348"></a>00348     Status = TWSR &amp; 0xF8;
<a name="l00349"></a>00349     
<a name="l00350"></a>00350     <span class="keywordflow">switch</span>(<a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a>){
<a name="l00351"></a>00351         <span class="keywordflow">default</span>:
<a name="l00352"></a>00352 
<a name="l00353"></a>00353         <span class="comment">//If not SLA_W or RSTOP, is an error!</span>
<a name="l00354"></a>00354         <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>:
<a name="l00355"></a>00355         
<a name="l00356"></a>00356         <span class="comment">// Saw Slave address match with a Write bit</span>
<a name="l00357"></a>00357         <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#13ec926035138d61a7e90193645942ee">TWS_SLA_W</a> == Status)
<a name="l00358"></a>00358         {
<a name="l00359"></a>00359             <span class="keywordflow">if</span>(<a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> == <a class="code" href="communication_8c.html#07b00aac11ba389d5b53e2f9d54bd0bd">SMB_GotCmdData</a>)
<a name="l00360"></a>00360             {
<a name="l00361"></a>00361                 <a class="code" href="timer_8c.html#3ad6d4c2cd213c29e403adeff96c71d4">SetGenericTimer</a>(<a class="code" href="timer_8h.html#1e9c8bb728946234c7ca94eefed0d4c1">SMBfaultTimer</a>, 26);
<a name="l00362"></a>00362                 
<a name="l00363"></a>00363                 <span class="comment">//Assert that we're 'busy' to SMBus Master by leaving TWEA *off* until we get a STOP.</span>
<a name="l00364"></a>00364                 <span class="comment">//Note that this is 'legal' because we have ALREADY sent an ACK to our Slave Address,</span>
<a name="l00365"></a>00365                 <span class="comment">// as is required by the SMBus specification.</span>
<a name="l00366"></a>00366                 
<a name="l00367"></a>00367                 <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5ce05baed30278f132f7d9d27a502e7a0">TW_Wait4Stop</a>;
<a name="l00368"></a>00368                 TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//must NOT re-enable ACKing!</span>
<a name="l00369"></a>00369                 <span class="keywordflow">break</span>;
<a name="l00370"></a>00370             }
<a name="l00371"></a>00371             
<a name="l00372"></a>00372             <span class="comment">// Still waiting for command data.</span>
<a name="l00373"></a>00373             <span class="keywordflow">else</span>
<a name="l00374"></a>00374             {
<a name="l00375"></a>00375                 <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b594d13a4b6be6ef4404b13908d933e1ad">TW_Wait4Cmd</a>;
<a name="l00376"></a>00376             }
<a name="l00377"></a>00377         }
<a name="l00378"></a>00378         <span class="comment">//Saw a Stop, possibly left over from previous cmd.</span>
<a name="l00379"></a>00379         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#ea29a640c276fdaea02372a2c1ac5f78">TWS_RSTOP</a> == Status)
<a name="l00380"></a>00380         {
<a name="l00381"></a>00381             <span class="comment">//Everything is probably OK.  Take no action.</span>
<a name="l00382"></a>00382         }
<a name="l00383"></a>00383         
<a name="l00384"></a>00384         <span class="comment">// Had some type of error!</span>
<a name="l00385"></a>00385         <span class="keywordflow">else</span>
<a name="l00386"></a>00386         {
<a name="l00387"></a>00387             <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;  <span class="comment">//Generate a bus timeout.</span>
<a name="l00388"></a>00388             TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);      <span class="comment">//Disable int, and DON'T clear the TWINT flag!</span>
<a name="l00389"></a>00389             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;             <span class="comment">//Reset the state machine.</span>
<a name="l00390"></a>00390             <span class="keywordflow">break</span>;
<a name="l00391"></a>00391         }
<a name="l00392"></a>00392         TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//must re-enable ACKing</span>
<a name="l00393"></a>00393         <span class="keywordflow">break</span>;
<a name="l00394"></a>00394         
<a name="l00395"></a>00395 
<a name="l00396"></a>00396         <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5ce05baed30278f132f7d9d27a502e7a0">TW_Wait4Stop</a>:
<a name="l00397"></a>00397         <span class="comment">//Saw a Stop, possibly left over from previous cmd.</span>
<a name="l00398"></a>00398         <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#ea29a640c276fdaea02372a2c1ac5f78">TWS_RSTOP</a> == Status)
<a name="l00399"></a>00399         {
<a name="l00400"></a>00400             TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//must re-enable ACKing</span>
<a name="l00401"></a>00401             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;          <span class="comment">//Reset the state machine.</span>
<a name="l00402"></a>00402         }
<a name="l00403"></a>00403         <span class="comment">//Error! Did not see a stop as expected. NACKing the rest.</span>
<a name="l00404"></a>00404         <span class="keywordflow">else</span>
<a name="l00405"></a>00405         {
<a name="l00406"></a>00406             TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//must NOT re-enable ACKing yet!</span>
<a name="l00407"></a>00407         }
<a name="l00408"></a>00408         <span class="keywordflow">break</span>;
<a name="l00409"></a>00409         
<a name="l00410"></a>00410         
<a name="l00411"></a>00411         <span class="comment">//SLAVE-mode states follow.</span>
<a name="l00412"></a>00412         
<a name="l00413"></a>00413         <span class="comment">// Upon entry, we expect to have received a Cmd byte.</span>
<a name="l00414"></a>00414         <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b594d13a4b6be6ef4404b13908d933e1ad">TW_Wait4Cmd</a>:
<a name="l00415"></a>00415 
<a name="l00416"></a>00416         <span class="comment">//It appears that we have received a Command byte now.</span>
<a name="l00417"></a>00417         <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#494d83524c0a35a9680f8abf43538088">TWS_RCMD</a> == Status)
<a name="l00418"></a>00418         {
<a name="l00419"></a>00419             tmp = TWDR;
<a name="l00420"></a>00420             
<a name="l00421"></a>00421             <span class="comment">//Is the Cmd within valid range?</span>
<a name="l00422"></a>00422             <span class="keywordflow">if</span>(tmp &lt;= <a class="code" href="SMBSlave_8h.html#335910998ef911de0e71a0c1b059e565">HIGHEST_SMB_CMD</a>)
<a name="l00423"></a>00423             {
<a name="l00424"></a>00424                 <a class="code" href="communication_8c.html#50d57ab7cb03b10099411f378522dadd">CurrentCmd</a> = tmp;       <span class="comment">//Save a copy.</span>
<a name="l00425"></a>00425                 tmp = <a class="code" href="communication_2interpreter_8h.html#98f76d05b9eb74053793b1fc1835b663">SM_Cmd_Table</a>[tmp][0]; <span class="comment">//Grab the Command Characteristics/Features flags.</span>
<a name="l00426"></a>00426                 <span class="keywordflow">if</span>(tmp &amp; <a class="code" href="communication_2interpreter_8h.html#3ffa90cb904c7f395662aa7573e79b4f">SMBslave</a>)      <span class="comment">//Is the Command valid for Slaves?</span>
<a name="l00427"></a>00427                 {               <span class="comment">//The command appears to be valid.</span>
<a name="l00428"></a>00428                     TWISR_CmdFeatures = tmp;    <span class="comment">//Save the Feature flags for use in Wait4RW state.</span>
<a name="l00429"></a>00429                     <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5bc8bda251da4d6aae1c2bfb2900c1444">TW_Wait4RW</a>;   <span class="comment">//set up next state</span>
<a name="l00430"></a>00430                     TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//enable ACKing</span>
<a name="l00431"></a>00431                     <span class="keywordflow">break</span>;
<a name="l00432"></a>00432                 }
<a name="l00433"></a>00433             }
<a name="l00434"></a>00434         }
<a name="l00435"></a>00435         <span class="comment">//In all cases except those that 'break' (above), it's an error.</span>
<a name="l00436"></a>00436         <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;  <span class="comment">//Generate a bus timeout.</span>
<a name="l00437"></a>00437         TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);      <span class="comment">//Disable int, and DON'T clear the TWINT flag!</span>
<a name="l00438"></a>00438         <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;             <span class="comment">//Reset the state machine.</span>
<a name="l00439"></a>00439         <span class="keywordflow">break</span>;
<a name="l00440"></a>00440         
<a name="l00441"></a>00441         <span class="comment">//We will now find out if we will RX more, or we need to TX a reply instead.</span>
<a name="l00442"></a>00442         <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5bc8bda251da4d6aae1c2bfb2900c1444">TW_Wait4RW</a>:
<a name="l00443"></a>00443         
<a name="l00444"></a>00444         <span class="comment">//It is a WRITE-type command. Prep the RX buffer to accept more data.</span>
<a name="l00445"></a>00445         <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#be4452976a52cc5e091f32ead12669ce">TWS_RDATA</a> == Status)
<a name="l00446"></a>00446         {
<a name="l00447"></a>00447             <span class="comment">//NOTE: except for OptionalMfgFunction5, all WRITE cmds are 2-byte, plus optional PEC.</span>
<a name="l00448"></a>00448             <span class="comment">//Place all bytes of the transaction into the buffer so we can do a PEC on it if needed.</span>
<a name="l00449"></a>00449             
<a name="l00450"></a>00450             <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[0] = TWAR &amp; 0xFE;  <span class="comment">//store everything incl. the slave address for computing PEC.</span>
<a name="l00451"></a>00451             <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[1] = <a class="code" href="communication_8c.html#50d57ab7cb03b10099411f378522dadd">CurrentCmd</a>;   <span class="comment">//store the previously-send Command.</span>
<a name="l00452"></a>00452             <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[2] = TWDR;     <span class="comment">//store this first DATA byte</span>
<a name="l00453"></a>00453             <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a> = 3;      <span class="comment">//use RxBufIndex as the index to store data in the buffer.</span>
<a name="l00454"></a>00454             
<a name="l00455"></a>00455             <span class="comment">//Is it a Write-WORD command type?</span>
<a name="l00456"></a>00456             <span class="keywordflow">if</span>(TWISR_CmdFeatures &amp; <a class="code" href="communication_2interpreter_8h.html#1200a2673b359fcd7568b69b684cc625">SCWW</a>)
<a name="l00457"></a>00457             {
<a name="l00458"></a>00458                 <a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> = 1;        <span class="comment">//We expect 1 more data byte, and possibly PEC after that.</span>
<a name="l00459"></a>00459             }
<a name="l00460"></a>00460             
<a name="l00461"></a>00461             <span class="comment">//Is it a write-BLOCK command (must be OptionalMfgFunction5 then)</span>
<a name="l00462"></a>00462             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(TWISR_CmdFeatures &amp; <a class="code" href="communication_2interpreter_8h.html#fb396475fb3fa7a935530e516e420c76">SCWG</a>)
<a name="l00463"></a>00463             {
<a name="l00464"></a>00464                 tmp = TWDR;
<a name="l00465"></a>00465                 <span class="keywordflow">if</span>((tmp &gt;= 1) &amp;&amp; (tmp &lt;= 32))
<a name="l00466"></a>00466                     <a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> = TWDR;
<a name="l00467"></a>00467                 <span class="keywordflow">else</span>
<a name="l00468"></a>00468                 {
<a name="l00469"></a>00469                     <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;  <span class="comment">//Generate a bus timeout.</span>
<a name="l00470"></a>00470                     TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);      <span class="comment">//Disable int, and DON'T clear the TWINT flag!</span>
<a name="l00471"></a>00471                     <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;             <span class="comment">//Reset the state machine.</span>
<a name="l00472"></a>00472                     <span class="keywordflow">break</span>;
<a name="l00473"></a>00473                 }
<a name="l00474"></a>00474             }
<a name="l00475"></a>00475 
<a name="l00476"></a>00476             <span class="comment">//Error! This Command doesn't allow EITHER word OR group/block Writes! It's Read-only!</span>
<a name="l00477"></a>00477             <span class="keywordflow">else</span>
<a name="l00478"></a>00478             {
<a name="l00479"></a>00479                 <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;  <span class="comment">//Generate a bus timeout.</span>
<a name="l00480"></a>00480                 TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);      <span class="comment">//Disable int, and DON'T clear the TWINT flag!</span>
<a name="l00481"></a>00481                 <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;             <span class="comment">//Reset the state machine.</span>
<a name="l00482"></a>00482                 <span class="keywordflow">break</span>;
<a name="l00483"></a>00483             }
<a name="l00484"></a>00484             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5e4714c204fd9c4052ca3208a63493baa">TW_Wait4Data</a>;
<a name="l00485"></a>00485             TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//enable ACKing</span>
<a name="l00486"></a>00486         }
<a name="l00487"></a>00487         
<a name="l00488"></a>00488         <span class="comment">//We saw a re-Start, so must be getting ready for a Read cmd.</span>
<a name="l00489"></a>00489         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#6ab2d53631ce164e3cd5fb1d1d1658ab">TWS_REPEAT</a> == Status)
<a name="l00490"></a>00490         {   
<a name="l00491"></a>00491             <span class="comment">//Must now interpret previously-sent CurrentCmd &amp; set up Reply data.</span>
<a name="l00492"></a>00492             
<a name="l00493"></a>00493             <span class="comment">//Is it a 'ReadWord' or 'ReadGroup' command type?</span>
<a name="l00494"></a>00494             <span class="keywordflow">if</span>(TWISR_CmdFeatures &amp; (<a class="code" href="communication_2interpreter_8h.html#a85af9d88231ee9fe08e31e03ba2d11b">SCRW</a> | <a class="code" href="communication_2interpreter_8h.html#f5e6b90ad1abedbf1c8b369dca830d8a">SCRG</a>))
<a name="l00495"></a>00495             {
<a name="l00496"></a>00496                 <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#1fef3300524ef987fa146cc892813b20">SMB_SetUpReply</a>;    <span class="comment">//Foreground decoder will set up TWCR.</span>
<a name="l00497"></a>00497                 <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b583d27cae0915c8a8002877623dcb0dc9">TW_ReplyData</a>;       <span class="comment">//Move to next state.</span>
<a name="l00498"></a>00498             }
<a name="l00499"></a>00499 
<a name="l00500"></a>00500             <span class="comment">//Error! Not a valid read command.</span>
<a name="l00501"></a>00501             <span class="keywordflow">else</span>
<a name="l00502"></a>00502             {
<a name="l00503"></a>00503                 <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;  <span class="comment">//Generate a bus timeout.</span>
<a name="l00504"></a>00504                 TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);      <span class="comment">//Disable int, and DON'T clear the TWINT flag!</span>
<a name="l00505"></a>00505                 <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;             <span class="comment">//Reset the state machine.</span>
<a name="l00506"></a>00506                 <span class="keywordflow">break</span>;
<a name="l00507"></a>00507             }
<a name="l00508"></a>00508             TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);         <span class="comment">//disable int, and DON'T clear the TWINT flag!</span>
<a name="l00509"></a>00509         }
<a name="l00510"></a>00510         
<a name="l00511"></a>00511         <span class="comment">// Some type of error!</span>
<a name="l00512"></a>00512         <span class="keywordflow">else</span>
<a name="l00513"></a>00513         {
<a name="l00514"></a>00514             <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;  <span class="comment">//Generate a bus timeout.</span>
<a name="l00515"></a>00515             TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);      <span class="comment">//Disable int, and DON'T clear the TWINT flag!</span>
<a name="l00516"></a>00516             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;             <span class="comment">//Reset the state machine.</span>
<a name="l00517"></a>00517             <span class="keywordflow">break</span>;
<a name="l00518"></a>00518         }
<a name="l00519"></a>00519         <span class="keywordflow">break</span>;
<a name="l00520"></a>00520         
<a name="l00521"></a>00521         
<a name="l00522"></a>00522         <span class="comment">//We are in Slave Receive operating mode.</span>
<a name="l00523"></a>00523         <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5e4714c204fd9c4052ca3208a63493baa">TW_Wait4Data</a>:
<a name="l00524"></a>00524 
<a name="l00525"></a>00525         <span class="comment">// Received a data byte.</span>
<a name="l00526"></a>00526         <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#be4452976a52cc5e091f32ead12669ce">TWS_RDATA</a> == Status) 
<a name="l00527"></a>00527         {
<a name="l00528"></a>00528             tmp = TWDR;
<a name="l00529"></a>00529             
<a name="l00530"></a>00530             <span class="comment">//Are we past the PEC byte and still getting more data?</span>
<a name="l00531"></a>00531             <span class="keywordflow">if</span>(--<a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> &lt; -1)
<a name="l00532"></a>00532             {
<a name="l00533"></a>00533                 <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;  <span class="comment">//Generate a bus timeout.</span>
<a name="l00534"></a>00534                 TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);      <span class="comment">//Disable int, and DON'T clear the TWINT flag!</span>
<a name="l00535"></a>00535                 <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;             <span class="comment">//Reset the state machine.</span>
<a name="l00536"></a>00536                 <span class="keywordflow">break</span>;
<a name="l00537"></a>00537             }
<a name="l00538"></a>00538             <span class="comment">//Store the byte in the buffer.</span>
<a name="l00539"></a>00539             <a class="code" href="communication_8c.html#7047349064b5667474f40f60b60bfa65">TW_RxBuf</a>[<a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>++] = tmp;
<a name="l00540"></a>00540         }
<a name="l00541"></a>00541     
<a name="l00542"></a>00542         <span class="comment">//Got a STOP; All done RXing data now.</span>
<a name="l00543"></a>00543         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#ea29a640c276fdaea02372a2c1ac5f78">TWS_RSTOP</a> == Status)
<a name="l00544"></a>00544         {
<a name="l00545"></a>00545             <span class="comment">//Note: If we get a STOP prematurely, then we simply ignore the command,</span>
<a name="l00546"></a>00546             <span class="comment">//since it is too late to inform the Master of the error.</span>
<a name="l00547"></a>00547             <span class="keywordflow">if</span>((<a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> &gt; 0) || (<a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> &lt; -1))
<a name="l00548"></a>00548             {
<a name="l00549"></a>00549                 <span class="comment">// We got a premature STOP or too much data; ERROR!</span>
<a name="l00550"></a>00550                 <span class="comment">// Error handling if needed.</span>
<a name="l00551"></a>00551             }
<a name="l00552"></a>00552             <span class="keywordflow">else</span>
<a name="l00553"></a>00553             {
<a name="l00554"></a>00554                 <span class="keywordflow">if</span>(0 == <a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a>){
<a name="l00555"></a>00555                     <a class="code" href="communication_8c.html#fd9b3e99365b45af6cf763b2dda41546">UsePEC</a> = 0;            <span class="comment">//there is no PEC coming for this packet.</span>
<a name="l00556"></a>00556                 }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(-1 == <a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a>){
<a name="l00557"></a>00557                     <a class="code" href="communication_8c.html#fd9b3e99365b45af6cf763b2dda41546">UsePEC</a> = 1;            <span class="comment">//PEC was included.</span>
<a name="l00558"></a>00558                 }
<a name="l00559"></a>00559                 
<a name="l00560"></a>00560                 <a class="code" href="communication_8c.html#70d458264aa3b695f8108f7ec1b9e493">TW_RxBufCnt</a> = <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a>;      <span class="comment">//re-use the Write Index's value as the Valid Byte Count.</span>
<a name="l00561"></a>00561                 <a class="code" href="communication_8c.html#98071e48f8969fdd79e1fa2337d0b6dd">TW_RxBufIndex</a> = 0;                <span class="comment">//clear the index in preparation for interpreting it.</span>
<a name="l00562"></a>00562                 <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#07b00aac11ba389d5b53e2f9d54bd0bd">SMB_GotCmdData</a>;    <span class="comment">//tell Foreground to process this now.</span>
<a name="l00563"></a>00563                 <span class="comment">//Note that when (TWI_CmdFlags == SMB_GotCmdData), TWI ISR will respond with BUSY condition.</span>
<a name="l00564"></a>00564             }
<a name="l00565"></a>00565             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;      <span class="comment">//Reset the state machine in all cases.</span>
<a name="l00566"></a>00566         }
<a name="l00567"></a>00567 
<a name="l00568"></a>00568         <span class="comment">//Some type of error during transmission!</span>
<a name="l00569"></a>00569         <span class="keywordflow">else</span>
<a name="l00570"></a>00570         {
<a name="l00571"></a>00571             <a class="code" href="communication_8c.html#72f0b2eb64dd62ffa6bb85ef96947543">TWI_CmdFlags</a> = <a class="code" href="communication_8c.html#75ae04e7aaa973e59f86209a3e8f7d3c">SMB_GenBusTimeout</a>;  <span class="comment">//Generate a bus timeout.</span>
<a name="l00572"></a>00572             TWCR = (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN);      <span class="comment">//Disable int, and DON'T clear the TWINT flag!</span>
<a name="l00573"></a>00573             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;             <span class="comment">//Reset the state machine.</span>
<a name="l00574"></a>00574             <span class="keywordflow">break</span>;
<a name="l00575"></a>00575         }
<a name="l00576"></a>00576         
<a name="l00577"></a>00577         TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);  <span class="comment">//enable ACKing</span>
<a name="l00578"></a>00578         <span class="keywordflow">break</span>;
<a name="l00579"></a>00579         
<a name="l00580"></a>00580 
<a name="l00581"></a>00581         <span class="comment">// We are now in Slave Transmit operating mode.</span>
<a name="l00582"></a>00582         <span class="comment">// The foreground code has set up the response that we are now sending.</span>
<a name="l00583"></a>00583         <span class="comment">// Note: TW_TxBufCnt *always* includes the PEC byte! Since we don't</span>
<a name="l00584"></a>00584         <span class="comment">// know whether the Master actually WANTS the PEC byte or not, we will</span>
<a name="l00585"></a>00585         <span class="comment">// always TRY to send it, regardless of the state of the UsePEC flag.</span>
<a name="l00586"></a>00586         <span class="comment">// If the Master does NOT want it, we will get a NAK while the PEC</span>
<a name="l00587"></a>00587         <span class="comment">// byte is still in the buffer.  In the rare case where we send it all,</span>
<a name="l00588"></a>00588         <span class="comment">// including the PEC byte, but we still get an ACK back, the TWI module</span>
<a name="l00589"></a>00589         <span class="comment">// will be off-line anyway due to not setting the TWEA bit after sending PEC,</span>
<a name="l00590"></a>00590         <span class="comment">// and we will therefore be unable to flag that an error has occurred.</span>
<a name="l00591"></a>00591         <span class="keywordflow">case</span> <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b583d27cae0915c8a8002877623dcb0dc9">TW_ReplyData</a>:
<a name="l00592"></a>00592         
<a name="l00593"></a>00593         <span class="comment">//Send out Reply data</span>
<a name="l00594"></a>00594         <span class="keywordflow">if</span>((<a class="code" href="SMBSlave_8h.html#56a6f2a019fcb0f004ad6a8619fd9b3f">TWS_SLA_R</a> == Status) || (<a class="code" href="SMBSlave_8h.html#69333e59f4e48bd3130a871152cc17ae">TWS_RACK</a> == Status))
<a name="l00595"></a>00595         {
<a name="l00596"></a>00596             <span class="comment">//Get data next byte from buffer and send data out.</span>
<a name="l00597"></a>00597             TWDR = <a class="code" href="communication_8c.html#204ea67bfcfaf14d21b4a31bc22e651e">TW_TxBuf</a>[<a class="code" href="communication_8c.html#ce8ce6c26dcb95748ab5026ce7157bf7">TW_TxBufIndex</a>++];
<a name="l00598"></a>00598             
<a name="l00599"></a>00599             <span class="comment">//Have we emptied the buffer, incl. PEC?</span>
<a name="l00600"></a>00600             <span class="keywordflow">if</span>(--<a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a> == 0)
<a name="l00601"></a>00601             {   <span class="comment">// Yes, so don't set TWEA.</span>
<a name="l00602"></a>00602                 TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);
<a name="l00603"></a>00603             }
<a name="l00604"></a>00604             <span class="keywordflow">else</span>
<a name="l00605"></a>00605             {   <span class="comment">// No, so assert TWEA.</span>
<a name="l00606"></a>00606                 TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);
<a name="l00607"></a>00607             }
<a name="l00608"></a>00608         }
<a name="l00609"></a>00609         
<a name="l00610"></a>00610         <span class="comment">//We may have gotten this validly or as an Error.</span>
<a name="l00611"></a>00611         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="SMBSlave_8h.html#d3a2ba13b4f5c4ccac0d9d5a67a08c9c">TWS_RNAK</a> == Status)
<a name="l00612"></a>00612         {
<a name="l00613"></a>00613             <span class="comment">//Not an error. Master didn't want PEC; clear UsePEC flag!</span>
<a name="l00614"></a>00614             <span class="keywordflow">if</span>(<a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a> == 1)
<a name="l00615"></a>00615             {
<a name="l00616"></a>00616                 <a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a> = 0;    <span class="comment">//clear the buffer too.</span>
<a name="l00617"></a>00617                 <a class="code" href="communication_8c.html#fd9b3e99365b45af6cf763b2dda41546">UsePEC</a> = 0;
<a name="l00618"></a>00618             }
<a name="l00619"></a>00619             <span class="comment">//Not an error. Master wanted PEC (and got it); assert UsePEC.</span>
<a name="l00620"></a>00620             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="communication_8c.html#1b712ae6a56048cf3cce7c93ed2ed6c1">TW_TxBufCnt</a> == 0)
<a name="l00621"></a>00621             {
<a name="l00622"></a>00622                 <a class="code" href="communication_8c.html#fd9b3e99365b45af6cf763b2dda41546">UsePEC</a> = 1;
<a name="l00623"></a>00623             }
<a name="l00624"></a>00624             
<a name="l00625"></a>00625             <span class="comment">//Some kind of error occurred; we got NAK too early!</span>
<a name="l00626"></a>00626             <span class="keywordflow">else</span>
<a name="l00627"></a>00627             {
<a name="l00628"></a>00628                 <span class="comment">//Note: the TWI module is now OFF-LINE, so we can't inform Host of this error!!</span>
<a name="l00629"></a>00629             }
<a name="l00630"></a>00630             
<a name="l00631"></a>00631             <span class="comment">//In all cases, go back to IDLE.</span>
<a name="l00632"></a>00632             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;
<a name="l00633"></a>00633             TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);
<a name="l00634"></a>00634         }
<a name="l00635"></a>00635         
<a name="l00636"></a>00636         <span class="comment">// if(TWS_FINAL == Status)  //ERROR: we got an ACK but we have no more data!</span>
<a name="l00637"></a>00637         <span class="comment">// Since the TWI module is now in "Not Addressed Slave" mode, we can't flag the error</span>
<a name="l00638"></a>00638         <span class="comment">// back to the Master DURING this transaction; we WILL assert an error status though.</span>
<a name="l00639"></a>00639         <span class="keywordflow">else</span>
<a name="l00640"></a>00640         {
<a name="l00641"></a>00641             <a class="code" href="communication_8c.html#6fd44d05795c577681c33fe2f105300c">TWISR_state</a> = <a class="code" href="communication_8c.html#99fb83031ce9923c84392b4e92f956b5b2ed574d9e01f56cd38bf441a8085640">TW_IDLE</a>;  <span class="comment">//Reset the state machine.</span>
<a name="l00642"></a>00642             TWCR = (1&lt;&lt;TWINT) | (1&lt;&lt;TWEA) | (1&lt;&lt;TWEN) | (1&lt;&lt;TWIE);
<a name="l00643"></a>00643         }
<a name="l00644"></a>00644         <span class="keywordflow">break</span>;
<a name="l00645"></a>00645     } <span class="comment">// end of switch(TWISR_state)</span>
<a name="l00646"></a>00646 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<p><center><img src="smbus_8c_1f03d433517342e03440452013989dc4_cgraph.gif" border="0" usemap="#smbus_8c_1f03d433517342e03440452013989dc4_cgraph_map" alt=""></center>
<map name="smbus_8c_1f03d433517342e03440452013989dc4_cgraph_map">
<area shape="rect" href="timer_8c.html#3ad6d4c2cd213c29e403adeff96c71d4" title="SetGenericTimer" alt="" coords="127,5,244,32"></map>
</div>

</div>
</div><p>
<a class="anchor" name="6ad83522570a9dfb8df36852769b5393"></a><!-- doxytag: member="smbus.c::TWICD_ISR" ref="6ad83522570a9dfb8df36852769b5393" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__interrupt void TWICD_ISR           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="smbus_8c-source.html#l00122">122</a> of file <a class="el" href="smbus_8c-source.html">smbus.c</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00123"></a>00123 {
<a name="l00124"></a>00124     <span class="comment">//clear bits per sbdat110, 4.4.2</span>
<a name="l00125"></a>00125     <span class="comment">//SMBvariables[SMBV_BattMode][hibyte] &amp;= ~(0xE3);   </span>
<a name="l00126"></a>00126     
<a name="l00127"></a>00127     <span class="keywordflow">if</span>(TWBCSR &amp; (1&lt;&lt;TWBCIP))    <span class="comment">//this int was caused by bus DISCONNECT event.</span>
<a name="l00128"></a>00128     {
<a name="l00129"></a>00129         TWBCSR &amp;= ~(1&lt;&lt;TWBCIP);
<a name="l00130"></a>00130 <span class="comment">//SH        ChangePowerMode(POWERMODE_IDLE,0);</span>
<a name="l00131"></a>00131     }
<a name="l00132"></a>00132     <span class="keywordflow">else</span>    <span class="comment">//this int occurred due to a bus CONNECT event.</span>
<a name="l00133"></a>00133     {
<a name="l00134"></a>00134         TWBCSR |= (1&lt;&lt;TWBCIP);
<a name="l00135"></a>00135 <span class="comment">//SH        ChangePowerMode(POWERMODE_ACTIVE,0);</span>
<a name="l00136"></a>00136     }
<a name="l00137"></a>00137 }
</pre></div>
<p>

</div>
</div><p>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="c0a0963896d590350fbb796f490ebd02"></a><!-- doxytag: member="smbus.c::CurrentCmd" ref="c0a0963896d590350fbb796f490ebd02" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="el" href="smbus_8c.html#c0a0963896d590350fbb796f490ebd02">CurrentCmd</a> = 0xFF          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="smbus_8c-source.html#l00089">89</a> of file <a class="el" href="smbus_8c-source.html">smbus.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="073f6663e89074a86174c10ad3b88a73"></a><!-- doxytag: member="smbus.c::SMLOCK" ref="073f6663e89074a86174c10ad3b88a73" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="el" href="smbus_8c.html#073f6663e89074a86174c10ad3b88a73">SMLOCK</a> = 0          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="smbus_8c-source.html#l00062">62</a> of file <a class="el" href="smbus_8c-source.html">smbus.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="3d8e137fcafe4a844f4c783f5b62b2f0"></a><!-- doxytag: member="smbus.c::TEST50US" ref="3d8e137fcafe4a844f4c783f5b62b2f0" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="el" href="smbus_8c.html#3d8e137fcafe4a844f4c783f5b62b2f0">TEST50US</a> = 0          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="smbus_8c-source.html#l00061">61</a> of file <a class="el" href="smbus_8c-source.html">smbus.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="2ba11b9846337754474c2db586742246"></a><!-- doxytag: member="smbus.c::TW_RxBuf" ref="2ba11b9846337754474c2db586742246" args="[36]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="el" href="smbus_8c.html#2ba11b9846337754474c2db586742246">TW_RxBuf</a>[36]          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="smbus_8c-source.html#l00074">74</a> of file <a class="el" href="smbus_8c-source.html">smbus.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="93d72a4a884264836af00f4d32ab677e"></a><!-- doxytag: member="smbus.c::TW_RxBufCnt" ref="93d72a4a884264836af00f4d32ab677e" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#ef44329758059c91c76d334e8fc09700">int8_t</a> <a class="el" href="smbus_8c.html#93d72a4a884264836af00f4d32ab677e">TW_RxBufCnt</a> = 0          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="smbus_8c-source.html#l00075">75</a> of file <a class="el" href="smbus_8c-source.html">smbus.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="6fb4d146b64f434730a82e2a4f10cee0"></a><!-- doxytag: member="smbus.c::TW_RxBufIndex" ref="6fb4d146b64f434730a82e2a4f10cee0" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="el" href="smbus_8c.html#6fb4d146b64f434730a82e2a4f10cee0">TW_RxBufIndex</a> = 0          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="smbus_8c-source.html#l00076">76</a> of file <a class="el" href="smbus_8c-source.html">smbus.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="639bcaf149615285a706ea342add17d7"></a><!-- doxytag: member="smbus.c::TW_TxBuf" ref="639bcaf149615285a706ea342add17d7" args="[36]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="el" href="smbus_8c.html#639bcaf149615285a706ea342add17d7">TW_TxBuf</a>[36]          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="smbus_8c-source.html#l00070">70</a> of file <a class="el" href="smbus_8c-source.html">smbus.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="8b0021b979a3e0d2abf84c558f0022a0"></a><!-- doxytag: member="smbus.c::TW_TxBufCnt" ref="8b0021b979a3e0d2abf84c558f0022a0" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="el" href="smbus_8c.html#8b0021b979a3e0d2abf84c558f0022a0">TW_TxBufCnt</a> = 0          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="smbus_8c-source.html#l00071">71</a> of file <a class="el" href="smbus_8c-source.html">smbus.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="eb6c852ef5c3ebe1a21b5c00de980185"></a><!-- doxytag: member="smbus.c::TW_TxBufIndex" ref="eb6c852ef5c3ebe1a21b5c00de980185" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="el" href="smbus_8c.html#eb6c852ef5c3ebe1a21b5c00de980185">TW_TxBufIndex</a> = 0          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="smbus_8c-source.html#l00072">72</a> of file <a class="el" href="smbus_8c-source.html">smbus.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="5d7f64488757c7f3316d68bfdea76a6d"></a><!-- doxytag: member="smbus.c::TWI_CmdFlags" ref="5d7f64488757c7f3316d68bfdea76a6d" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile <a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="el" href="smbus_8c.html#5d7f64488757c7f3316d68bfdea76a6d">TWI_CmdFlags</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="smbus_8c-source.html#l00084">84</a> of file <a class="el" href="smbus_8c-source.html">smbus.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="988a0e4620a54c9475e880542c2c2df6"></a><!-- doxytag: member="smbus.c::TWISR_state" ref="988a0e4620a54c9475e880542c2c2df6" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="el" href="smbus_8c.html#988a0e4620a54c9475e880542c2c2df6">TWISR_state</a> = TW_IDLE          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="smbus_8c-source.html#l00335">335</a> of file <a class="el" href="smbus_8c-source.html">smbus.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="ef8fe2dab8cfd0c7933a63418d64f462"></a><!-- doxytag: member="smbus.c::UsePEC" ref="ef8fe2dab8cfd0c7933a63418d64f462" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="el" href="smbus_8c.html#ef8fe2dab8cfd0c7933a63418d64f462">UsePEC</a> = 0          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="smbus_8c-source.html#l00090">90</a> of file <a class="el" href="smbus_8c-source.html">smbus.c</a>.</p>

</div>
</div><p>
</div>
<html>
 <head>
  <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
  <title>@DOC_TITLE@</title>
  <link href="doxygen.css" rel="stylesheet" type="text/css">
</head>
<body>

<table width="100%" height="10%" bgcolor="#FFFFFF">
  <tr>
    <td colspan="6" height="1" background="blue.gif"></td>
  </tr>

  <tr>
    <td colspan="6">
    <address style="align: right;"><small>
Generated on Wed Aug 4 11:02:00 2010 for AVR474 Firmware User's Guide for SB202 by <a href="http://www.doxygen.org/index.html"><img src="doxygen.png" alt="doxygen" align="middle" border=0></a> 1.5.6</small></address>
    </td>
  </tr>

</table>
