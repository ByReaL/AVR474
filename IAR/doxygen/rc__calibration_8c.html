<html xmlns:v="urn:schemas-microsoft-com:vml"
xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns="http://www.w3.org/TR/REC-html40">

<head>
<meta http-equiv=Content-Type content="text/html; charset=iso-8859-1">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 11">
<meta name=Originator content="Microsoft Word 11">
<link rel=File-List href="atmel-header_files/filelist.xml">
<link rel=Edit-Time-Data href="atmel-header_files/editdata.mso">
<!--[if !mso]>
<style>
v\:* {behavior:url(#default#VML);}
o\:* {behavior:url(#default#VML);}
w\:* {behavior:url(#default#VML);}
.shape {behavior:url(#default#VML);}
</style>
<![endif]-->
<title>@DOC_TITLE@</title>
<!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>ping.zhou</o:Author>
  <o:Template>Normal</o:Template>
  <o:LastAuthor>ping.zhou</o:LastAuthor>
  <o:Revision>3</o:Revision>
  <o:TotalTime>0</o:TotalTime>
  <o:Created>2010-08-04T02:58:00Z</o:Created>
  <o:LastSaved>2010-08-04T02:58:00Z</o:LastSaved>
  <o:Pages>1</o:Pages>
  <o:Words>51</o:Words>
  <o:Characters>297</o:Characters>
  <o:Company>Atmel</o:Company>
  <o:Lines>2</o:Lines>
  <o:Paragraphs>1</o:Paragraphs>
  <o:CharactersWithSpaces>347</o:CharactersWithSpaces>
  <o:Version>11.9999</o:Version>
 </o:DocumentProperties>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:Zoom>150</w:Zoom>
  <w:SpellingState>Clean</w:SpellingState>
  <w:GrammarState>Clean</w:GrammarState>
  <w:ValidateAgainstSchemas/>
  <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid>
  <w:IgnoreMixedContent>false</w:IgnoreMixedContent>
  <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText>
  <w:Compatibility>
   <w:UseFELayout/>
  </w:Compatibility>
  <w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel>
 </w:WordDocument>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:LatentStyles DefLockedState="false" LatentStyleCount="156">
 </w:LatentStyles>
</xml><![endif]-->
<link rel=Stylesheet type="text/css" media=all href="doxygen.css">
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Helvetica;
	panose-1:2 11 6 4 2 2 2 2 2 4;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:536902279 -2147483648 8 0 511 0;}
@font-face
	{font-family:SimSun;
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-alt:SimSun;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 135135232 16 0 262145 0;}
@font-face
	{font-family:SimSun;
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 135135232 16 0 262145 0;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:SimSun;}
p
	{font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:SimSun;}
span.SpellE
	{mso-style-name:"";
	mso-spl-e:yes;}
@page Section1
	{size:8.5in 11.0in;
	margin:1.0in 1.25in 1.0in 1.25in;
	mso-header-margin:.5in;
	mso-footer-margin:.5in;
	mso-paper-source:0;}
div.Section1
	{page:Section1;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
	{mso-style-name:"Table Normal";
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-parent:"";
	mso-padding-alt:0in 5.4pt 0in 5.4pt;
	mso-para-margin:0in;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-ansi-language:#0400;
	mso-fareast-language:#0400;
	mso-bidi-language:#0400;}
</style>
<![endif]--><!--[if gte mso 9]><xml>
 <o:shapedefaults v:ext="edit" spidmax="2050"/>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <o:shapelayout v:ext="edit">
  <o:idmap v:ext="edit" data="1"/>
 </o:shapelayout></xml><![endif]-->
</head>

<body lang=EN-US link=blue vlink=blue style='tab-interval:.5in'>

<div class=Section1>

<table class=MsoNormalTable border=0 cellpadding=0 width="100%"
 style='width:100.0%;mso-cellspacing:1.5pt;background:white'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes'>
  <td style='padding:.75pt .75pt .75pt .75pt'>
  <p><a href="http://www.atmel.com"><span style='text-decoration:none;
  text-underline:none'><img border=0 width=109 height=50 id="_x0000_i1025"
  src=atmel.jpg></span></a></p>
  <p class=MsoNormal><o:p>&nbsp;</o:p></p>
  </td>
  <td style='padding:.75pt .75pt .75pt .75pt'>
  <p class=MsoNormal><span class=SpellE><strong><span style='font-size:24.0pt;
  font-family:Helvetica;color:black'>SmartBattery</span></strong></span><strong><span
  style='font-size:24.0pt;font-family:Helvetica;color:black'> Device
  Application Note</span></strong></p>
  </td>
  <td style='padding:.75pt .75pt .75pt .75pt'>
  <p><a href="http://www.atmel.com/products/AVR"><span style='text-decoration:
  none;text-underline:none'><img border=0 width=138 height=77 id="_x0000_i1026"
  src="AVR_logo_blue.gif"></span></a></p>
  <p class=MsoNormal><o:p>&nbsp;</o:p></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:1;mso-yfti-lastrow:yes;height:.75pt'>
  <td colspan=3 style='padding:.75pt .75pt .75pt .75pt;height:.75pt'
  background=blue.gif>
  <p class=MsoNormal><span style='font-size:1.0pt;mso-bidi-font-size:12.0pt'><o:p>&nbsp;</o:p></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

</div>

</body>

</html>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_21d9b7b08462661958c4d98529a1490d.html">lib_board</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_838e5789a01ac928a89e39ed608adacc.html">rc_calibration</a>
  </div>
</div>
<div class="contents">
<h1>rc_calibration.c File Reference</h1><hr><a name="_details"></a><h2>Detailed Description</h2>
Functions for calibrating and estimating clock periods of the RC Oscillators. 
<p>
<dl class="user" compact><dt><b>Application note:</b></dt><dd>AVR474: SB202 Firmware.</dd></dl>
<dl class="user" compact><dt><b>Documentation</b></dt><dd>For comprehensive code documentation, supported compilers, compiler settings and supported devices see readme.html</dd></dl>
<dl class="author" compact><dt><b>Author:</b></dt><dd>Atmel Corporation: <a href="http://www.atmel.com">http://www.atmel.com</a> <br>
 Support email: <a href="mailto:avr@atmel.com">avr@atmel.com</a></dd></dl>
<dl class="rcs" compact><dt><b>Revision</b></dt><dd>6090 </dd></dl>
<dl class="rcs" compact><dt><b>Date</b></dt><dd>2009-10-05 21:40:12 +0800 (Mon, 05 Oct 2009) </dd></dl>
<br>
<p>
Copyright (c) 2009, Atmel Corporation All rights reserved.<p>
Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:<p>
1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.<p>
2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.<p>
3. The name of ATMEL may not be used to endorse or promote products derived from this software without specific prior written permission.<p>
THIS SOFTWARE IS PROVIDED BY ATMEL "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE EXPRESSLY AND SPECIFICALLY DISCLAIMED. IN NO EVENT SHALL ATMEL BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. 
<p>Definition in file <a class="el" href="rc__calibration_8c-source.html">rc_calibration.c</a>.</p>

<p>
<code>#include &quot;<a class="el" href="common_8h-source.html">common.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="rc__calibration_8h-source.html">rc_calibration.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="ATmega32HVB__signature_8h-source.html">ATmega32HVB_signature.h</a>&quot;</code><br>

<p>
<div class="dynheader">
Include dependency graph for rc_calibration.c:</div>
<div class="dynsection">
<p><center><img src="rc__calibration_8c__incl.gif" border="0" usemap="#lib_board/rc_calibration/rc_calibration.c_map" alt=""></center>
<map name="lib_board/rc_calibration/rc_calibration.c_map">
<area shape="rect" href="common_8h.html" title="Common headerfile." alt="" coords="161,155,244,181"><area shape="rect" href="rc__calibration_8h.html" title="Defines and prototypes for rc_calibration.c." alt="" coords="148,80,257,107"><area shape="rect" href="ATmega32HVB__signature_8h.html" title="Signature row defines for ATmega16HVB and ATmega32HVB." alt="" coords="281,80,463,107"><area shape="rect" href="stdint_8h.html" title="stdint.h" alt="" coords="171,229,235,256"><area shape="rect" href="error_8h.html" title="error.h" alt="" coords="357,229,416,256"></map>
</div>

<p>
<a href="rc__calibration_8c-source.html">Go to the source code of this file.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="rc__calibration_8c.html#01eda13db136451568e1c22f17b3ac40">RCCAL_CalculateSlowRCperiod</a> (<a class="el" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a> temperature)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Calculate Slow RC period time.  <a href="#01eda13db136451568e1c22f17b3ac40"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="rc__calibration_8c.html#80054145825d11a31568f5d7ddbe948d">RCCAL_CalculateUlpRCperiod</a> (<a class="el" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a> temperature)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Calculate Ultra-low power RC (Ulp RC) period time.  <a href="#80054145825d11a31568f5d7ddbe948d"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="rc__calibration_8c.html#344e46598bc6ed3bc1d025d10edd2578">RCCAL_CalibrateFastRCruntime</a> (<a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> cal_RC_period)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Calibrate the Fast RC against the Slow RC oscillator runtime.  <a href="#344e46598bc6ed3bc1d025d10edd2578"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="rc__calibration_8h.html#8c494e607329ee1c12964f340c250cea">RCCAL_CalibState_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="rc__calibration_8c.html#d31c4916062296248c228bdee0e81395">RCCAL_GetState</a> ()</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Returns the current state of fast rc calibration.  <a href="#d31c4916062296248c228bdee0e81395"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">__interrupt void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="rc__calibration_8c.html#15fbe16bb72ef18494d1649c9f8c5e4b">RCCAL_InputCapture_ISR</a> ()</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Interrupt routine for Timer0 input capture.  <a href="#15fbe16bb72ef18494d1649c9f8c5e4b"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="rc__calibration_8c.html#3324e52d9c103e1c3889824170dd7d08">RCCAL_StartCalibrateFastRC</a> ()</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Start the Fast RC calibration.  <a href="#3324e52d9c103e1c3889824170dd7d08"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="rc__calibration_8c.html#346b53f8df2aad519bda12f6a90bbfab">RCCAL_StartOSIsampleClockPeriod</a> (<a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> clock_source)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Measure OSI prescaled clock periods.  <a href="#346b53f8df2aad519bda12f6a90bbfab"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="rc__calibration_8c.html#539c9921f8cbaf485509f8f5562a9918">RCCAL_StopTimer0</a> ()</td></tr>

<tr><td colspan="2"><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="rc__calibration_8c.html#a18842f9efbf604ec2b2c30df8223648">LastICResult</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="rc__calibration_8h.html#8c494e607329ee1c12964f340c250cea">RCCAL_CalibState_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="rc__calibration_8c.html#08831d7310dc2450802d2b25f87d3d32">RCCAL_CalibState</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="rc__calibration_8h.html#fb47a0eadca39ec0d8f9280e76df7b1a">RCCAL_IC_State_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="rc__calibration_8c.html#56707fdc2d6420df927a3ea6d6f9ff38">RCCAL_IC_State</a></td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="01eda13db136451568e1c22f17b3ac40"></a><!-- doxytag: member="rc_calibration.c::RCCAL_CalculateSlowRCperiod" ref="01eda13db136451568e1c22f17b3ac40" args="(int16_t temperature)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> RCCAL_CalculateSlowRCperiod           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a>&nbsp;</td>
          <td class="paramname"> <em>temperature</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Calculate Slow RC period time. 
<p>
Calculate Slow RC period time given a temperature. The formula for calculation of Slow RC period is used with the signature data (loaded from the signature row) to calculate the actual period as described in the data sheet and application note. The result is in ms * 1024. It can thus be seen as ms in 16 bit fixed point format, with 10 fractional bits, i.e. 0x XXXX XX.xx xxxx xxxx.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>temperature</em>&nbsp;</td><td>Temperature in Kelvin</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>Slow RC period in ms*1024 </dd></dl>

<p>Definition at line <a class="el" href="rc__calibration_8c-source.html#l00085">85</a> of file <a class="el" href="rc__calibration_8c-source.html">rc_calibration.c</a>.</p>

<p>References <a class="el" href="common_8h.html#8dec381e6ff65f996cc9b817e6939d6e">READ_SIGNATUREBYTE()</a>, <a class="el" href="common_8h.html#a16b708c9ea40f05cacc9d2e4456f741">READ_SIGNATUREWORD()</a>, <a class="el" href="ATmega32HVB__signature_8h-source.html#l00061">SIG_SLOW_RC_L</a>, <a class="el" href="ATmega32HVB__signature_8h-source.html#l00063">SIG_SLOW_RC_PRED_L</a>, <a class="el" href="ATmega32HVB__signature_8h-source.html#l00103">SIG_TEMPERATURE_HOT</a>, and <a class="el" href="common_8h-source.html#l00075">ZERO_KELVIN</a>.</p>

<p>Referenced by <a class="el" href="main_8c-source.html#l00187">main()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00086"></a>00086 {
<a name="l00087"></a>00087     <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> slow_RC_period;
<a name="l00088"></a>00088     <a class="code" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a>  slow_RC_temperature_coeff;
<a name="l00089"></a>00089     <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> calib_temperature;
<a name="l00090"></a>00090 
<a name="l00091"></a>00091     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> interrupt_status = __save_interrupt();  <span class="comment">// Disable interrupts.</span>
<a name="l00092"></a>00092     __disable_interrupt();
<a name="l00093"></a>00093     
<a name="l00094"></a>00094     <span class="comment">//Read necessary data from the signature row. The delay cycles are to avoid</span>
<a name="l00095"></a>00095     <span class="comment">//accessing the SPMCSR register within 6 cycles of previous write, since it</span>
<a name="l00096"></a>00096     <span class="comment">//is locked for further writing during these cycles.</span>
<a name="l00097"></a>00097     slow_RC_period = <a class="code" href="common_8h.html#a16b708c9ea40f05cacc9d2e4456f741">READ_SIGNATUREWORD</a>(<a class="code" href="ATmega32HVB__signature_8h.html#162ffedbeb148cb9a415b327e0571b6f">SIG_SLOW_RC_L</a>);
<a name="l00098"></a>00098 
<a name="l00099"></a>00099     slow_RC_temperature_coeff = <a class="code" href="common_8h.html#a16b708c9ea40f05cacc9d2e4456f741">READ_SIGNATUREWORD</a>(<a class="code" href="ATmega32HVB__signature_8h.html#6389034f412066699ecf7a72e10e69ba">SIG_SLOW_RC_PRED_L</a>);
<a name="l00100"></a>00100 
<a name="l00101"></a>00101     calib_temperature = <a class="code" href="common_8h.html#8dec381e6ff65f996cc9b817e6939d6e">READ_SIGNATUREBYTE</a>(<a class="code" href="ATmega32HVB__signature_8h.html#e29f5fadcd4f2c268cb0ae3611881ac1">SIG_TEMPERATURE_HOT</a>) + <a class="code" href="common_8h.html#6845ca0b7bf6295d883ba9ad80c2338c" title="0 K in degrees celcius.">ZERO_KELVIN</a>;
<a name="l00102"></a>00102     
<a name="l00103"></a>00103     __restore_interrupt(interrupt_status);
<a name="l00104"></a>00104     
<a name="l00105"></a>00105     <span class="keywordflow">return</span> (<a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a>)(slow_RC_period - ((temperature - calib_temperature)*slow_RC_temperature_coeff)/64);
<a name="l00106"></a>00106 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<p><center><img src="rc__calibration_8c_01eda13db136451568e1c22f17b3ac40_cgraph.gif" border="0" usemap="#rc__calibration_8c_01eda13db136451568e1c22f17b3ac40_cgraph_map" alt=""></center>
<map name="rc__calibration_8c_01eda13db136451568e1c22f17b3ac40_cgraph_map">
<area shape="rect" href="common_8h.html#8dec381e6ff65f996cc9b817e6939d6e" title="READ_SIGNATUREBYTE" alt="" coords="267,5,437,32"><area shape="rect" href="common_8h.html#a16b708c9ea40f05cacc9d2e4456f741" title="READ_SIGNATUREWORD" alt="" coords="263,56,441,83"></map>
</div>

</div>
</div><p>
<a class="anchor" name="80054145825d11a31568f5d7ddbe948d"></a><!-- doxytag: member="rc_calibration.c::RCCAL_CalculateUlpRCperiod" ref="80054145825d11a31568f5d7ddbe948d" args="(int16_t temperature)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> RCCAL_CalculateUlpRCperiod           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a>&nbsp;</td>
          <td class="paramname"> <em>temperature</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Calculate Ultra-low power RC (Ulp RC) period time. 
<p>
Calculate Ulp RC period time given a temperature. The formula for calculation of Ulp RC period is used with the signature data (loaded from the signature row) to calculate the actual period as described in the data sheet and application note. The result is in ms * 1024. It can thus be seen as ms in 16 bit fixed point format, with 10 fractional bits, i.e. 0x XXXX XX.xx xxxx xxxx.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>temperature</em>&nbsp;</td><td>Temperature in Kelvin</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>Ulp RC period in ms*1024 </dd></dl>

<p>Definition at line <a class="el" href="rc__calibration_8c-source.html#l00123">123</a> of file <a class="el" href="rc__calibration_8c-source.html">rc_calibration.c</a>.</p>

<p>References <a class="el" href="common_8h.html#8dec381e6ff65f996cc9b817e6939d6e">READ_SIGNATUREBYTE()</a>, <a class="el" href="common_8h.html#a16b708c9ea40f05cacc9d2e4456f741">READ_SIGNATUREWORD()</a>, <a class="el" href="ATmega32HVB__signature_8h-source.html#l00103">SIG_TEMPERATURE_HOT</a>, <a class="el" href="ATmega32HVB__signature_8h-source.html#l00070">SIG_ULP_RC_L</a>, <a class="el" href="ATmega32HVB__signature_8h-source.html#l00067">SIG_ULP_RC_PRED_L</a>, and <a class="el" href="common_8h-source.html#l00075">ZERO_KELVIN</a>.</p>

<p>Referenced by <a class="el" href="main_8c-source.html#l01076">handleSBSCommand()</a>, and <a class="el" href="main_8c-source.html#l00187">main()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00124"></a>00124 {
<a name="l00125"></a>00125         <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> ulp_RC_period;
<a name="l00126"></a>00126     <a class="code" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a>  ulp_RC_temperature_coeff;
<a name="l00127"></a>00127     <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> calib_temperature;
<a name="l00128"></a>00128 
<a name="l00129"></a>00129     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> interrupt_status = __save_interrupt();  <span class="comment">// Disable interrupts.</span>
<a name="l00130"></a>00130     __disable_interrupt();
<a name="l00131"></a>00131     
<a name="l00132"></a>00132     <span class="comment">//Read necessary data from the signature row. The delay cycles are to avoid</span>
<a name="l00133"></a>00133     <span class="comment">//accessing the SPMCSR register within 6 cycles of previous write, since it</span>
<a name="l00134"></a>00134     <span class="comment">//is locked for further writing during these cycles.</span>
<a name="l00135"></a>00135     ulp_RC_period = <a class="code" href="common_8h.html#a16b708c9ea40f05cacc9d2e4456f741">READ_SIGNATUREWORD</a>(<a class="code" href="ATmega32HVB__signature_8h.html#07800f7309fa7efeabfa9a98ccdbbeca">SIG_ULP_RC_L</a>);
<a name="l00136"></a>00136 
<a name="l00137"></a>00137     ulp_RC_temperature_coeff = <a class="code" href="common_8h.html#a16b708c9ea40f05cacc9d2e4456f741">READ_SIGNATUREWORD</a>(<a class="code" href="ATmega32HVB__signature_8h.html#10e816d7f2288c99d12e2f923b45f2a0">SIG_ULP_RC_PRED_L</a>);
<a name="l00138"></a>00138 
<a name="l00139"></a>00139     calib_temperature = <a class="code" href="common_8h.html#8dec381e6ff65f996cc9b817e6939d6e">READ_SIGNATUREBYTE</a>(<a class="code" href="ATmega32HVB__signature_8h.html#e29f5fadcd4f2c268cb0ae3611881ac1">SIG_TEMPERATURE_HOT</a>) + <a class="code" href="common_8h.html#6845ca0b7bf6295d883ba9ad80c2338c" title="0 K in degrees celcius.">ZERO_KELVIN</a>;
<a name="l00140"></a>00140     
<a name="l00141"></a>00141     __restore_interrupt(interrupt_status);
<a name="l00142"></a>00142     
<a name="l00143"></a>00143     <span class="keywordflow">return</span> (<a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a>)(ulp_RC_period - ((temperature - calib_temperature)*ulp_RC_temperature_coeff)/64);
<a name="l00144"></a>00144 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<p><center><img src="rc__calibration_8c_80054145825d11a31568f5d7ddbe948d_cgraph.gif" border="0" usemap="#rc__calibration_8c_80054145825d11a31568f5d7ddbe948d_cgraph_map" alt=""></center>
<map name="rc__calibration_8c_80054145825d11a31568f5d7ddbe948d_cgraph_map">
<area shape="rect" href="common_8h.html#8dec381e6ff65f996cc9b817e6939d6e" title="READ_SIGNATUREBYTE" alt="" coords="256,5,427,32"><area shape="rect" href="common_8h.html#a16b708c9ea40f05cacc9d2e4456f741" title="READ_SIGNATUREWORD" alt="" coords="252,56,431,83"></map>
</div>

</div>
</div><p>
<a class="anchor" name="344e46598bc6ed3bc1d025d10edd2578"></a><!-- doxytag: member="rc_calibration.c::RCCAL_CalibrateFastRCruntime" ref="344e46598bc6ed3bc1d025d10edd2578" args="(uint16_t cal_RC_period)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void RCCAL_CalibrateFastRCruntime           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a>&nbsp;</td>
          <td class="paramname"> <em>cal_RC_period</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Calibrate the Fast RC against the Slow RC oscillator runtime. 
<p>
Since the value we're searching for is probably close to the current we do a linear search. It searches the segment where FOSCCAL default is and the one below. When searching downwards we use the FOSC SEGMENT signature byte to avoid a jump in frequency when reaching the lower segment and thus giving a longer continous search range. FOSC segment is the first value in the previous segment that gives a lower frequency than the lowest value in the FOSCCAL default segment. If we reach the bottom of the lower segment or the top of the default segment we select the default FOSCCAL value and return failed as this range should provide a more than sufficient range for adjusting FOSCCAL over all temperatures, so something is wrong.<p>
Note that no other boundary check is done, but even if the FOSCCAL value is outside the search range the frequency should be correctly calibrated, although jumps in frequency results will be encountered. If the FOSCCAL value is between the lowest value in FOSCCAL default segment and the FOSC SEGMENT, a value in that range might be selected.<p>
<dl class="note" compact><dt><b>Note:</b></dt><dd>Do not call with different cal_RC_period during the "working" part of the function. If the slow RC period change during calibration, re-run <a class="el" href="rc__calibration_8c.html#3324e52d9c103e1c3889824170dd7d08" title="Start the Fast RC calibration.">RCCAL_StartCalibrateFastRC()</a> to re-initialize some variables.</dd></dl>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>cal_RC_period</em>&nbsp;</td><td>Slow RC period in ms * 1024 </td></tr>
  </table>
</dl>

<p>Definition at line <a class="el" href="rc__calibration_8c-source.html#l00182">182</a> of file <a class="el" href="rc__calibration_8c-source.html">rc_calibration.c</a>.</p>

<p>References <a class="el" href="rc__calibration_8h-source.html#l00071">FAST_RC_TARGET_MHZ</a>, <a class="el" href="rc__calibration_8c-source.html#l00068">LastICResult</a>, <a class="el" href="rc__calibration_8h-source.html#l00087">RCCAL_CALIB_FAILURE</a>, <a class="el" href="rc__calibration_8h-source.html#l00086">RCCAL_CALIB_FINISHED</a>, <a class="el" href="rc__calibration_8h-source.html#l00084">RCCAL_CALIB_INIT</a>, <a class="el" href="rc__calibration_8h-source.html#l00085">RCCAL_CALIB_WORKING</a>, <a class="el" href="rc__calibration_8c-source.html#l00065">RCCAL_CalibState</a>, <a class="el" href="rc__calibration_8h-source.html#l00094">RCCAL_IC_FINISHED</a>, <a class="el" href="rc__calibration_8c-source.html#l00066">RCCAL_IC_State</a>, <a class="el" href="rc__calibration_8c-source.html#l00306">RCCAL_StartOSIsampleClockPeriod()</a>, <a class="el" href="common_8h.html#8dec381e6ff65f996cc9b817e6939d6e">READ_SIGNATUREBYTE()</a>, <a class="el" href="ATmega32HVB__signature_8h-source.html#l00058">SIG_FOSC_SEGMENT</a>, <a class="el" href="ATmega32HVB__signature_8h-source.html#l00056">SIG_FOSCCAL_DEFAULT</a>, and <a class="el" href="rc__calibration_8h-source.html#l00080">SLOW_RC</a>.</p>

<p>Referenced by <a class="el" href="main_8c-source.html#l00187">main()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00183"></a>00183 {
<a name="l00184"></a>00184     <span class="keyword">static</span> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> fosccal_segment;
<a name="l00185"></a>00185     <span class="keyword">static</span> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> fosccal_default;
<a name="l00186"></a>00186     <span class="keyword">static</span> <a class="code" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a> error;
<a name="l00187"></a>00187     <span class="keyword">static</span> <a class="code" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a> last_error;
<a name="l00188"></a>00188     <span class="keyword">static</span> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> fosccal_saved;
<a name="l00189"></a>00189     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> interrupt_status;
<a name="l00190"></a>00190     
<a name="l00191"></a>00191     <span class="keywordflow">switch</span>(<a class="code" href="rc__calibration_8c.html#08831d7310dc2450802d2b25f87d3d32">RCCAL_CalibState</a>) {
<a name="l00192"></a>00192         
<a name="l00193"></a>00193     <span class="keywordflow">case</span> <a class="code" href="rc__calibration_8h.html#8c494e607329ee1c12964f340c250ceacefbf3e28965a0cd990ace3b1d515cdf">RCCAL_CALIB_INIT</a>:
<a name="l00194"></a>00194         <span class="comment">//Read necessary data from the signature row. The delay cycles are to avoid</span>
<a name="l00195"></a>00195         <span class="comment">//accessing the SPMCSR register within 6 cycles of previous write, since it</span>
<a name="l00196"></a>00196         <span class="comment">//is locked for further writing during these cycles.</span>
<a name="l00197"></a>00197         
<a name="l00198"></a>00198             interrupt_status = __save_interrupt();  <span class="comment">// Disable interrupts.</span>
<a name="l00199"></a>00199         __disable_interrupt();
<a name="l00200"></a>00200         
<a name="l00201"></a>00201         fosccal_default = <a class="code" href="common_8h.html#8dec381e6ff65f996cc9b817e6939d6e">READ_SIGNATUREBYTE</a>(<a class="code" href="ATmega32HVB__signature_8h.html#82890311538e23b133d0cf3565983043">SIG_FOSCCAL_DEFAULT</a>);
<a name="l00202"></a>00202 
<a name="l00203"></a>00203         fosccal_segment = <a class="code" href="common_8h.html#8dec381e6ff65f996cc9b817e6939d6e">READ_SIGNATUREBYTE</a>(<a class="code" href="ATmega32HVB__signature_8h.html#1a4e57eda233859798cd6d7ee25ba928">SIG_FOSC_SEGMENT</a>);
<a name="l00204"></a>00204         
<a name="l00205"></a>00205         __restore_interrupt(interrupt_status);
<a name="l00206"></a>00206         
<a name="l00207"></a>00207         <a class="code" href="rc__calibration_8c.html#346b53f8df2aad519bda12f6a90bbfab" title="Measure OSI prescaled clock periods.">RCCAL_StartOSIsampleClockPeriod</a>(<a class="code" href="rc__calibration_8h.html#32159ce8f1f1c0b26c0c757919bb08f4" title="For selecting Fast RC calibration source.">SLOW_RC</a>);
<a name="l00208"></a>00208         <a class="code" href="rc__calibration_8c.html#08831d7310dc2450802d2b25f87d3d32">RCCAL_CalibState</a> = <a class="code" href="rc__calibration_8h.html#8c494e607329ee1c12964f340c250ceabff3a10d059a47420ee760225ef4dbec">RCCAL_CALIB_WORKING</a>;
<a name="l00209"></a>00209         
<a name="l00210"></a>00210         last_error = 32767; <span class="comment">// last_error is invalid after a temperature change</span>
<a name="l00211"></a>00211         <span class="keywordflow">break</span>;
<a name="l00212"></a>00212         
<a name="l00213"></a>00213     <span class="keywordflow">case</span> <a class="code" href="rc__calibration_8h.html#8c494e607329ee1c12964f340c250ceabff3a10d059a47420ee760225ef4dbec">RCCAL_CALIB_WORKING</a>:
<a name="l00214"></a>00214         {
<a name="l00215"></a>00215             <span class="keywordflow">if</span>(<a class="code" href="rc__calibration_8h.html#fb47a0eadca39ec0d8f9280e76df7b1a207e233067fd777ae55ef98999e4a529">RCCAL_IC_FINISHED</a> == <a class="code" href="rc__calibration_8c.html#56707fdc2d6420df927a3ea6d6f9ff38">RCCAL_IC_State</a>) {
<a name="l00216"></a>00216                 <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> bottom_limit = fosccal_segment &amp; 0xE0;
<a name="l00217"></a>00217                 <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> top_limit =  (fosccal_default &amp; 0xE0) + 0x1F;
<a name="l00218"></a>00218                 
<a name="l00219"></a>00219                 <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> target_period = cal_RC_period * <a class="code" href="rc__calibration_8h.html#ffe0d91fdf137f3e5c053df93ffe3990" title="System clock frequency in Hz.">FAST_RC_TARGET_MHZ</a>;    <span class="comment">// Only whole MHz accounted for.</span>
<a name="l00220"></a>00220                 
<a name="l00221"></a>00221                 error = <a class="code" href="rc__calibration_8c.html#a18842f9efbf604ec2b2c30df8223648">LastICResult</a> - target_period;
<a name="l00222"></a>00222                 
<a name="l00223"></a>00223                 <span class="comment">// If absolute of last error is lower than absolute of current error, use the fosccal value from last test</span>
<a name="l00224"></a>00224                 <span class="comment">// (this happens when going from for example -4 error to +5 error)</span>
<a name="l00225"></a>00225                 <span class="keywordflow">if</span>(last_error &lt; 0 &amp;&amp; error &gt; 0) {
<a name="l00226"></a>00226                     <span class="keywordflow">if</span>(-last_error &lt; error) {
<a name="l00227"></a>00227                         FOSCCAL = fosccal_saved;
<a name="l00228"></a>00228                         <a class="code" href="rc__calibration_8c.html#08831d7310dc2450802d2b25f87d3d32">RCCAL_CalibState</a> = <a class="code" href="rc__calibration_8h.html#8c494e607329ee1c12964f340c250cea676293d88b42766b19d849c46ed1d5f4">RCCAL_CALIB_FINISHED</a>;
<a name="l00229"></a>00229                         <span class="keywordflow">break</span>;
<a name="l00230"></a>00230                     }
<a name="l00231"></a>00231                 }
<a name="l00232"></a>00232                 <span class="keywordflow">if</span>(last_error &gt; 0 &amp;&amp; error &lt; 0) {
<a name="l00233"></a>00233                     <span class="keywordflow">if</span>(last_error &lt; -error) {
<a name="l00234"></a>00234                         FOSCCAL = fosccal_saved;
<a name="l00235"></a>00235                         <a class="code" href="rc__calibration_8c.html#08831d7310dc2450802d2b25f87d3d32">RCCAL_CalibState</a> = <a class="code" href="rc__calibration_8h.html#8c494e607329ee1c12964f340c250cea676293d88b42766b19d849c46ed1d5f4">RCCAL_CALIB_FINISHED</a>;
<a name="l00236"></a>00236                         <span class="keywordflow">break</span>;
<a name="l00237"></a>00237                     }
<a name="l00238"></a>00238                 }
<a name="l00239"></a>00239                 
<a name="l00240"></a>00240                 <span class="keywordflow">if</span>(error &gt; 0) {
<a name="l00241"></a>00241                     <span class="comment">// Search downwards.</span>
<a name="l00242"></a>00242                     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> check_value = bottom_limit + 0x1F;
<a name="l00243"></a>00243                     last_error = error;
<a name="l00244"></a>00244                     fosccal_saved = FOSCCAL;
<a name="l00245"></a>00245                     <span class="keywordflow">if</span> ( FOSCCAL-- == check_value ) {   
<a name="l00246"></a>00246                         FOSCCAL = fosccal_segment;  <span class="comment">// Use fosccal segment value to avoid a step in frequency when going to lower segment.</span>
<a name="l00247"></a>00247                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FOSCCAL &lt; bottom_limit) {
<a name="l00248"></a>00248                         FOSCCAL = fosccal_default;  <span class="comment">// The range have been searched without success, so we select default fosccal value.</span>
<a name="l00249"></a>00249                         <a class="code" href="rc__calibration_8c.html#08831d7310dc2450802d2b25f87d3d32">RCCAL_CalibState</a> = <a class="code" href="rc__calibration_8h.html#8c494e607329ee1c12964f340c250ceafab9333e661c2a4d461afa0a4053f0ce">RCCAL_CALIB_FAILURE</a>;
<a name="l00250"></a>00250                     }
<a name="l00251"></a>00251                     <a class="code" href="rc__calibration_8c.html#346b53f8df2aad519bda12f6a90bbfab" title="Measure OSI prescaled clock periods.">RCCAL_StartOSIsampleClockPeriod</a>(<a class="code" href="rc__calibration_8h.html#32159ce8f1f1c0b26c0c757919bb08f4" title="For selecting Fast RC calibration source.">SLOW_RC</a>);
<a name="l00252"></a>00252                     
<a name="l00253"></a>00253                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (error &lt; 0) {
<a name="l00254"></a>00254                     <span class="comment">// Search upwards.</span>
<a name="l00255"></a>00255                     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> check_value = fosccal_segment + 0x01;
<a name="l00256"></a>00256                     last_error = error;
<a name="l00257"></a>00257                     fosccal_saved = FOSCCAL;
<a name="l00258"></a>00258                     <span class="keywordflow">if</span> ( FOSCCAL++ == check_value ) {   
<a name="l00259"></a>00259                         FOSCCAL = fosccal_default &amp; 0xE0; <span class="comment">// Use fosccal segment value to avoid a step in frequency when going to upper segment.</span>
<a name="l00260"></a>00260                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( FOSCCAL &gt; top_limit ) {
<a name="l00261"></a>00261                         FOSCCAL = fosccal_default;  <span class="comment">// The range have been searched without success, so we select default fosccal value.</span>
<a name="l00262"></a>00262                         <a class="code" href="rc__calibration_8c.html#08831d7310dc2450802d2b25f87d3d32">RCCAL_CalibState</a> = <a class="code" href="rc__calibration_8h.html#8c494e607329ee1c12964f340c250ceafab9333e661c2a4d461afa0a4053f0ce">RCCAL_CALIB_FAILURE</a>;
<a name="l00263"></a>00263                     }
<a name="l00264"></a>00264                     <a class="code" href="rc__calibration_8c.html#346b53f8df2aad519bda12f6a90bbfab" title="Measure OSI prescaled clock periods.">RCCAL_StartOSIsampleClockPeriod</a>(<a class="code" href="rc__calibration_8h.html#32159ce8f1f1c0b26c0c757919bb08f4" title="For selecting Fast RC calibration source.">SLOW_RC</a>);
<a name="l00265"></a>00265                     
<a name="l00266"></a>00266                 } <span class="keywordflow">else</span> {
<a name="l00267"></a>00267                     <span class="comment">// error is equal to zero, so stop at this value</span>
<a name="l00268"></a>00268                     <a class="code" href="rc__calibration_8c.html#08831d7310dc2450802d2b25f87d3d32">RCCAL_CalibState</a> = <a class="code" href="rc__calibration_8h.html#8c494e607329ee1c12964f340c250cea676293d88b42766b19d849c46ed1d5f4">RCCAL_CALIB_FINISHED</a>;
<a name="l00269"></a>00269                     <span class="keywordflow">break</span>;
<a name="l00270"></a>00270                 }
<a name="l00271"></a>00271             }
<a name="l00272"></a>00272         }
<a name="l00273"></a>00273         <span class="keywordflow">break</span>;
<a name="l00274"></a>00274         
<a name="l00275"></a>00275     <span class="keywordflow">default</span>:
<a name="l00276"></a>00276         <span class="comment">// If it gets here it's no error, probably the calibration is finished</span>
<a name="l00277"></a>00277         <span class="keywordflow">break</span>;
<a name="l00278"></a>00278         
<a name="l00279"></a>00279     }
<a name="l00280"></a>00280 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<p><center><img src="rc__calibration_8c_344e46598bc6ed3bc1d025d10edd2578_cgraph.gif" border="0" usemap="#rc__calibration_8c_344e46598bc6ed3bc1d025d10edd2578_cgraph_map" alt=""></center>
<map name="rc__calibration_8c_344e46598bc6ed3bc1d025d10edd2578_cgraph_map">
<area shape="rect" href="rc__calibration_8c.html#346b53f8df2aad519bda12f6a90bbfab" title="Measure OSI prescaled clock periods." alt="" coords="265,5,497,32"><area shape="rect" href="common_8h.html#8dec381e6ff65f996cc9b817e6939d6e" title="READ_SIGNATUREBYTE" alt="" coords="296,56,467,83"></map>
</div>

</div>
</div><p>
<a class="anchor" name="d31c4916062296248c228bdee0e81395"></a><!-- doxytag: member="rc_calibration.c::RCCAL_GetState" ref="d31c4916062296248c228bdee0e81395" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="rc__calibration_8h.html#8c494e607329ee1c12964f340c250cea">RCCAL_CalibState_t</a> RCCAL_GetState           </td>
          <td>(</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Returns the current state of fast rc calibration. 
<p>

<p>Definition at line <a class="el" href="rc__calibration_8c-source.html#l00286">286</a> of file <a class="el" href="rc__calibration_8c-source.html">rc_calibration.c</a>.</p>

<p>References <a class="el" href="rc__calibration_8c-source.html#l00065">RCCAL_CalibState</a>.</p>

<p>Referenced by <a class="el" href="main_8c-source.html#l00187">main()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00287"></a>00287 {
<a name="l00288"></a>00288     <span class="keywordflow">return</span> <a class="code" href="rc__calibration_8c.html#08831d7310dc2450802d2b25f87d3d32">RCCAL_CalibState</a>;
<a name="l00289"></a>00289 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="15fbe16bb72ef18494d1649c9f8c5e4b"></a><!-- doxytag: member="rc_calibration.c::RCCAL_InputCapture_ISR" ref="15fbe16bb72ef18494d1649c9f8c5e4b" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__interrupt void RCCAL_InputCapture_ISR           </td>
          <td>(</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Interrupt routine for Timer0 input capture. 
<p>
Measure number of Fast RC clock cycles in RC_CALIB_CYCLES number of Oscillator Sampling Interface prescaled Clock periods. The prescaler is 128 for ATmega32HVB. osi_cycles is typically 8, giving a total of 1024 cycles for the selected input clock. Available inputs are Slow RC and ULP RC.<p>
Warning: The routine only takes into account one overflow of OCR0, so make sure the number of Fast RC cycles used for calibration are less than 2^16. 
<p>Definition at line <a class="el" href="rc__calibration_8c-source.html#l00333">333</a> of file <a class="el" href="rc__calibration_8c-source.html">rc_calibration.c</a>.</p>

<p>References <a class="el" href="rc__calibration_8c-source.html#l00068">LastICResult</a>, <a class="el" href="rc__calibration_8h-source.html#l00078">RC_CALIB_CYCLES</a>, <a class="el" href="rc__calibration_8h-source.html#l00093">RCCAL_IC_CAPTURES</a>, <a class="el" href="rc__calibration_8h-source.html#l00094">RCCAL_IC_FINISHED</a>, <a class="el" href="rc__calibration_8h-source.html#l00092">RCCAL_IC_INITIAL_CAPTURE</a>, and <a class="el" href="rc__calibration_8c-source.html#l00066">RCCAL_IC_State</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00334"></a>00334 {
<a name="l00335"></a>00335     <span class="keyword">static</span> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> i = 0;
<a name="l00336"></a>00336     <span class="keyword">static</span> <a class="code" href="stdint_8h.html#273cf69d639a59973b6019625df33e30">uint16_t</a> initial_capture, final_capture;
<a name="l00337"></a>00337     
<a name="l00338"></a>00338     
<a name="l00339"></a>00339     <span class="keywordflow">if</span>(<a class="code" href="rc__calibration_8h.html#fb47a0eadca39ec0d8f9280e76df7b1a1c5cf0454f43a18b0d6cd3db2764fc6e">RCCAL_IC_INITIAL_CAPTURE</a> == <a class="code" href="rc__calibration_8c.html#56707fdc2d6420df927a3ea6d6f9ff38">RCCAL_IC_State</a> ) {
<a name="l00340"></a>00340         i = 0;
<a name="l00341"></a>00341         initial_capture = OCR0A;
<a name="l00342"></a>00342         initial_capture |= OCR0B &lt;&lt; 8;
<a name="l00343"></a>00343         <a class="code" href="rc__calibration_8c.html#56707fdc2d6420df927a3ea6d6f9ff38">RCCAL_IC_State</a> = <a class="code" href="rc__calibration_8h.html#fb47a0eadca39ec0d8f9280e76df7b1a44289e36cdad3a8d07ac793af4211bf7">RCCAL_IC_CAPTURES</a>;
<a name="l00344"></a>00344     
<a name="l00345"></a>00345     } <span class="keywordflow">else</span> {
<a name="l00346"></a>00346         ++i;
<a name="l00347"></a>00347         <span class="keywordflow">if</span>(i == <a class="code" href="rc__calibration_8h.html#fab15c077276c2fed0b7426b2af7eb11" title="Number of calibration cycles cycles for OSI calibration.">RC_CALIB_CYCLES</a>) {
<a name="l00348"></a>00348             final_capture = OCR0A;
<a name="l00349"></a>00349             final_capture |= OCR0B &lt;&lt; 8;
<a name="l00350"></a>00350             <a class="code" href="rc__calibration_8c.html#a18842f9efbf604ec2b2c30df8223648">LastICResult</a> = final_capture - initial_capture;
<a name="l00351"></a>00351             <a class="code" href="rc__calibration_8c.html#56707fdc2d6420df927a3ea6d6f9ff38">RCCAL_IC_State</a> = <a class="code" href="rc__calibration_8h.html#fb47a0eadca39ec0d8f9280e76df7b1a207e233067fd777ae55ef98999e4a529">RCCAL_IC_FINISHED</a>;
<a name="l00352"></a>00352             TIMSK0 &amp;= ~(1&lt;&lt;ICIE0);
<a name="l00353"></a>00353         }
<a name="l00354"></a>00354     }
<a name="l00355"></a>00355 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="3324e52d9c103e1c3889824170dd7d08"></a><!-- doxytag: member="rc_calibration.c::RCCAL_StartCalibrateFastRC" ref="3324e52d9c103e1c3889824170dd7d08" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void RCCAL_StartCalibrateFastRC           </td>
          <td>(</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Start the Fast RC calibration. 
<p>

<p>Definition at line <a class="el" href="rc__calibration_8c-source.html#l00150">150</a> of file <a class="el" href="rc__calibration_8c-source.html">rc_calibration.c</a>.</p>

<p>References <a class="el" href="rc__calibration_8h-source.html#l00084">RCCAL_CALIB_INIT</a>, and <a class="el" href="rc__calibration_8c-source.html#l00065">RCCAL_CalibState</a>.</p>

<p>Referenced by <a class="el" href="main_8c-source.html#l00187">main()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00151"></a>00151 {
<a name="l00152"></a>00152     <a class="code" href="rc__calibration_8c.html#08831d7310dc2450802d2b25f87d3d32">RCCAL_CalibState</a> = <a class="code" href="rc__calibration_8h.html#8c494e607329ee1c12964f340c250ceacefbf3e28965a0cd990ace3b1d515cdf">RCCAL_CALIB_INIT</a>;
<a name="l00153"></a>00153 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="346b53f8df2aad519bda12f6a90bbfab"></a><!-- doxytag: member="rc_calibration.c::RCCAL_StartOSIsampleClockPeriod" ref="346b53f8df2aad519bda12f6a90bbfab" args="(uint8_t clock_source)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void RCCAL_StartOSIsampleClockPeriod           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>&nbsp;</td>
          <td class="paramname"> <em>clock_source</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Measure OSI prescaled clock periods. 
<p>
Measure number of Fast RC clock cycles in RC_CALIB_CYCLES number of Oscillator Sampling Interface prescaled Clock periods. The prescaler is 128 for ATmega32HVB. osi_cycles is typically 8, giving a total of 1024 cycles for the selected input clock. Available inputs are Slow RC and ULP RC.<p>
Warning: The routine only takes into account one overflow of OCR0, so make sure the number of Fast RC cycles used for calibration are less than 2^16.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>clock_source</em>&nbsp;</td><td>Which clock to use (slow RC or ULP RC) </td></tr>
  </table>
</dl>

<p>Definition at line <a class="el" href="rc__calibration_8c-source.html#l00306">306</a> of file <a class="el" href="rc__calibration_8c-source.html">rc_calibration.c</a>.</p>

<p>References <a class="el" href="rc__calibration_8h-source.html#l00092">RCCAL_IC_INITIAL_CAPTURE</a>, <a class="el" href="rc__calibration_8c-source.html#l00066">RCCAL_IC_State</a>, and <a class="el" href="rc__calibration_8h-source.html#l00068">T0_PRESCALER</a>.</p>

<p>Referenced by <a class="el" href="rc__calibration_8c-source.html#l00182">RCCAL_CalibrateFastRCruntime()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00307"></a>00307 {
<a name="l00308"></a>00308     OSICSR = clock_source | (1 &lt;&lt; OSIEN);   <span class="comment">// OSI enable and select</span>
<a name="l00309"></a>00309     TCCR0A = (1 &lt;&lt; TCW0) | (1 &lt;&lt; ICEN0) | (0 &lt;&lt; ICS0) | (1&lt;&lt;ICES0); <span class="comment">// 16-bit mode, falling edge trigger</span>
<a name="l00310"></a>00310     TCCR0B = <a class="code" href="rc__calibration_8h.html#40c5589fa9e42b6c11f57e89f83291c0">T0_PRESCALER</a>;                  <span class="comment">// Timer0 running with 1x prescaling.</span>
<a name="l00311"></a>00311     TIFR0 |= (1 &lt;&lt; ICF0);                   <span class="comment">// Clear interrupt flag in case it was set from before.</span>
<a name="l00312"></a>00312     TIMSK0 |= (1&lt;&lt;ICIE0);                   <span class="comment">// Enable the input capture interrupt</span>
<a name="l00313"></a>00313     
<a name="l00314"></a>00314     TCNT0 = 0; <span class="comment">// Clear the counter to avoid overflow</span>
<a name="l00315"></a>00315     
<a name="l00316"></a>00316     <a class="code" href="rc__calibration_8c.html#56707fdc2d6420df927a3ea6d6f9ff38">RCCAL_IC_State</a> = <a class="code" href="rc__calibration_8h.html#fb47a0eadca39ec0d8f9280e76df7b1a1c5cf0454f43a18b0d6cd3db2764fc6e">RCCAL_IC_INITIAL_CAPTURE</a>;
<a name="l00317"></a>00317     
<a name="l00318"></a>00318 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="539c9921f8cbaf485509f8f5562a9918"></a><!-- doxytag: member="rc_calibration.c::RCCAL_StopTimer0" ref="539c9921f8cbaf485509f8f5562a9918" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void RCCAL_StopTimer0           </td>
          <td>(</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a18842f9efbf604ec2b2c30df8223648"></a><!-- doxytag: member="rc_calibration.c::LastICResult" ref="a18842f9efbf604ec2b2c30df8223648" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="stdint_8h.html#269259c924dce846340ddbb810db2e3c">int16_t</a> <a class="el" href="rc__calibration_8c.html#a18842f9efbf604ec2b2c30df8223648">LastICResult</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="rc__calibration_8c-source.html#l00068">68</a> of file <a class="el" href="rc__calibration_8c-source.html">rc_calibration.c</a>.</p>

<p>Referenced by <a class="el" href="rc__calibration_8c-source.html#l00182">RCCAL_CalibrateFastRCruntime()</a>, and <a class="el" href="rc__calibration_8c-source.html#l00333">RCCAL_InputCapture_ISR()</a>.</p>

</div>
</div><p>
<a class="anchor" name="08831d7310dc2450802d2b25f87d3d32"></a><!-- doxytag: member="rc_calibration.c::RCCAL_CalibState" ref="08831d7310dc2450802d2b25f87d3d32" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="rc__calibration_8h.html#8c494e607329ee1c12964f340c250cea">RCCAL_CalibState_t</a> <a class="el" href="rc__calibration_8c.html#08831d7310dc2450802d2b25f87d3d32">RCCAL_CalibState</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="rc__calibration_8c-source.html#l00065">65</a> of file <a class="el" href="rc__calibration_8c-source.html">rc_calibration.c</a>.</p>

<p>Referenced by <a class="el" href="rc__calibration_8c-source.html#l00182">RCCAL_CalibrateFastRCruntime()</a>, <a class="el" href="rc__calibration_8c-source.html#l00286">RCCAL_GetState()</a>, and <a class="el" href="rc__calibration_8c-source.html#l00150">RCCAL_StartCalibrateFastRC()</a>.</p>

</div>
</div><p>
<a class="anchor" name="56707fdc2d6420df927a3ea6d6f9ff38"></a><!-- doxytag: member="rc_calibration.c::RCCAL_IC_State" ref="56707fdc2d6420df927a3ea6d6f9ff38" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="rc__calibration_8h.html#fb47a0eadca39ec0d8f9280e76df7b1a">RCCAL_IC_State_t</a> <a class="el" href="rc__calibration_8c.html#56707fdc2d6420df927a3ea6d6f9ff38">RCCAL_IC_State</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="rc__calibration_8c-source.html#l00066">66</a> of file <a class="el" href="rc__calibration_8c-source.html">rc_calibration.c</a>.</p>

<p>Referenced by <a class="el" href="rc__calibration_8c-source.html#l00182">RCCAL_CalibrateFastRCruntime()</a>, <a class="el" href="rc__calibration_8c-source.html#l00333">RCCAL_InputCapture_ISR()</a>, and <a class="el" href="rc__calibration_8c-source.html#l00306">RCCAL_StartOSIsampleClockPeriod()</a>.</p>

</div>
</div><p>
</div>
<html>
 <head>
  <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
  <title>@DOC_TITLE@</title>
  <link href="doxygen.css" rel="stylesheet" type="text/css">
</head>
<body>

<table width="100%" height="10%" bgcolor="#FFFFFF">
  <tr>
    <td colspan="6" height="1" background="blue.gif"></td>
  </tr>

  <tr>
    <td colspan="6">
    <address style="align: right;"><small>
Generated on Wed Aug 4 11:00:38 2010 for AVR474 Firmware User's Guide for SB202 by <a href="http://www.doxygen.org/index.html"><img src="doxygen.png" alt="doxygen" align="middle" border=0></a> 1.5.6</small></address>
    </td>
  </tr>

</table>
